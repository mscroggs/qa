<html><!-- Powered by Question2Answer - http://www.question2answer.org/ --><head>
		<meta http-equiv="content-type" content="text/html; charset=utf-8">
		<title>Is it possible to move the boundary between two subdomains? - FEniCS Q&amp;A</title>
		<meta name="description" content="My mesh is created by gmsh, converted by dolfin-convert and loaded into my script. The Domain ... when the displacement is not a continous function...">
		<meta name="keywords" content="mesh,move-mesh,move,boundary,subdomains">
		<link rel="stylesheet" type="text/css" href="../../qa-theme/Snow/qa-styles.css">
		<link rel="canonical" href="http://fenicsproject.org/qa/10655/is-it-possible-to-move-the-boundary-between-two-subdomains">
		<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
    tex2jax: {inlineMath: [["$","$"],["\\(","\\)"]]},
    TeX: { extensions: ["AMSmath.js","AMSsymbols.js"]}
  });
</script>
<script type="text/javascript" src="../../mathjax/MathJax.js"></script>
		<script src="../../jquery-1.7.2.min.js" type="text/javascript"></script>
		<script src="../../highlight.min.js"></script>
<script type="text/javascript">
$(function(){
	$('.wmd-input').keypress(function(){
		window.clearTimeout(hljs.Timeout);
		hljs.Timeout = window.setTimeout(function() {
			hljs.initHighlighting.called = false;
			hljs.initHighlighting();
		}, 500);
	});
	window.setTimeout(function() {
		hljs.initHighlighting.called = false;
		hljs.initHighlighting();
	}, 500);
});
</script>


	</head>
	<body class="qa-template-question qa-body-js-off">
		<div class="qa-body-wrapper">
			
			<div class="qa-header">
				<div class="qa-logo">
					<a href="../../" class="qa-logo-link" title="FEniCS Q&amp;A"><img src="../../qa-theme/fenics_qa.png" border="0" alt="FEniCS Q&amp;A"></a>
				</div>
				<div class="qa-header-clear">
				</div>
			</div> <!-- END qa-header -->
			
			<div class="qa-main-shadow">
				
				<div class="qa-main-wrapper">
					
					<div class="qa-sidepanel">
						<div class="qa-sidebar">
							This is a read only copy of the old FEniCS QA forum. Please visit the <a href="https://www.allanswered.com/community/s/fenics-project/">new QA forum</a> to ask questions
						</div>
						
					</div>
					
					<div class="qa-main">
						<h1>
							<span class="entry-title">Is it possible to move the boundary between two subdomains?</span>
						</h1>
						<div class="qa-part-q-view">
							<div class="qa-q-view  hentry question" id="q10655">
								<form method="post" action="../../10655/is-it-possible-to-move-the-boundary-between-two-subdomains">
									<div class="qa-q-view-stats">
										<div class="qa-voting qa-voting-net" id="voting_10655">
											<div class="qa-vote-count qa-vote-count-net">
												<span class="qa-netvote-count">
													<span class="qa-netvote-count-data">0<span class="votes-up"><span class="value-title" title="0"></span></span><span class="votes-down"><span class="value-title" title="0"></span></span></span><span class="qa-netvote-count-pad"> votes</span>
												</span>
											</div>
											<div class="qa-vote-clear">
											</div>
										</div>
									</div>
									<input type="hidden" name="code" value="0-1516467069-7f88e7884e40779add4017f2666184c060af027a">
								</form>
								<div class="qa-q-view-main">
									<form method="post" action="../../10655/is-it-possible-to-move-the-boundary-between-two-subdomains">
										<div class="qa-q-view-content">
											<a name="10655"></a><div class="entry-content"><p>My mesh is created by gmsh, converted by dolfin-convert and loaded into my script.<br>
The Domain is divided in two subdomains which I can access via MeshFunction.</p>

<p>Is it possible to move the boundary between the two subdomains only slightly without having to re-run gmsh and dolfin-convert?</p>

<p>I have found Mesh.move() and ALE.move() in the docs. But I don't quite get how they can be used when the displacement is not a continous function...</p>
</div>
										</div>
										<div class="qa-q-view-tags">
											<ul class="qa-q-view-tag-list">
												<li class="qa-q-view-tag-item"><a href="../../tag/mesh" rel="tag" class="qa-tag-link">mesh</a></li>
												<li class="qa-q-view-tag-item"><a href="../../tag/move-mesh" rel="tag" class="qa-tag-link">move-mesh</a></li>
												<li class="qa-q-view-tag-item"><a href="../../tag/move" rel="tag" class="qa-tag-link">move</a></li>
												<li class="qa-q-view-tag-item"><a href="../../tag/boundary" rel="tag" class="qa-tag-link">boundary</a></li>
												<li class="qa-q-view-tag-item"><a href="../../tag/subdomains" rel="tag" class="qa-tag-link">subdomains</a></li>
											</ul>
										</div>
										<span class="qa-q-view-avatar-meta">
											<span class="qa-q-view-meta">
												<a href="../../10655/is-it-possible-to-move-the-boundary-between-two-subdomains" class="qa-q-view-what">asked</a>
												<span class="qa-q-view-when">
													<span class="qa-q-view-when-data"><span class="published"><span class="value-title" title="2016-07-13T15:38:03+0000"></span>Jul 13, 2016</span></span>
												</span>
												<span class="qa-q-view-who">
													<span class="qa-q-view-who-pad">by </span>
													<span class="qa-q-view-who-data"><span class="vcard author"><a href="../../user/cweickhmann" class="qa-user-link url nickname">cweickhmann</a></span></span>
													<span class="qa-q-view-who-title">FEniCS Novice</span>
													<span class="qa-q-view-who-points">
														<span class="qa-q-view-who-points-pad">(</span><span class="qa-q-view-who-points-data">550</span><span class="qa-q-view-who-points-pad"> points)</span>
													</span>
												</span>
											</span>
										</span>
										<div class="qa-q-view-buttons">
										</div>
										
										<div class="qa-q-view-c-list" style="display:none;" id="c10655_list">
										</div> <!-- END qa-c-list -->
										
										<input type="hidden" name="code" value="0-1516467069-03dea10b80646122cc35fe26c2a2e0ea777a35de">
										<input type="hidden" name="qa_click" value="">
									</form>
									<div class="qa-c-form">
									</div> <!-- END qa-c-form -->
									
								</div> <!-- END qa-q-view-main -->
								<div class="qa-q-view-clear">
								</div>
							</div> <!-- END qa-q-view -->
							
						</div>
						<div class="qa-part-a-list">
							<h2 id="a_list_title">2 Answers</h2>
							<div class="qa-a-list" id="a_list">
								
								<div class="qa-a-list-item  hentry answer answer-selected qa-a-list-item-selected" id="a10675">
									<form method="post" action="../../10655/is-it-possible-to-move-the-boundary-between-two-subdomains">
										<div class="qa-voting qa-voting-net" id="voting_10675">
											<div class="qa-vote-count qa-vote-count-net">
												<span class="qa-netvote-count">
													<span class="qa-netvote-count-data">+1<span class="votes-up"><span class="value-title" title="1"></span></span><span class="votes-down"><span class="value-title" title="0"></span></span></span><span class="qa-netvote-count-pad"> vote</span>
												</span>
											</div>
											<div class="qa-vote-clear">
											</div>
										</div>
										<input type="hidden" name="code" value="0-1516467069-7f88e7884e40779add4017f2666184c060af027a">
									</form>
									<div class="qa-a-item-main">
										<form method="post" action="../../10655/is-it-possible-to-move-the-boundary-between-two-subdomains">
											<div class="qa-a-item-selected">
												<div class="qa-a-selection">
													<div class="qa-a-selected">&#160;</div>
													<div class="qa-a-selected-text">Best answer</div>
												</div>
												<div class="qa-a-item-content">
													<a name="10675"></a><div class="entry-content"><p>Hello, <code>x=mesh.coordinates()</code> does not return a copy so any modification to <code>x</code> is a modification of the coordinates of your mesh. Consider</p>

<pre><code>from dolfin import *
import numpy as np

mesh = RectangleMesh(Point(-1, -1), Point(1, 1), 2, 10)
iface = FacetFunction('size_t', mesh, 0)
CompiledSubDomain('near(x[0], 0)').mark(iface, 1)

# Get unique indices of vertices on the interface
mesh.init(1, 0)
ivertex = list(set(sum((facet.entities(0).tolist()
                        for facet in SubsetIterator(iface, 1)), [])))

dx = np.linspace(0, 2, 10)
dx = 0.5*np.sin(2*pi*dx)
# Move 
coordinates = mesh.coordinates()
for dxi in dx:
    coordinates[ivertex, 0] = dxi
    plot(mesh, interactive=True) 
</code></pre>
</div>
												</div>
												<span class="qa-a-item-avatar-meta">
													<span class="qa-a-item-meta">
														<a href="../../10655/is-it-possible-to-move-the-boundary-between-two-subdomains?show=10675#a10675" class="qa-a-item-what">answered</a>
														<span class="qa-a-item-when">
															<span class="qa-a-item-when-data"><span class="published"><span class="value-title" title="2016-07-15T14:00:07+0000"></span>Jul 15, 2016</span></span>
														</span>
														<span class="qa-a-item-who">
															<span class="qa-a-item-who-pad">by </span>
															<span class="qa-a-item-who-data"><span class="vcard author"><a href="../../user/OxbowQuest" class="qa-user-link url nickname">OxbowQuest</a></span></span>
															<span class="qa-a-item-who-title">FEniCS User</span>
															<span class="qa-a-item-who-points">
																<span class="qa-a-item-who-points-pad">(</span><span class="qa-a-item-who-points-data">1,360</span><span class="qa-a-item-who-points-pad"> points)</span>
															</span>
														</span>
														<br>
														<span class="qa-a-item-what">selected</span>
														<span class="qa-a-item-when">
															<span class="qa-a-item-when-data"><span class="updated"><span class="value-title" title="2016-07-16T14:22:06+0000"></span>Jul 16, 2016</span></span>
														</span>
														<span class="qa-a-item-who">
															<span class="qa-a-item-who-pad">by </span><span class="qa-a-item-who-data"><a href="../../user/cweickhmann" class="qa-user-link url nickname">cweickhmann</a></span>
														</span>
													</span>
												</span>
											</div>
											<div class="qa-a-item-buttons">
												</div>
											
											<div class="qa-a-item-c-list" id="c10675_list">
												<div class="qa-c-list-item  hentry comment" id="c10682">
													<div class="qa-c-item-content">
														<a name="10682"></a><div class="entry-content"><p>Hi! Thanks! That actually helped a lot! I didn't realise Mesh.coordinates() returned a reference rather than a copy.<br>
Quick update: If you use gmsh like I do, you can mark the boundary by a Physical Line clause and pick it quickly in the code (some people probably know this, I just want to point this out because it took me a while to realise that then).</p>

<p>Example gmsh geo code:<br>
</p><pre><br>
Point(1) = {-1, -1, 0, .1};<br>
Point(2) = {-1,  1, 0, .1};<br>
Point(3) = { 1,  1, 0, .1};<br>
Point(4) = { 1, -1, 0, .1};

Line(1) = {1, 2};<br>
Line(2) = {2, 3};<br>
Line(3) = {3, 4};<br>
Line(4) = {4, 1};

Line Loop(5) = {1, 2, 3, 4};

Physical Line(1) = {4};<br>
</pre>

<p>Then you go<br>
</p><pre>$&gt; gmsh file.geo -2<br>
$&gt; dolfin-convert file.msh file.xml</pre><br>
and now, in Python you can load the xml and the _facet_region.xml files:<br>
<pre><br>
from dolfin import *<br>
geometry_file = "file.xml"<br>
facet_file = "file_facet_region.xml"

mesh = Mesh(geometry_file)<br>
facets = MeshFunction("size_t", mesh, facet_file)<br>
</pre><br>
and OxbowQuest's code adapts to<br>
<pre><br>
mesh.init(1,0)<br>
ivertex = list(set(sum((facet.entities(0).tolist() for facet in SubsetIterator(facets, 3)), [])))<br>
coordinates = mesh.coordinates()<br>
coordinates[ivertex, 0] += .05 # or whatever you want them to move...<br>
</pre>

<p><b>Discussion</b>: The ivertex-line is really not straight-forward... I would've given up at the Iterator. Any suggestions on how to ease this up a bit?</p>
</div>
													</div>
													<div class="qa-c-item-footer">
														<span class="qa-c-item-avatar-meta">
															<span class="qa-c-item-meta">
																<a href="../../10655/is-it-possible-to-move-the-boundary-between-two-subdomains?show=10682#c10682" class="qa-c-item-what">commented</a>
																<span class="qa-c-item-when">
																	<span class="qa-c-item-when-data"><span class="published"><span class="value-title" title="2016-07-16T14:32:49+0000"></span>Jul 16, 2016</span></span>
																</span>
																<span class="qa-c-item-who">
																	<span class="qa-c-item-who-pad">by </span>
																	<span class="qa-c-item-who-data"><span class="vcard author"><a href="../../user/cweickhmann" class="qa-user-link url nickname">cweickhmann</a></span></span>
																	<span class="qa-c-item-who-title">FEniCS Novice</span>
																	<span class="qa-c-item-who-points">
																		<span class="qa-c-item-who-points-pad">(</span><span class="qa-c-item-who-points-data">550</span><span class="qa-c-item-who-points-pad"> points)</span>
																	</span>
																</span>
															</span>
														</span>
														<div class="qa-c-item-buttons">
														</div>
													</div>
													<div class="qa-c-item-clear">
													</div>
												</div> <!-- END qa-c-item -->
												<div class="qa-c-list-item  hentry comment" id="c10683">
													<div class="qa-c-item-content">
														<a name="10683"></a><div class="entry-content"><p>Hi, the original code uses sum to concatenate lists of vertices created by the generator expression. The construction is equivalent with the following</p>

<pre><code>jvertex = []
# For each interface facet get the vertices connected to it
for facet in SubsetIterator(iface, 1):
    jvertex.extend(facet.entities(0))
# From the construction there are duplicate vertices in the list. Filter them by
# creating a set from the list
jvertex = set(jvertex)
# Bacause we want to use jvertex for indexing arrays it needs to be converted
# back to list
jvertex = list(jvertex)

print jvertex == ivertex 
</code></pre>

<p>Note that <code>mesh.init(1, 0)</code> is required to get the connectivity of edges (entities of topological dimension 1) to vertices (their topological dimension is 0).</p>
</div>
													</div>
													<div class="qa-c-item-footer">
														<span class="qa-c-item-avatar-meta">
															<span class="qa-c-item-meta">
																<a href="../../10655/is-it-possible-to-move-the-boundary-between-two-subdomains?show=10683#c10683" class="qa-c-item-what">commented</a>
																<span class="qa-c-item-when">
																	<span class="qa-c-item-when-data"><span class="published"><span class="value-title" title="2016-07-16T14:47:48+0000"></span>Jul 16, 2016</span></span>
																</span>
																<span class="qa-c-item-who">
																	<span class="qa-c-item-who-pad">by </span>
																	<span class="qa-c-item-who-data"><span class="vcard author"><a href="../../user/OxbowQuest" class="qa-user-link url nickname">OxbowQuest</a></span></span>
																	<span class="qa-c-item-who-title">FEniCS User</span>
																	<span class="qa-c-item-who-points">
																		<span class="qa-c-item-who-points-pad">(</span><span class="qa-c-item-who-points-data">1,360</span><span class="qa-c-item-who-points-pad"> points)</span>
																	</span>
																</span>
															</span>
														</span>
														<div class="qa-c-item-buttons">
														</div>
													</div>
													<div class="qa-c-item-clear">
													</div>
												</div> <!-- END qa-c-item -->
											</div> <!-- END qa-c-list -->
											
											<input type="hidden" name="code" value="0-1516467069-691f470dc9f8b6f3b809ec18c3a899dfa8d43e4a">
											<input type="hidden" name="qa_click" value="">
										</form>
										<div class="qa-c-form">
										</div> <!-- END qa-c-form -->
										
									</div> <!-- END qa-a-item-main -->
									<div class="qa-a-item-clear">
									</div>
								</div> <!-- END qa-a-list-item -->
								
								<div class="qa-a-list-item  hentry answer" id="a10670">
									<form method="post" action="../../10655/is-it-possible-to-move-the-boundary-between-two-subdomains">
										<div class="qa-voting qa-voting-net" id="voting_10670">
											<div class="qa-vote-count qa-vote-count-net">
												<span class="qa-netvote-count">
													<span class="qa-netvote-count-data">0<span class="votes-up"><span class="value-title" title="0"></span></span><span class="votes-down"><span class="value-title" title="0"></span></span></span><span class="qa-netvote-count-pad"> votes</span>
												</span>
											</div>
											<div class="qa-vote-clear">
											</div>
										</div>
										<input type="hidden" name="code" value="0-1516467069-7f88e7884e40779add4017f2666184c060af027a">
									</form>
									<div class="qa-a-item-main">
										<form method="post" action="../../10655/is-it-possible-to-move-the-boundary-between-two-subdomains">
											<div class="qa-a-selection">
											</div>
											<div class="qa-a-item-content">
												<a name="10670"></a><div class="entry-content"><p>How do you determine the movement at the boundary?</p>

<p>You can the use the FEniCS mesh editor to move redefine the mesh.</p>
</div>
											</div>
											<span class="qa-a-item-avatar-meta">
												<span class="qa-a-item-avatar">
													<a href="../../user/KristianE" class="qa-avatar-link"><img src="https://www.gravatar.com/avatar/8e8c30d82e263e44bd8fe50055a60421?s=40" width="40" height="40" class="qa-avatar-image" alt=""></a>
												</span>
												<span class="qa-a-item-meta">
													<a href="../../10655/is-it-possible-to-move-the-boundary-between-two-subdomains?show=10670#a10670" class="qa-a-item-what">answered</a>
													<span class="qa-a-item-when">
														<span class="qa-a-item-when-data"><span class="published"><span class="value-title" title="2016-07-14T19:08:18+0000"></span>Jul 14, 2016</span></span>
													</span>
													<span class="qa-a-item-who">
														<span class="qa-a-item-who-pad">by </span>
														<span class="qa-a-item-who-data"><span class="vcard author"><a href="../../user/KristianE" class="qa-user-link url nickname">KristianE</a></span></span>
														<span class="qa-a-item-who-title">FEniCS Expert</span>
														<span class="qa-a-item-who-points">
															<span class="qa-a-item-who-points-pad">(</span><span class="qa-a-item-who-points-data">12,900</span><span class="qa-a-item-who-points-pad"> points)</span>
														</span>
													</span>
												</span>
											</span>
											<div class="qa-a-item-buttons">
												</div>
											
											<div class="qa-a-item-c-list" id="c10670_list">
												<div class="qa-c-list-item  hentry comment" id="c10672">
													<div class="qa-c-item-content">
														<a name="10672"></a><div class="entry-content"><p>I want to use scipy.optimize to optimize for the position of the boundary. The initial position is pretty close to the optimal boundary, so I don't expect any weird mesh deformations.</p>

<p>MeshEditor only allows to <em>add</em> vertices. I would like to <em>move</em> vertices which are already present without changing the mesh topology.</p>

<p><img src="https://dl.dropboxusercontent.com/u/2465459/g8216.png" alt="Example Mesh"></p>

<p>Example:<br>
</p><pre><br>
mesh = Mesh("geometry.xml") # Created by gmsh -&gt; dolfin-convert<br>
boundary = MeshFunction('size_t', mesh, "geometry_facets.xml") # Autocreated by dolfin-convert when PhysicalLine is defined<br>
</pre>

<p>Now, I can't get the vertices' coordinates, overwrite the x-coordinate with x_iter and write it back to the mesh.</p>

<pre>vert_idx = <b>SomeMeshSelectionFunction(mesh, boundary)</b> # Maybe MeshEntity?
mesh_coord = mesh.coordinates()
mesh_coord[vert_idx][:,1] = r_iter # assign current value for radius
<b>mesh.OverwriteMeshCoordinates(mesh_coord)</b> # Didn't find anything along that line...
</pre>

<p>Now I thought mesh.move() would help me. I can get a delta (something like $x_{\text{iter},i} - x_{\text{iter},i-1}$) easily. But I don't get how I select the highlighted elements only and apply the move.</p>

<p>The reason for this approach is that the meshing and conversion takes the largest fraction of the evaluation time. And since the mesh only changes very, very little (vertex 3, for example, will always stay between 2 and 4 and probably only move by 10% of the edge length).</p>
</div>
													</div>
													<div class="qa-c-item-footer">
														<span class="qa-c-item-avatar-meta">
															<span class="qa-c-item-meta">
																<a href="../../10655/is-it-possible-to-move-the-boundary-between-two-subdomains?show=10672#c10672" class="qa-c-item-what">commented</a>
																<span class="qa-c-item-when">
																	<span class="qa-c-item-when-data"><span class="published"><span class="value-title" title="2016-07-15T09:08:52+0000"></span>Jul 15, 2016</span></span>
																</span>
																<span class="qa-c-item-who">
																	<span class="qa-c-item-who-pad">by </span>
																	<span class="qa-c-item-who-data"><span class="vcard author"><a href="../../user/cweickhmann" class="qa-user-link url nickname">cweickhmann</a></span></span>
																	<span class="qa-c-item-who-title">FEniCS Novice</span>
																	<span class="qa-c-item-who-points">
																		<span class="qa-c-item-who-points-pad">(</span><span class="qa-c-item-who-points-data">550</span><span class="qa-c-item-who-points-pad"> points)</span>
																	</span>
																</span>
															</span>
														</span>
														<div class="qa-c-item-buttons">
														</div>
													</div>
													<div class="qa-c-item-clear">
													</div>
												</div> <!-- END qa-c-item -->
											</div> <!-- END qa-c-list -->
											
											<input type="hidden" name="code" value="0-1516467069-4df8577d56cc8b467b16be39b72e7e124b8e1491">
											<input type="hidden" name="qa_click" value="">
										</form>
										<div class="qa-c-form">
										</div> <!-- END qa-c-form -->
										
									</div> <!-- END qa-a-item-main -->
									<div class="qa-a-item-clear">
									</div>
								</div> <!-- END qa-a-list-item -->
								
							</div> <!-- END qa-a-list -->
							
						</div>
					</div> <!-- END qa-main -->
					
				</div> <!-- END main-wrapper -->
			</div> <!-- END main-shadow -->
		</div> <!-- END body-wrapper -->
		<!-- END footer-bottom-group -->
		
		<div style="position:absolute; left:-9999px; top:-9999px;">
			<span id="qa-waiting-template" class="qa-waiting">...</span>
		</div>
	
	

</body><!-- Powered by Question2Answer - http://www.question2answer.org/ --></html>