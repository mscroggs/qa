<html><!-- Powered by Question2Answer - http://www.question2answer.org/ --><head>
		<meta http-equiv="content-type" content="text/html; charset=utf-8">
		<title>variation form dependent on non-analytical/complicated expression - FEniCS Q&amp;A</title>
		<meta name="description" content="I am working on a nonlinear temperature field problem; some of the terms variational/weak form  ...  given the temperature value of the node/vertex?">
		<link rel="stylesheet" type="text/css" href="../../qa-theme/Snow/qa-styles.css">
		<link rel="canonical" href="http://fenicsproject.org/qa/12686/variation-form-dependent-analytical-complicated-expression">
		<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
    tex2jax: {inlineMath: [["$","$"],["\\(","\\)"]]},
    TeX: { extensions: ["AMSmath.js","AMSsymbols.js"]}
  });
</script>
<script type="text/javascript" src="../../mathjax/MathJax.js"></script>
		<script src="../../jquery-1.7.2.min.js" type="text/javascript"></script>
		<script src="../../highlight.min.js"></script>
<script type="text/javascript">
$(function(){
	$('.wmd-input').keypress(function(){
		window.clearTimeout(hljs.Timeout);
		hljs.Timeout = window.setTimeout(function() {
			hljs.initHighlighting.called = false;
			hljs.initHighlighting();
		}, 500);
	});
	window.setTimeout(function() {
		hljs.initHighlighting.called = false;
		hljs.initHighlighting();
	}, 500);
});
</script>


	</head>
	<body class="qa-template-question qa-body-js-off">
		<div class="qa-body-wrapper">
			
			<div class="qa-header">
				<div class="qa-logo">
					<a href="../../" class="qa-logo-link" title="FEniCS Q&amp;A"><img src="../../qa-theme/fenics_qa.png" border="0" alt="FEniCS Q&amp;A"></a>
				</div>
				<div class="qa-header-clear">
				</div>
			</div> <!-- END qa-header -->
			
			<div class="qa-main-shadow">
				
				<div class="qa-main-wrapper">
					
					<div class="qa-sidepanel">
						<div class="qa-sidebar">
							This is a read only copy of the old FEniCS QA forum. Please visit the <a href="https://www.allanswered.com/community/s/fenics-project/">new QA forum</a> to ask questions
						</div>
						
					</div>
					
					<div class="qa-main">
						<h1>
							<span class="entry-title">variation form dependent on non-analytical/complicated expression</span>
						</h1>
						<div class="qa-part-q-view">
							<div class="qa-q-view  hentry question" id="q12686">
								<form method="post" action="../../12686/variation-form-dependent-analytical-complicated-expression">
									<div class="qa-q-view-stats">
										<div class="qa-voting qa-voting-net" id="voting_12686">
											<div class="qa-vote-count qa-vote-count-net">
												<span class="qa-netvote-count">
													<span class="qa-netvote-count-data">0<span class="votes-up"><span class="value-title" title="0"></span></span><span class="votes-down"><span class="value-title" title="0"></span></span></span><span class="qa-netvote-count-pad"> votes</span>
												</span>
											</div>
											<div class="qa-vote-clear">
											</div>
										</div>
									</div>
									<input type="hidden" name="code" value="0-1516467834-a2b6ed19fab9a6f84c63a5cb086c65718dfbf5cb">
								</form>
								<div class="qa-q-view-main">
									<form method="post" action="../../12686/variation-form-dependent-analytical-complicated-expression">
										<div class="qa-q-view-content">
											<a name="12686"></a><div class="entry-content"><p>I am working on a nonlinear temperature field problem; some of the terms variational/weak form depend on the temperature. I plan on implementing solving the nonlinear problem "manually", using a simple iteration scheme: guess a temperature, solve, and update parameters, and solve again until I reach the converge criteria. My problem is transient so this scheme works nicely as you can use the previous temperature field as a good guess of the temperature field for the next time step.</p>

<p>I've seen examples on how to treat nonlinear terms but those cases have the simple expressions, like k = 1+u**2.  For my problem, I am relying on a python package that provides an equation of state which tells me what a certain property is given the temperature. The equation of state does not have some analytical or polynomial form and there's a lot going on in the background. How do I go about implementing this in FEniCS? Do I need to create an instance of Expression that has a method that determines the value of the parameter of interest given the temperature value of the node/vertex? </p>
</div>
										</div>
										<span class="qa-q-view-avatar-meta">
											<span class="qa-q-view-meta">
												<a href="../../12686/variation-form-dependent-analytical-complicated-expression" class="qa-q-view-what">asked</a>
												<span class="qa-q-view-when">
													<span class="qa-q-view-when-data"><span class="published"><span class="value-title" title="2017-03-13T02:45:20+0000"></span>Mar 13, 2017</span></span>
												</span>
												<span class="qa-q-view-who">
													<span class="qa-q-view-who-pad">by </span>
													<span class="qa-q-view-who-data"><span class="vcard author"><a href="../../user/dbfox" class="qa-user-link url nickname">dbfox</a></span></span>
													<span class="qa-q-view-who-title">FEniCS Novice</span>
													<span class="qa-q-view-who-points">
														<span class="qa-q-view-who-points-pad">(</span><span class="qa-q-view-who-points-data">240</span><span class="qa-q-view-who-points-pad"> points)</span>
													</span>
												</span>
											</span>
										</span>
										<div class="qa-q-view-buttons">
										</div>
										
										<div class="qa-q-view-c-list" style="display:none;" id="c12686_list">
										</div> <!-- END qa-c-list -->
										
										<input type="hidden" name="code" value="0-1516467834-445c85b01365ca8953abac17a375a62e359aa7d0">
										<input type="hidden" name="qa_click" value="">
									</form>
									<div class="qa-c-form">
									</div> <!-- END qa-c-form -->
									
								</div> <!-- END qa-q-view-main -->
								<div class="qa-q-view-clear">
								</div>
							</div> <!-- END qa-q-view -->
							
						</div>
						<div class="qa-part-a-list">
							<h2 id="a_list_title">1 Answer</h2>
							<div class="qa-a-list" id="a_list">
								
								<div class="qa-a-list-item  hentry answer answer-selected qa-a-list-item-selected" id="a12697">
									<form method="post" action="../../12686/variation-form-dependent-analytical-complicated-expression">
										<div class="qa-voting qa-voting-net" id="voting_12697">
											<div class="qa-vote-count qa-vote-count-net">
												<span class="qa-netvote-count">
													<span class="qa-netvote-count-data">0<span class="votes-up"><span class="value-title" title="0"></span></span><span class="votes-down"><span class="value-title" title="0"></span></span></span><span class="qa-netvote-count-pad"> votes</span>
												</span>
											</div>
											<div class="qa-vote-clear">
											</div>
										</div>
										<input type="hidden" name="code" value="0-1516467834-a2b6ed19fab9a6f84c63a5cb086c65718dfbf5cb">
									</form>
									<div class="qa-a-item-main">
										<form method="post" action="../../12686/variation-form-dependent-analytical-complicated-expression">
											<div class="qa-a-item-selected">
												<div class="qa-a-selection">
													<div class="qa-a-selected">&#160;</div>
													<div class="qa-a-selected-text">Best answer</div>
												</div>
												<div class="qa-a-item-content">
													<a name="12697"></a><div class="entry-content"><p>I'm pretty sure that is what you are looking for -&gt; building your own custom expressions. The following example is for a modified custom 3D expression used on the RHS as source in my weak form. You can use your own definitions like my <em>topo</em>-function for "a lot is going on in the background" within the dolfin expression.</p>

<pre><code>import numpy as np
import dolfin as df

def topo(x, y, h=250., xmin=-1e4):

    return h * np.sin((10.0 / xmin) * y) + 0.1 * x

class Custom_Expression(df.Expression):

    def __init__(self, J=1., a=6., origin=[1., 2., -5.], R=100.,
                        **fenics_kwargs):

    self.J = J
    self.a = a
    self.R = R
    self.O = origin

def eval(self, values, x):

    xx = (x[0] - self.O[0])
    yy = (x[1] - self.O[0])

    # you can use either dolfin math ...

    r = df.sqrt(xx**2 + yy**2)
    values[0] = (-(self.J * (x[1]/r))) * df.exp(-(r-self.R)**2 / self.a**2)
    values[1] = ((self.J * (x[0]/r))) * df.exp(-(r-self.R)**2 / self.a**2) 
    values[2] = 0.0

    # ... or something such as own defenitions or numpy math:

    values[0] = x[0]
    values[1] = x[1] * np.sin(x[0])
    values[2] = x[2] * topo(xx, yy)

def value_shape(self):  #  not necessarily needed, at least in Fenics 2016.2
    return (3,)
</code></pre>

<p>FEniCS needs some keyword argument such as the <em>element</em> type, so call your expression in every time step <em>t</em> in the weak form as in the following pseudo-code. The custom expression is evaulated on the fly in every time-step you call it with your updated input parameters.</p>

<pre><code>mesh = df.UnitCubeMesh(6, 6, 6)
FS = df.VectorFunctionSpace(mesh, 'CG', 1)
u = df.TrialFunction(FS)
v = df.TestFunction(FS)
J_t = 1.0
R_t = 234.5
C_E_t = Custom_Expression(J=J_t, R=R_t, element=FS.ufl_element())

lhs = df.inner(df.grad(u), df.grad(v))*dx
rhs = df.inner(C_E_t, v)*dx
# solve(lhs, rhs)
</code></pre>
</div>
												</div>
												<span class="qa-a-item-avatar-meta">
													<span class="qa-a-item-meta">
														<a href="../../12686/variation-form-dependent-analytical-complicated-expression?show=12697#a12697" class="qa-a-item-what">answered</a>
														<span class="qa-a-item-when">
															<span class="qa-a-item-when-data"><span class="published"><span class="value-title" title="2017-03-14T10:52:44+0000"></span>Mar 14, 2017</span></span>
														</span>
														<span class="qa-a-item-who">
															<span class="qa-a-item-who-pad">by </span>
															<span class="qa-a-item-who-data"><span class="vcard author"><a href="../../user/RR" class="qa-user-link url nickname">RR</a></span></span>
															<span class="qa-a-item-who-title">FEniCS User</span>
															<span class="qa-a-item-who-points">
																<span class="qa-a-item-who-points-pad">(</span><span class="qa-a-item-who-points-data">3,330</span><span class="qa-a-item-who-points-pad"> points)</span>
															</span>
														</span>
														<br>
														<span class="qa-a-item-what">selected</span>
														<span class="qa-a-item-when">
															<span class="qa-a-item-when-data"><span class="updated"><span class="value-title" title="2017-05-02T18:57:37+0000"></span>May 2, 2017</span></span>
														</span>
														<span class="qa-a-item-who">
															<span class="qa-a-item-who-pad">by </span><span class="qa-a-item-who-data"><a href="../../user/dbfox" class="qa-user-link url nickname">dbfox</a></span>
														</span>
													</span>
												</span>
											</div>
											<div class="qa-a-item-buttons">
												</div>
											
											<div class="qa-a-item-c-list" style="display:none;" id="c12697_list">
											</div> <!-- END qa-c-list -->
											
											<input type="hidden" name="code" value="0-1516467834-3a018d8a23dd48b39640e49c563c42256f416240">
											<input type="hidden" name="qa_click" value="">
										</form>
										<div class="qa-c-form">
										</div> <!-- END qa-c-form -->
										
									</div> <!-- END qa-a-item-main -->
									<div class="qa-a-item-clear">
									</div>
								</div> <!-- END qa-a-list-item -->
								
							</div> <!-- END qa-a-list -->
							
						</div>
					</div> <!-- END qa-main -->
					
				</div> <!-- END main-wrapper -->
			</div> <!-- END main-shadow -->
		</div> <!-- END body-wrapper -->
		<!-- END footer-bottom-group -->
		
		<div style="position:absolute; left:-9999px; top:-9999px;">
			<span id="qa-waiting-template" class="qa-waiting">...</span>
		</div>
	
	

</body><!-- Powered by Question2Answer - http://www.question2answer.org/ --></html>