<html><!-- Powered by Question2Answer - http://www.question2answer.org/ --><head>
		<meta http-equiv="content-type" content="text/html; charset=utf-8">
		<title>Constructing discrete gradient operator from a group finite element formulation? - FEniCS Q&amp;A</title>
		<meta name="description" content="Suppose we have the scalar advection equation with compressible velocity $\vec{v}$: $$ \frac{du}{ ... velocity will be changing in time in my problem.">
		<link rel="stylesheet" type="text/css" href="../../qa-theme/Snow/qa-styles.css">
		<link rel="canonical" href="http://fenicsproject.org/qa/13972/constructing-discrete-gradient-operator-element-formulation">
		<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
    tex2jax: {inlineMath: [["$","$"],["\\(","\\)"]]},
    TeX: { extensions: ["AMSmath.js","AMSsymbols.js"]}
  });
</script>
<script type="text/javascript" src="../../mathjax/MathJax.js"></script>
		<script src="../../jquery-1.7.2.min.js" type="text/javascript"></script>
		<script src="../../highlight.min.js"></script>
<script type="text/javascript">
$(function(){
	$('.wmd-input').keypress(function(){
		window.clearTimeout(hljs.Timeout);
		hljs.Timeout = window.setTimeout(function() {
			hljs.initHighlighting.called = false;
			hljs.initHighlighting();
		}, 500);
	});
	window.setTimeout(function() {
		hljs.initHighlighting.called = false;
		hljs.initHighlighting();
	}, 500);
});
</script>


	</head>
	<body class="qa-template-question qa-body-js-off">
		<div class="qa-body-wrapper">
			
			<div class="qa-header">
				<div class="qa-logo">
					<a href="../../" class="qa-logo-link" title="FEniCS Q&amp;A"><img src="../../qa-theme/fenics_qa.png" border="0" alt="FEniCS Q&amp;A"></a>
				</div>
				<div class="qa-header-clear">
				</div>
			</div> <!-- END qa-header -->
			
			<div class="qa-main-shadow">
				
				<div class="qa-main-wrapper">
					
					<div class="qa-sidepanel">
						<div class="qa-sidebar">
							This is a read only copy of the old FEniCS QA forum. Please visit the <a href="https://www.allanswered.com/community/s/fenics-project/">new QA forum</a> to ask questions
						</div>
						
					</div>
					
					<div class="qa-main">
						<h1>
							<span class="entry-title">Constructing discrete gradient operator from a group finite element formulation?</span>
						</h1>
						<div class="qa-part-q-view">
							<div class="qa-q-view  hentry question" id="q13972">
								<form method="post" action="../../13972/constructing-discrete-gradient-operator-element-formulation">
									<div class="qa-q-view-stats">
										<div class="qa-voting qa-voting-net" id="voting_13972">
											<div class="qa-vote-count qa-vote-count-net">
												<span class="qa-netvote-count">
													<span class="qa-netvote-count-data">0<span class="votes-up"><span class="value-title" title="0"></span></span><span class="votes-down"><span class="value-title" title="0"></span></span></span><span class="qa-netvote-count-pad"> votes</span>
												</span>
											</div>
											<div class="qa-vote-clear">
											</div>
										</div>
									</div>
									<input type="hidden" name="code" value="0-1516466501-af085c29c4e631b6079c9d46d3e3d4fdf9887c89">
								</form>
								<div class="qa-q-view-main">
									<form method="post" action="../../13972/constructing-discrete-gradient-operator-element-formulation">
										<div class="qa-q-view-content">
											<a name="13972"></a><div class="entry-content"><p>Suppose we have the scalar advection equation with compressible velocity $\vec{v}$:<br>
$$ \frac{du}{dt} + \nabla \cdot( \vec{v} u ) = 0 $$<br>
in some domain $\Omega$. </p>

<p>Using the group finite element formulation with $\phi$ representing the basis functions such that</p>

<p>$$ u = \sum_j u_j \phi_j $$</p>

<p>and<br>
$$ (\vec{v} u)_h = \sum_j u_j ( \vec{v}_j \cdot \nabla \phi_j ) $$</p>

<p>we can write the semi-discrete form of the advection equation as follows:</p>

<p>$$\sum_j \left( \int_{\Omega}  \phi_i \phi_j dx \right) \frac{du_j}{dt} = - \sum_j \vec{v}_j \cdot \left( \int_{\Omega}\phi_i \nabla \phi_j dx \right) u_j $$</p>

<p>My question is this: is there a way to construct the discrete gradient defined by<br>
$$ \vec{c}_{ij} = \left( \int_{\Omega}\phi_i \nabla \phi_j dx \right) $$</p>

<p>as a set of PETScMatrices (for each spatial variable) to be used for computing the discrete transport operator in the PDE above? This is to avoid reassembly of the gradient mainly since the velocity will be changing in time in my problem.</p>
</div>
										</div>
										<span class="qa-q-view-avatar-meta">
											<span class="qa-q-view-avatar">
												<a href="../../user/ndanes" class="qa-avatar-link"><img src="https://www.gravatar.com/avatar/66f7ce48d94188fa389bdc04521dce64?s=50" width="50" height="50" class="qa-avatar-image" alt=""></a>
											</span>
											<span class="qa-q-view-meta">
												<a href="../../13972/constructing-discrete-gradient-operator-element-formulation" class="qa-q-view-what">asked</a>
												<span class="qa-q-view-when">
													<span class="qa-q-view-when-data"><span class="published"><span class="value-title" title="2017-06-14T18:50:40+0000"></span>Jun 14, 2017</span></span>
												</span>
												<span class="qa-q-view-who">
													<span class="qa-q-view-who-pad">by </span>
													<span class="qa-q-view-who-data"><span class="vcard author"><a href="../../user/ndanes" class="qa-user-link url nickname">ndanes</a></span></span>
													<span class="qa-q-view-who-title">FEniCS Novice</span>
													<span class="qa-q-view-who-points">
														<span class="qa-q-view-who-points-pad">(</span><span class="qa-q-view-who-points-data">260</span><span class="qa-q-view-who-points-pad"> points)</span>
													</span>
												</span>
												<br>
												<span class="qa-q-view-what">edited</span>
												<span class="qa-q-view-when">
													<span class="qa-q-view-when-data"><span class="updated"><span class="value-title" title="2017-06-15T12:51:36+0000"></span>Jun 15, 2017</span></span>
												</span>
												<span class="qa-q-view-who">
													<span class="qa-q-view-who-pad">by </span><span class="qa-q-view-who-data"><a href="../../user/ndanes" class="qa-user-link url nickname">ndanes</a></span>
												</span>
											</span>
										</span>
										<div class="qa-q-view-buttons">
										</div>
										
										<div class="qa-q-view-c-list" id="c13972_list">
											<div class="qa-c-list-item  hentry comment" id="c13979">
												<div class="qa-c-item-content">
													<a name="13979"></a><div class="entry-content"><p>Hi, what is the function space for velocity $\vec{v}$ ?</p>
</div>
												</div>
												<div class="qa-c-item-footer">
													<span class="qa-c-item-avatar-meta">
														<span class="qa-c-item-avatar">
															<a href="../../user/MiroK" class="qa-avatar-link"><img src="https://www.gravatar.com/avatar/f566be3274ec73e3a6dda27bca11631c?s=20" width="20" height="20" class="qa-avatar-image" alt=""></a>
														</span>
														<span class="qa-c-item-meta">
															<a href="../../13972/constructing-discrete-gradient-operator-element-formulation?show=13979#c13979" class="qa-c-item-what">commented</a>
															<span class="qa-c-item-when">
																<span class="qa-c-item-when-data"><span class="published"><span class="value-title" title="2017-06-15T09:30:54+0000"></span>Jun 15, 2017</span></span>
															</span>
															<span class="qa-c-item-who">
																<span class="qa-c-item-who-pad">by </span>
																<span class="qa-c-item-who-data"><span class="vcard author"><a href="../../user/MiroK" class="qa-user-link url nickname">MiroK</a></span></span>
																<span class="qa-c-item-who-title">FEniCS Expert</span>
																<span class="qa-c-item-who-points">
																	<span class="qa-c-item-who-points-pad">(</span><span class="qa-c-item-who-points-data">80,920</span><span class="qa-c-item-who-points-pad"> points)</span>
																</span>
															</span>
														</span>
													</span>
													<div class="qa-c-item-buttons">
													</div>
												</div>
												<div class="qa-c-item-clear">
												</div>
											</div> <!-- END qa-c-item -->
											<div class="qa-c-list-item  hentry comment" id="c13982">
												<div class="qa-c-item-content">
													<a name="13982"></a><div class="entry-content"><p>$u$ lives in a CG1 space, while the velocity $\vec{v}$ can either live in CG1 or CG2 depending on the initial setup.</p>
</div>
												</div>
												<div class="qa-c-item-footer">
													<span class="qa-c-item-avatar-meta">
														<span class="qa-c-item-avatar">
															<a href="../../user/ndanes" class="qa-avatar-link"><img src="https://www.gravatar.com/avatar/66f7ce48d94188fa389bdc04521dce64?s=20" width="20" height="20" class="qa-avatar-image" alt=""></a>
														</span>
														<span class="qa-c-item-meta">
															<a href="../../13972/constructing-discrete-gradient-operator-element-formulation?show=13982#c13982" class="qa-c-item-what">commented</a>
															<span class="qa-c-item-when">
																<span class="qa-c-item-when-data"><span class="published"><span class="value-title" title="2017-06-15T12:49:03+0000"></span>Jun 15, 2017</span></span>
															</span>
															<span class="qa-c-item-who">
																<span class="qa-c-item-who-pad">by </span>
																<span class="qa-c-item-who-data"><span class="vcard author"><a href="../../user/ndanes" class="qa-user-link url nickname">ndanes</a></span></span>
																<span class="qa-c-item-who-title">FEniCS Novice</span>
																<span class="qa-c-item-who-points">
																	<span class="qa-c-item-who-points-pad">(</span><span class="qa-c-item-who-points-data">260</span><span class="qa-c-item-who-points-pad"> points)</span>
																</span>
															</span>
														</span>
													</span>
													<div class="qa-c-item-buttons">
													</div>
												</div>
												<div class="qa-c-item-clear">
												</div>
											</div> <!-- END qa-c-item -->
											<div class="qa-c-list-item  hentry comment" id="c13985">
												<div class="qa-c-item-content">
													<a name="13985"></a><div class="entry-content"><p>I've attempted to setup this operation as follows assuming $\vec{v}$ lives in a CG1 space.</p>

<p>For $\vec{c}_{ij}$ I've assembled each term separately, i.e.</p>

<p>$$ c^x_{ij} = \int_{\Omega} \phi \frac{\partial \phi}{\partial x} \; dx $$</p>

<p>$$ c^y_{ij} = \int_{\Omega} \phi \frac{\partial \phi}{\partial y} \; dx $$</p>

<p>the corresponding UFL code looks like:</p>

<pre><code>  Q = FunctionSpace(mesh, "CG",1)
  q = TrialFunction(Q)
  u = TestFunction(Q)
  gradX_form = q * Dx(u,0) * dx
  gradY_form = q * Dx(u,1) * dx
</code></pre>

<p>With this, we can write the dot product $ \vec{c}_{ij} \cdot \vec{v}_j$ as:<br>
$$  \vec{c}_{ij} \cdot \vec{v}_j = c^x_{ij} * v_{x,j} + c^y_{ij} * v_{y,j} $$<br>
which I currently have setup as a loop over the scipy.coo_matrix forms of $c^x$ and $c^y$ with the corresponding $j$ indices for $v$. </p>

<p>However, comparing this construction to the assembly of the advection operator (assuming uvel is in a CG1 vector function space) directly, i.e.</p>

<pre><code>adv =  -1.0 * div( uvel * u ) * q * dx
</code></pre>

<p>There is severe disagreement. It looks like the rows of the matrices assembled are not the same indexing as a CG1 function (both vector and scalar)? Is this true?</p>

<p>I should also comment that I have:</p>

<pre><code>parameters['reorder_dofs_serial'] = False 
</code></pre>

<p>EDIT: This solution works. I just had to remember that the entries of this formulation is different than the standard Galerkin approach. Things seem to be doing what I expect now...</p>
</div>
												</div>
												<div class="qa-c-item-footer">
													<span class="qa-c-item-avatar-meta">
														<span class="qa-c-item-avatar">
															<a href="../../user/ndanes" class="qa-avatar-link"><img src="https://www.gravatar.com/avatar/66f7ce48d94188fa389bdc04521dce64?s=20" width="20" height="20" class="qa-avatar-image" alt=""></a>
														</span>
														<span class="qa-c-item-meta">
															<a href="../../13972/constructing-discrete-gradient-operator-element-formulation?show=13985#c13985" class="qa-c-item-what">commented</a>
															<span class="qa-c-item-when">
																<span class="qa-c-item-when-data"><span class="published"><span class="value-title" title="2017-06-15T17:11:31+0000"></span>Jun 15, 2017</span></span>
															</span>
															<span class="qa-c-item-who">
																<span class="qa-c-item-who-pad">by </span>
																<span class="qa-c-item-who-data"><span class="vcard author"><a href="../../user/ndanes" class="qa-user-link url nickname">ndanes</a></span></span>
																<span class="qa-c-item-who-title">FEniCS Novice</span>
																<span class="qa-c-item-who-points">
																	<span class="qa-c-item-who-points-pad">(</span><span class="qa-c-item-who-points-data">260</span><span class="qa-c-item-who-points-pad"> points)</span>
																</span>
															</span>
															<br>
															<span class="qa-c-item-what">edited</span>
															<span class="qa-c-item-when">
																<span class="qa-c-item-when-data"><span class="updated"><span class="value-title" title="2017-06-15T20:16:17+0000"></span>Jun 15, 2017</span></span>
															</span>
															<span class="qa-c-item-who">
																<span class="qa-c-item-who-pad">by </span><span class="qa-c-item-who-data"><a href="../../user/ndanes" class="qa-user-link url nickname">ndanes</a></span>
															</span>
														</span>
													</span>
													<div class="qa-c-item-buttons">
													</div>
												</div>
												<div class="qa-c-item-clear">
												</div>
											</div> <!-- END qa-c-item -->
											<div class="qa-c-list-item  hentry comment" id="c14097">
												<div class="qa-c-item-content">
													<a name="14097"></a><div class="entry-content"><p>Method seems to be suffering from some consistency issues.</p>

<p>I've traced itback to assuming that:<br>
$$ c^x_{ij} = \int_{\Omega} \phi \frac{\partial \phi}{\partial x} \; dx $$</p>

<p>can be written in UFL as:</p>

<pre><code>gradX_form = q * Dx(u,0) * dx
</code></pre>

<p>Not really sure what to try next here...</p>
</div>
												</div>
												<div class="qa-c-item-footer">
													<span class="qa-c-item-avatar-meta">
														<span class="qa-c-item-avatar">
															<a href="../../user/ndanes" class="qa-avatar-link"><img src="https://www.gravatar.com/avatar/66f7ce48d94188fa389bdc04521dce64?s=20" width="20" height="20" class="qa-avatar-image" alt=""></a>
														</span>
														<span class="qa-c-item-meta">
															<a href="../../13972/constructing-discrete-gradient-operator-element-formulation?show=14097#c14097" class="qa-c-item-what">commented</a>
															<span class="qa-c-item-when">
																<span class="qa-c-item-when-data"><span class="published"><span class="value-title" title="2017-06-23T22:53:29+0000"></span>Jun 24, 2017</span></span>
															</span>
															<span class="qa-c-item-who">
																<span class="qa-c-item-who-pad">by </span>
																<span class="qa-c-item-who-data"><span class="vcard author"><a href="../../user/ndanes" class="qa-user-link url nickname">ndanes</a></span></span>
																<span class="qa-c-item-who-title">FEniCS Novice</span>
																<span class="qa-c-item-who-points">
																	<span class="qa-c-item-who-points-pad">(</span><span class="qa-c-item-who-points-data">260</span><span class="qa-c-item-who-points-pad"> points)</span>
																</span>
															</span>
														</span>
													</span>
													<div class="qa-c-item-buttons">
													</div>
												</div>
												<div class="qa-c-item-clear">
												</div>
											</div> <!-- END qa-c-item -->
										</div> <!-- END qa-c-list -->
										
										<input type="hidden" name="code" value="0-1516466501-b0c940d7c4fe6a4c0ce36903b2a3db28aba5a7ec">
										<input type="hidden" name="qa_click" value="">
									</form>
									<div class="qa-c-form">
									</div> <!-- END qa-c-form -->
									
								</div> <!-- END qa-q-view-main -->
								<div class="qa-q-view-clear">
								</div>
							</div> <!-- END qa-q-view -->
							
						</div>
						<div class="qa-part-a-list">
							<h2 id="a_list_title" style="display:none;"></h2>
							<div class="qa-a-list" id="a_list">
								
							</div> <!-- END qa-a-list -->
							
						</div>
					</div> <!-- END qa-main -->
					
				</div> <!-- END main-wrapper -->
			</div> <!-- END main-shadow -->
		</div> <!-- END body-wrapper -->
		<!-- END footer-bottom-group -->
		
		<div style="position:absolute; left:-9999px; top:-9999px;">
			<span id="qa-waiting-template" class="qa-waiting">...</span>
		</div>
	
	

</body><!-- Powered by Question2Answer - http://www.question2answer.org/ --></html>