<html><!-- Powered by Question2Answer - http://www.question2answer.org/ --><head>
		<meta http-equiv="content-type" content="text/html; charset=utf-8">
		<title>Gradient of a "CG" order one element. - FEniCS Q&amp;A</title>
		<meta name="description" content="Hi all, I am running an iterative scheme which includes the gradient of a function. Therefore, I ...  idea to get around this problem? Best, Sebastian">
		<link rel="stylesheet" type="text/css" href="../../qa-theme/Snow/qa-styles.css">
		<link rel="canonical" href="http://fenicsproject.org/qa/12634/gradient-of-a-cg-order-one-element">
		<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
    tex2jax: {inlineMath: [["$","$"],["\\(","\\)"]]},
    TeX: { extensions: ["AMSmath.js","AMSsymbols.js"]}
  });
</script>
<script type="text/javascript" src="../../mathjax/MathJax.js"></script>
		<script src="../../jquery-1.7.2.min.js" type="text/javascript"></script>
		<script src="../../highlight.min.js"></script>
<script type="text/javascript">
$(function(){
	$('.wmd-input').keypress(function(){
		window.clearTimeout(hljs.Timeout);
		hljs.Timeout = window.setTimeout(function() {
			hljs.initHighlighting.called = false;
			hljs.initHighlighting();
		}, 500);
	});
	window.setTimeout(function() {
		hljs.initHighlighting.called = false;
		hljs.initHighlighting();
	}, 500);
});
</script>


	</head>
	<body class="qa-template-question qa-body-js-off">
		<div class="qa-body-wrapper">
			
			<div class="qa-header">
				<div class="qa-logo">
					<a href="../" class="qa-logo-link" title="FEniCS Q&amp;A"><img src="../../qa-theme/fenics_qa.png" border="0" alt="FEniCS Q&amp;A"></a>
				</div>
				<div class="qa-header-clear">
				</div>
			</div> <!-- END qa-header -->
			
			<div class="qa-main-shadow">
				
				<div class="qa-main-wrapper">
					
					<div class="qa-sidepanel">
						<div class="qa-sidebar">
							This is a read only copy of the old FEniCS QA forum. Please visit the <a href="https://www.allanswered.com/community/s/fenics-project/">new QA forum</a> to ask questions
						</div>
						
					</div>
					
					<div class="qa-main">
						<h1>
							<span class="entry-title">Gradient of a "CG" order one element.</span>
						</h1>
						<div class="qa-part-q-view">
							<div class="qa-q-view qa-q-closed hentry question" id="q12634">
								<form method="post" action="../12634">
									<div class="qa-q-view-stats">
										<div class="qa-voting qa-voting-net" id="voting_12634">
											<div class="qa-vote-count qa-vote-count-net">
												<span class="qa-netvote-count">
													<span class="qa-netvote-count-data">+1<span class="votes-up"><span class="value-title" title="1"></span></span><span class="votes-down"><span class="value-title" title="0"></span></span></span><span class="qa-netvote-count-pad"> vote</span>
												</span>
											</div>
											<div class="qa-vote-clear">
											</div>
										</div>
									</div>
									<input type="hidden" name="code" value="0-1516478290-f334df62f93019e638aa86530f308be40114663c">
								</form>
								<div class="qa-q-view-main">
									<form method="post" action="../12634">
										<div class="qa-q-view-content">
											<a name="12634"></a><div class="entry-content"><p>Hi all,</p>

<p>I am running an iterative scheme which includes the gradient of a function. Therefore, I use the gradient operator in Fenics, but this not returning a Fenics function, which makes sense because the gradient will not always live in some finite element space. However, in the case of piece-wise linear continuous functions the derivative would be just piece-wise constant.<br>
I know that I can just use the projection into the "DG" 0 (originally DG1, that was a typo)  space which should give me the result and to some extend I can improve the speed of this operation a lot. Now to my question, is it possible to compute the derivative in this case without taking the workaround of projecting the gradient into the space of piece-wise constants? This is performance wise and in terms of memory usage quite inconvenient for me, since the scales of my problems will be quite big. Basically I have to solve a second huge linear system which gives me no new information, computing the gradient of something piece-wise linear is a lot easier problem than that. So far I am not really using this fact. Does anyone have any idea to get around this problem?</p>

<p>Best,<br>
Sebastian</p>
</div>
										</div>
										<div class="qa-q-view-closed">
											closed with the note:
											<span class="qa-q-view-closed-content">
												Question is answered
											</span>
										</div>
										<span class="qa-q-view-avatar-meta">
											<span class="qa-q-view-meta">
												<a href="../12634/gradient-of-a-cg-order-one-element" class="qa-q-view-what">asked</a>
												<span class="qa-q-view-when">
													<span class="qa-q-view-when-data"><span class="published"><span class="value-title" title="2017-03-07T16:27:37+0000"></span>Mar 7, 2017</span></span>
												</span>
												<span class="qa-q-view-who">
													<span class="qa-q-view-who-pad">by </span>
													<span class="qa-q-view-who-data"><span class="vcard author"><a href="../../user/Sebi9496" class="qa-user-link url nickname">Sebi9496</a></span></span>
													<span class="qa-q-view-who-title">FEniCS Novice</span>
													<span class="qa-q-view-who-points">
														<span class="qa-q-view-who-points-pad">(</span><span class="qa-q-view-who-points-data">290</span><span class="qa-q-view-who-points-pad"> points)</span>
													</span>
												</span>
												<br>
												<span class="qa-q-view-what">closed</span>
												<span class="qa-q-view-when">
													<span class="qa-q-view-when-data"><span class="updated"><span class="value-title" title="2017-03-09T11:19:00+0000"></span>Mar 9, 2017</span></span>
												</span>
												<span class="qa-q-view-who">
													<span class="qa-q-view-who-pad">by </span><span class="qa-q-view-who-data"><a href="../../user/Sebi9496" class="qa-user-link url nickname">Sebi9496</a></span>
												</span>
											</span>
										</span>
										<div class="qa-q-view-buttons">
										</div>
										
										<div class="qa-q-view-c-list" style="display:none;" id="c12634_list">
										</div> <!-- END qa-c-list -->
										
										<input type="hidden" name="code" value="0-1516478290-fd54a8d1cc0f7126e99a8740b77c7274c3b3562d">
										<input type="hidden" name="qa_click" value="">
									</form>
									<div class="qa-c-form">
									</div> <!-- END qa-c-form -->
									
								</div> <!-- END qa-q-view-main -->
								<div class="qa-q-view-clear">
								</div>
							</div> <!-- END qa-q-view -->
							
						</div>
						<div class="qa-part-a-list">
							<h2 id="a_list_title">2 Answers</h2>
							<div class="qa-a-list" id="a_list">
								
								<div class="qa-a-list-item  hentry answer" id="a12641">
									<form method="post" action="../12634">
										<div class="qa-voting qa-voting-net" id="voting_12641">
											<div class="qa-vote-count qa-vote-count-net">
												<span class="qa-netvote-count">
													<span class="qa-netvote-count-data">0<span class="votes-up"><span class="value-title" title="0"></span></span><span class="votes-down"><span class="value-title" title="0"></span></span></span><span class="qa-netvote-count-pad"> votes</span>
												</span>
											</div>
											<div class="qa-vote-clear">
											</div>
										</div>
										<input type="hidden" name="code" value="0-1516478290-f334df62f93019e638aa86530f308be40114663c">
									</form>
									<div class="qa-a-item-main">
										<form method="post" action="../12634">
											<div class="qa-a-selection">
											</div>
											<div class="qa-a-item-content">
												<a name="12641"></a><div class="entry-content"><p>I asked a similar question, some years ago</p>

<p><a rel="nofollow" href="https://fenicsproject.org/qa/1899/fast-projection-in-case-of-explicit-relations">https://fenicsproject.org/qa/1899/fast-projection-in-case-of-explicit-relations</a></p>
</div>
											</div>
											<span class="qa-a-item-avatar-meta">
												<span class="qa-a-item-avatar">
													<a href="../../user/KristianE" class="qa-avatar-link"><img src="https://www.gravatar.com/avatar/8e8c30d82e263e44bd8fe50055a60421?s=40" width="40" height="40" class="qa-avatar-image" alt=""></a>
												</span>
												<span class="qa-a-item-meta">
													<a href="../12634/gradient-of-a-cg-order-one-element?show=12641#a12641" class="qa-a-item-what">answered</a>
													<span class="qa-a-item-when">
														<span class="qa-a-item-when-data"><span class="published"><span class="value-title" title="2017-03-08T13:47:22+0000"></span>Mar 8, 2017</span></span>
													</span>
													<span class="qa-a-item-who">
														<span class="qa-a-item-who-pad">by </span>
														<span class="qa-a-item-who-data"><span class="vcard author"><a href="../../user/KristianE" class="qa-user-link url nickname">KristianE</a></span></span>
														<span class="qa-a-item-who-title">FEniCS Expert</span>
														<span class="qa-a-item-who-points">
															<span class="qa-a-item-who-points-pad">(</span><span class="qa-a-item-who-points-data">12,900</span><span class="qa-a-item-who-points-pad"> points)</span>
														</span>
													</span>
												</span>
											</span>
											<div class="qa-a-item-buttons">
												</div>
											
											<div class="qa-a-item-c-list" id="c12641_list">
												<div class="qa-c-list-item  hentry comment" id="c12643">
													<div class="qa-c-item-content">
														<a name="12643"></a><div class="entry-content"><p>Hm. I am familiar with this speed up option. However, it does not really solve the problem because I still have storage of the assembled matrices which produces a huge memory overhead. But I will read through it maybe I can get some additional improvement. Actually, I was hoping for something more elegant around this issue. </p>

<p>Edit:<br>
I actually tried the code and there is no attribute 'compress()' for matrices anymore, was it removed?</p>
</div>
													</div>
													<div class="qa-c-item-footer">
														<span class="qa-c-item-avatar-meta">
															<span class="qa-c-item-meta">
																<a href="../12634/gradient-of-a-cg-order-one-element?show=12643#c12643" class="qa-c-item-what">commented</a>
																<span class="qa-c-item-when">
																	<span class="qa-c-item-when-data"><span class="published"><span class="value-title" title="2017-03-08T16:04:05+0000"></span>Mar 8, 2017</span></span>
																</span>
																<span class="qa-c-item-who">
																	<span class="qa-c-item-who-pad">by </span>
																	<span class="qa-c-item-who-data"><span class="vcard author"><a href="../../user/Sebi9496" class="qa-user-link url nickname">Sebi9496</a></span></span>
																	<span class="qa-c-item-who-title">FEniCS Novice</span>
																	<span class="qa-c-item-who-points">
																		<span class="qa-c-item-who-points-pad">(</span><span class="qa-c-item-who-points-data">290</span><span class="qa-c-item-who-points-pad"> points)</span>
																	</span>
																</span>
																<br>
																<span class="qa-c-item-what">edited</span>
																<span class="qa-c-item-when">
																	<span class="qa-c-item-when-data"><span class="updated"><span class="value-title" title="2017-03-08T16:58:35+0000"></span>Mar 8, 2017</span></span>
																</span>
																<span class="qa-c-item-who">
																	<span class="qa-c-item-who-pad">by </span><span class="qa-c-item-who-data"><a href="../../user/Sebi9496" class="qa-user-link url nickname">Sebi9496</a></span>
																</span>
															</span>
														</span>
														<div class="qa-c-item-buttons">
														</div>
													</div>
													<div class="qa-c-item-clear">
													</div>
												</div> <!-- END qa-c-item -->
											</div> <!-- END qa-c-list -->
											
											<input type="hidden" name="code" value="0-1516478290-e30c37576d9d6f5cd1d4260b9f1d2c06377e2e3c">
											<input type="hidden" name="qa_click" value="">
										</form>
										<div class="qa-c-form">
										</div> <!-- END qa-c-form -->
										
									</div> <!-- END qa-a-item-main -->
									<div class="qa-a-item-clear">
									</div>
								</div> <!-- END qa-a-list-item -->
								
								<div class="qa-a-list-item  hentry answer" id="a12646">
									<form method="post" action="../12634">
										<div class="qa-voting qa-voting-net" id="voting_12646">
											<div class="qa-vote-count qa-vote-count-net">
												<span class="qa-netvote-count">
													<span class="qa-netvote-count-data">+4<span class="votes-up"><span class="value-title" title="4"></span></span><span class="votes-down"><span class="value-title" title="0"></span></span></span><span class="qa-netvote-count-pad"> votes</span>
												</span>
											</div>
											<div class="qa-vote-clear">
											</div>
										</div>
										<input type="hidden" name="code" value="0-1516478290-f334df62f93019e638aa86530f308be40114663c">
									</form>
									<div class="qa-a-item-main">
										<form method="post" action="../12634">
											<div class="qa-a-selection">
											</div>
											<div class="qa-a-item-content">
												<a name="12646"></a><div class="entry-content"><p>Hi, the following uses the fact that for DG0 space(a natural space for a derivative of CG1) the mass matrix is diagonal with the entries being volumes of the cells. Thus you can actually assemble the vector representing the gradient directly and then use it to define function.</p>

<pre><code>from dolfin import *
import numpy as np

mesh = UnitCubeMesh(20, 20, 20)
V = FunctionSpace(mesh, 'CG', 1)

f = Function(V)
f_vec = f.vector()
f_vec.set_local(np.random.rand(f_vec.local_size()))
f_vec.apply('insert')

Q = VectorFunctionSpace(mesh, 'DG', 0)
# Grad via projection
p, q = TrialFunction(Q), TestFunction(Q)
L = inner(grad(f), q)*dx
M = assemble(inner(p, q)*dx)
b = assemble(L)

grad_f0 = Function(Q)
x0 = grad_f0.vector()
solve(M, x0, b)

# Assemble the action of Minv onto the rhs - no mass matrix needed
MinvL = (1/CellVolume(mesh))*inner(grad(f), q)*dx
x = assemble(MinvL)

print (x - x0).norm('linf')

# You can define a function now
grad_f = Function(Q, x) 
</code></pre>

<p>Why do you want to represent the gradient in DG1? </p>
</div>
											</div>
											<span class="qa-a-item-avatar-meta">
												<span class="qa-a-item-avatar">
													<a href="../../user/MiroK" class="qa-avatar-link"><img src="https://www.gravatar.com/avatar/f566be3274ec73e3a6dda27bca11631c?s=40" width="40" height="40" class="qa-avatar-image" alt=""></a>
												</span>
												<span class="qa-a-item-meta">
													<a href="../12634/gradient-of-a-cg-order-one-element?show=12646#a12646" class="qa-a-item-what">answered</a>
													<span class="qa-a-item-when">
														<span class="qa-a-item-when-data"><span class="published"><span class="value-title" title="2017-03-08T17:15:51+0000"></span>Mar 8, 2017</span></span>
													</span>
													<span class="qa-a-item-who">
														<span class="qa-a-item-who-pad">by </span>
														<span class="qa-a-item-who-data"><span class="vcard author"><a href="../../user/MiroK" class="qa-user-link url nickname">MiroK</a></span></span>
														<span class="qa-a-item-who-title">FEniCS Expert</span>
														<span class="qa-a-item-who-points">
															<span class="qa-a-item-who-points-pad">(</span><span class="qa-a-item-who-points-data">80,920</span><span class="qa-a-item-who-points-pad"> points)</span>
														</span>
													</span>
												</span>
											</span>
											<div class="qa-a-item-buttons">
												</div>
											
											<div class="qa-a-item-c-list" id="c12646_list">
												<div class="qa-c-list-item  hentry comment" id="c12647">
													<div class="qa-c-item-content">
														<a name="12647"></a><div class="entry-content"><p>Oh sorry, this is a typo :/ Clearly I want to be in DG0. I will try this approach, thank you very much.</p>
</div>
													</div>
													<div class="qa-c-item-footer">
														<span class="qa-c-item-avatar-meta">
															<span class="qa-c-item-meta">
																<a href="../12634/gradient-of-a-cg-order-one-element?show=12647#c12647" class="qa-c-item-what">commented</a>
																<span class="qa-c-item-when">
																	<span class="qa-c-item-when-data"><span class="published"><span class="value-title" title="2017-03-08T17:29:11+0000"></span>Mar 8, 2017</span></span>
																</span>
																<span class="qa-c-item-who">
																	<span class="qa-c-item-who-pad">by </span>
																	<span class="qa-c-item-who-data"><span class="vcard author"><a href="../../user/Sebi9496" class="qa-user-link url nickname">Sebi9496</a></span></span>
																	<span class="qa-c-item-who-title">FEniCS Novice</span>
																	<span class="qa-c-item-who-points">
																		<span class="qa-c-item-who-points-pad">(</span><span class="qa-c-item-who-points-data">290</span><span class="qa-c-item-who-points-pad"> points)</span>
																	</span>
																</span>
															</span>
														</span>
														<div class="qa-c-item-buttons">
														</div>
													</div>
													<div class="qa-c-item-clear">
													</div>
												</div> <!-- END qa-c-item -->
												<div class="qa-c-list-item  hentry comment" id="c12648">
													<div class="qa-c-item-content">
														<a name="12648"></a><div class="entry-content"><p>Okay that is definitely what I was looking for, but I have another question related to this and I am not sure if it is worth opening a new topic.<br>
Will the gradient be exact with this method up to machine precision or is there some numerical round off? Additionally, is there a way to influence the assemble command in performance and accuracy wise?</p>
</div>
													</div>
													<div class="qa-c-item-footer">
														<span class="qa-c-item-avatar-meta">
															<span class="qa-c-item-meta">
																<a href="../12634/gradient-of-a-cg-order-one-element?show=12648#c12648" class="qa-c-item-what">commented</a>
																<span class="qa-c-item-when">
																	<span class="qa-c-item-when-data"><span class="published"><span class="value-title" title="2017-03-08T18:19:29+0000"></span>Mar 8, 2017</span></span>
																</span>
																<span class="qa-c-item-who">
																	<span class="qa-c-item-who-pad">by </span>
																	<span class="qa-c-item-who-data"><span class="vcard author"><a href="../../user/Sebi9496" class="qa-user-link url nickname">Sebi9496</a></span></span>
																	<span class="qa-c-item-who-title">FEniCS Novice</span>
																	<span class="qa-c-item-who-points">
																		<span class="qa-c-item-who-points-pad">(</span><span class="qa-c-item-who-points-data">290</span><span class="qa-c-item-who-points-pad"> points)</span>
																	</span>
																</span>
															</span>
														</span>
														<div class="qa-c-item-buttons">
														</div>
													</div>
													<div class="qa-c-item-clear">
													</div>
												</div> <!-- END qa-c-item -->
												<div class="qa-c-list-item  hentry comment" id="c12649">
													<div class="qa-c-item-content">
														<a name="12649"></a><div class="entry-content"><p>For precision consider the following</p>

<pre><code>from dolfin import *
import numpy as np

mesh = UnitCubeMesh(20, 20, 20)
V = FunctionSpace(mesh, 'CG', 1)

f = interpolate(Expression('2*x[0]+3*x[1]+x[2]', degree=1), V)

Q = VectorFunctionSpace(mesh, 'DG', 0)
q = TestFunction(Q)

MinvL = (1/CellVolume(mesh))*inner(grad(f), q)*dx
x = assemble(MinvL)
grad_f = Function(Q, x)

grad_f0 = interpolate(Constant((2, 3, 1)), Q)

print (grad_f.vector() - grad_f0.vector()).norm('linf')
</code></pre>
</div>
													</div>
													<div class="qa-c-item-footer">
														<span class="qa-c-item-avatar-meta">
															<span class="qa-c-item-avatar">
																<a href="../../user/MiroK" class="qa-avatar-link"><img src="https://www.gravatar.com/avatar/f566be3274ec73e3a6dda27bca11631c?s=20" width="20" height="20" class="qa-avatar-image" alt=""></a>
															</span>
															<span class="qa-c-item-meta">
																<a href="../12634/gradient-of-a-cg-order-one-element?show=12649#c12649" class="qa-c-item-what">commented</a>
																<span class="qa-c-item-when">
																	<span class="qa-c-item-when-data"><span class="published"><span class="value-title" title="2017-03-08T18:26:49+0000"></span>Mar 8, 2017</span></span>
																</span>
																<span class="qa-c-item-who">
																	<span class="qa-c-item-who-pad">by </span>
																	<span class="qa-c-item-who-data"><span class="vcard author"><a href="../../user/MiroK" class="qa-user-link url nickname">MiroK</a></span></span>
																	<span class="qa-c-item-who-title">FEniCS Expert</span>
																	<span class="qa-c-item-who-points">
																		<span class="qa-c-item-who-points-pad">(</span><span class="qa-c-item-who-points-data">80,920</span><span class="qa-c-item-who-points-pad"> points)</span>
																	</span>
																</span>
															</span>
														</span>
														<div class="qa-c-item-buttons">
														</div>
													</div>
													<div class="qa-c-item-clear">
													</div>
												</div> <!-- END qa-c-item -->
											</div> <!-- END qa-c-list -->
											
											<input type="hidden" name="code" value="0-1516478290-5653aacae27b8e545c3bb5759aa11b951fd131b8">
											<input type="hidden" name="qa_click" value="">
										</form>
										<div class="qa-c-form">
										</div> <!-- END qa-c-form -->
										
									</div> <!-- END qa-a-item-main -->
									<div class="qa-a-item-clear">
									</div>
								</div> <!-- END qa-a-list-item -->
								
							</div> <!-- END qa-a-list -->
							
						</div>
					</div> <!-- END qa-main -->
					
				</div> <!-- END main-wrapper -->
			</div> <!-- END main-shadow -->
		</div> <!-- END body-wrapper -->
		<!-- END footer-bottom-group -->
		
		<div style="position:absolute; left:-9999px; top:-9999px;">
			<span id="qa-waiting-template" class="qa-waiting">...</span>
		</div>
	
	

</body><!-- Powered by Question2Answer - http://www.question2answer.org/ --></html>