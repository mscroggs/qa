<html><!-- Powered by Question2Answer - http://www.question2answer.org/ --><head>
		<meta http-equiv="content-type" content="text/html; charset=utf-8">
		<title>Probing a function at a point when running in parallel - FEniCS Q&amp;A</title>
		<meta name="description" content="I understand that the mesh is split up when running in the code parallel. Is there any way to determine  ... . Is there an easy way to deal with this?">
		<link rel="stylesheet" type="text/css" href="../../qa-theme/Snow/qa-styles.css">
		<link rel="canonical" href="http://fenicsproject.org/qa/4451/probing-a-function-at-a-point-when-running-in-parallel">
		<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
    tex2jax: {inlineMath: [["$","$"],["\\(","\\)"]]},
    TeX: { extensions: ["AMSmath.js","AMSsymbols.js"]}
  });
</script>
<script type="text/javascript" src="../../mathjax/MathJax.js"></script>
		<script src="../../jquery-1.7.2.min.js" type="text/javascript"></script>
		<script src="../../highlight.min.js"></script>
<script type="text/javascript">
$(function(){
	$('.wmd-input').keypress(function(){
		window.clearTimeout(hljs.Timeout);
		hljs.Timeout = window.setTimeout(function() {
			hljs.initHighlighting.called = false;
			hljs.initHighlighting();
		}, 500);
	});
	window.setTimeout(function() {
		hljs.initHighlighting.called = false;
		hljs.initHighlighting();
	}, 500);
});
</script>


	</head>
	<body class="qa-template-question qa-body-js-off">
		<div class="qa-body-wrapper">
			
			<div class="qa-header">
				<div class="qa-logo">
					<a href="../../" class="qa-logo-link" title="FEniCS Q&amp;A"><img src="../../qa-theme/fenics_qa.png" border="0" alt="FEniCS Q&amp;A"></a>
				</div>
				<div class="qa-header-clear">
				</div>
			</div> <!-- END qa-header -->
			
			<div class="qa-main-shadow">
				
				<div class="qa-main-wrapper">
					
					<div class="qa-sidepanel">
						<div class="qa-sidebar">
							This is a read only copy of the old FEniCS QA forum. Please visit the <a href="https://www.allanswered.com/community/s/fenics-project/">new QA forum</a> to ask questions
						</div>
						
					</div>
					
					<div class="qa-main">
						<h1>
							<span class="entry-title">Probing a function at a point when running in parallel</span>
						</h1>
						<div class="qa-part-q-view">
							<div class="qa-q-view  hentry question" id="q4451">
								<form method="post" action="../../4451/probing-a-function-at-a-point-when-running-in-parallel">
									<div class="qa-q-view-stats">
										<div class="qa-voting qa-voting-net" id="voting_4451">
											<div class="qa-vote-count qa-vote-count-net">
												<span class="qa-netvote-count">
													<span class="qa-netvote-count-data">+3<span class="votes-up"><span class="value-title" title="3"></span></span><span class="votes-down"><span class="value-title" title="0"></span></span></span><span class="qa-netvote-count-pad"> votes</span>
												</span>
											</div>
											<div class="qa-vote-clear">
											</div>
										</div>
									</div>
									<input type="hidden" name="code" value="0-1516468013-473d0cbe57418a45837c6401c986b1205943af39">
								</form>
								<div class="qa-q-view-main">
									<form method="post" action="../../4451/probing-a-function-at-a-point-when-running-in-parallel">
										<div class="qa-q-view-content">
											<a name="4451"></a><div class="entry-content"><p>I understand that the mesh is split up when running in the code parallel. Is there any way to determine whether a particular point resides in which of the split mesh domain belonging to different process?</p>

<p>For example, I have a function v and if I probe v at point (0,0), v(0,0) works fine if I run on a single processor.</p>

<p>However, if I run the code in parallel, I run into error because the point (0,0) only belongs to a mesh domain associated with a particular process.</p>

<p>Is there an easy way to deal with this?</p>
</div>
										</div>
										<span class="qa-q-view-avatar-meta">
											<span class="qa-q-view-meta">
												<a href="../../4451/probing-a-function-at-a-point-when-running-in-parallel" class="qa-q-view-what">asked</a>
												<span class="qa-q-view-when">
													<span class="qa-q-view-when-data"><span class="published"><span class="value-title" title="2014-08-18T19:44:11+0000"></span>Aug 18, 2014</span></span>
												</span>
												<span class="qa-q-view-who">
													<span class="qa-q-view-who-pad">by </span>
													<span class="qa-q-view-who-data"><span class="vcard author"><a href="../../user/lee" class="qa-user-link url nickname">lee</a></span></span>
													<span class="qa-q-view-who-title">FEniCS User</span>
													<span class="qa-q-view-who-points">
														<span class="qa-q-view-who-points-pad">(</span><span class="qa-q-view-who-points-data">1,170</span><span class="qa-q-view-who-points-pad"> points)</span>
													</span>
												</span>
											</span>
										</span>
										<div class="qa-q-view-buttons">
										</div>
										
										<div class="qa-q-view-c-list" style="display:none;" id="c4451_list">
										</div> <!-- END qa-c-list -->
										
										<input type="hidden" name="code" value="0-1516468013-27328ceefd8054d81babd347f5f5702b3fef02ac">
										<input type="hidden" name="qa_click" value="">
									</form>
									<div class="qa-c-form">
									</div> <!-- END qa-c-form -->
									
								</div> <!-- END qa-q-view-main -->
								<div class="qa-q-view-clear">
								</div>
							</div> <!-- END qa-q-view -->
							
						</div>
						<div class="qa-part-a-list">
							<h2 id="a_list_title">2 Answers</h2>
							<div class="qa-a-list" id="a_list">
								
								<div class="qa-a-list-item  hentry answer" id="a4452">
									<form method="post" action="../../4451/probing-a-function-at-a-point-when-running-in-parallel">
										<div class="qa-voting qa-voting-net" id="voting_4452">
											<div class="qa-vote-count qa-vote-count-net">
												<span class="qa-netvote-count">
													<span class="qa-netvote-count-data">+1<span class="votes-up"><span class="value-title" title="1"></span></span><span class="votes-down"><span class="value-title" title="0"></span></span></span><span class="qa-netvote-count-pad"> vote</span>
												</span>
											</div>
											<div class="qa-vote-clear">
											</div>
										</div>
										<input type="hidden" name="code" value="0-1516468013-473d0cbe57418a45837c6401c986b1205943af39">
									</form>
									<div class="qa-a-item-main">
										<form method="post" action="../../4451/probing-a-function-at-a-point-when-running-in-parallel">
											<div class="qa-a-selection">
											</div>
											<div class="qa-a-item-content">
												<a name="4452"></a><div class="entry-content"><p>The trick is to only call evaluate on the process which actually contains the point and then distribute the evaluated value to all other processes (in case that you need the information on all other processes as well). Here's a little example:</p>

<pre><code>from dolfin import *
from numpy import infty

mesh = UnitIntervalMesh(100)
V = FunctionSpace(mesh, 'CG', 1)
f = interpolate(Expression("x[0]"), V)

val = -infty
point = Point(0.2)
if mesh.bounding_box_tree().compute_first_entity_collision(point) &lt; mesh.num_cells():
    val = f(point)

val = MPI.max(mpi_comm_world(), val)

print(val)
</code></pre>

<p>Note, that this code implies that if the point is located outside the full mesh this will always just return -infty and not yield an error, so take care.</p>
</div>
											</div>
											<span class="qa-a-item-avatar-meta">
												<span class="qa-a-item-meta">
													<a href="../../4451/probing-a-function-at-a-point-when-running-in-parallel?show=4452#a4452" class="qa-a-item-what">answered</a>
													<span class="qa-a-item-when">
														<span class="qa-a-item-when-data"><span class="published"><span class="value-title" title="2014-08-18T20:10:55+0000"></span>Aug 18, 2014</span></span>
													</span>
													<span class="qa-a-item-who">
														<span class="qa-a-item-who-pad">by </span>
														<span class="qa-a-item-who-data"><span class="vcard author"><a href="../../user/cevito" class="qa-user-link url nickname">cevito</a></span></span>
														<span class="qa-a-item-who-title">FEniCS User</span>
														<span class="qa-a-item-who-points">
															<span class="qa-a-item-who-points-pad">(</span><span class="qa-a-item-who-points-data">5,550</span><span class="qa-a-item-who-points-pad"> points)</span>
														</span>
													</span>
													<br>
													<span class="qa-a-item-what">edited</span>
													<span class="qa-a-item-when">
														<span class="qa-a-item-when-data"><span class="updated"><span class="value-title" title="2014-08-18T20:44:07+0000"></span>Aug 18, 2014</span></span>
													</span>
													<span class="qa-a-item-who">
														<span class="qa-a-item-who-pad">by </span><span class="qa-a-item-who-data"><a href="../../user/cevito" class="qa-user-link url nickname">cevito</a></span>
													</span>
												</span>
											</span>
											<div class="qa-a-item-buttons">
												</div>
											
											<div class="qa-a-item-c-list" id="c4452_list">
												<div class="qa-c-list-item  hentry comment" id="c4454">
													<div class="qa-c-item-content">
														<a name="4454"></a><div class="entry-content"><p>Careful also with the MPI.sum. The point could live on more than one CPU... </p>
</div>
													</div>
													<div class="qa-c-item-footer">
														<span class="qa-c-item-avatar-meta">
															<span class="qa-c-item-avatar">
																<a href="../../user/mikael-mortensen" class="qa-avatar-link"><img src="https://www.gravatar.com/avatar/d5614112a2818f1800a461e49ac229df?s=20" width="20" height="20" class="qa-avatar-image" alt=""></a>
															</span>
															<span class="qa-c-item-meta">
																<a href="../../4451/probing-a-function-at-a-point-when-running-in-parallel?show=4454#c4454" class="qa-c-item-what">commented</a>
																<span class="qa-c-item-when">
																	<span class="qa-c-item-when-data"><span class="published"><span class="value-title" title="2014-08-18T20:26:45+0000"></span>Aug 18, 2014</span></span>
																</span>
																<span class="qa-c-item-who">
																	<span class="qa-c-item-who-pad">by </span>
																	<span class="qa-c-item-who-data"><span class="vcard author"><a href="../../user/mikael-mortensen" class="qa-user-link url nickname">mikael-mortensen</a></span></span>
																	<span class="qa-c-item-who-title">FEniCS Expert</span>
																	<span class="qa-c-item-who-points">
																		<span class="qa-c-item-who-points-pad">(</span><span class="qa-c-item-who-points-data">29,340</span><span class="qa-c-item-who-points-pad"> points)</span>
																	</span>
																</span>
															</span>
														</span>
														<div class="qa-c-item-buttons">
														</div>
													</div>
													<div class="qa-c-item-clear">
													</div>
												</div> <!-- END qa-c-item -->
												<div class="qa-c-list-item  hentry comment" id="c4457">
													<div class="qa-c-item-content">
														<a name="4457"></a><div class="entry-content"><p>Thx, changed it.</p>
</div>
													</div>
													<div class="qa-c-item-footer">
														<span class="qa-c-item-avatar-meta">
															<span class="qa-c-item-meta">
																<a href="../../4451/probing-a-function-at-a-point-when-running-in-parallel?show=4457#c4457" class="qa-c-item-what">commented</a>
																<span class="qa-c-item-when">
																	<span class="qa-c-item-when-data"><span class="published"><span class="value-title" title="2014-08-18T20:42:51+0000"></span>Aug 18, 2014</span></span>
																</span>
																<span class="qa-c-item-who">
																	<span class="qa-c-item-who-pad">by </span>
																	<span class="qa-c-item-who-data"><span class="vcard author"><a href="../../user/cevito" class="qa-user-link url nickname">cevito</a></span></span>
																	<span class="qa-c-item-who-title">FEniCS User</span>
																	<span class="qa-c-item-who-points">
																		<span class="qa-c-item-who-points-pad">(</span><span class="qa-c-item-who-points-data">5,550</span><span class="qa-c-item-who-points-pad"> points)</span>
																	</span>
																</span>
															</span>
														</span>
														<div class="qa-c-item-buttons">
														</div>
													</div>
													<div class="qa-c-item-clear">
													</div>
												</div> <!-- END qa-c-item -->
											</div> <!-- END qa-c-list -->
											
											<input type="hidden" name="code" value="0-1516468013-675cf283c43c435d61b21269398713e0147b7199">
											<input type="hidden" name="qa_click" value="">
										</form>
										<div class="qa-c-form">
										</div> <!-- END qa-c-form -->
										
									</div> <!-- END qa-a-item-main -->
									<div class="qa-a-item-clear">
									</div>
								</div> <!-- END qa-a-list-item -->
								
								<div class="qa-a-list-item  hentry answer" id="a4453">
									<form method="post" action="../../4451/probing-a-function-at-a-point-when-running-in-parallel">
										<div class="qa-voting qa-voting-net" id="voting_4453">
											<div class="qa-vote-count qa-vote-count-net">
												<span class="qa-netvote-count">
													<span class="qa-netvote-count-data">+2<span class="votes-up"><span class="value-title" title="2"></span></span><span class="votes-down"><span class="value-title" title="0"></span></span></span><span class="qa-netvote-count-pad"> votes</span>
												</span>
											</div>
											<div class="qa-vote-clear">
											</div>
										</div>
										<input type="hidden" name="code" value="0-1516468013-473d0cbe57418a45837c6401c986b1205943af39">
									</form>
									<div class="qa-a-item-main">
										<form method="post" action="../../4451/probing-a-function-at-a-point-when-running-in-parallel">
											<div class="qa-a-selection">
											</div>
											<div class="qa-a-item-content">
												<a name="4453"></a><div class="entry-content"><p>Hi</p>

<p>This could be solved using some try-catch+MPI communication. Otherwise the <a rel="nofollow" href="https://github.com/mikaem/fenicstools/wiki/Multiple-Probes">fenicstools</a> package has a nice solution for this. Examples of both below</p>

<pre><code>from dolfin import *
from numpy import array

mesh = UnitSquareMesh(4, 4)
V = FunctionSpace(mesh, "CG", 1)
u = interpolate(Expression("x[0]"), V)
x = array([0.25, 0.75])

# Simple example, works only for scalar space
try:
    uu = u(x)
except:
    uu = -1e16
    print "Not found on proc ", MPI.rank(mpi_comm_world()) 

ux = MPI.max(mpi_comm_world(), uu)
print "Proc ", MPI.rank(mpi_comm_world()), " ux = ", ux

from fenicstools import Probes
p = Probes(x, V)  # This works for any mixed space
# Probe once
p(u)
# Probe once again (here same result)
p(u)
# Print results of first probings on rank 0
pa = p.array()
if MPI.rank(mpi_comm_world()) == 0:
    print "Probe = ", pa[0]
</code></pre>
</div>
											</div>
											<span class="qa-a-item-avatar-meta">
												<span class="qa-a-item-avatar">
													<a href="../../user/mikael-mortensen" class="qa-avatar-link"><img src="https://www.gravatar.com/avatar/d5614112a2818f1800a461e49ac229df?s=40" width="40" height="40" class="qa-avatar-image" alt=""></a>
												</span>
												<span class="qa-a-item-meta">
													<a href="../../4451/probing-a-function-at-a-point-when-running-in-parallel?show=4453#a4453" class="qa-a-item-what">answered</a>
													<span class="qa-a-item-when">
														<span class="qa-a-item-when-data"><span class="published"><span class="value-title" title="2014-08-18T20:25:54+0000"></span>Aug 18, 2014</span></span>
													</span>
													<span class="qa-a-item-who">
														<span class="qa-a-item-who-pad">by </span>
														<span class="qa-a-item-who-data"><span class="vcard author"><a href="../../user/mikael-mortensen" class="qa-user-link url nickname">mikael-mortensen</a></span></span>
														<span class="qa-a-item-who-title">FEniCS Expert</span>
														<span class="qa-a-item-who-points">
															<span class="qa-a-item-who-points-pad">(</span><span class="qa-a-item-who-points-data">29,340</span><span class="qa-a-item-who-points-pad"> points)</span>
														</span>
													</span>
												</span>
											</span>
											<div class="qa-a-item-buttons">
												</div>
											
											<div class="qa-a-item-c-list" id="c4453_list">
												<div class="qa-c-list-item  hentry comment" id="c4462">
													<div class="qa-c-item-content">
														<a name="4462"></a><div class="entry-content"><p>Thanks a lot! </p>
</div>
													</div>
													<div class="qa-c-item-footer">
														<span class="qa-c-item-avatar-meta">
															<span class="qa-c-item-meta">
																<a href="../../4451/probing-a-function-at-a-point-when-running-in-parallel?show=4462#c4462" class="qa-c-item-what">commented</a>
																<span class="qa-c-item-when">
																	<span class="qa-c-item-when-data"><span class="published"><span class="value-title" title="2014-08-18T21:19:21+0000"></span>Aug 18, 2014</span></span>
																</span>
																<span class="qa-c-item-who">
																	<span class="qa-c-item-who-pad">by </span>
																	<span class="qa-c-item-who-data"><span class="vcard author"><a href="../../user/lee" class="qa-user-link url nickname">lee</a></span></span>
																	<span class="qa-c-item-who-title">FEniCS User</span>
																	<span class="qa-c-item-who-points">
																		<span class="qa-c-item-who-points-pad">(</span><span class="qa-c-item-who-points-data">1,170</span><span class="qa-c-item-who-points-pad"> points)</span>
																	</span>
																</span>
															</span>
														</span>
														<div class="qa-c-item-buttons">
														</div>
													</div>
													<div class="qa-c-item-clear">
													</div>
												</div> <!-- END qa-c-item -->
												<div class="qa-c-list-item  hentry comment" id="c6176">
													<div class="qa-c-item-content">
														<a name="6176"></a><div class="entry-content"><p>For me, using the Probes class in a serial job takes about twice as long as doing a simple loop in python (dof=17k).</p>
</div>
													</div>
													<div class="qa-c-item-footer">
														<span class="qa-c-item-avatar-meta">
															<span class="qa-c-item-meta">
																<a href="../../4451/probing-a-function-at-a-point-when-running-in-parallel?show=6176#c6176" class="qa-c-item-what">commented</a>
																<span class="qa-c-item-when">
																	<span class="qa-c-item-when-data"><span class="published"><span class="value-title" title="2014-12-09T16:52:34+0000"></span>Dec 9, 2014</span></span>
																</span>
																<span class="qa-c-item-who">
																	<span class="qa-c-item-who-pad">by </span>
																	<span class="qa-c-item-who-data"><span class="vcard author"><a href="../../user/thisch" class="qa-user-link url nickname">thisch</a></span></span>
																	<span class="qa-c-item-who-title">FEniCS Novice</span>
																	<span class="qa-c-item-who-points">
																		<span class="qa-c-item-who-points-pad">(</span><span class="qa-c-item-who-points-data">580</span><span class="qa-c-item-who-points-pad"> points)</span>
																	</span>
																</span>
															</span>
														</span>
														<div class="qa-c-item-buttons">
														</div>
													</div>
													<div class="qa-c-item-clear">
													</div>
												</div> <!-- END qa-c-item -->
											</div> <!-- END qa-c-list -->
											
											<input type="hidden" name="code" value="0-1516468013-85409a253616f28e48ecd5cbd55cedcc839a47fe">
											<input type="hidden" name="qa_click" value="">
										</form>
										<div class="qa-c-form">
										</div> <!-- END qa-c-form -->
										
									</div> <!-- END qa-a-item-main -->
									<div class="qa-a-item-clear">
									</div>
								</div> <!-- END qa-a-list-item -->
								
							</div> <!-- END qa-a-list -->
							
						</div>
					</div> <!-- END qa-main -->
					
				</div> <!-- END main-wrapper -->
			</div> <!-- END main-shadow -->
		</div> <!-- END body-wrapper -->
		<!-- END footer-bottom-group -->
		
		<div style="position:absolute; left:-9999px; top:-9999px;">
			<span id="qa-waiting-template" class="qa-waiting">...</span>
		</div>
	
	

</body><!-- Powered by Question2Answer - http://www.question2answer.org/ --></html>