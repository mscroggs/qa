<html><!-- Powered by Question2Answer - http://www.question2answer.org/ --><head>
		<meta http-equiv="content-type" content="text/html; charset=utf-8">
		<title>Solving for scalar function from its gradient - FEniCS Q&amp;A</title>
		<meta name="description" content="I would like to know how to quickly find a scalar function $a$ given the values of $\partial a ... Are there any functions in fenics that can do this?">
		<link rel="stylesheet" type="text/css" href="../../qa-theme/Snow/qa-styles.css">
		<link rel="canonical" href="http://fenicsproject.org/qa/14104/solving-for-scalar-function-from-its-gradient">
		<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
    tex2jax: {inlineMath: [["$","$"],["\\(","\\)"]]},
    TeX: { extensions: ["AMSmath.js","AMSsymbols.js"]}
  });
</script>
<script type="text/javascript" src="../../mathjax/MathJax.js"></script>
		<script src="../../jquery-1.7.2.min.js" type="text/javascript"></script>
		<script src="../../highlight.min.js"></script>
<script type="text/javascript">
$(function(){
	$('.wmd-input').keypress(function(){
		window.clearTimeout(hljs.Timeout);
		hljs.Timeout = window.setTimeout(function() {
			hljs.initHighlighting.called = false;
			hljs.initHighlighting();
		}, 500);
	});
	window.setTimeout(function() {
		hljs.initHighlighting.called = false;
		hljs.initHighlighting();
	}, 500);
});
</script>


	</head>
	<body class="qa-template-question qa-body-js-off">
		<div class="qa-body-wrapper">
			
			<div class="qa-header">
				<div class="qa-logo">
					<a href="../../" class="qa-logo-link" title="FEniCS Q&amp;A"><img src="../../qa-theme/fenics_qa.png" border="0" alt="FEniCS Q&amp;A"></a>
				</div>
				<div class="qa-header-clear">
				</div>
			</div> <!-- END qa-header -->
			
			<div class="qa-main-shadow">
				
				<div class="qa-main-wrapper">
					
					<div class="qa-sidepanel">
						<div class="qa-sidebar">
							This is a read only copy of the old FEniCS QA forum. Please visit the <a href="https://www.allanswered.com/community/s/fenics-project/">new QA forum</a> to ask questions
						</div>
						
					</div>
					
					<div class="qa-main">
						<h1>
							<span class="entry-title">Solving for scalar function from its gradient</span>
						</h1>
						<div class="qa-part-q-view">
							<div class="qa-q-view  hentry question" id="q14104">
								<form method="post" action="../../14104/solving-for-scalar-function-from-its-gradient">
									<div class="qa-q-view-stats">
										<div class="qa-voting qa-voting-net" id="voting_14104">
											<div class="qa-vote-count qa-vote-count-net">
												<span class="qa-netvote-count">
													<span class="qa-netvote-count-data">0<span class="votes-up"><span class="value-title" title="0"></span></span><span class="votes-down"><span class="value-title" title="0"></span></span></span><span class="qa-netvote-count-pad"> votes</span>
												</span>
											</div>
											<div class="qa-vote-clear">
											</div>
										</div>
									</div>
									<input type="hidden" name="code" value="0-1516466506-3087bee65313bc1761f312a9aa5255faab0a8a21">
								</form>
								<div class="qa-q-view-main">
									<form method="post" action="../../14104/solving-for-scalar-function-from-its-gradient">
										<div class="qa-q-view-content">
											<a name="14104"></a><div class="entry-content"><p>I would like to know how to quickly find a scalar function $a$ given the values of $\partial a / \partial x$ and $\partial a / \partial y$, with the scalar function having a known value at a point. </p>

<p>Two solutions I'm working on are the following:<br>
Solving an inverse problem using derivative() within fenics or using dolfin-adjoint<br>
If I want just one $a$ value at a point I could integrate from the known point to the required point on a straight line</p>

<p>Has anyone needed to do this calculation before? Are there any functions in fenics that can do this?</p>
</div>
										</div>
										<span class="qa-q-view-avatar-meta">
											<span class="qa-q-view-meta">
												<a href="../../14104/solving-for-scalar-function-from-its-gradient" class="qa-q-view-what">asked</a>
												<span class="qa-q-view-when">
													<span class="qa-q-view-when-data"><span class="published"><span class="value-title" title="2017-06-25T14:50:31+0000"></span>Jun 25, 2017</span></span>
												</span>
												<span class="qa-q-view-who">
													<span class="qa-q-view-who-pad">by </span>
													<span class="qa-q-view-who-data"><span class="vcard author"><a href="../../user/alexmm" class="qa-user-link url nickname">alexmm</a></span></span>
													<span class="qa-q-view-who-title">FEniCS User</span>
													<span class="qa-q-view-who-points">
														<span class="qa-q-view-who-points-pad">(</span><span class="qa-q-view-who-points-data">4,240</span><span class="qa-q-view-who-points-pad"> points)</span>
													</span>
												</span>
												<br>
												<span class="qa-q-view-what">edited</span>
												<span class="qa-q-view-when">
													<span class="qa-q-view-when-data"><span class="updated"><span class="value-title" title="2017-06-25T14:59:21+0000"></span>Jun 25, 2017</span></span>
												</span>
												<span class="qa-q-view-who">
													<span class="qa-q-view-who-pad">by </span><span class="qa-q-view-who-data"><a href="../../user/alexmm" class="qa-user-link url nickname">alexmm</a></span>
												</span>
											</span>
										</span>
										<div class="qa-q-view-buttons">
										</div>
										
										<div class="qa-q-view-c-list" style="display:none;" id="c14104_list">
										</div> <!-- END qa-c-list -->
										
										<input type="hidden" name="code" value="0-1516466506-a9d5e04feb55b2b4dc8a856d7f65c305275e1b8b">
										<input type="hidden" name="qa_click" value="">
									</form>
									<div class="qa-c-form">
									</div> <!-- END qa-c-form -->
									
								</div> <!-- END qa-q-view-main -->
								<div class="qa-q-view-clear">
								</div>
							</div> <!-- END qa-q-view -->
							
						</div>
						<div class="qa-part-a-list">
							<h2 id="a_list_title">1 Answer</h2>
							<div class="qa-a-list" id="a_list">
								
								<div class="qa-a-list-item  hentry answer answer-selected qa-a-list-item-selected" id="a14108">
									<form method="post" action="../../14104/solving-for-scalar-function-from-its-gradient">
										<div class="qa-voting qa-voting-net" id="voting_14108">
											<div class="qa-vote-count qa-vote-count-net">
												<span class="qa-netvote-count">
													<span class="qa-netvote-count-data">0<span class="votes-up"><span class="value-title" title="0"></span></span><span class="votes-down"><span class="value-title" title="0"></span></span></span><span class="qa-netvote-count-pad"> votes</span>
												</span>
											</div>
											<div class="qa-vote-clear">
											</div>
										</div>
										<input type="hidden" name="code" value="0-1516466506-3087bee65313bc1761f312a9aa5255faab0a8a21">
									</form>
									<div class="qa-a-item-main">
										<form method="post" action="../../14104/solving-for-scalar-function-from-its-gradient">
											<div class="qa-a-item-selected">
												<div class="qa-a-selection">
													<div class="qa-a-selected">&#160;</div>
													<div class="qa-a-selected-text">Best answer</div>
												</div>
												<div class="qa-a-item-content">
													<a name="14108"></a><div class="entry-content"><p>I figured it out, its a linear problem, I can do it as follows:</p>

<pre><code>V = VectorFunctionSpace(mesh, 'P', 2)
Q = FunctionSpace(mesh, 'P', 1)

PPoint  = 'near(x[0], 0.0) &amp;&amp; near(x[1], 0.0)'
bcp = DirichletBC(Q, Constant(0.0), PPoint, 'pointwise')

p  = TrialFunction(Q)
v = TestFunction(V)
F5 = dot(as_vector([px_,py_]) - grad(p), v)*dx
a  = lhs(F5)
L  = rhs(F5)

p = Function(Q)
solve(a == L, p, bcs=bcp)
</code></pre>

<p>But I get a dolfin error:</p>

<pre><code>*** Error:   Unable to apply boundary condition.
*** Reason:  Dofmap ownership range (0,1089) does not match matrix row range (0,8450).
*** Where:   This error was encountered inside BoundaryCondition.cpp.
*** Process: 0
</code></pre>

<p>The domain is a 0 to 1 square. What is the reason for this error?</p>
</div>
												</div>
												<span class="qa-a-item-avatar-meta">
													<span class="qa-a-item-meta">
														<a href="../../14104/solving-for-scalar-function-from-its-gradient?show=14108#a14108" class="qa-a-item-what">answered</a>
														<span class="qa-a-item-when">
															<span class="qa-a-item-when-data"><span class="published"><span class="value-title" title="2017-06-25T20:32:56+0000"></span>Jun 25, 2017</span></span>
														</span>
														<span class="qa-a-item-who">
															<span class="qa-a-item-who-pad">by </span>
															<span class="qa-a-item-who-data"><span class="vcard author"><a href="../../user/alexmm" class="qa-user-link url nickname">alexmm</a></span></span>
															<span class="qa-a-item-who-title">FEniCS User</span>
															<span class="qa-a-item-who-points">
																<span class="qa-a-item-who-points-pad">(</span><span class="qa-a-item-who-points-data">4,240</span><span class="qa-a-item-who-points-pad"> points)</span>
															</span>
														</span>
														<br>
														<span class="qa-a-item-what">selected</span>
														<span class="qa-a-item-when">
															<span class="qa-a-item-when-data"><span class="updated"><span class="value-title" title="2017-06-29T02:50:37+0000"></span>Jun 29, 2017</span></span>
														</span>
														<span class="qa-a-item-who">
															<span class="qa-a-item-who-pad">by </span><span class="qa-a-item-who-data"><a href="../../user/alexmm" class="qa-user-link url nickname">alexmm</a></span>
														</span>
													</span>
												</span>
											</div>
											<div class="qa-a-item-buttons">
												</div>
											
											<div class="qa-a-item-c-list" id="c14108_list">
												<div class="qa-c-list-item  hentry comment" id="c14131">
													<div class="qa-c-item-content">
														<a name="14131"></a><div class="entry-content"><p>Hi, the error is due to the assembled matrix being rectangular.</p>

<pre><code>A = assemble(a)
print A.size(0), A.size(1)
</code></pre>
</div>
													</div>
													<div class="qa-c-item-footer">
														<span class="qa-c-item-avatar-meta">
															<span class="qa-c-item-avatar">
																<a href="../../user/MiroK" class="qa-avatar-link"><img src="https://www.gravatar.com/avatar/f566be3274ec73e3a6dda27bca11631c?s=20" width="20" height="20" class="qa-avatar-image" alt=""></a>
															</span>
															<span class="qa-c-item-meta">
																<a href="../../14104/solving-for-scalar-function-from-its-gradient?show=14131#c14131" class="qa-c-item-what">commented</a>
																<span class="qa-c-item-when">
																	<span class="qa-c-item-when-data"><span class="published"><span class="value-title" title="2017-06-27T12:50:33+0000"></span>Jun 27, 2017</span></span>
																</span>
																<span class="qa-c-item-who">
																	<span class="qa-c-item-who-pad">by </span>
																	<span class="qa-c-item-who-data"><span class="vcard author"><a href="../../user/MiroK" class="qa-user-link url nickname">MiroK</a></span></span>
																	<span class="qa-c-item-who-title">FEniCS Expert</span>
																	<span class="qa-c-item-who-points">
																		<span class="qa-c-item-who-points-pad">(</span><span class="qa-c-item-who-points-data">80,920</span><span class="qa-c-item-who-points-pad"> points)</span>
																	</span>
																</span>
															</span>
														</span>
														<div class="qa-c-item-buttons">
														</div>
													</div>
													<div class="qa-c-item-clear">
													</div>
												</div> <!-- END qa-c-item -->
												<div class="qa-c-list-item  hentry comment" id="c14132">
													<div class="qa-c-item-content">
														<a name="14132"></a><div class="entry-content"><p>Thank you for the answer Miro. Is the assembled matrix rectangular because of the function spaces I'm using? Shouldn't the assembly matrix always be square?</p>
</div>
													</div>
													<div class="qa-c-item-footer">
														<span class="qa-c-item-avatar-meta">
															<span class="qa-c-item-meta">
																<a href="../../14104/solving-for-scalar-function-from-its-gradient?show=14132#c14132" class="qa-c-item-what">commented</a>
																<span class="qa-c-item-when">
																	<span class="qa-c-item-when-data"><span class="published"><span class="value-title" title="2017-06-27T13:03:48+0000"></span>Jun 27, 2017</span></span>
																</span>
																<span class="qa-c-item-who">
																	<span class="qa-c-item-who-pad">by </span>
																	<span class="qa-c-item-who-data"><span class="vcard author"><a href="../../user/alexmm" class="qa-user-link url nickname">alexmm</a></span></span>
																	<span class="qa-c-item-who-title">FEniCS User</span>
																	<span class="qa-c-item-who-points">
																		<span class="qa-c-item-who-points-pad">(</span><span class="qa-c-item-who-points-data">4,240</span><span class="qa-c-item-who-points-pad"> points)</span>
																	</span>
																</span>
															</span>
														</span>
														<div class="qa-c-item-buttons">
														</div>
													</div>
													<div class="qa-c-item-clear">
													</div>
												</div> <!-- END qa-c-item -->
												<div class="qa-c-list-item  hentry comment" id="c14152">
													<div class="qa-c-item-content">
														<a name="14152"></a><div class="entry-content"><p>I got the gradient inverse by solving a Poisson equation as described in Efficient Computation of the Inverse Gradient on Irregular Domains. The code is shown below:</p>

<pre><code>PPoint  = 'near(x[0], 0.0) &amp;&amp; near(x[1], 0.0)'
bc      = DirichletBC(Q, Constant(0.0), PPoint, 'pointwise')

# Define variational problem
p = TrialFunction(Q)
q = TestFunction(Q)

f = div(as_vector([px_,py_]))
n = FacetNormal(mesh)
g = dot(n,as_vector([px_,py_]))

a = -inner(grad(p), grad(q))*dx
L =  f*q*dx + g*q*ds

# Compute solution
p = Function(Q)
solve(a == L, p, bc)
</code></pre>

<p>I'm still not sure why my original solution doesn't work</p>
</div>
													</div>
													<div class="qa-c-item-footer">
														<span class="qa-c-item-avatar-meta">
															<span class="qa-c-item-meta">
																<a href="../../14104/solving-for-scalar-function-from-its-gradient?show=14152#c14152" class="qa-c-item-what">commented</a>
																<span class="qa-c-item-when">
																	<span class="qa-c-item-when-data"><span class="published"><span class="value-title" title="2017-06-29T02:50:29+0000"></span>Jun 29, 2017</span></span>
																</span>
																<span class="qa-c-item-who">
																	<span class="qa-c-item-who-pad">by </span>
																	<span class="qa-c-item-who-data"><span class="vcard author"><a href="../../user/alexmm" class="qa-user-link url nickname">alexmm</a></span></span>
																	<span class="qa-c-item-who-title">FEniCS User</span>
																	<span class="qa-c-item-who-points">
																		<span class="qa-c-item-who-points-pad">(</span><span class="qa-c-item-who-points-data">4,240</span><span class="qa-c-item-who-points-pad"> points)</span>
																	</span>
																</span>
															</span>
														</span>
														<div class="qa-c-item-buttons">
														</div>
													</div>
													<div class="qa-c-item-clear">
													</div>
												</div> <!-- END qa-c-item -->
												<div class="qa-c-list-item  hentry comment" id="c14153">
													<div class="qa-c-item-content">
														<a name="14153"></a><div class="entry-content"><p>The matrix you assemble from a bilinear form has as many rows as is the dimensionality of the function space from which the test functions come and as many columns as the dimensionality of the space of trial functions. Think of the block off-diagonal block <code>inner(div(v), q)*dx</code> in the Stokes problem for example. </p>
</div>
													</div>
													<div class="qa-c-item-footer">
														<span class="qa-c-item-avatar-meta">
															<span class="qa-c-item-avatar">
																<a href="../../user/MiroK" class="qa-avatar-link"><img src="https://www.gravatar.com/avatar/f566be3274ec73e3a6dda27bca11631c?s=20" width="20" height="20" class="qa-avatar-image" alt=""></a>
															</span>
															<span class="qa-c-item-meta">
																<a href="../../14104/solving-for-scalar-function-from-its-gradient?show=14153#c14153" class="qa-c-item-what">commented</a>
																<span class="qa-c-item-when">
																	<span class="qa-c-item-when-data"><span class="published"><span class="value-title" title="2017-06-29T07:46:58+0000"></span>Jun 29, 2017</span></span>
																</span>
																<span class="qa-c-item-who">
																	<span class="qa-c-item-who-pad">by </span>
																	<span class="qa-c-item-who-data"><span class="vcard author"><a href="../../user/MiroK" class="qa-user-link url nickname">MiroK</a></span></span>
																	<span class="qa-c-item-who-title">FEniCS Expert</span>
																	<span class="qa-c-item-who-points">
																		<span class="qa-c-item-who-points-pad">(</span><span class="qa-c-item-who-points-data">80,920</span><span class="qa-c-item-who-points-pad"> points)</span>
																	</span>
																</span>
															</span>
														</span>
														<div class="qa-c-item-buttons">
														</div>
													</div>
													<div class="qa-c-item-clear">
													</div>
												</div> <!-- END qa-c-item -->
												<div class="qa-c-list-item  hentry comment" id="c14188">
													<div class="qa-c-item-content">
														<a name="14188"></a><div class="entry-content"><p>Thank you for the reply Miro. I changed the order of the V functions space to 1 to try to match the number of rows but I still get the same error:</p>

<pre><code>*** Error:   Unable to apply boundary condition.
*** Reason:  Dofmap ownership range (0,1089) does not match matrix row range (0,2178).
*** Where:   This error was encountered inside BoundaryCondition.cpp.
*** Process: 0
</code></pre>

<p>The order of the px_ and py_ functions is 1 as well. The error message says that the error is from BoundaryCondition.cpp, could it have something to do with how I'm writing the boundary condition? Could the problem be my use of the as_vector() function?</p>

<p>The original pde I'm trying to solve for in 2D is:</p>

<p>$$p - \nabla u = 0$$ </p>

<p>Where u is the p function in the code and p is composed of the two scalar functions px_ and py_. </p>
</div>
													</div>
													<div class="qa-c-item-footer">
														<span class="qa-c-item-avatar-meta">
															<span class="qa-c-item-meta">
																<a href="../../14104/solving-for-scalar-function-from-its-gradient?show=14188#c14188" class="qa-c-item-what">commented</a>
																<span class="qa-c-item-when">
																	<span class="qa-c-item-when-data"><span class="published"><span class="value-title" title="2017-07-02T23:18:24+0000"></span>Jul 3, 2017</span></span>
																</span>
																<span class="qa-c-item-who">
																	<span class="qa-c-item-who-pad">by </span>
																	<span class="qa-c-item-who-data"><span class="vcard author"><a href="../../user/alexmm" class="qa-user-link url nickname">alexmm</a></span></span>
																	<span class="qa-c-item-who-title">FEniCS User</span>
																	<span class="qa-c-item-who-points">
																		<span class="qa-c-item-who-points-pad">(</span><span class="qa-c-item-who-points-data">4,240</span><span class="qa-c-item-who-points-pad"> points)</span>
																	</span>
																</span>
															</span>
														</span>
														<div class="qa-c-item-buttons">
														</div>
													</div>
													<div class="qa-c-item-clear">
													</div>
												</div> <!-- END qa-c-item -->
												<div class="qa-c-list-item  hentry comment" id="c14190">
													<div class="qa-c-item-content">
														<a name="14190"></a><div class="entry-content"><p>The issue is that you are still assembling a rectangular matrix. </p>
</div>
													</div>
													<div class="qa-c-item-footer">
														<span class="qa-c-item-avatar-meta">
															<span class="qa-c-item-avatar">
																<a href="../../user/MiroK" class="qa-avatar-link"><img src="https://www.gravatar.com/avatar/f566be3274ec73e3a6dda27bca11631c?s=20" width="20" height="20" class="qa-avatar-image" alt=""></a>
															</span>
															<span class="qa-c-item-meta">
																<a href="../../14104/solving-for-scalar-function-from-its-gradient?show=14190#c14190" class="qa-c-item-what">commented</a>
																<span class="qa-c-item-when">
																	<span class="qa-c-item-when-data"><span class="published"><span class="value-title" title="2017-07-03T07:57:40+0000"></span>Jul 3, 2017</span></span>
																</span>
																<span class="qa-c-item-who">
																	<span class="qa-c-item-who-pad">by </span>
																	<span class="qa-c-item-who-data"><span class="vcard author"><a href="../../user/MiroK" class="qa-user-link url nickname">MiroK</a></span></span>
																	<span class="qa-c-item-who-title">FEniCS Expert</span>
																	<span class="qa-c-item-who-points">
																		<span class="qa-c-item-who-points-pad">(</span><span class="qa-c-item-who-points-data">80,920</span><span class="qa-c-item-who-points-pad"> points)</span>
																	</span>
																</span>
															</span>
														</span>
														<div class="qa-c-item-buttons">
														</div>
													</div>
													<div class="qa-c-item-clear">
													</div>
												</div> <!-- END qa-c-item -->
											</div> <!-- END qa-c-list -->
											
											<input type="hidden" name="code" value="0-1516466506-22162025a23120cc87dd20506579f99c84a2b659">
											<input type="hidden" name="qa_click" value="">
										</form>
										<div class="qa-c-form">
										</div> <!-- END qa-c-form -->
										
									</div> <!-- END qa-a-item-main -->
									<div class="qa-a-item-clear">
									</div>
								</div> <!-- END qa-a-list-item -->
								
							</div> <!-- END qa-a-list -->
							
						</div>
					</div> <!-- END qa-main -->
					
				</div> <!-- END main-wrapper -->
			</div> <!-- END main-shadow -->
		</div> <!-- END body-wrapper -->
		<!-- END footer-bottom-group -->
		
		<div style="position:absolute; left:-9999px; top:-9999px;">
			<span id="qa-waiting-template" class="qa-waiting">...</span>
		</div>
	
	

</body><!-- Powered by Question2Answer - http://www.question2answer.org/ --></html>