<html><!-- Powered by Question2Answer - http://www.question2answer.org/ --><head>
		<meta http-equiv="content-type" content="text/html; charset=utf-8">
		<title>Removing zeros for matrix - FEniCS Q&amp;A</title>
		<meta name="description" content="Is there a way to remove the zeros for the sparsity pattern?">
		<meta name="keywords" content="zeros,sparsity-pattern">
		<link rel="stylesheet" type="text/css" href="../../qa-theme/Snow/qa-styles.css">
		<link rel="canonical" href="http://fenicsproject.org/qa/8258/removing-zeros-for-matrix">
		<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
    tex2jax: {inlineMath: [["$","$"],["\\(","\\)"]]},
    TeX: { extensions: ["AMSmath.js","AMSsymbols.js"]}
  });
</script>
<script type="text/javascript" src="../../mathjax/MathJax.js"></script>
		<script src="../../jquery-1.7.2.min.js" type="text/javascript"></script>
		<script src="../../highlight.min.js"></script>
<script type="text/javascript">
$(function(){
	$('.wmd-input').keypress(function(){
		window.clearTimeout(hljs.Timeout);
		hljs.Timeout = window.setTimeout(function() {
			hljs.initHighlighting.called = false;
			hljs.initHighlighting();
		}, 500);
	});
	window.setTimeout(function() {
		hljs.initHighlighting.called = false;
		hljs.initHighlighting();
	}, 500);
});
</script>


	</head>
	<body class="qa-template-question qa-body-js-off">
		<div class="qa-body-wrapper">
			
			<div class="qa-header">
				<div class="qa-logo">
					<a href="../../" class="qa-logo-link" title="FEniCS Q&amp;A"><img src="../../qa-theme/fenics_qa.png" border="0" alt="FEniCS Q&amp;A"></a>
				</div>
				<div class="qa-header-clear">
				</div>
			</div> <!-- END qa-header -->
			
			<div class="qa-main-shadow">
				
				<div class="qa-main-wrapper">
					
					<div class="qa-sidepanel">
						<div class="qa-sidebar">
							This is a read only copy of the old FEniCS QA forum. Please visit the <a href="https://www.allanswered.com/community/s/fenics-project/">new QA forum</a> to ask questions
						</div>
						
					</div>
					
					<div class="qa-main">
						<h1>
							<span class="entry-title">Removing zeros for matrix</span>
						</h1>
						<div class="qa-part-q-view">
							<div class="qa-q-view  hentry question" id="q8258">
								<form method="post" action="../../8258/removing-zeros-for-matrix">
									<div class="qa-q-view-stats">
										<div class="qa-voting qa-voting-net" id="voting_8258">
											<div class="qa-vote-count qa-vote-count-net">
												<span class="qa-netvote-count">
													<span class="qa-netvote-count-data">+1<span class="votes-up"><span class="value-title" title="1"></span></span><span class="votes-down"><span class="value-title" title="0"></span></span></span><span class="qa-netvote-count-pad"> vote</span>
												</span>
											</div>
											<div class="qa-vote-clear">
											</div>
										</div>
									</div>
									<input type="hidden" name="code" value="0-1516468164-92e596bf07c1a4a3ec7e87952d77df3523bda026">
								</form>
								<div class="qa-q-view-main">
									<form method="post" action="../../8258/removing-zeros-for-matrix">
										<div class="qa-q-view-content">
											<a name="8258"></a><div class="entry-content"><p>Is there a way to remove the zeros for the sparsity pattern?</p>
</div>
										</div>
										<div class="qa-q-view-tags">
											<ul class="qa-q-view-tag-list">
												<li class="qa-q-view-tag-item"><a href="../../tag/zeros" rel="tag" class="qa-tag-link">zeros</a></li>
												<li class="qa-q-view-tag-item"><a href="../../tag/sparsity-pattern" rel="tag" class="qa-tag-link">sparsity-pattern</a></li>
											</ul>
										</div>
										<span class="qa-q-view-avatar-meta">
											<span class="qa-q-view-meta">
												<a href="../../8258/removing-zeros-for-matrix" class="qa-q-view-what">asked</a>
												<span class="qa-q-view-when">
													<span class="qa-q-view-when-data"><span class="published"><span class="value-title" title="2015-09-30T21:21:05+0000"></span>Sep 30, 2015</span></span>
												</span>
												<span class="qa-q-view-who">
													<span class="qa-q-view-who-pad">by </span>
													<span class="qa-q-view-who-data"><span class="vcard author"><a href="../../user/mwathen" class="qa-user-link url nickname">mwathen</a></span></span>
													<span class="qa-q-view-who-title">FEniCS Novice</span>
													<span class="qa-q-view-who-points">
														<span class="qa-q-view-who-points-pad">(</span><span class="qa-q-view-who-points-data">710</span><span class="qa-q-view-who-points-pad"> points)</span>
													</span>
												</span>
											</span>
										</span>
										<div class="qa-q-view-buttons">
										</div>
										
										<div class="qa-q-view-c-list" id="c8258_list">
											<div class="qa-c-list-item  hentry comment" id="c8274">
												<div class="qa-c-item-content">
													<a name="8274"></a><div class="entry-content"><p>So you computed a stiffness matrix and want to remove potential zero entries to make the structure more sparse? This can (to my knowledge) only be accomplished by computing the new sparsity pattern and copying the nonzero entries to a newly allocated matrix. But then, why would you want that? If there is an excessive number of zeros, then most likely you are missing something beforehand. Conversely, if they only make up a few percent of all elements in your pattern, the postprocessing of the assembled system might be much more expensive than just computing with a few extra entries.</p>
</div>
												</div>
												<div class="qa-c-item-footer">
													<span class="qa-c-item-avatar-meta">
														<span class="qa-c-item-meta">
															<a href="../../8258/removing-zeros-for-matrix?show=8274#c8274" class="qa-c-item-what">commented</a>
															<span class="qa-c-item-when">
																<span class="qa-c-item-when-data"><span class="published"><span class="value-title" title="2015-10-03T12:26:34+0000"></span>Oct 3, 2015</span></span>
															</span>
															<span class="qa-c-item-who">
																<span class="qa-c-item-who-pad">by </span>
																<span class="qa-c-item-who-data"><span class="vcard author"><a href="../../user/Christian+Waluga" class="qa-user-link url nickname">Christian Waluga</a></span></span>
																<span class="qa-c-item-who-title">FEniCS Expert</span>
																<span class="qa-c-item-who-points">
																	<span class="qa-c-item-who-points-pad">(</span><span class="qa-c-item-who-points-data">12,310</span><span class="qa-c-item-who-points-pad"> points)</span>
																</span>
															</span>
														</span>
													</span>
													<div class="qa-c-item-buttons">
													</div>
												</div>
												<div class="qa-c-item-clear">
												</div>
											</div> <!-- END qa-c-item -->
											<div class="qa-c-list-item  hentry comment" id="c8852">
												<div class="qa-c-item-content">
													<a name="8852"></a><div class="entry-content"><p>I am having the same question: my domain has a small finite-width border where the solution is zero, rather than just on the boundary. I assume I could define a SubMesh and use boundary conditions, but instead I apply a DirichletBC over the border. If you can elaborate a bit on <em>'computing the new sparsity pattern and copying the nonzero entries to a newly allocated matrix</em>' that would be most useful! (I use petsc4py but I haven't much experience on sparsity patterns)</p>
</div>
												</div>
												<div class="qa-c-item-footer">
													<span class="qa-c-item-avatar-meta">
														<span class="qa-c-item-meta">
															<a href="../../8258/removing-zeros-for-matrix?show=8852#c8852" class="qa-c-item-what">commented</a>
															<span class="qa-c-item-when">
																<span class="qa-c-item-when-data"><span class="published"><span class="value-title" title="2015-12-14T15:15:41+0000"></span>Dec 14, 2015</span></span>
															</span>
															<span class="qa-c-item-who">
																<span class="qa-c-item-who-pad">by </span>
																<span class="qa-c-item-who-data"><span class="vcard author"><a href="../../user/maartent" class="qa-user-link url nickname">maartent</a></span></span>
																<span class="qa-c-item-who-title">FEniCS User</span>
																<span class="qa-c-item-who-points">
																	<span class="qa-c-item-who-points-pad">(</span><span class="qa-c-item-who-points-data">3,910</span><span class="qa-c-item-who-points-pad"> points)</span>
																</span>
															</span>
														</span>
													</span>
													<div class="qa-c-item-buttons">
													</div>
												</div>
												<div class="qa-c-item-clear">
												</div>
											</div> <!-- END qa-c-item -->
										</div> <!-- END qa-c-list -->
										
										<input type="hidden" name="code" value="0-1516468164-c171fe65670acfbb4a041e9ca6ce15aeafc126ad">
										<input type="hidden" name="qa_click" value="">
									</form>
									<div class="qa-c-form">
									</div> <!-- END qa-c-form -->
									
								</div> <!-- END qa-q-view-main -->
								<div class="qa-q-view-clear">
								</div>
							</div> <!-- END qa-q-view -->
							
						</div>
						<div class="qa-part-a-list">
							<h2 id="a_list_title">1 Answer</h2>
							<div class="qa-a-list" id="a_list">
								
								<div class="qa-a-list-item  hentry answer" id="a8943">
									<form method="post" action="../../8258/removing-zeros-for-matrix">
										<div class="qa-voting qa-voting-net" id="voting_8943">
											<div class="qa-vote-count qa-vote-count-net">
												<span class="qa-netvote-count">
													<span class="qa-netvote-count-data">+1<span class="votes-up"><span class="value-title" title="1"></span></span><span class="votes-down"><span class="value-title" title="0"></span></span></span><span class="qa-netvote-count-pad"> vote</span>
												</span>
											</div>
											<div class="qa-vote-clear">
											</div>
										</div>
										<input type="hidden" name="code" value="0-1516468164-92e596bf07c1a4a3ec7e87952d77df3523bda026">
									</form>
									<div class="qa-a-item-main">
										<form method="post" action="../../8258/removing-zeros-for-matrix">
											<div class="qa-a-selection">
											</div>
											<div class="qa-a-item-content">
												<a name="8943"></a><div class="entry-content"><p>Hi,</p>

<p>i did it this way : (i found this solution somewhere in this forum but i dont know where :-)</p>

<pre><code>from dolfin import*
import numpy as np
from petsc4py import PETSc
import scipy.sparse as sp_sparse
</code></pre>

<p>Your matrices and bc come here</p>

<pre><code>test = S.mat()
row, col, data = test.getValuesCSR()
S_scipy = sp_sparse.csc_matrix((data, col, row), shape=(N_row, N_row),dtype=np.float) 

test = T.mat()
row, col, data = test.getValuesCSR()
T_scipy = sp_sparse.csc_matrix((data, col, row), shape=(N_row, N_row),dtype=np.float) 


nv = S_scipy.shape[0]
auxu = np.zeros((nv,1))
bcinds = []

bcdict = bc.get_boundary_values()
auxu[bcdict.keys(),0] = bcdict.values()
bcinds.extend(bcdict.keys())

fvbc =  S_scipy*auxu

invinds = np.setdiff1d(range(nv),bcinds)
S_red = S_scipy[invinds,:][:,invinds]
T_red = T_scipy[invinds,:][:,invinds]

S = PETScMatrix(PETSc.Mat().createAIJ(size=S_red.shape,csr=(S_red.indptr, S_red.indices,S_red.data)))
T = PETScMatrix(PETSc.Mat().createAIJ(size=S_red.shape,csr=(T_red.indptr, T_red.indices,T_red.data)))    
</code></pre>

<p>You need scipy, numpy and petsc4py for this i guess. For me this solution works flawlessly. However, it does hardly give any performance gain (for me).</p>

<p>Kind regards </p>

<p>Johann</p>
</div>
											</div>
											<span class="qa-a-item-avatar-meta">
												<span class="qa-a-item-avatar">
													<a href="../../user/jh600" class="qa-avatar-link"><img src="../../?qa=image&amp;qa_blobid=11569025954653921126&amp;qa_size=40" width="40" height="40" class="qa-avatar-image" alt=""></a>
												</span>
												<span class="qa-a-item-meta">
													<a href="../../8258/removing-zeros-for-matrix?show=8943#a8943" class="qa-a-item-what">answered</a>
													<span class="qa-a-item-when">
														<span class="qa-a-item-when-data"><span class="published"><span class="value-title" title="2015-12-28T15:10:20+0000"></span>Dec 28, 2015</span></span>
													</span>
													<span class="qa-a-item-who">
														<span class="qa-a-item-who-pad">by </span>
														<span class="qa-a-item-who-data"><span class="vcard author"><a href="../../user/jh600" class="qa-user-link url nickname">jh600</a></span></span>
														<span class="qa-a-item-who-title">FEniCS Novice</span>
														<span class="qa-a-item-who-points">
															<span class="qa-a-item-who-points-pad">(</span><span class="qa-a-item-who-points-data">900</span><span class="qa-a-item-who-points-pad"> points)</span>
														</span>
													</span>
													<br>
													<span class="qa-a-item-what">edited</span>
													<span class="qa-a-item-when">
														<span class="qa-a-item-when-data"><span class="updated"><span class="value-title" title="2015-12-28T15:16:18+0000"></span>Dec 28, 2015</span></span>
													</span>
													<span class="qa-a-item-who">
														<span class="qa-a-item-who-pad">by </span><span class="qa-a-item-who-data"><a href="../../user/jh600" class="qa-user-link url nickname">jh600</a></span>
													</span>
												</span>
											</span>
											<div class="qa-a-item-buttons">
												</div>
											
											<div class="qa-a-item-c-list" style="display:none;" id="c8943_list">
											</div> <!-- END qa-c-list -->
											
											<input type="hidden" name="code" value="0-1516468164-b47d50b2bb3d9c621c59c38e5607db8f190c4427">
											<input type="hidden" name="qa_click" value="">
										</form>
										<div class="qa-c-form">
										</div> <!-- END qa-c-form -->
										
									</div> <!-- END qa-a-item-main -->
									<div class="qa-a-item-clear">
									</div>
								</div> <!-- END qa-a-list-item -->
								
							</div> <!-- END qa-a-list -->
							
						</div>
					</div> <!-- END qa-main -->
					
				</div> <!-- END main-wrapper -->
			</div> <!-- END main-shadow -->
		</div> <!-- END body-wrapper -->
		<!-- END footer-bottom-group -->
		
		<div style="position:absolute; left:-9999px; top:-9999px;">
			<span id="qa-waiting-template" class="qa-waiting">...</span>
		</div>
	
	

</body><!-- Powered by Question2Answer - http://www.question2answer.org/ --></html>