<html><!-- Powered by Question2Answer - http://www.question2answer.org/ --><head>
		<meta http-equiv="content-type" content="text/html; charset=utf-8">
		<title>Solving linear system in parallel - FEniCS Q&amp;A</title>
		<meta name="description" content="Hi, I implemented an iterative method in c++ using Fenics for the assembly of some system/ ...  backend, telling it to compute in parallel? Regards">
		<meta name="keywords" content="linear-solver,parallel,iterative">
		<link rel="stylesheet" type="text/css" href="../../qa-theme/Snow/qa-styles.css">
		<link rel="canonical" href="http://fenicsproject.org/qa/10068/solving-linear-system-in-parallel">
		<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
    tex2jax: {inlineMath: [["$","$"],["\\(","\\)"]]},
    TeX: { extensions: ["AMSmath.js","AMSsymbols.js"]}
  });
</script>
<script type="text/javascript" src="../../mathjax/MathJax.js"></script>
		<script src="../../jquery-1.7.2.min.js" type="text/javascript"></script>
		<script src="../../highlight.min.js"></script>
<script type="text/javascript">
$(function(){
	$('.wmd-input').keypress(function(){
		window.clearTimeout(hljs.Timeout);
		hljs.Timeout = window.setTimeout(function() {
			hljs.initHighlighting.called = false;
			hljs.initHighlighting();
		}, 500);
	});
	window.setTimeout(function() {
		hljs.initHighlighting.called = false;
		hljs.initHighlighting();
	}, 500);
});
</script>


	</head>
	<body class="qa-template-question qa-body-js-off">
		<div class="qa-body-wrapper">
			
			<div class="qa-header">
				<div class="qa-logo">
					<a href="../../" class="qa-logo-link" title="FEniCS Q&amp;A"><img src="../../qa-theme/fenics_qa.png" border="0" alt="FEniCS Q&amp;A"></a>
				</div>
				<div class="qa-header-clear">
				</div>
			</div> <!-- END qa-header -->
			
			<div class="qa-main-shadow">
				
				<div class="qa-main-wrapper">
					
					<div class="qa-sidepanel">
						<div class="qa-sidebar">
							This is a read only copy of the old FEniCS QA forum. Please visit the <a href="https://www.allanswered.com/community/s/fenics-project/">new QA forum</a> to ask questions
						</div>
						
					</div>
					
					<div class="qa-main">
						<h1>
							<span class="entry-title">Solving linear system in parallel</span>
						</h1>
						<div class="qa-part-q-view">
							<div class="qa-q-view  hentry question" id="q10068">
								<form method="post" action="../../10068/solving-linear-system-in-parallel">
									<div class="qa-q-view-stats">
										<div class="qa-voting qa-voting-net" id="voting_10068">
											<div class="qa-vote-count qa-vote-count-net">
												<span class="qa-netvote-count">
													<span class="qa-netvote-count-data">+1<span class="votes-up"><span class="value-title" title="1"></span></span><span class="votes-down"><span class="value-title" title="0"></span></span></span><span class="qa-netvote-count-pad"> vote</span>
												</span>
											</div>
											<div class="qa-vote-clear">
											</div>
										</div>
									</div>
									<input type="hidden" name="code" value="0-1516467038-72ee5248b84e25dc1c82648677ecb9a24e4a2f8b">
								</form>
								<div class="qa-q-view-main">
									<form method="post" action="../../10068/solving-linear-system-in-parallel">
										<div class="qa-q-view-content">
											<a name="10068"></a><div class="entry-content"><p>Hi,</p>

<p>I implemented an iterative method in c++ using Fenics for the assembly of some system/mass matrices. In each iteration I have to solve several times the linear system</p>

<p>K^(-1) x = y</p>

<p>which is realised by</p>

<pre><code>solve(K, y, x, "gmres", "icc")
</code></pre>

<p>Here K is the system matrix for the Laplacian, which is constant all time and is just assembled one time of course. The solver and preconditioner are found to be very fast in 1D, for 2D I use bicgstab with hypre_amg.</p>

<p>Now by running some bigger computations I noticed that Fenics only uses 1 core (with 100%) which is of course not reasonable. I looked at the parallel tutorials but they are only for solving the PDE only one time.<br>
By simply starting my program with mpirun I run into an error of course.</p>

<p>Is there any method to only solve Kx = y for K being a given matrix and y being a given vector in parallel and then continue in serial? </p>

<p>Same question holds for the multiplication of matrices which can be done perfectly in parallel. Can I just send a parameter to the linear algebra backend, telling it to compute in parallel?</p>

<p>Regards</p>
</div>
										</div>
										<div class="qa-q-view-tags">
											<ul class="qa-q-view-tag-list">
												<li class="qa-q-view-tag-item"><a href="../../tag/linear-solver" rel="tag" class="qa-tag-link">linear-solver</a></li>
												<li class="qa-q-view-tag-item"><a href="../../tag/parallel" rel="tag" class="qa-tag-link">parallel</a></li>
												<li class="qa-q-view-tag-item"><a href="../../tag/iterative" rel="tag" class="qa-tag-link">iterative</a></li>
											</ul>
										</div>
										<span class="qa-q-view-avatar-meta">
											<span class="qa-q-view-meta">
												<a href="../../10068/solving-linear-system-in-parallel" class="qa-q-view-what">asked</a>
												<span class="qa-q-view-when">
													<span class="qa-q-view-when-data"><span class="published"><span class="value-title" title="2016-05-10T11:55:37+0000"></span>May 10, 2016</span></span>
												</span>
												<span class="qa-q-view-who">
													<span class="qa-q-view-who-pad">by </span>
													<span class="qa-q-view-who-data"><span class="vcard author"><a href="../../user/Kokett" class="qa-user-link url nickname">Kokett</a></span></span>
													<span class="qa-q-view-who-title">FEniCS Novice</span>
													<span class="qa-q-view-who-points">
														<span class="qa-q-view-who-points-pad">(</span><span class="qa-q-view-who-points-data">300</span><span class="qa-q-view-who-points-pad"> points)</span>
													</span>
												</span>
											</span>
										</span>
										<div class="qa-q-view-buttons">
										</div>
										
										<div class="qa-q-view-c-list" style="display:none;" id="c10068_list">
										</div> <!-- END qa-c-list -->
										
										<input type="hidden" name="code" value="0-1516467038-29496dc94d3a006a863702907989e91140e530ee">
										<input type="hidden" name="qa_click" value="">
									</form>
									<div class="qa-c-form">
									</div> <!-- END qa-c-form -->
									
								</div> <!-- END qa-q-view-main -->
								<div class="qa-q-view-clear">
								</div>
							</div> <!-- END qa-q-view -->
							
						</div>
						<div class="qa-part-a-list">
							<h2 id="a_list_title">2 Answers</h2>
							<div class="qa-a-list" id="a_list">
								
								<div class="qa-a-list-item  hentry answer" id="a10074">
									<form method="post" action="../../10068/solving-linear-system-in-parallel">
										<div class="qa-voting qa-voting-net" id="voting_10074">
											<div class="qa-vote-count qa-vote-count-net">
												<span class="qa-netvote-count">
													<span class="qa-netvote-count-data">0<span class="votes-up"><span class="value-title" title="0"></span></span><span class="votes-down"><span class="value-title" title="0"></span></span></span><span class="qa-netvote-count-pad"> votes</span>
												</span>
											</div>
											<div class="qa-vote-clear">
											</div>
										</div>
										<input type="hidden" name="code" value="0-1516467038-72ee5248b84e25dc1c82648677ecb9a24e4a2f8b">
									</form>
									<div class="qa-a-item-main">
										<form method="post" action="../../10068/solving-linear-system-in-parallel">
											<div class="qa-a-selection">
											</div>
											<div class="qa-a-item-content">
												<a name="10074"></a><div class="entry-content"><p>I tried setting up a direct parallel solver, with PETSc and MUMPS:</p>

<pre><code>PETScLUSolver Solver("mumps")
Solver.solve(*K, y, x)
</code></pre>

<p>but it still uses only one core. </p>

<p>Maybe let me reformulate my question: <br>
Is there any way to implement a parallel solver (I would like to have parallel bicgstab + hypre_amg) in FeniCs without using MPI? </p>

<p>Edit: Or maybe there is a way with MPI? Still i have no idea how to implement this and how to communicate between the threads.</p>
</div>
											</div>
											<span class="qa-a-item-avatar-meta">
												<span class="qa-a-item-meta">
													<a href="../../10068/solving-linear-system-in-parallel?show=10074#a10074" class="qa-a-item-what">answered</a>
													<span class="qa-a-item-when">
														<span class="qa-a-item-when-data"><span class="published"><span class="value-title" title="2016-05-11T07:31:18+0000"></span>May 11, 2016</span></span>
													</span>
													<span class="qa-a-item-who">
														<span class="qa-a-item-who-pad">by </span>
														<span class="qa-a-item-who-data"><span class="vcard author"><a href="../../user/Kokett" class="qa-user-link url nickname">Kokett</a></span></span>
														<span class="qa-a-item-who-title">FEniCS Novice</span>
														<span class="qa-a-item-who-points">
															<span class="qa-a-item-who-points-pad">(</span><span class="qa-a-item-who-points-data">300</span><span class="qa-a-item-who-points-pad"> points)</span>
														</span>
													</span>
													<br>
													<span class="qa-a-item-what">edited</span>
													<span class="qa-a-item-when">
														<span class="qa-a-item-when-data"><span class="updated"><span class="value-title" title="2016-05-11T09:50:07+0000"></span>May 11, 2016</span></span>
													</span>
													<span class="qa-a-item-who">
														<span class="qa-a-item-who-pad">by </span><span class="qa-a-item-who-data"><a href="../../user/Kokett" class="qa-user-link url nickname">Kokett</a></span>
													</span>
												</span>
											</span>
											<div class="qa-a-item-buttons">
												</div>
											
											<div class="qa-a-item-c-list" id="c10074_list">
												<div class="qa-c-list-item  hentry comment" id="c10075">
													<div class="qa-c-item-content">
														<a name="10075"></a><div class="entry-content"><p>Hey. I have been trying to solve navia stokes in parallel with bicgstab/grmes/cg + hyper_amg (since hypre_parasails does not work for somereason) but so far had no luck getting a solution Its seems to work fine with simple poisson however so I believe the issue is mesh/preconditioner selection)<br>
It does iterate and convrge though. </p>

<p>Here is a snippit of the code to configure it  Also make sure to put this at start of the code. (regarding mpirun it handles all the communication between threads for you so you don't have to deal with that, as far as I understand)<br>
    parameters["ghost_mode"] = "shared_facet"</p>

<p>Then just run it with "mpirun -n numberofcores python yourscript.py"</p>

<pre><code># Compute solution
problem = NonlinearVariationalProblem(F, u_, bcs, J)
solver  = NonlinearVariationalSolver(problem)
#paramters['linear_algebra_backend']= 'PETSc'

prm = solver.parameters
#prm['linear_algebra_backend']= 'PETSc'
prm['newton_solver']['absolute_tolerance'] = 1E-5
prm['newton_solver']['relative_tolerance'] = 1E-5
prm['newton_solver']['maximum_iterations'] = 10000
prm['newton_solver']['relaxation_parameter'] = 1.0
#paramters['linear_algebra_backend']= 'PETSc'
#prm['newton_solver']['linear_solver'] = "cg"
#prm['newton_solver']['linear_solver'] = "mumps"
if True :
    prm['newton_solver']['linear_solver'] = 'bicgstab'
    #prm['newton_solver']['linear_solver'] = "cg"
    #prm['newton_solver']['linear_solver'] = 'gmres'
    prm['newton_solver']['preconditioner'] = 'hypre_amg'
    prm['newton_solver']['krylov_solver']['absolute_tolerance'] = 1E-6
    prm['newton_solver']['krylov_solver']['relative_tolerance'] = 1E-6
    prm['newton_solver']['krylov_solver']['maximum_iterations'] = 100
    prm['newton_solver']['krylov_solver']['monitor_convergence'] = True
    prm['newton_solver']['krylov_solver']['nonzero_initial_guess'] = True
    prm['newton_solver']['krylov_solver']['gmres']['restart'] = 40
</code></pre>
</div>
													</div>
													<div class="qa-c-item-footer">
														<span class="qa-c-item-avatar-meta">
															<span class="qa-c-item-meta">
																<a href="../../10068/solving-linear-system-in-parallel?show=10075#c10075" class="qa-c-item-what">commented</a>
																<span class="qa-c-item-when">
																	<span class="qa-c-item-when-data"><span class="published"><span class="value-title" title="2016-05-11T16:37:47+0000"></span>May 11, 2016</span></span>
																</span>
																<span class="qa-c-item-who">
																	<span class="qa-c-item-who-pad">by </span>
																	<span class="qa-c-item-who-data"><span class="vcard author"><a href="../../user/soviet911" class="qa-user-link url nickname">soviet911</a></span></span>
																	<span class="qa-c-item-who-title">FEniCS Novice</span>
																	<span class="qa-c-item-who-points">
																		<span class="qa-c-item-who-points-pad">(</span><span class="qa-c-item-who-points-data">180</span><span class="qa-c-item-who-points-pad"> points)</span>
																	</span>
																</span>
															</span>
														</span>
														<div class="qa-c-item-buttons">
														</div>
													</div>
													<div class="qa-c-item-clear">
													</div>
												</div> <!-- END qa-c-item -->
												<div class="qa-c-list-item  hentry comment" id="c10084">
													<div class="qa-c-item-content">
														<a name="10084"></a><div class="entry-content"><p>Thanks for your answer, but the problem is: I dont want to apply a mesh-partitionier. Maybe i give a little bit more insight into my code structure (pseudo code):</p>

<pre><code>int main()
{
// Do Stuff in serial 
set up grid
set up functional spaces and auxiliary variables
assemble System matrix K

while iteration &lt; iter_max
{

assemble mass matrix M1, M2

// do stuff in parallel
solve Ky = x
y = M1*M2*y
// end parallel computation

//continue things in serial


iteration++
}

}
</code></pre>

<p>If i run it with MPI - assume with a mesh-partitionier -  the multiplication produces some errors, so my aim is to solve only the system Ky=x in parallel, and when its done continue in serial.</p>

<p>I'm not sure if this is even possible with Fenics.</p>
</div>
													</div>
													<div class="qa-c-item-footer">
														<span class="qa-c-item-avatar-meta">
															<span class="qa-c-item-meta">
																<a href="../../10068/solving-linear-system-in-parallel?show=10084#c10084" class="qa-c-item-what">commented</a>
																<span class="qa-c-item-when">
																	<span class="qa-c-item-when-data"><span class="published"><span class="value-title" title="2016-05-12T07:26:36+0000"></span>May 12, 2016</span></span>
																</span>
																<span class="qa-c-item-who">
																	<span class="qa-c-item-who-pad">by </span>
																	<span class="qa-c-item-who-data"><span class="vcard author"><a href="../../user/Kokett" class="qa-user-link url nickname">Kokett</a></span></span>
																	<span class="qa-c-item-who-title">FEniCS Novice</span>
																	<span class="qa-c-item-who-points">
																		<span class="qa-c-item-who-points-pad">(</span><span class="qa-c-item-who-points-data">300</span><span class="qa-c-item-who-points-pad"> points)</span>
																	</span>
																</span>
															</span>
														</span>
														<div class="qa-c-item-buttons">
														</div>
													</div>
													<div class="qa-c-item-clear">
													</div>
												</div> <!-- END qa-c-item -->
												<div class="qa-c-list-item  hentry comment" id="c10090">
													<div class="qa-c-item-content">
														<a name="10090"></a><div class="entry-content"><p>Hmm. I don't have time to test right now but I had success with useing MPI.Rank to force only one process perform a given task. Not sure if it will work for your applicaiton but you can do the following: </p>

<pre><code> if MPI.rank(mpi_comm_world())==0:
            wdata=open(resultvarName,'ab')
            dfile=csv.writer(wdata,dialect='excel')
            dfile.writerow([flowRate,u_flow,flux,avgTemp,outTemp,voltage,current,inU,outU,     (time.time()-solverStart)/60.0])
            wdata.close()
</code></pre>

<p>This is how I save data I got from integration over a surface (such as average tempreture etc) The integrations and computation is done all in parallel, but the answers are all coupled IE, when you integrate over a surface with 8 process all of them will have access to same solution, even though I think it splits up integration into 8 parts, and then sums it and returns complete answer to each process.<br>
I am not sure what  you mean multiplication produces some errors?  but if you use the aproach above you need to make sure all process will have access to solved matrix. Apperntly you can use Bcast( data) to send solution to all process.. not sure but look at following PPT, slide 11 MPI Basics.  (<a rel="nofollow" href="http://www.math.pitt.edu/~sussmanm/3040Summer14/fenicsI-4up.pdf)">http://www.math.pitt.edu/~sussmanm/3040Summer14/fenicsI-4up.pdf)</a></p>

<p>I think you will need to use Bcast and Recv to make sure that all process have to same matrices after you do the math in serial.</p>

<p>Then the psudocode would be <br>
    }</p>

<pre><code>}


set up grid
set up functional spaces and auxiliary variables


if (MPI.rank(mpi_comm_world())==0)
{matrix = assemble System matrix K
    comm.Bcast(matrix)}
matrix=comm.Recv(matrix)
while iteration &lt; iter_max
{ if (MPI.rank(mpi_comm_world())==0)
{matrix = assemble System matrix M1,M2
    comm.Bcast(matrix)}
M1,M2=comm.Recv(matrix)
    y = M1*M2*y
    // end parallel computation
if (MPI.rank(mpi_comm_world())==0)
{//continue things in serial}


iteration++
}

}
</code></pre>

<p>This is a rather nasty implementation, so I think it might be better if you tell use whats the multiplication error? </p>
</div>
													</div>
													<div class="qa-c-item-footer">
														<span class="qa-c-item-avatar-meta">
															<span class="qa-c-item-meta">
																<a href="../../10068/solving-linear-system-in-parallel?show=10090#c10090" class="qa-c-item-what">commented</a>
																<span class="qa-c-item-when">
																	<span class="qa-c-item-when-data"><span class="published"><span class="value-title" title="2016-05-12T19:39:40+0000"></span>May 12, 2016</span></span>
																</span>
																<span class="qa-c-item-who">
																	<span class="qa-c-item-who-pad">by </span>
																	<span class="qa-c-item-who-data"><span class="vcard author"><a href="../../user/soviet911" class="qa-user-link url nickname">soviet911</a></span></span>
																	<span class="qa-c-item-who-title">FEniCS Novice</span>
																	<span class="qa-c-item-who-points">
																		<span class="qa-c-item-who-points-pad">(</span><span class="qa-c-item-who-points-data">180</span><span class="qa-c-item-who-points-pad"> points)</span>
																	</span>
																</span>
															</span>
														</span>
														<div class="qa-c-item-buttons">
														</div>
													</div>
													<div class="qa-c-item-clear">
													</div>
												</div> <!-- END qa-c-item -->
												<div class="qa-c-list-item  hentry comment" id="c10095">
													<div class="qa-c-item-content">
														<a name="10095"></a><div class="entry-content"><p>Up to now i was not able to implement this code for a simple example, but I am a beginner to MPI. I am still a little bit confused that MPI.h does not contain a receive command...</p>

<p>Here is a little bit more details of my code to see the overall structure of my code and where the error occurs:</p>

<p>I mainly work with two classes:</p>

<p>1) PDEHandler: contains the Functionspace, system and mass matrix of my bilinear form<br>
2) NewtonSolver: mainly contains a CG-method to solve a Newton-system of the type<br>
M1 K^(-1) M2 K^(-1) x = M1 K^(-1) y   <br>
where M1 is newly assembled in each iteration</p>

<p>For applying a CG method i have to solve K(-1) x = y. </p>

<p>Here is the code (shorted): I work with Pointers to easily refine the mesh. And I know, i should use shared_ptr...</p>

<pre><code>int main()
{
// Initialize mesh
Mesh* mesh=MakeMesh(Case,h);
// initialize PDEHandler
PDEHandler* PDESolve = new PDEHandler(*mesh, Case);
// initialize NewtonSolver
SemiSmoothNewtonSolver* NewtonSolver = new SemiSmoothNewtonSolver( PDESolve-&gt;V,  );

// define Functions
Function* z = new Function(PDESolve-&gt;V);
Function* lambda = new Function(PDESolve-&gt;V);
Function* adp = new Function(PDESolve-&gt;V);

// exact solution (if known - else = 0)
Function* p_ex = new Function(PDESolve-&gt;V);
Function* u_ex = new Function(PDESolve-&gt;V);
Function* y_ex = new Function(PDESolve-&gt;V);


// computed solution
Function* p = new Function(PDESolve-&gt;V);
Function* u = new Function(PDESolve-&gt;V);
Function* y = new Function(PDESolve-&gt;V);

// Initialize test problem
InitializeTestProblem(*p_ex,*u_ex,*y_ex,*z, PDESolve);

// iterate
for (unsigned int k = 1; k &lt; max_iter; k++)
{

    // Solve subproblem
    NewtonSolver-&gt;Solve(*u,*lambda,*z,*adp,*p,k);


    // update lambda - this is already done in the newton method
    *lambda-&gt;vector() = *adp-&gt;vector();


    // approx. error - if exact solution is known
    ErrorNormFunctional E1(*mesh, *u_ex, *u);
    arr_error.push_back( assemble(E1) );

    // optimality
    ErrorNormFunctional E2(*mesh, temp2, *u);
    double opt = assemble(E2);

}


delete mesh;
return 0;
}
</code></pre>

<p>The solve Method of my Newton-Solver is a bit longer, so i just post the assembling of the right handed side of the Newton-equation:</p>

<pre><code>void SemiSmoothNewtonSolver::ComputeRHS(Vector&amp; rhs, const Function&amp; lambda, const Function&amp; z, Vector&amp; g, const int k)
{

// compute g
temp1 = pua;
pMua-&gt;mult(temp1, g); //g = Mua * pua;

temp1 = pub;
pMub-&gt;mult(temp1, temp2); // temp2 = Mub * pub;

// g = Mua*pua + Mub*pub
g += temp2;

MultKinv(g,temp2);                      // temp2 = K^(-1)*g
temp2 -= *z.vector();                   // temp2 = K^(-1)*g - z
PDESolve-&gt;Mdir.mult(temp2,temp1);       // temp1 = M ( K^(-1)*g -z)
MultKinv(temp1,temp2);                  // temp2 = K^(-1 )M ( K^(-1)*g -z)
pMinact-&gt;mult(temp2,temp1);             // temp1 = MI K^(-1) M ( K^(-1)*g -z)
temp1 *= -1.0/alpha(k);                 // temp1 = -1/alpha * MI K^(-1) M ( K^(-1)*g -z)
pMinact-&gt;mult(*lambda.vector(), rhs);   // rhs = MI*lambda

rhs += temp1;                           // rhs = MI*lambda -1/alpha * MI K^(-1) M ( K^(-1)*g -z)

}
</code></pre>

<p>where the multiplication with Kinv = K^(-1) is performed with the solve-Command.</p>

<p>If i run this code (which runs fine in serial) with mpi, it produces a run-time error at the first multiplication pMub-&gt;mult(temp1, temp2); complaining:</p>

<p>PETSC ERROR: Nonconforming object sizes,<br>
PETSC ERROR: Mat mat,Vec y: local dim 233 241!</p>

<p>I think this is due to the partioning of the mesh and the resulting different matrix dimensions.</p>
</div>
													</div>
													<div class="qa-c-item-footer">
														<span class="qa-c-item-avatar-meta">
															<span class="qa-c-item-meta">
																<a href="../../10068/solving-linear-system-in-parallel?show=10095#c10095" class="qa-c-item-what">commented</a>
																<span class="qa-c-item-when">
																	<span class="qa-c-item-when-data"><span class="published"><span class="value-title" title="2016-05-13T13:25:07+0000"></span>May 13, 2016</span></span>
																</span>
																<span class="qa-c-item-who">
																	<span class="qa-c-item-who-pad">by </span>
																	<span class="qa-c-item-who-data"><span class="vcard author"><a href="../../user/Kokett" class="qa-user-link url nickname">Kokett</a></span></span>
																	<span class="qa-c-item-who-title">FEniCS Novice</span>
																	<span class="qa-c-item-who-points">
																		<span class="qa-c-item-who-points-pad">(</span><span class="qa-c-item-who-points-data">300</span><span class="qa-c-item-who-points-pad"> points)</span>
																	</span>
																</span>
															</span>
														</span>
														<div class="qa-c-item-buttons">
														</div>
													</div>
													<div class="qa-c-item-clear">
													</div>
												</div> <!-- END qa-c-item -->
												<div class="qa-c-list-item  hentry comment" id="c10096">
													<div class="qa-c-item-content">
														<a name="10096"></a><div class="entry-content"><p>Have you tried adding the following parameter at start of your code? (before you build the mesh?) I had same issue when trying to set different materials with DG space in parallel. </p>

<p>parameters["ghost_mode"] = "shared_facet";</p>
</div>
													</div>
													<div class="qa-c-item-footer">
														<span class="qa-c-item-avatar-meta">
															<span class="qa-c-item-meta">
																<a href="../../10068/solving-linear-system-in-parallel?show=10096#c10096" class="qa-c-item-what">commented</a>
																<span class="qa-c-item-when">
																	<span class="qa-c-item-when-data"><span class="published"><span class="value-title" title="2016-05-13T15:06:53+0000"></span>May 13, 2016</span></span>
																</span>
																<span class="qa-c-item-who">
																	<span class="qa-c-item-who-pad">by </span>
																	<span class="qa-c-item-who-data"><span class="vcard author"><a href="../../user/soviet911" class="qa-user-link url nickname">soviet911</a></span></span>
																	<span class="qa-c-item-who-title">FEniCS Novice</span>
																	<span class="qa-c-item-who-points">
																		<span class="qa-c-item-who-points-pad">(</span><span class="qa-c-item-who-points-data">180</span><span class="qa-c-item-who-points-pad"> points)</span>
																	</span>
																</span>
															</span>
														</span>
														<div class="qa-c-item-buttons">
														</div>
													</div>
													<div class="qa-c-item-clear">
													</div>
												</div> <!-- END qa-c-item -->
												<div class="qa-c-list-item  hentry comment" id="c10098">
													<div class="qa-c-item-content">
														<a name="10098"></a><div class="entry-content"><p>Hi,</p>

<p>this produces the same error.</p>
</div>
													</div>
													<div class="qa-c-item-footer">
														<span class="qa-c-item-avatar-meta">
															<span class="qa-c-item-meta">
																<a href="../../10068/solving-linear-system-in-parallel?show=10098#c10098" class="qa-c-item-what">commented</a>
																<span class="qa-c-item-when">
																	<span class="qa-c-item-when-data"><span class="published"><span class="value-title" title="2016-05-13T16:26:17+0000"></span>May 13, 2016</span></span>
																</span>
																<span class="qa-c-item-who">
																	<span class="qa-c-item-who-pad">by </span>
																	<span class="qa-c-item-who-data"><span class="vcard author"><a href="../../user/Kokett" class="qa-user-link url nickname">Kokett</a></span></span>
																	<span class="qa-c-item-who-title">FEniCS Novice</span>
																	<span class="qa-c-item-who-points">
																		<span class="qa-c-item-who-points-pad">(</span><span class="qa-c-item-who-points-data">300</span><span class="qa-c-item-who-points-pad"> points)</span>
																	</span>
																</span>
															</span>
														</span>
														<div class="qa-c-item-buttons">
														</div>
													</div>
													<div class="qa-c-item-clear">
													</div>
												</div> <!-- END qa-c-item -->
												<div class="qa-c-list-item  hentry comment" id="c10106">
													<div class="qa-c-item-content">
														<a name="10106"></a><div class="entry-content"><p>I inadvertently added a new answer instead of a reply. Sry about that. Lets continue discussing there.</p>
</div>
													</div>
													<div class="qa-c-item-footer">
														<span class="qa-c-item-avatar-meta">
															<span class="qa-c-item-meta">
																<a href="../../10068/solving-linear-system-in-parallel?show=10106#c10106" class="qa-c-item-what">commented</a>
																<span class="qa-c-item-when">
																	<span class="qa-c-item-when-data"><span class="published"><span class="value-title" title="2016-05-14T09:53:37+0000"></span>May 14, 2016</span></span>
																</span>
																<span class="qa-c-item-who">
																	<span class="qa-c-item-who-pad">by </span>
																	<span class="qa-c-item-who-data"><span class="vcard author"><a href="../../user/Kokett" class="qa-user-link url nickname">Kokett</a></span></span>
																	<span class="qa-c-item-who-title">FEniCS Novice</span>
																	<span class="qa-c-item-who-points">
																		<span class="qa-c-item-who-points-pad">(</span><span class="qa-c-item-who-points-data">300</span><span class="qa-c-item-who-points-pad"> points)</span>
																	</span>
																</span>
															</span>
														</span>
														<div class="qa-c-item-buttons">
														</div>
													</div>
													<div class="qa-c-item-clear">
													</div>
												</div> <!-- END qa-c-item -->
											</div> <!-- END qa-c-list -->
											
											<input type="hidden" name="code" value="0-1516467038-570c02049d2e000ba5e64ae4302d44c4f3377d41">
											<input type="hidden" name="qa_click" value="">
										</form>
										<div class="qa-c-form">
										</div> <!-- END qa-c-form -->
										
									</div> <!-- END qa-a-item-main -->
									<div class="qa-a-item-clear">
									</div>
								</div> <!-- END qa-a-list-item -->
								
								<div class="qa-a-list-item  hentry answer" id="a10105">
									<form method="post" action="../../10068/solving-linear-system-in-parallel">
										<div class="qa-voting qa-voting-net" id="voting_10105">
											<div class="qa-vote-count qa-vote-count-net">
												<span class="qa-netvote-count">
													<span class="qa-netvote-count-data">0<span class="votes-up"><span class="value-title" title="0"></span></span><span class="votes-down"><span class="value-title" title="0"></span></span></span><span class="qa-netvote-count-pad"> votes</span>
												</span>
											</div>
											<div class="qa-vote-clear">
											</div>
										</div>
										<input type="hidden" name="code" value="0-1516467038-72ee5248b84e25dc1c82648677ecb9a24e4a2f8b">
									</form>
									<div class="qa-a-item-main">
										<form method="post" action="../../10068/solving-linear-system-in-parallel">
											<div class="qa-a-selection">
											</div>
											<div class="qa-a-item-content">
												<a name="10105"></a><div class="entry-content"><p>I found the source of the error - though I have no solution yet.</p>

<p>The problem is the following: In my class NewtonSolver I initialise some help-Vectors of the following form with a init-list</p>

<pre><code>SemiSmoothNewtonSolver(... int len):
    help(MPI_COMM_WORLD, len)
{
....
}
</code></pre>

<p>where len is the (global) number of DOFs. I though this was a good idea to avoid reinitialisation of my help-vectors in each iteration. Here is a minimal working example (taken from the Poisson example file) to reconstruct the error. Works fine in serial, fails in parallel:</p>

<pre><code>class mySolver
{
public:
    Matrix* K;

    void sol(GenericVector&amp; u, int len)
    {
            Vector b(MPI_COMM_WORLD, len);

            b = 1;

            //each of the following lines produces some errors
            K-&gt;mult(b,u);
            solve(*K, u, b, "bicgstab", "hypre_amg");
    }
};


int main()
{
 // Create mesh and function space
 UnitSquareMesh mesh(32, 32);
 Poisson::FunctionSpace V(mesh);

// Define boundary condition
Constant u0(0.0);
DirichletBoundary boundary;
DirichletBC bc(V, u0, boundary);

// Define variational forms
Poisson::BilinearForm a(V, V);
Poisson::LinearForm L(V);

Source f;
dUdN g;
L.f = f;
L.g = g;


// Compute solution
Function u(V);

Matrix K;
Vector b;

assemble(K, a);
assemble(b,L);
bc.apply(K,b);


mySolver NewtonSolver;
NewtonSolver.K = &amp;K;


NewtonSolver.sol(*u.vector(), b.size());
//solve(K, *u.vector(), b, "bicgstab", "hypre_amg");


// Plot solution
plot(u);
interactive();

return 0;
}
</code></pre>

<p>How can i create a vector in each thread with 1s in of the correct size, such that the above multiplication and solve command is working?</p>
</div>
											</div>
											<span class="qa-a-item-avatar-meta">
												<span class="qa-a-item-meta">
													<a href="../../10068/solving-linear-system-in-parallel?show=10105#a10105" class="qa-a-item-what">answered</a>
													<span class="qa-a-item-when">
														<span class="qa-a-item-when-data"><span class="published"><span class="value-title" title="2016-05-14T09:50:59+0000"></span>May 14, 2016</span></span>
													</span>
													<span class="qa-a-item-who">
														<span class="qa-a-item-who-pad">by </span>
														<span class="qa-a-item-who-data"><span class="vcard author"><a href="../../user/Kokett" class="qa-user-link url nickname">Kokett</a></span></span>
														<span class="qa-a-item-who-title">FEniCS Novice</span>
														<span class="qa-a-item-who-points">
															<span class="qa-a-item-who-points-pad">(</span><span class="qa-a-item-who-points-data">300</span><span class="qa-a-item-who-points-pad"> points)</span>
														</span>
													</span>
												</span>
											</span>
											<div class="qa-a-item-buttons">
												</div>
											
											<div class="qa-a-item-c-list" id="c10105_list">
												<div class="qa-c-list-item  hentry comment" id="c10110">
													<div class="qa-c-item-content">
														<a name="10110"></a><div class="entry-content"><p>Okay here is a workaround (not very nice but working):</p>

<p>I assemble a vector with a LinearForm and use this vector to init my help-Vectors, so that the specific structure is copied:</p>

<pre><code>Vector vec_init;
assemble(vec_init, PoissonLinearForm);

[...]

SemiSmoothNewtonSolver(..., Vector&amp; _init):
     help(_init)
{
...
}
</code></pre>

<p>Now (nearly) everything works perfectly in parallel. Still some problems left, but I will figure that out. Thanks for your help!</p>
</div>
													</div>
													<div class="qa-c-item-footer">
														<span class="qa-c-item-avatar-meta">
															<span class="qa-c-item-meta">
																<a href="../../10068/solving-linear-system-in-parallel?show=10110#c10110" class="qa-c-item-what">commented</a>
																<span class="qa-c-item-when">
																	<span class="qa-c-item-when-data"><span class="published"><span class="value-title" title="2016-05-15T09:47:07+0000"></span>May 15, 2016</span></span>
																</span>
																<span class="qa-c-item-who">
																	<span class="qa-c-item-who-pad">by </span>
																	<span class="qa-c-item-who-data"><span class="vcard author"><a href="../../user/Kokett" class="qa-user-link url nickname">Kokett</a></span></span>
																	<span class="qa-c-item-who-title">FEniCS Novice</span>
																	<span class="qa-c-item-who-points">
																		<span class="qa-c-item-who-points-pad">(</span><span class="qa-c-item-who-points-data">300</span><span class="qa-c-item-who-points-pad"> points)</span>
																	</span>
																</span>
															</span>
														</span>
														<div class="qa-c-item-buttons">
														</div>
													</div>
													<div class="qa-c-item-clear">
													</div>
												</div> <!-- END qa-c-item -->
											</div> <!-- END qa-c-list -->
											
											<input type="hidden" name="code" value="0-1516467038-20cbe69e491ee77d26cc7b8692806267d600bdc9">
											<input type="hidden" name="qa_click" value="">
										</form>
										<div class="qa-c-form">
										</div> <!-- END qa-c-form -->
										
									</div> <!-- END qa-a-item-main -->
									<div class="qa-a-item-clear">
									</div>
								</div> <!-- END qa-a-list-item -->
								
							</div> <!-- END qa-a-list -->
							
						</div>
					</div> <!-- END qa-main -->
					
				</div> <!-- END main-wrapper -->
			</div> <!-- END main-shadow -->
		</div> <!-- END body-wrapper -->
		<!-- END footer-bottom-group -->
		
		<div style="position:absolute; left:-9999px; top:-9999px;">
			<span id="qa-waiting-template" class="qa-waiting">...</span>
		</div>
	
	

</body><!-- Powered by Question2Answer - http://www.question2answer.org/ --></html>