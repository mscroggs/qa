<html><!-- Powered by Question2Answer - http://www.question2answer.org/ --><head>
		<meta http-equiv="content-type" content="text/html; charset=utf-8">
		<title>Compute element-wise integral on subdomain - FEniCS Q&amp;A</title>
		<meta name="description" content="I want to know if there is a way to get the element-wise value of the integral of a functional.  ...  how to do it, so any help would be appreciated.">
		<meta name="keywords" content="integration,functional,elementwise">
		<link rel="stylesheet" type="text/css" href="../../qa-theme/Snow/qa-styles.css">
		<link rel="canonical" href="http://fenicsproject.org/qa/8830/compute-element-wise-integral-on-subdomain">
		<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
    tex2jax: {inlineMath: [["$","$"],["\\(","\\)"]]},
    TeX: { extensions: ["AMSmath.js","AMSsymbols.js"]}
  });
</script>
<script type="text/javascript" src="../../mathjax/MathJax.js"></script>
		<script src="../../jquery-1.7.2.min.js" type="text/javascript"></script>
		<script src="../../highlight.min.js"></script>
<script type="text/javascript">
$(function(){
	$('.wmd-input').keypress(function(){
		window.clearTimeout(hljs.Timeout);
		hljs.Timeout = window.setTimeout(function() {
			hljs.initHighlighting.called = false;
			hljs.initHighlighting();
		}, 500);
	});
	window.setTimeout(function() {
		hljs.initHighlighting.called = false;
		hljs.initHighlighting();
	}, 500);
});
</script>


	</head>
	<body class="qa-template-question qa-body-js-off">
		<div class="qa-body-wrapper">
			
			<div class="qa-header">
				<div class="qa-logo">
					<a href="../../" class="qa-logo-link" title="FEniCS Q&amp;A"><img src="../../qa-theme/fenics_qa.png" border="0" alt="FEniCS Q&amp;A"></a>
				</div>
				<div class="qa-header-clear">
				</div>
			</div> <!-- END qa-header -->
			
			<div class="qa-main-shadow">
				
				<div class="qa-main-wrapper">
					
					<div class="qa-sidepanel">
						<div class="qa-sidebar">
							This is a read only copy of the old FEniCS QA forum. Please visit the <a href="https://www.allanswered.com/community/s/fenics-project/">new QA forum</a> to ask questions
						</div>
						
					</div>
					
					<div class="qa-main">
						<h1>
							<span class="entry-title">Compute element-wise integral on subdomain</span>
						</h1>
						<div class="qa-part-q-view">
							<div class="qa-q-view  hentry question" id="q8830">
								<form method="post" action="../../8830/compute-element-wise-integral-on-subdomain">
									<div class="qa-q-view-stats">
										<div class="qa-voting qa-voting-net" id="voting_8830">
											<div class="qa-vote-count qa-vote-count-net">
												<span class="qa-netvote-count">
													<span class="qa-netvote-count-data">0<span class="votes-up"><span class="value-title" title="0"></span></span><span class="votes-down"><span class="value-title" title="0"></span></span></span><span class="qa-netvote-count-pad"> votes</span>
												</span>
											</div>
											<div class="qa-vote-clear">
											</div>
										</div>
									</div>
									<input type="hidden" name="code" value="0-1516468194-6686a2ec9867d14effbd23caf454fc38a4c3c140">
								</form>
								<div class="qa-q-view-main">
									<form method="post" action="../../8830/compute-element-wise-integral-on-subdomain">
										<div class="qa-q-view-content">
											<a name="8830"></a><div class="entry-content"><p>I want to know if there is a way to get the element-wise value of the integral of a functional.  The following code gives me the value of the integral over the whole boundary subdomain. </p>

<pre><code>f = inner(nabla_grad(u), nabla_grad(u))*ds(1)
E = assemble(f)
</code></pre>

<p>But I want to know if there is a way to get it by element. That is, if the boundary subdomain (marked as "1")  has "n" edges, then I want the value of each of the "n" integrals, that when added together match the value of the integral over the whole boundary subdomain (shown above). </p>

<p>The only solution that I can think of is to split the subdomain into "n" different subdomains and perform the integration. However I haven't figured out how to do it, so any help would be appreciated.</p>
</div>
										</div>
										<div class="qa-q-view-tags">
											<ul class="qa-q-view-tag-list">
												<li class="qa-q-view-tag-item"><a href="../../tag/integration" rel="tag" class="qa-tag-link">integration</a></li>
												<li class="qa-q-view-tag-item"><a href="../../tag/functional" rel="tag" class="qa-tag-link">functional</a></li>
												<li class="qa-q-view-tag-item"><a href="../../tag/elementwise" rel="tag" class="qa-tag-link">elementwise</a></li>
											</ul>
										</div>
										<span class="qa-q-view-avatar-meta">
											<span class="qa-q-view-meta">
												<a href="../../8830/compute-element-wise-integral-on-subdomain" class="qa-q-view-what">asked</a>
												<span class="qa-q-view-when">
													<span class="qa-q-view-when-data"><span class="published"><span class="value-title" title="2015-12-09T16:08:23+0000"></span>Dec 9, 2015</span></span>
												</span>
												<span class="qa-q-view-who">
													<span class="qa-q-view-who-pad">by </span>
													<span class="qa-q-view-who-data"><span class="vcard author"><a href="../../user/jgap61" class="qa-user-link url nickname">jgap61</a></span></span>
													<span class="qa-q-view-who-title">FEniCS Novice</span>
													<span class="qa-q-view-who-points">
														<span class="qa-q-view-who-points-pad">(</span><span class="qa-q-view-who-points-data">150</span><span class="qa-q-view-who-points-pad"> points)</span>
													</span>
												</span>
												<br>
												<span class="qa-q-view-what">edited</span>
												<span class="qa-q-view-when">
													<span class="qa-q-view-when-data"><span class="updated"><span class="value-title" title="2015-12-10T10:39:13+0000"></span>Dec 10, 2015</span></span>
												</span>
												<span class="qa-q-view-who">
													<span class="qa-q-view-who-pad">by </span><span class="qa-q-view-who-data"><a href="../../user/jgap61" class="qa-user-link url nickname">jgap61</a></span>
												</span>
											</span>
										</span>
										<div class="qa-q-view-buttons">
										</div>
										
										<div class="qa-q-view-c-list" style="display:none;" id="c8830_list">
										</div> <!-- END qa-c-list -->
										
										<input type="hidden" name="code" value="0-1516468194-5ccde9cfa16fcf25eff073bfafda8783ebc0cf6d">
										<input type="hidden" name="qa_click" value="">
									</form>
									<div class="qa-c-form">
									</div> <!-- END qa-c-form -->
									
								</div> <!-- END qa-q-view-main -->
								<div class="qa-q-view-clear">
								</div>
							</div> <!-- END qa-q-view -->
							
						</div>
						<div class="qa-part-a-list">
							<h2 id="a_list_title">1 Answer</h2>
							<div class="qa-a-list" id="a_list">
								
								<div class="qa-a-list-item  hentry answer answer-selected qa-a-list-item-selected" id="a8853">
									<form method="post" action="../../8830/compute-element-wise-integral-on-subdomain">
										<div class="qa-voting qa-voting-net" id="voting_8853">
											<div class="qa-vote-count qa-vote-count-net">
												<span class="qa-netvote-count">
													<span class="qa-netvote-count-data">+1<span class="votes-up"><span class="value-title" title="1"></span></span><span class="votes-down"><span class="value-title" title="0"></span></span></span><span class="qa-netvote-count-pad"> vote</span>
												</span>
											</div>
											<div class="qa-vote-clear">
											</div>
										</div>
										<input type="hidden" name="code" value="0-1516468194-6686a2ec9867d14effbd23caf454fc38a4c3c140">
									</form>
									<div class="qa-a-item-main">
										<form method="post" action="../../8830/compute-element-wise-integral-on-subdomain">
											<div class="qa-a-item-selected">
												<div class="qa-a-selection">
													<div class="qa-a-selected">&#160;</div>
													<div class="qa-a-selected-text">Best answer</div>
												</div>
												<div class="qa-a-item-content">
													<a name="8853"></a><div class="entry-content"><p>The master branch now has an <a rel="nofollow" href="https://bitbucket.org/fenics-project/dolfin/src/65b4fd3a28e55aa6b6bb90319e042fdb09e45c3e/site-packages/dolfin/fem/assembling_local.py?at=master&amp;fileviewer=file-view-default">assemble_local</a> function that does what you want. It takes a form and a cell. You will have to build FEniCS yourself to use it, or wait for the next release. Building FEniCS is quite easy if you use the scripts that are described on the <a rel="nofollow" href="http://fenicsproject.org/download/">web page</a> (fenics-install.sh), at least I was able to do it without too many problems.</p>

<p>You can most likely also split the domain into subdomains and use the current version of FEniCS. I guess you only need one subdomain and then change which cell is marked in a loop. I have not used subdomains much, so I would start by looking to see if there is a tutorial that uses subdomains.</p>
</div>
												</div>
												<span class="qa-a-item-avatar-meta">
													<span class="qa-a-item-meta">
														<a href="../../8830/compute-element-wise-integral-on-subdomain?show=8853#a8853" class="qa-a-item-what">answered</a>
														<span class="qa-a-item-when">
															<span class="qa-a-item-when-data"><span class="published"><span class="value-title" title="2015-12-14T17:51:13+0000"></span>Dec 14, 2015</span></span>
														</span>
														<span class="qa-a-item-who">
															<span class="qa-a-item-who-pad">by </span>
															<span class="qa-a-item-who-data"><span class="vcard author"><a href="../../user/Tormod+Landet" class="qa-user-link url nickname">Tormod Landet</a></span></span>
															<span class="qa-a-item-who-title">FEniCS User</span>
															<span class="qa-a-item-who-points">
																<span class="qa-a-item-who-points-pad">(</span><span class="qa-a-item-who-points-data">5,130</span><span class="qa-a-item-who-points-pad"> points)</span>
															</span>
														</span>
														<br>
														<span class="qa-a-item-what">selected</span>
														<span class="qa-a-item-when">
															<span class="qa-a-item-when-data"><span class="updated"><span class="value-title" title="2015-12-16T14:05:37+0000"></span>Dec 16, 2015</span></span>
														</span>
														<span class="qa-a-item-who">
															<span class="qa-a-item-who-pad">by </span><span class="qa-a-item-who-data"><a href="../../user/jgap61" class="qa-user-link url nickname">jgap61</a></span>
														</span>
													</span>
												</span>
											</div>
											<div class="qa-a-item-buttons">
												</div>
											
											<div class="qa-a-item-c-list" id="c8853_list">
												<div class="qa-c-list-item  hentry comment" id="c8856">
													<div class="qa-c-item-content">
														<a name="8856"></a><div class="entry-content"><p>Thanks for the answer Tormod</p>

<p>I am getting closer now, however the code is still not working. I am doing something wrong with the cells, maybe you can tell:</p>

<pre><code>All_edges = SubsetIterator(boundary_parts, 1)
E_t = 0.0
for cell in All_edges:
     f = inner(nabla_grad(u), nabla_grad(u))*ds(1)
     E = assemble_local(f, cell)
     E_t += E
print E_t
</code></pre>

<p>Which returns the TypeError:</p>

<blockquote>
  <p>** TypeError: in method 'assemble_local', argument 2 of type 'dolfin::Cell const &amp;' **</p>
</blockquote>

<p>So clearly "cell" is not a cell, I have also tried:</p>

<pre><code>All_edges = SubsetIterator(boundary_parts, 1)
E_t = 0.0
for edge in All_edges:
     cell = Cell(mesh, edge.index())
     f = inner(nabla_grad(u), nabla_grad(u))*ds(1)
     E = assemble_local(f, cell)
     E_t += E
print E_t
</code></pre>

<p>Which returns zeros at the first computed values and errors in the next ones presumably because the index is out of range.</p>

<blockquote>
  <p>** Error:   Unable to create mesh entity.<br>
  **  Reason:  Mesh entity index 4987 out of range [0, 4938] for entity of dimension 2.</p>
</blockquote>

<p>Which is confusing because the iterator said there were more entities:</p>

<blockquote>
  <p>** Iterating over subset, found 16 entities out of 7556. **</p>
</blockquote>

<p>So am I confusing cells with facets?, Instead of "Cell" I have also tried using "Facet" but then TypeError comes back. <br>
Any help would be great!</p>
</div>
													</div>
													<div class="qa-c-item-footer">
														<span class="qa-c-item-avatar-meta">
															<span class="qa-c-item-meta">
																<a href="../../8830/compute-element-wise-integral-on-subdomain?show=8856#c8856" class="qa-c-item-what">commented</a>
																<span class="qa-c-item-when">
																	<span class="qa-c-item-when-data"><span class="published"><span class="value-title" title="2015-12-14T21:21:40+0000"></span>Dec 14, 2015</span></span>
																</span>
																<span class="qa-c-item-who">
																	<span class="qa-c-item-who-pad">by </span>
																	<span class="qa-c-item-who-data"><span class="vcard author"><a href="../../user/jgap61" class="qa-user-link url nickname">jgap61</a></span></span>
																	<span class="qa-c-item-who-title">FEniCS Novice</span>
																	<span class="qa-c-item-who-points">
																		<span class="qa-c-item-who-points-pad">(</span><span class="qa-c-item-who-points-data">150</span><span class="qa-c-item-who-points-pad"> points)</span>
																	</span>
																</span>
																<br>
																<span class="qa-c-item-what">edited</span>
																<span class="qa-c-item-when">
																	<span class="qa-c-item-when-data"><span class="updated"><span class="value-title" title="2015-12-16T11:08:35+0000"></span>Dec 16, 2015</span></span>
																</span>
																<span class="qa-c-item-who">
																	<span class="qa-c-item-who-pad">by </span><span class="qa-c-item-who-data"><a href="../../user/jgap61" class="qa-user-link url nickname">jgap61</a></span>
																</span>
															</span>
														</span>
														<div class="qa-c-item-buttons">
														</div>
													</div>
													<div class="qa-c-item-clear">
													</div>
												</div> <!-- END qa-c-item -->
												<div class="qa-c-list-item  hentry comment" id="c8863">
													<div class="qa-c-item-content">
														<a name="8863"></a><div class="entry-content"><p>You need to pass it a Cell object. Just get the index of the cell connected to the facet and pass this cell, Cell(mesh, cell_index). For cells with multiple ds facets (multiple external facets) you will have to use a FacetFunction to mark the facet you are interested in. It will probably be quite a lot faster than integrating globally, but you will need the marking function.</p>

<p>As far as I know all assembly routines in dolfin takes a cell and iterates over interior, interior and exterior facets and points, you cannot assemble over a facet on its own</p>
</div>
													</div>
													<div class="qa-c-item-footer">
														<span class="qa-c-item-avatar-meta">
															<span class="qa-c-item-meta">
																<a href="../../8830/compute-element-wise-integral-on-subdomain?show=8863#c8863" class="qa-c-item-what">commented</a>
																<span class="qa-c-item-when">
																	<span class="qa-c-item-when-data"><span class="published"><span class="value-title" title="2015-12-16T12:14:41+0000"></span>Dec 16, 2015</span></span>
																</span>
																<span class="qa-c-item-who">
																	<span class="qa-c-item-who-pad">by </span>
																	<span class="qa-c-item-who-data"><span class="vcard author"><a href="../../user/Tormod+Landet" class="qa-user-link url nickname">Tormod Landet</a></span></span>
																	<span class="qa-c-item-who-title">FEniCS User</span>
																	<span class="qa-c-item-who-points">
																		<span class="qa-c-item-who-points-pad">(</span><span class="qa-c-item-who-points-data">5,130</span><span class="qa-c-item-who-points-pad"> points)</span>
																	</span>
																</span>
															</span>
														</span>
														<div class="qa-c-item-buttons">
														</div>
													</div>
													<div class="qa-c-item-clear">
													</div>
												</div> <!-- END qa-c-item -->
												<div class="qa-c-list-item  hentry comment" id="c8866">
													<div class="qa-c-item-content">
														<a name="8866"></a><div class="entry-content"><p>Thanks a lot Tormod!<br>
 It works as expected!</p>

<p>Posting here my final solution:</p>

<pre><code>D = mesh.topology().dim()
# Build connectivity between facets and cells
mesh.init(D-1,D) 
# Initialize total 
E_t = 0.0
for edge in SubsetIterator(boundary_parts, 1):
    cell = Cell(mesh, edge.entities(D)[0])
    f = inner(nabla_grad(u), nabla_grad(u))*ds(1)
    E = assemble_local(f, cell)
    E_t += E
print E_t
</code></pre>

<p>If there are facets with 2 or more cells assigned the following line should be changed:</p>

<pre><code>cell = Cell(mesh, edge.entities(D)[0])
</code></pre>
</div>
													</div>
													<div class="qa-c-item-footer">
														<span class="qa-c-item-avatar-meta">
															<span class="qa-c-item-meta">
																<a href="../../8830/compute-element-wise-integral-on-subdomain?show=8866#c8866" class="qa-c-item-what">commented</a>
																<span class="qa-c-item-when">
																	<span class="qa-c-item-when-data"><span class="published"><span class="value-title" title="2015-12-16T14:05:26+0000"></span>Dec 16, 2015</span></span>
																</span>
																<span class="qa-c-item-who">
																	<span class="qa-c-item-who-pad">by </span>
																	<span class="qa-c-item-who-data"><span class="vcard author"><a href="../../user/jgap61" class="qa-user-link url nickname">jgap61</a></span></span>
																	<span class="qa-c-item-who-title">FEniCS Novice</span>
																	<span class="qa-c-item-who-points">
																		<span class="qa-c-item-who-points-pad">(</span><span class="qa-c-item-who-points-data">150</span><span class="qa-c-item-who-points-pad"> points)</span>
																	</span>
																</span>
															</span>
														</span>
														<div class="qa-c-item-buttons">
														</div>
													</div>
													<div class="qa-c-item-clear">
													</div>
												</div> <!-- END qa-c-item -->
											</div> <!-- END qa-c-list -->
											
											<input type="hidden" name="code" value="0-1516468194-1cf413a15466a3b91773ebe731dd5e206f4fdad7">
											<input type="hidden" name="qa_click" value="">
										</form>
										<div class="qa-c-form">
										</div> <!-- END qa-c-form -->
										
									</div> <!-- END qa-a-item-main -->
									<div class="qa-a-item-clear">
									</div>
								</div> <!-- END qa-a-list-item -->
								
							</div> <!-- END qa-a-list -->
							
						</div>
					</div> <!-- END qa-main -->
					
				</div> <!-- END main-wrapper -->
			</div> <!-- END main-shadow -->
		</div> <!-- END body-wrapper -->
		<!-- END footer-bottom-group -->
		
		<div style="position:absolute; left:-9999px; top:-9999px;">
			<span id="qa-waiting-template" class="qa-waiting">...</span>
		</div>
	
	

</body><!-- Powered by Question2Answer - http://www.question2answer.org/ --></html>