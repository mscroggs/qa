<html><!-- Powered by Question2Answer - http://www.question2answer.org/ --><head>
		<meta http-equiv="content-type" content="text/html; charset=utf-8">
		<title>How to compute residual of adjoint functional with dolfin-adjoint? - FEniCS Q&amp;A</title>
		<meta name="description" content="There is a function which computes solution of adjoint problem: http://www.dolfin-adjoint.org/en/latest/ ... inside C library libadjoint? ----------">
		<meta name="keywords" content="dolfin-adjoint,adjoint,residuals,functional,error-estimate">
		<link rel="stylesheet" type="text/css" href="../../qa-theme/Snow/qa-styles.css">
		<link rel="canonical" href="http://fenicsproject.org/qa/13008/how-compute-residual-adjoint-functional-with-dolfin-adjoint">
		<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
    tex2jax: {inlineMath: [["$","$"],["\\(","\\)"]]},
    TeX: { extensions: ["AMSmath.js","AMSsymbols.js"]}
  });
</script>
<script type="text/javascript" src="../../mathjax/MathJax.js"></script>
		<script src="../../jquery-1.7.2.min.js" type="text/javascript"></script>
		<script src="../../highlight.min.js"></script>
<script type="text/javascript">
$(function(){
	$('.wmd-input').keypress(function(){
		window.clearTimeout(hljs.Timeout);
		hljs.Timeout = window.setTimeout(function() {
			hljs.initHighlighting.called = false;
			hljs.initHighlighting();
		}, 500);
	});
	window.setTimeout(function() {
		hljs.initHighlighting.called = false;
		hljs.initHighlighting();
	}, 500);
});
</script>


	</head>
	<body class="qa-template-question qa-body-js-off">
		<div class="qa-body-wrapper">
			
			<div class="qa-header">
				<div class="qa-logo">
					<a href="../../" class="qa-logo-link" title="FEniCS Q&amp;A"><img src="../../qa-theme/fenics_qa.png" border="0" alt="FEniCS Q&amp;A"></a>
				</div>
				<div class="qa-header-clear">
				</div>
			</div> <!-- END qa-header -->
			
			<div class="qa-main-shadow">
				
				<div class="qa-main-wrapper">
					
					<div class="qa-sidepanel">
						<div class="qa-sidebar">
							This is a read only copy of the old FEniCS QA forum. Please visit the <a href="https://www.allanswered.com/community/s/fenics-project/">new QA forum</a> to ask questions
						</div>
						
					</div>
					
					<div class="qa-main">
						<h1>
							<span class="entry-title">How to compute residual of adjoint functional with dolfin-adjoint?</span>
						</h1>
						<div class="qa-part-q-view">
							<div class="qa-q-view  hentry question" id="q13008">
								<form method="post" action="../../13008/how-compute-residual-adjoint-functional-with-dolfin-adjoint">
									<div class="qa-q-view-stats">
										<div class="qa-voting qa-voting-net" id="voting_13008">
											<div class="qa-vote-count qa-vote-count-net">
												<span class="qa-netvote-count">
													<span class="qa-netvote-count-data">+1<span class="votes-up"><span class="value-title" title="1"></span></span><span class="votes-down"><span class="value-title" title="0"></span></span></span><span class="qa-netvote-count-pad"> vote</span>
												</span>
											</div>
											<div class="qa-vote-clear">
											</div>
										</div>
									</div>
									<input type="hidden" name="code" value="0-1516467849-872e64f5ea6261721b9bc8cce72f13d8d451df32">
								</form>
								<div class="qa-q-view-main">
									<form method="post" action="../../13008/how-compute-residual-adjoint-functional-with-dolfin-adjoint">
										<div class="qa-q-view-content">
											<a name="13008"></a><div class="entry-content"><p>There is a function which computes solution of adjoint problem: <a rel="nofollow" href="http://www.dolfin-adjoint.org/en/latest/documentation/api.html#dolfin_adjoint.compute_adjoint">http://www.dolfin-adjoint.org/en/latest/documentation/api.html#dolfin_adjoint.compute_adjoint</a></p>

<pre><code>J = Functional(inner(u, u)*dx*dt[FINISH_TIME])
for (variable, solution) in compute_adjoint(J):
</code></pre>

<p>But I need not only solution, but also its residual. So, I need adjoint equations. I thought it should be somewhere in adjointer class, but I grepped the source code and it seems there is no way to get it. I think I'm missing something, because how could dolfin adjoint find solution without forming the equations first? Or is those steps are hidden inside C library libadjoint?</p>

<hr>
</div>
										</div>
										<div class="qa-q-view-tags">
											<ul class="qa-q-view-tag-list">
												<li class="qa-q-view-tag-item"><a href="../../tag/dolfin-adjoint" rel="tag" class="qa-tag-link">dolfin-adjoint</a></li>
												<li class="qa-q-view-tag-item"><a href="../../tag/adjoint" rel="tag" class="qa-tag-link">adjoint</a></li>
												<li class="qa-q-view-tag-item"><a href="../../tag/residuals" rel="tag" class="qa-tag-link">residuals</a></li>
												<li class="qa-q-view-tag-item"><a href="../../tag/functional" rel="tag" class="qa-tag-link">functional</a></li>
												<li class="qa-q-view-tag-item"><a href="../../tag/error-estimate" rel="tag" class="qa-tag-link">error-estimate</a></li>
											</ul>
										</div>
										<span class="qa-q-view-avatar-meta">
											<span class="qa-q-view-meta">
												<a href="../../13008/how-compute-residual-adjoint-functional-with-dolfin-adjoint" class="qa-q-view-what">asked</a>
												<span class="qa-q-view-when">
													<span class="qa-q-view-when-data"><span class="published"><span class="value-title" title="2017-04-09T14:07:49+0000"></span>Apr 9, 2017</span></span>
												</span>
												<span class="qa-q-view-who">
													<span class="qa-q-view-who-pad">by </span>
													<span class="qa-q-view-who-data"><span class="vcard author"><a href="../../user/gtt" class="qa-user-link url nickname">gtt</a></span></span>
													<span class="qa-q-view-who-title">FEniCS Novice</span>
													<span class="qa-q-view-who-points">
														<span class="qa-q-view-who-points-pad">(</span><span class="qa-q-view-who-points-data">630</span><span class="qa-q-view-who-points-pad"> points)</span>
													</span>
												</span>
											</span>
										</span>
										<div class="qa-q-view-buttons">
										</div>
										
										<div class="qa-q-view-c-list" id="c13008_list">
											<div class="qa-c-list-item  hentry comment" id="c13748">
												<div class="qa-c-item-content">
													<a name="13748"></a><div class="entry-content"><p>Why the residual? The adjoint equation is linear and it is solved exactly by dolfin-adjoint. The residual should be zero.</p>
</div>
												</div>
												<div class="qa-c-item-footer">
													<span class="qa-c-item-avatar-meta">
														<span class="qa-c-item-meta">
															<a href="../../13008/how-compute-residual-adjoint-functional-with-dolfin-adjoint?show=13748#c13748" class="qa-c-item-what">commented</a>
															<span class="qa-c-item-when">
																<span class="qa-c-item-when-data"><span class="published"><span class="value-title" title="2017-05-31T19:23:48+0000"></span>May 31, 2017</span></span>
															</span>
															<span class="qa-c-item-who">
																<span class="qa-c-item-who-pad">by </span>
																<span class="qa-c-item-who-data"><span class="vcard author"><a href="../../user/miguelito" class="qa-user-link url nickname">miguelito</a></span></span>
																<span class="qa-c-item-who-title">FEniCS Novice</span>
																<span class="qa-c-item-who-points">
																	<span class="qa-c-item-who-points-pad">(</span><span class="qa-c-item-who-points-data">760</span><span class="qa-c-item-who-points-pad"> points)</span>
																</span>
															</span>
														</span>
													</span>
													<div class="qa-c-item-buttons">
													</div>
												</div>
												<div class="qa-c-item-clear">
												</div>
											</div> <!-- END qa-c-item -->
											<div class="qa-c-list-item  hentry comment" id="c13757">
												<div class="qa-c-item-content">
													<a name="13757"></a><div class="entry-content"><p>1) Depending on condition number of system residual may not be close to zero, but you have a point.<br>
2) Assuming I have non-linear equation, will residual of adjoint equation still be zero?</p>
</div>
												</div>
												<div class="qa-c-item-footer">
													<span class="qa-c-item-avatar-meta">
														<span class="qa-c-item-meta">
															<a href="../../13008/how-compute-residual-adjoint-functional-with-dolfin-adjoint?show=13757#c13757" class="qa-c-item-what">commented</a>
															<span class="qa-c-item-when">
																<span class="qa-c-item-when-data"><span class="published"><span class="value-title" title="2017-06-01T10:30:02+0000"></span>Jun 1, 2017</span></span>
															</span>
															<span class="qa-c-item-who">
																<span class="qa-c-item-who-pad">by </span>
																<span class="qa-c-item-who-data"><span class="vcard author"><a href="../../user/gtt" class="qa-user-link url nickname">gtt</a></span></span>
																<span class="qa-c-item-who-title">FEniCS Novice</span>
																<span class="qa-c-item-who-points">
																	<span class="qa-c-item-who-points-pad">(</span><span class="qa-c-item-who-points-data">630</span><span class="qa-c-item-who-points-pad"> points)</span>
																</span>
															</span>
														</span>
													</span>
													<div class="qa-c-item-buttons">
													</div>
												</div>
												<div class="qa-c-item-clear">
												</div>
											</div> <!-- END qa-c-item -->
											<div class="qa-c-list-item  hentry comment" id="c13767">
												<div class="qa-c-item-content">
													<a name="13767"></a><div class="entry-content"><p>The adjoint equation is always linear. Yes, if you use an iterative solver and decide to stop it with a high tolerance, the residual will not be zero. This could be useful in early iterations of an optimization when you don't need the gradient to be very accurate. What's your equation and what are you trying to do?</p>
</div>
												</div>
												<div class="qa-c-item-footer">
													<span class="qa-c-item-avatar-meta">
														<span class="qa-c-item-meta">
															<a href="../../13008/how-compute-residual-adjoint-functional-with-dolfin-adjoint?show=13767#c13767" class="qa-c-item-what">commented</a>
															<span class="qa-c-item-when">
																<span class="qa-c-item-when-data"><span class="published"><span class="value-title" title="2017-06-01T14:03:08+0000"></span>Jun 1, 2017</span></span>
															</span>
															<span class="qa-c-item-who">
																<span class="qa-c-item-who-pad">by </span>
																<span class="qa-c-item-who-data"><span class="vcard author"><a href="../../user/miguelito" class="qa-user-link url nickname">miguelito</a></span></span>
																<span class="qa-c-item-who-title">FEniCS Novice</span>
																<span class="qa-c-item-who-points">
																	<span class="qa-c-item-who-points-pad">(</span><span class="qa-c-item-who-points-data">760</span><span class="qa-c-item-who-points-pad"> points)</span>
																</span>
															</span>
														</span>
													</span>
													<div class="qa-c-item-buttons">
													</div>
												</div>
												<div class="qa-c-item-clear">
												</div>
											</div> <!-- END qa-c-item -->
											<div class="qa-c-list-item  hentry comment" id="c13844">
												<div class="qa-c-item-content">
													<a name="13844"></a><div class="entry-content"><p>I'm trying to implement error analysis from <a rel="nofollow" href="http://www.dolfin-adjoint.org/en/latest/documentation/maths/5-applications.html">http://www.dolfin-adjoint.org/en/latest/documentation/maths/5-applications.html</a> </p>

<p>Also, I'm struggling with something which is like very simple task: I want to compute gradient of reduced functional J_hat by lib-adjoint to implement certain optimization method manually:<br>
dJdm = J_hat.derivative()<br>
a = a + dJdm<br>
but dolfin says "a" and "dJdm" are of different types.</p>
</div>
												</div>
												<div class="qa-c-item-footer">
													<span class="qa-c-item-avatar-meta">
														<span class="qa-c-item-meta">
															<a href="../../13008/how-compute-residual-adjoint-functional-with-dolfin-adjoint?show=13844#c13844" class="qa-c-item-what">commented</a>
															<span class="qa-c-item-when">
																<span class="qa-c-item-when-data"><span class="published"><span class="value-title" title="2017-06-06T23:35:37+0000"></span>Jun 7, 2017</span></span>
															</span>
															<span class="qa-c-item-who">
																<span class="qa-c-item-who-pad">by </span>
																<span class="qa-c-item-who-data"><span class="vcard author"><a href="../../user/gtt" class="qa-user-link url nickname">gtt</a></span></span>
																<span class="qa-c-item-who-title">FEniCS Novice</span>
																<span class="qa-c-item-who-points">
																	<span class="qa-c-item-who-points-pad">(</span><span class="qa-c-item-who-points-data">630</span><span class="qa-c-item-who-points-pad"> points)</span>
																</span>
															</span>
														</span>
													</span>
													<div class="qa-c-item-buttons">
													</div>
												</div>
												<div class="qa-c-item-clear">
												</div>
											</div> <!-- END qa-c-item -->
										</div> <!-- END qa-c-list -->
										
										<input type="hidden" name="code" value="0-1516467849-84c419c3489f3384738f19fe9bd743029e38874c">
										<input type="hidden" name="qa_click" value="">
									</form>
									<div class="qa-c-form">
									</div> <!-- END qa-c-form -->
									
								</div> <!-- END qa-q-view-main -->
								<div class="qa-q-view-clear">
								</div>
							</div> <!-- END qa-q-view -->
							
						</div>
						<div class="qa-part-a-list">
							<h2 id="a_list_title" style="display:none;"></h2>
							<div class="qa-a-list" id="a_list">
								
							</div> <!-- END qa-a-list -->
							
						</div>
					</div> <!-- END qa-main -->
					
				</div> <!-- END main-wrapper -->
			</div> <!-- END main-shadow -->
		</div> <!-- END body-wrapper -->
		<!-- END footer-bottom-group -->
		
		<div style="position:absolute; left:-9999px; top:-9999px;">
			<span id="qa-waiting-template" class="qa-waiting">...</span>
		</div>
	
	

</body><!-- Powered by Question2Answer - http://www.question2answer.org/ --></html>