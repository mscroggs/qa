<html><!-- Powered by Question2Answer - http://www.question2answer.org/ --><head>
		<meta http-equiv="content-type" content="text/html; charset=utf-8">
		<title>Adding a random perturbation to a solution at each time step - FEniCS Q&amp;A</title>
		<meta name="description" content="My code solves a system of reaction-diffusion equations on a spherical shape. The system is solved at  ... of the code roughly look like this: while t">
		<link rel="stylesheet" type="text/css" href="../../qa-theme/Snow/qa-styles.css">
		<link rel="canonical" href="http://fenicsproject.org/qa/1484/adding-a-random-perturbation-to-a-solution-at-each-time-step">
		<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
    tex2jax: {inlineMath: [["$","$"],["\\(","\\)"]]},
    TeX: { extensions: ["AMSmath.js","AMSsymbols.js"]}
  });
</script>
<script type="text/javascript" src="../../mathjax/MathJax.js"></script>
		<script src="../../jquery-1.7.2.min.js" type="text/javascript"></script>
		<script src="../../highlight.min.js"></script>
<script type="text/javascript">
$(function(){
	$('.wmd-input').keypress(function(){
		window.clearTimeout(hljs.Timeout);
		hljs.Timeout = window.setTimeout(function() {
			hljs.initHighlighting.called = false;
			hljs.initHighlighting();
		}, 500);
	});
	window.setTimeout(function() {
		hljs.initHighlighting.called = false;
		hljs.initHighlighting();
	}, 500);
});
</script>


	</head>
	<body class="qa-template-question qa-body-js-off">
		<div class="qa-body-wrapper">
			
			<div class="qa-header">
				<div class="qa-logo">
					<a href="../../" class="qa-logo-link" title="FEniCS Q&amp;A"><img src="../../qa-theme/fenics_qa.png" border="0" alt="FEniCS Q&amp;A"></a>
				</div>
				<div class="qa-header-clear">
				</div>
			</div> <!-- END qa-header -->
			
			<div class="qa-main-shadow">
				
				<div class="qa-main-wrapper">
					
					<div class="qa-sidepanel">
						<div class="qa-sidebar">
							This is a read only copy of the old FEniCS QA forum. Please visit the <a href="https://www.allanswered.com/community/s/fenics-project/">new QA forum</a> to ask questions
						</div>
						
					</div>
					
					<div class="qa-main">
						<h1>
							<span class="entry-title">Adding a random perturbation to a solution at each time step</span>
						</h1>
						<div class="qa-part-q-view">
							<div class="qa-q-view  hentry question" id="q1484">
								<form method="post" action="../../1484/adding-a-random-perturbation-to-a-solution-at-each-time-step">
									<div class="qa-q-view-stats">
										<div class="qa-voting qa-voting-net" id="voting_1484">
											<div class="qa-vote-count qa-vote-count-net">
												<span class="qa-netvote-count">
													<span class="qa-netvote-count-data">0<span class="votes-up"><span class="value-title" title="0"></span></span><span class="votes-down"><span class="value-title" title="0"></span></span></span><span class="qa-netvote-count-pad"> votes</span>
												</span>
											</div>
											<div class="qa-vote-clear">
											</div>
										</div>
									</div>
									<input type="hidden" name="code" value="0-1516467889-716d0882f78618878b450788fe63f0f3644a5d04">
								</form>
								<div class="qa-q-view-main">
									<form method="post" action="../../1484/adding-a-random-perturbation-to-a-solution-at-each-time-step">
										<div class="qa-q-view-content">
											<a name="1484"></a><div class="entry-content"><p>My code solves a system of reaction-diffusion equations on a spherical shape. The system is solved at each time step, and I wish to add a small random perturbation to each solution as they will become the initial conditions for the next time step integration. The one caveat is that it could be the case that only a subset of the solution needs to be updated, e.g., the elements where the z &gt; 0.5 on a unit sphere.</p>

<p>I suspect there must be a simple way of doing this, but I haven't been able to figure it out. </p>

<p>The guts of the code roughly look like this:</p>

<p>while t &lt;= T:<br>
    b_u1 = assemble(L_u1, tensor = b_u1)<br>
    bc_u1.apply(A_u1, b_u1)<br>
    solve(A_u1, u1.vector(), b_u1)<br>
    t += dt<br>
    u1_old.assign(u1)</p>
</div>
										</div>
										<span class="qa-q-view-avatar-meta">
											<span class="qa-q-view-meta">
												<a href="../../1484/adding-a-random-perturbation-to-a-solution-at-each-time-step" class="qa-q-view-what">asked</a>
												<span class="qa-q-view-when">
													<span class="qa-q-view-when-data"><span class="published"><span class="value-title" title="2013-10-25T17:33:15+0000"></span>Oct 25, 2013</span></span>
												</span>
												<span class="qa-q-view-who">
													<span class="qa-q-view-who-pad">by </span>
													<span class="qa-q-view-who-data"><span class="vcard author"><a href="../../user/irozada" class="qa-user-link url nickname">irozada</a></span></span>
													<span class="qa-q-view-who-title">FEniCS Novice</span>
													<span class="qa-q-view-who-points">
														<span class="qa-q-view-who-points-pad">(</span><span class="qa-q-view-who-points-data">330</span><span class="qa-q-view-who-points-pad"> points)</span>
													</span>
												</span>
											</span>
										</span>
										<div class="qa-q-view-buttons">
										</div>
										
										<div class="qa-q-view-c-list" style="display:none;" id="c1484_list">
										</div> <!-- END qa-c-list -->
										
										<input type="hidden" name="code" value="0-1516467889-767071f18481ec621389a8980060e1a553dd4974">
										<input type="hidden" name="qa_click" value="">
									</form>
									<div class="qa-c-form">
									</div> <!-- END qa-c-form -->
									
								</div> <!-- END qa-q-view-main -->
								<div class="qa-q-view-clear">
								</div>
							</div> <!-- END qa-q-view -->
							
						</div>
						<div class="qa-part-a-list">
							<h2 id="a_list_title">1 Answer</h2>
							<div class="qa-a-list" id="a_list">
								
								<div class="qa-a-list-item  hentry answer answer-selected qa-a-list-item-selected" id="a1492">
									<form method="post" action="../../1484/adding-a-random-perturbation-to-a-solution-at-each-time-step">
										<div class="qa-voting qa-voting-net" id="voting_1492">
											<div class="qa-vote-count qa-vote-count-net">
												<span class="qa-netvote-count">
													<span class="qa-netvote-count-data">+2<span class="votes-up"><span class="value-title" title="2"></span></span><span class="votes-down"><span class="value-title" title="0"></span></span></span><span class="qa-netvote-count-pad"> votes</span>
												</span>
											</div>
											<div class="qa-vote-clear">
											</div>
										</div>
										<input type="hidden" name="code" value="0-1516467889-716d0882f78618878b450788fe63f0f3644a5d04">
									</form>
									<div class="qa-a-item-main">
										<form method="post" action="../../1484/adding-a-random-perturbation-to-a-solution-at-each-time-step">
											<div class="qa-a-item-selected">
												<div class="qa-a-selection">
													<div class="qa-a-selected">&#160;</div>
													<div class="qa-a-selected-text">Best answer</div>
												</div>
												<div class="qa-a-item-content">
													<a name="1492"></a><div class="entry-content"><p>Hi,</p>

<p>I guess there are several ways of doing this. The Cahn-Hilliard demo contains an example of how to generate initial conditions using random values in an Expression. A simple solution to your problem (neglecting caveat) could be:</p>

<pre><code>from numpy import random
eps = 0.001 # Weight of random number
while t &lt;= T:
    b_u1 = assemble(L_u1, tensor = b_u1)
    bc_u1.apply(A_u1, b_u1)
    solve(A_u1, u1.vector(), b_u1)
    t += dt
    u1_old.vector().set_local(u1.vector().array()+eps*(0.5-random.random(u1.vector().size())))
</code></pre>

<p>If you only want to add pertubations to some part of your problem you can, e.g., mark this using a SubDomain or use an Expression that evaluates only in that domain, like</p>

<pre><code>class OuterPart(Expression):
    def eval(self, values, x):
        if sqrt(x[0]**2+x[1]**2+x[2]**2) &gt; 0.5:
            values[0] = 0.01*(0.5 - random.random())
</code></pre>

<p>You would have to interpolate this Expression onto the function space of u1 each timestep and then add it, like</p>

<pre><code>pert = interpolate(OuterPart(), V)
u1_old.assign(u1)
u1_old.vector().axpy(1.0, pert.vector())
</code></pre>

<p>There may be more efficient ways. Perhaps this is better:</p>

<pre><code>radius = interpolate(Expression("sqrt(x[0]*x[0]+x[1]*x[1]+x[2]*x[2])"), V)
num_dofs_perturbed = radius.vector()[radius.vector()&gt;0.5].size()
u1_old.assign(u1)
u1_old.vector()[radius.vector()&gt;0.5] += 0.01*(0.5-random.random(num_dofs_perturbed))
</code></pre>

<p>where the first two lines are precomputed and only the last two lines go inside your while loop.</p>
</div>
												</div>
												<span class="qa-a-item-avatar-meta">
													<span class="qa-a-item-avatar">
														<a href="../../user/mikael-mortensen" class="qa-avatar-link"><img src="https://www.gravatar.com/avatar/d5614112a2818f1800a461e49ac229df?s=40" width="40" height="40" class="qa-avatar-image" alt=""></a>
													</span>
													<span class="qa-a-item-meta">
														<a href="../../1484/adding-a-random-perturbation-to-a-solution-at-each-time-step?show=1492#a1492" class="qa-a-item-what">answered</a>
														<span class="qa-a-item-when">
															<span class="qa-a-item-when-data"><span class="published"><span class="value-title" title="2013-10-27T12:25:45+0000"></span>Oct 27, 2013</span></span>
														</span>
														<span class="qa-a-item-who">
															<span class="qa-a-item-who-pad">by </span>
															<span class="qa-a-item-who-data"><span class="vcard author"><a href="../../user/mikael-mortensen" class="qa-user-link url nickname">mikael-mortensen</a></span></span>
															<span class="qa-a-item-who-title">FEniCS Expert</span>
															<span class="qa-a-item-who-points">
																<span class="qa-a-item-who-points-pad">(</span><span class="qa-a-item-who-points-data">29,340</span><span class="qa-a-item-who-points-pad"> points)</span>
															</span>
														</span>
														<br>
														<span class="qa-a-item-what">selected</span>
														<span class="qa-a-item-when">
															<span class="qa-a-item-when-data"><span class="updated"><span class="value-title" title="2013-10-28T17:15:32+0000"></span>Oct 28, 2013</span></span>
														</span>
														<span class="qa-a-item-who">
															<span class="qa-a-item-who-pad">by </span><span class="qa-a-item-who-data"><a href="../../user/irozada" class="qa-user-link url nickname">irozada</a></span>
														</span>
													</span>
												</span>
											</div>
											<div class="qa-a-item-buttons">
												</div>
											
											<div class="qa-a-item-c-list" id="c1492_list">
												<div class="qa-c-list-item  hentry comment" id="c1552">
													<div class="qa-c-item-content">
														<a name="1552"></a><div class="entry-content"><p>I altered the top suggestion to</p>

<p>u2_old.vector().set_local(u2.vector().array()+0.01*randn())</p>

<p>and it works great, thank you!</p>
</div>
													</div>
													<div class="qa-c-item-footer">
														<span class="qa-c-item-avatar-meta">
															<span class="qa-c-item-meta">
																<a href="../../1484/adding-a-random-perturbation-to-a-solution-at-each-time-step?show=1552#c1552" class="qa-c-item-what">commented</a>
																<span class="qa-c-item-when">
																	<span class="qa-c-item-when-data"><span class="published"><span class="value-title" title="2013-10-31T18:52:35+0000"></span>Oct 31, 2013</span></span>
																</span>
																<span class="qa-c-item-who">
																	<span class="qa-c-item-who-pad">by </span>
																	<span class="qa-c-item-who-data"><span class="vcard author"><a href="../../user/David+Holloway" class="qa-user-link url nickname">David Holloway</a></span></span>
																	<span class="qa-c-item-who-title">FEniCS Novice</span>
																	<span class="qa-c-item-who-points">
																		<span class="qa-c-item-who-points-pad">(</span><span class="qa-c-item-who-points-data">170</span><span class="qa-c-item-who-points-pad"> points)</span>
																	</span>
																</span>
															</span>
														</span>
														<div class="qa-c-item-buttons">
														</div>
													</div>
													<div class="qa-c-item-clear">
													</div>
												</div> <!-- END qa-c-item -->
											</div> <!-- END qa-c-list -->
											
											<input type="hidden" name="code" value="0-1516467889-beb8dd7dc60cbb6ed18ef337534f370ae02e074d">
											<input type="hidden" name="qa_click" value="">
										</form>
										<div class="qa-c-form">
										</div> <!-- END qa-c-form -->
										
									</div> <!-- END qa-a-item-main -->
									<div class="qa-a-item-clear">
									</div>
								</div> <!-- END qa-a-list-item -->
								
							</div> <!-- END qa-a-list -->
							
						</div>
					</div> <!-- END qa-main -->
					
				</div> <!-- END main-wrapper -->
			</div> <!-- END main-shadow -->
		</div> <!-- END body-wrapper -->
		<!-- END footer-bottom-group -->
		
		<div style="position:absolute; left:-9999px; top:-9999px;">
			<span id="qa-waiting-template" class="qa-waiting">...</span>
		</div>
	
	

</body><!-- Powered by Question2Answer - http://www.question2answer.org/ --></html>