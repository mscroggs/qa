<html><!-- Powered by Question2Answer - http://www.question2answer.org/ --><head>
		<meta http-equiv="content-type" content="text/html; charset=utf-8">
		<title>ALE.move class and meshes - FEniCS Q&amp;A</title>
		<meta name="description" content="Dear all, I am using the ALE.move class and some displacement function for moving my old mesh to a  ... might has to do with ALE.move for some reason.">
		<meta name="keywords" content="ale,move,move-mesh,reset">
		<link rel="stylesheet" type="text/css" href="../../qa-theme/Snow/qa-styles.css">
		<link rel="canonical" href="http://fenicsproject.org/qa/13470/ale-move-class-and-meshes">
		<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
    tex2jax: {inlineMath: [["$","$"],["\\(","\\)"]]},
    TeX: { extensions: ["AMSmath.js","AMSsymbols.js"]}
  });
</script>
<script type="text/javascript" src="../../mathjax/MathJax.js"></script>
		<script src="../../jquery-1.7.2.min.js" type="text/javascript"></script>
		<script src="../../highlight.min.js"></script>
<script type="text/javascript">
$(function(){
	$('.wmd-input').keypress(function(){
		window.clearTimeout(hljs.Timeout);
		hljs.Timeout = window.setTimeout(function() {
			hljs.initHighlighting.called = false;
			hljs.initHighlighting();
		}, 500);
	});
	window.setTimeout(function() {
		hljs.initHighlighting.called = false;
		hljs.initHighlighting();
	}, 500);
});
</script>


	</head>
	<body class="qa-template-question qa-body-js-off">
		<div class="qa-body-wrapper">
			
			<div class="qa-header">
				<div class="qa-logo">
					<a href="../../" class="qa-logo-link" title="FEniCS Q&amp;A"><img src="../../qa-theme/fenics_qa.png" border="0" alt="FEniCS Q&amp;A"></a>
				</div>
				<div class="qa-header-clear">
				</div>
			</div> <!-- END qa-header -->
			
			<div class="qa-main-shadow">
				
				<div class="qa-main-wrapper">
					
					<div class="qa-sidepanel">
						<div class="qa-sidebar">
							This is a read only copy of the old FEniCS QA forum. Please visit the <a href="https://www.allanswered.com/community/s/fenics-project/">new QA forum</a> to ask questions
						</div>
						
					</div>
					
					<div class="qa-main">
						<h1>
							<span class="entry-title">ALE.move class and meshes</span>
						</h1>
						<div class="qa-part-q-view">
							<div class="qa-q-view  hentry question" id="q13470">
								<form method="post" action="../../13470/ale-move-class-and-meshes">
									<div class="qa-q-view-stats">
										<div class="qa-voting qa-voting-net" id="voting_13470">
											<div class="qa-vote-count qa-vote-count-net">
												<span class="qa-netvote-count">
													<span class="qa-netvote-count-data">+1<span class="votes-up"><span class="value-title" title="1"></span></span><span class="votes-down"><span class="value-title" title="0"></span></span></span><span class="qa-netvote-count-pad"> vote</span>
												</span>
											</div>
											<div class="qa-vote-clear">
											</div>
										</div>
									</div>
									<input type="hidden" name="code" value="0-1516467868-a52d68448227f92accf7e07fdba2d8a6ea1b9da8">
								</form>
								<div class="qa-q-view-main">
									<form method="post" action="../../13470/ale-move-class-and-meshes">
										<div class="qa-q-view-content">
											<a name="13470"></a><div class="entry-content"><p>Dear all,</p>

<p>I am using the ALE.move class and some displacement function for moving my old mesh to a new one. Furthermore I want to reset the new mesh to my old mesh, if my new mesh doesn't fullfill some criteria.</p>

<p><code>ALE.move(mesh, displacement)</code></p>

<p>I already tried to solve my problems with the inverse direction, like</p>

<p><code>ALE.move(mesh, -1.0*displacement)</code></p>

<p>but this produces some rounding errors I want to avoid. Furthermore I tried saving the mesh to some temporary variable, like</p>

<p><code>mesh_temp = mesh</code><br>
<code>subdomains_temp = subdomains</code><br>
<code>boundaries_temp = boundaries</code><br>
<code>ALE.move(mesh, displacement)</code><br>
<code>mesh = mesh_temp</code><br>
<code>subdomains = subdomains_temp</code><br>
<code>boundaries = boundaries_temp</code><br>
<code>Vol0 = assemble(Constant(1.0)*dx(domain=mesh))</code></p>

<p>but it seems not to work the way I expect it to work. When I calculate the volume and plot the mesh, it still calculates in Vol0 the volume of the <strong>deformed</strong> mesh and still plots the <strong>deformed</strong> mesh.  Is there a way to work with the old, not deformed mesh? </p>

<p>In another test it seems to work with saving the components to a temporary variable, thats why I think the problem might has to do with ALE.move for some reason.</p>
</div>
										</div>
										<div class="qa-q-view-tags">
											<ul class="qa-q-view-tag-list">
												<li class="qa-q-view-tag-item"><a href="../../tag/ale" rel="tag" class="qa-tag-link">ale</a></li>
												<li class="qa-q-view-tag-item"><a href="../../tag/move" rel="tag" class="qa-tag-link">move</a></li>
												<li class="qa-q-view-tag-item"><a href="../../tag/move-mesh" rel="tag" class="qa-tag-link">move-mesh</a></li>
												<li class="qa-q-view-tag-item"><a href="../../tag/reset" rel="tag" class="qa-tag-link">reset</a></li>
											</ul>
										</div>
										<span class="qa-q-view-avatar-meta">
											<span class="qa-q-view-meta">
												<a href="../../13470/ale-move-class-and-meshes" class="qa-q-view-what">asked</a>
												<span class="qa-q-view-when">
													<span class="qa-q-view-when-data"><span class="published"><span class="value-title" title="2017-05-15T11:18:30+0000"></span>May 15, 2017</span></span>
												</span>
												<span class="qa-q-view-who">
													<span class="qa-q-view-who-pad">by </span>
													<span class="qa-q-view-who-data"><span class="vcard author"><a href="../../user/crashknight" class="qa-user-link url nickname">crashknight</a></span></span>
													<span class="qa-q-view-who-title">FEniCS Novice</span>
													<span class="qa-q-view-who-points">
														<span class="qa-q-view-who-points-pad">(</span><span class="qa-q-view-who-points-data">210</span><span class="qa-q-view-who-points-pad"> points)</span>
													</span>
												</span>
												<br>
												<span class="qa-q-view-what">edited</span>
												<span class="qa-q-view-when">
													<span class="qa-q-view-when-data"><span class="updated"><span class="value-title" title="2017-05-15T11:31:23+0000"></span>May 15, 2017</span></span>
												</span>
												<span class="qa-q-view-who">
													<span class="qa-q-view-who-pad">by </span><span class="qa-q-view-who-data"><a href="../../user/crashknight" class="qa-user-link url nickname">crashknight</a></span>
												</span>
											</span>
										</span>
										<div class="qa-q-view-buttons">
										</div>
										
										<div class="qa-q-view-c-list" id="c13470_list">
											<div class="qa-c-list-item  hentry comment" id="c13486">
												<div class="qa-c-item-content">
													<a name="13486"></a><div class="entry-content"><p>Setting <code>mesh_temp = mesh</code> and then moving <code>mesh</code> using <code>ALE.move</code> will also move <code>mesh_temp</code>. Try to set <code>mesh_temp = Mesh(mesh)</code>. For your rounding errors, could you provided a minimal working example? If you are projecting your displacement field, that might cause rounding errors. If so, you can try to interpolate in stead. </p>
</div>
												</div>
												<div class="qa-c-item-footer">
													<span class="qa-c-item-avatar-meta">
														<span class="qa-c-item-meta">
															<a href="../../13470/ale-move-class-and-meshes?show=13486#c13486" class="qa-c-item-what">commented</a>
															<span class="qa-c-item-when">
																<span class="qa-c-item-when-data"><span class="published"><span class="value-title" title="2017-05-15T17:17:00+0000"></span>May 15, 2017</span></span>
															</span>
															<span class="qa-c-item-who">
																<span class="qa-c-item-who-pad">by </span>
																<span class="qa-c-item-who-data"><span class="vcard author"><a href="../../user/finsberg" class="qa-user-link url nickname">finsberg</a></span></span>
																<span class="qa-c-item-who-title">FEniCS User</span>
																<span class="qa-c-item-who-points">
																	<span class="qa-c-item-who-points-pad">(</span><span class="qa-c-item-who-points-data">2,360</span><span class="qa-c-item-who-points-pad"> points)</span>
																</span>
															</span>
														</span>
													</span>
													<div class="qa-c-item-buttons">
													</div>
												</div>
												<div class="qa-c-item-clear">
												</div>
											</div> <!-- END qa-c-item -->
											<div class="qa-c-list-item  hentry comment" id="c13508">
												<div class="qa-c-item-content">
													<a name="13508"></a><div class="entry-content"><p>Using the latest version of Fenics right now, as it is 2017.01</p>

<p>Tested that, but it doesn't work either. I'm getting some error about</p>

<blockquote>
  <p>Error: Unable to create Dirichlet boundary condition<br>
  Reason: User MeshFunctions and FunctionSpace meshes are different</p>
</blockquote>

<p>I'll try to provide a minimal working example asap, but I'm getting my displacement field from a solution of a PDE, however I still think moving the mesh forward and backwards should lead to the same volume and not some offset in the volume.</p>
</div>
												</div>
												<div class="qa-c-item-footer">
													<span class="qa-c-item-avatar-meta">
														<span class="qa-c-item-meta">
															<a href="../../13470/ale-move-class-and-meshes?show=13508#c13508" class="qa-c-item-what">commented</a>
															<span class="qa-c-item-when">
																<span class="qa-c-item-when-data"><span class="published"><span class="value-title" title="2017-05-16T13:23:33+0000"></span>May 16, 2017</span></span>
															</span>
															<span class="qa-c-item-who">
																<span class="qa-c-item-who-pad">by </span>
																<span class="qa-c-item-who-data"><span class="vcard author"><a href="../../user/crashknight" class="qa-user-link url nickname">crashknight</a></span></span>
																<span class="qa-c-item-who-title">FEniCS Novice</span>
																<span class="qa-c-item-who-points">
																	<span class="qa-c-item-who-points-pad">(</span><span class="qa-c-item-who-points-data">210</span><span class="qa-c-item-who-points-pad"> points)</span>
																</span>
															</span>
														</span>
													</span>
													<div class="qa-c-item-buttons">
													</div>
												</div>
												<div class="qa-c-item-clear">
												</div>
											</div> <!-- END qa-c-item -->
											<div class="qa-c-list-item  hentry comment" id="c13509">
												<div class="qa-c-item-content">
													<a name="13509"></a><div class="entry-content"><p>If you set <code>mesh_temp = Mesh(mesh)</code> then you have constructed a new mesh-object. Hence if you want to use <code>mesh_temp</code> in some computation you have to update <code>boundaries</code> and <code>subdomains</code> as well, using the new mesh object. For example if <code>boundaries</code> is a <code>MeshFunction</code> on the facets you can simply do</p>

<pre><code>boundaries_temp = MeshFunction("size_t", mesh_temp, 2)
boundaries_temp.set_values(boundaries.array())
</code></pre>

<p>and likewise with <code>subdomains</code>. </p>

<p>Moving the mesh back and forth should yield the same result unless the displacement field change in between. What type of function space does your displacement belong to? If it does not belong to a linear Lagrange space then your rounding error could be explained by the projection from your displacement space to the linear Lagrange space. </p>
</div>
												</div>
												<div class="qa-c-item-footer">
													<span class="qa-c-item-avatar-meta">
														<span class="qa-c-item-meta">
															<a href="../../13470/ale-move-class-and-meshes?show=13509#c13509" class="qa-c-item-what">commented</a>
															<span class="qa-c-item-when">
																<span class="qa-c-item-when-data"><span class="published"><span class="value-title" title="2017-05-16T13:40:16+0000"></span>May 16, 2017</span></span>
															</span>
															<span class="qa-c-item-who">
																<span class="qa-c-item-who-pad">by </span>
																<span class="qa-c-item-who-data"><span class="vcard author"><a href="../../user/finsberg" class="qa-user-link url nickname">finsberg</a></span></span>
																<span class="qa-c-item-who-title">FEniCS User</span>
																<span class="qa-c-item-who-points">
																	<span class="qa-c-item-who-points-pad">(</span><span class="qa-c-item-who-points-data">2,360</span><span class="qa-c-item-who-points-pad"> points)</span>
																</span>
															</span>
														</span>
													</span>
													<div class="qa-c-item-buttons">
													</div>
												</div>
												<div class="qa-c-item-clear">
												</div>
											</div> <!-- END qa-c-item -->
											<div class="qa-c-list-item  hentry comment" id="c13514">
												<div class="qa-c-item-content">
													<a name="13514"></a><div class="entry-content"><p>Hi,</p>

<p>now this is working - atleast in my mini-example (with some minor adjustments, as my mesh is generated by gmsh and the boundaries/subdomain data is stored in some other file). My dispalcement function is in</p>

<pre><code>V = VectorFunctionSpace(mesh, "Lagrange", 1)
</code></pre>

<p>As I said, the displacement is the solution of the linear elasticity PDE (LHS) with some shape derivative as the RHS. I'm not using </p>

<pre><code>project(displacement, V)
</code></pre>

<p>or something.</p>

<p>I'd just need some way without relying on the first mesh, as there are some accepted deformations of the mesh and I don't want them to reset. Like</p>

<pre><code>... # assembling a, L
solve(a == L, displacement, bcs)
... # scaling displacement
ALE.move(mesh, displacement)
... # assuming new mesh accepted, new mesh is mesh1
... # assembling a, L
solve(a == L, displacement1, bcs)
*
ALE.move(mesh1, displacment1)
...  # new mesh not accepted - restoring mesh1 without ALE.move(mesh1, -1.0*displacement)
...
</code></pre>

<p>If new mesh accepted, then continue from new mesh, if mesh not accepted move mesh back/reload new mesh, so at the line with the star I'd need to save mesh1 with the according subdomains and boundaries, not the ones from the "old" mesh.</p>
</div>
												</div>
												<div class="qa-c-item-footer">
													<span class="qa-c-item-avatar-meta">
														<span class="qa-c-item-meta">
															<a href="../../13470/ale-move-class-and-meshes?show=13514#c13514" class="qa-c-item-what">commented</a>
															<span class="qa-c-item-when">
																<span class="qa-c-item-when-data"><span class="published"><span class="value-title" title="2017-05-16T16:59:28+0000"></span>May 16, 2017</span></span>
															</span>
															<span class="qa-c-item-who">
																<span class="qa-c-item-who-pad">by </span>
																<span class="qa-c-item-who-data"><span class="vcard author"><a href="../../user/crashknight" class="qa-user-link url nickname">crashknight</a></span></span>
																<span class="qa-c-item-who-title">FEniCS Novice</span>
																<span class="qa-c-item-who-points">
																	<span class="qa-c-item-who-points-pad">(</span><span class="qa-c-item-who-points-data">210</span><span class="qa-c-item-who-points-pad"> points)</span>
																</span>
															</span>
														</span>
													</span>
													<div class="qa-c-item-buttons">
													</div>
												</div>
												<div class="qa-c-item-clear">
												</div>
											</div> <!-- END qa-c-item -->
										</div> <!-- END qa-c-list -->
										
										<input type="hidden" name="code" value="0-1516467868-82b52e3f443cfb10e855a7cd8a2965fd956e97a1">
										<input type="hidden" name="qa_click" value="">
									</form>
									<div class="qa-c-form">
									</div> <!-- END qa-c-form -->
									
								</div> <!-- END qa-q-view-main -->
								<div class="qa-q-view-clear">
								</div>
							</div> <!-- END qa-q-view -->
							
						</div>
						<div class="qa-part-a-list">
							<h2 id="a_list_title">1 Answer</h2>
							<div class="qa-a-list" id="a_list">
								
								<div class="qa-a-list-item  hentry answer answer-selected qa-a-list-item-selected" id="a13515">
									<form method="post" action="../../13470/ale-move-class-and-meshes">
										<div class="qa-voting qa-voting-net" id="voting_13515">
											<div class="qa-vote-count qa-vote-count-net">
												<span class="qa-netvote-count">
													<span class="qa-netvote-count-data">+1<span class="votes-up"><span class="value-title" title="1"></span></span><span class="votes-down"><span class="value-title" title="0"></span></span></span><span class="qa-netvote-count-pad"> vote</span>
												</span>
											</div>
											<div class="qa-vote-clear">
											</div>
										</div>
										<input type="hidden" name="code" value="0-1516467868-a52d68448227f92accf7e07fdba2d8a6ea1b9da8">
									</form>
									<div class="qa-a-item-main">
										<form method="post" action="../../13470/ale-move-class-and-meshes">
											<div class="qa-a-item-selected">
												<div class="qa-a-selection">
													<div class="qa-a-selected">&#160;</div>
													<div class="qa-a-selected-text">Best answer</div>
												</div>
												<div class="qa-a-item-content">
													<a name="13515"></a><div class="entry-content"><p>OK, I constructed an example below which hopefully contains some answers for you.</p>

<pre><code>from dolfin import *

def solve_linear_elasticity(mesh, boundaries, d):
    c = Constant(d)

    V = VectorFunctionSpace(mesh, "Lagrange", 1)
    u = TrialFunction(V)
    v = TestFunction(V)

    E, nu = 10.0, 0.3
    mu = E/(2.0*(1.0 + nu))
    lmbda = E*nu/((1.0 + nu)*(1.0 -2.0*nu))
    sigma = 2*mu*sym(grad(u)) + lmbda*tr(grad(u))*Identity(3)
    F = inner(sigma, grad(v))*dx 
    a, L = lhs(F), rhs(F)

    bcs = [DirichletBC(V, Constant((0.0, 0.0, 0.0)), boundaries, 1),
           DirichletBC(V.sub(0), c, boundaries, 2)]

    displacement = Function(V)
    solve(a==L, displacement, bcs)
    return displacement

def update_mesh(mesh, displacement, boundaries):

    new_mesh = Mesh(mesh)
    new_boundaries = MeshFunction("size_t", new_mesh, 2)
    new_boundaries.set_values(boundaries.array())
    ALE.move(new_mesh, displacement)
    return new_mesh, new_boundaries


# Original mesh
mesh = UnitCubeMesh(8, 8, 8)
subdomain1 = CompiledSubDomain("near(x[1], 0)")
subdomain2 = CompiledSubDomain("near(x[1], 1)")
boundaries = MeshFunction("size_t", mesh, 2)
boundaries.set_all(0)
subdomain1.mark(boundaries, 1)
subdomain2.mark(boundaries, 2)
plot(mesh, title = "Original mesh")

# First iteration (accepted)
displacement1 = solve_linear_elasticity(mesh, boundaries, 0.1)
mesh1, boundaries1 = update_mesh(mesh, displacement1, boundaries)
plot(mesh1, title = "First iteration (accepted)")

# Second iteration
displacement2 = solve_linear_elasticity(mesh1, boundaries1, 0.5)
mesh2, boundaries2 = update_mesh(mesh1, displacement2, boundaries1)
plot(mesh2, title = "Second iteration (rejected)")

# Something went wrong move mesh back to previous
displacement3 = Function(displacement2.function_space())
displacement3.vector()[:] = -1.0*displacement2.vector()
mesh3, boundaries3 = update_mesh(mesh2, displacement3, boundaries2)
plot(mesh3, title = "Moved back from second iteration (same as first iteration)")

from numpy.linalg import norm as np_norm
print np_norm(mesh3.coordinates() - mesh1.coordinates())

interactive()
</code></pre>
</div>
												</div>
												<span class="qa-a-item-avatar-meta">
													<span class="qa-a-item-meta">
														<a href="../../13470/ale-move-class-and-meshes?show=13515#a13515" class="qa-a-item-what">answered</a>
														<span class="qa-a-item-when">
															<span class="qa-a-item-when-data"><span class="published"><span class="value-title" title="2017-05-16T19:20:39+0000"></span>May 16, 2017</span></span>
														</span>
														<span class="qa-a-item-who">
															<span class="qa-a-item-who-pad">by </span>
															<span class="qa-a-item-who-data"><span class="vcard author"><a href="../../user/finsberg" class="qa-user-link url nickname">finsberg</a></span></span>
															<span class="qa-a-item-who-title">FEniCS User</span>
															<span class="qa-a-item-who-points">
																<span class="qa-a-item-who-points-pad">(</span><span class="qa-a-item-who-points-data">2,360</span><span class="qa-a-item-who-points-pad"> points)</span>
															</span>
														</span>
														<br>
														<span class="qa-a-item-what">selected</span>
														<span class="qa-a-item-when">
															<span class="qa-a-item-when-data"><span class="updated"><span class="value-title" title="2017-05-23T14:15:09+0000"></span>May 23, 2017</span></span>
														</span>
														<span class="qa-a-item-who">
															<span class="qa-a-item-who-pad">by </span><span class="qa-a-item-who-data"><a href="../../user/crashknight" class="qa-user-link url nickname">crashknight</a></span>
														</span>
													</span>
												</span>
											</div>
											<div class="qa-a-item-buttons">
												</div>
											
											<div class="qa-a-item-c-list" id="c13515_list">
												<div class="qa-c-list-item  hentry comment" id="c13526">
													<div class="qa-c-item-content">
														<a name="13526"></a><div class="entry-content"><p>Hi,</p>

<p>thanks for your help - I think I should be able to do it.</p>
</div>
													</div>
													<div class="qa-c-item-footer">
														<span class="qa-c-item-avatar-meta">
															<span class="qa-c-item-meta">
																<a href="../../13470/ale-move-class-and-meshes?show=13526#c13526" class="qa-c-item-what">commented</a>
																<span class="qa-c-item-when">
																	<span class="qa-c-item-when-data"><span class="published"><span class="value-title" title="2017-05-17T18:14:05+0000"></span>May 17, 2017</span></span>
																</span>
																<span class="qa-c-item-who">
																	<span class="qa-c-item-who-pad">by </span>
																	<span class="qa-c-item-who-data"><span class="vcard author"><a href="../../user/crashknight" class="qa-user-link url nickname">crashknight</a></span></span>
																	<span class="qa-c-item-who-title">FEniCS Novice</span>
																	<span class="qa-c-item-who-points">
																		<span class="qa-c-item-who-points-pad">(</span><span class="qa-c-item-who-points-data">210</span><span class="qa-c-item-who-points-pad"> points)</span>
																	</span>
																</span>
															</span>
														</span>
														<div class="qa-c-item-buttons">
														</div>
													</div>
													<div class="qa-c-item-clear">
													</div>
												</div> <!-- END qa-c-item -->
											</div> <!-- END qa-c-list -->
											
											<input type="hidden" name="code" value="0-1516467868-3aee275ba17d7ca27d722624c22eed3f251658e7">
											<input type="hidden" name="qa_click" value="">
										</form>
										<div class="qa-c-form">
										</div> <!-- END qa-c-form -->
										
									</div> <!-- END qa-a-item-main -->
									<div class="qa-a-item-clear">
									</div>
								</div> <!-- END qa-a-list-item -->
								
							</div> <!-- END qa-a-list -->
							
						</div>
					</div> <!-- END qa-main -->
					
				</div> <!-- END main-wrapper -->
			</div> <!-- END main-shadow -->
		</div> <!-- END body-wrapper -->
		<!-- END footer-bottom-group -->
		
		<div style="position:absolute; left:-9999px; top:-9999px;">
			<span id="qa-waiting-template" class="qa-waiting">...</span>
		</div>
	
	

</body><!-- Powered by Question2Answer - http://www.question2answer.org/ --></html>