<html><!-- Powered by Question2Answer - http://www.question2answer.org/ --><head>
		<meta http-equiv="content-type" content="text/html; charset=utf-8">
		<title>setting condition for mesh refinement - FEniCS Q&amp;A</title>
		<meta name="description" content="Hi, I am trying to set a condition for where to refine the mesh and I'm getting the following ... defined subdomains. Is there a way out? Many thanks,">
		<meta name="keywords" content="refinement">
		<link rel="stylesheet" type="text/css" href="../../qa-theme/Snow/qa-styles.css">
		<link rel="canonical" href="http://fenicsproject.org/qa/596/setting-condition-for-mesh-refinement">
		<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
    tex2jax: {inlineMath: [["$","$"],["\\(","\\)"]]},
    TeX: { extensions: ["AMSmath.js","AMSsymbols.js"]}
  });
</script>
<script type="text/javascript" src="../../mathjax/MathJax.js"></script>
		<script src="../../jquery-1.7.2.min.js" type="text/javascript"></script>
		<script src="../../highlight.min.js"></script>
<script type="text/javascript">
$(function(){
	$('.wmd-input').keypress(function(){
		window.clearTimeout(hljs.Timeout);
		hljs.Timeout = window.setTimeout(function() {
			hljs.initHighlighting.called = false;
			hljs.initHighlighting();
		}, 500);
	});
	window.setTimeout(function() {
		hljs.initHighlighting.called = false;
		hljs.initHighlighting();
	}, 500);
});
</script>


	</head>
	<body class="qa-template-question qa-body-js-off">
		<div class="qa-body-wrapper">
			
			<div class="qa-header">
				<div class="qa-logo">
					<a href="../../" class="qa-logo-link" title="FEniCS Q&amp;A"><img src="../../qa-theme/fenics_qa.png" border="0" alt="FEniCS Q&amp;A"></a>
				</div>
				<div class="qa-header-clear">
				</div>
			</div> <!-- END qa-header -->
			
			<div class="qa-main-shadow">
				
				<div class="qa-main-wrapper">
					
					<div class="qa-sidepanel">
						<div class="qa-sidebar">
							This is a read only copy of the old FEniCS QA forum. Please visit the <a href="https://www.allanswered.com/community/s/fenics-project/">new QA forum</a> to ask questions
						</div>
						
					</div>
					
					<div class="qa-main">
						<h1>
							<span class="entry-title">setting condition for mesh refinement</span>
						</h1>
						<div class="qa-part-q-view">
							<div class="qa-q-view  hentry question" id="q596">
								<form method="post" action="../../596/setting-condition-for-mesh-refinement">
									<div class="qa-q-view-stats">
										<div class="qa-voting qa-voting-net" id="voting_596">
											<div class="qa-vote-count qa-vote-count-net">
												<span class="qa-netvote-count">
													<span class="qa-netvote-count-data">+1<span class="votes-up"><span class="value-title" title="1"></span></span><span class="votes-down"><span class="value-title" title="0"></span></span></span><span class="qa-netvote-count-pad"> vote</span>
												</span>
											</div>
											<div class="qa-vote-clear">
											</div>
										</div>
									</div>
									<input type="hidden" name="code" value="0-1516468051-6a302a9c01bdda136ac43b6a1f5e7f9be27e2c75">
								</form>
								<div class="qa-q-view-main">
									<form method="post" action="../../596/setting-condition-for-mesh-refinement">
										<div class="qa-q-view-content">
											<a name="596"></a><div class="entry-content"><p>Hi,</p>

<p>I am trying to set a condition for where to refine the mesh and I'm getting the following error message:</p>

<pre><code>if phi0(p) &lt; 0.05 and phi0(p) &gt; -0.05:
File "C:\FEniCS\lib\site-packages\dolfin\functions\function.py", line 342, in
__call__
raise TypeError, "expected scalar arguments for the coordinates"
TypeError: expected scalar arguments for the coordinates
</code></pre>

<p>I have obtained the function phi0 by solving a PDE, and I would like to refine the mesh in all cells where this function attains values between -0.05 and 0.05. The corresponding piece of code is:</p>

<pre><code>cell_markers = CellFunction("bool", mesh)
cell_markers.set_all(False)
for cell in cells(mesh):
    p = cell.midpoint()
    if phi0(p) &lt; 0.05 and phi0(p) &gt; -0.05:
        cell_markers[cell] = True
mesh = refine(mesh, cell_markers)
</code></pre>

<p>Should I be addressing the cells in a different way? I could use a subdomain definition to cover the range for phi0 but the problem is it would overlap with my defined subdomains. Is there a way out?</p>

<p>Many thanks,</p>
</div>
										</div>
										<div class="qa-q-view-tags">
											<ul class="qa-q-view-tag-list">
												<li class="qa-q-view-tag-item"><a href="../../tag/refinement" rel="tag" class="qa-tag-link">refinement</a></li>
											</ul>
										</div>
										<span class="qa-q-view-avatar-meta">
											<span class="qa-q-view-meta">
												<a href="../../596/setting-condition-for-mesh-refinement" class="qa-q-view-what">asked</a>
												<span class="qa-q-view-when">
													<span class="qa-q-view-when-data"><span class="published"><span class="value-title" title="2013-07-16T13:35:58+0000"></span>Jul 16, 2013</span></span>
												</span>
												<span class="qa-q-view-who">
													<span class="qa-q-view-who-pad">by </span>
													<span class="qa-q-view-who-data"><span class="vcard author"><a href="../../user/hnili" class="qa-user-link url nickname">hnili</a></span></span>
													<span class="qa-q-view-who-title">FEniCS Novice</span>
													<span class="qa-q-view-who-points">
														<span class="qa-q-view-who-points-pad">(</span><span class="qa-q-view-who-points-data">590</span><span class="qa-q-view-who-points-pad"> points)</span>
													</span>
												</span>
											</span>
										</span>
										<div class="qa-q-view-buttons">
										</div>
										
										<div class="qa-q-view-c-list" style="display:none;" id="c596_list">
										</div> <!-- END qa-c-list -->
										
										<input type="hidden" name="code" value="0-1516468051-56ec7d130f6747154ec3abf73f265fe171c74608">
										<input type="hidden" name="qa_click" value="">
									</form>
									<div class="qa-c-form">
									</div> <!-- END qa-c-form -->
									
								</div> <!-- END qa-q-view-main -->
								<div class="qa-q-view-clear">
								</div>
							</div> <!-- END qa-q-view -->
							
						</div>
						<div class="qa-part-a-list">
							<h2 id="a_list_title">1 Answer</h2>
							<div class="qa-a-list" id="a_list">
								
								<div class="qa-a-list-item  hentry answer answer-selected qa-a-list-item-selected" id="a599">
									<form method="post" action="../../596/setting-condition-for-mesh-refinement">
										<div class="qa-voting qa-voting-net" id="voting_599">
											<div class="qa-vote-count qa-vote-count-net">
												<span class="qa-netvote-count">
													<span class="qa-netvote-count-data">+2<span class="votes-up"><span class="value-title" title="2"></span></span><span class="votes-down"><span class="value-title" title="0"></span></span></span><span class="qa-netvote-count-pad"> votes</span>
												</span>
											</div>
											<div class="qa-vote-clear">
											</div>
										</div>
										<input type="hidden" name="code" value="0-1516468051-6a302a9c01bdda136ac43b6a1f5e7f9be27e2c75">
									</form>
									<div class="qa-a-item-main">
										<form method="post" action="../../596/setting-condition-for-mesh-refinement">
											<div class="qa-a-item-selected">
												<div class="qa-a-selection">
													<div class="qa-a-selected">&#160;</div>
													<div class="qa-a-selected-text">Best answer</div>
												</div>
												<div class="qa-a-item-content">
													<a name="599"></a><div class="entry-content"><p>Your code is good. This is <a rel="nofollow" href="https://bitbucket.org/fenics-project/dolfin/issue/68/function__call__-point-does-not-work">bug in DOLFIN</a> which is already resolved in development version. The workaround is to call <code>phi0([p.x(), p.y(), p.z()])</code> instead of <code>phi0(p)</code>.</p>

<p>But note that if you would need to optimize it for efficiency you should use <code>phi0.eval(value, x, cell)</code> because you already have an information on which cell you want to evaluate <code>phi0</code> and you waste this information and let geometry algorithm to search again for cell. This note does not apply iff <code>phi0</code> is defined on different mesh.</p>
</div>
												</div>
												<span class="qa-a-item-avatar-meta">
													<span class="qa-a-item-avatar">
														<a href="../../user/Jan+Blechta" class="qa-avatar-link"><img src="https://www.gravatar.com/avatar/dc6f8dce77e4a0bd5adc7ff31ab83741?s=40" width="40" height="40" class="qa-avatar-image" alt=""></a>
													</span>
													<span class="qa-a-item-meta">
														<a href="../../596/setting-condition-for-mesh-refinement?show=599#a599" class="qa-a-item-what">answered</a>
														<span class="qa-a-item-when">
															<span class="qa-a-item-when-data"><span class="published"><span class="value-title" title="2013-07-16T14:40:42+0000"></span>Jul 16, 2013</span></span>
														</span>
														<span class="qa-a-item-who">
															<span class="qa-a-item-who-pad">by </span>
															<span class="qa-a-item-who-data"><span class="vcard author"><a href="../../user/Jan+Blechta" class="qa-user-link url nickname">Jan Blechta</a></span></span>
															<span class="qa-a-item-who-title">FEniCS Expert</span>
															<span class="qa-a-item-who-points">
																<span class="qa-a-item-who-points-pad">(</span><span class="qa-a-item-who-points-data">51,420</span><span class="qa-a-item-who-points-pad"> points)</span>
															</span>
														</span>
														<br>
														<span class="qa-a-item-what">selected</span>
														<span class="qa-a-item-when">
															<span class="qa-a-item-when-data"><span class="updated"><span class="value-title" title="2013-07-19T08:31:47+0000"></span>Jul 19, 2013</span></span>
														</span>
														<span class="qa-a-item-who">
															<span class="qa-a-item-who-pad">by </span><span class="qa-a-item-who-data"><a href="../../user/Jan+Blechta" class="qa-user-link url nickname">Jan Blechta</a></span>
														</span>
													</span>
												</span>
											</div>
											<div class="qa-a-item-buttons">
												</div>
											
											<div class="qa-a-item-c-list" id="c599_list">
												<div class="qa-c-list-item  hentry comment" id="c600">
													<div class="qa-c-item-content">
														<a name="600"></a><div class="entry-content"><p>Sure. Thanks very much.</p>

<p>On another note (for mesh refinement), is there a way I could set how small I would like the refined mesh elements to be?</p>

<p>I understand the method in place is edge bisection, and the way I see the refined mesh, it has divided the original elements into two which is far too coarse for my computations. If I repeat the </p>

<pre><code>mesh = refine(mesh, cell_markers)
</code></pre>

<p>command, would that do the job of re-dividing?</p>

<p>Many thanks,</p>
</div>
													</div>
													<div class="qa-c-item-footer">
														<span class="qa-c-item-avatar-meta">
															<span class="qa-c-item-meta">
																<a href="../../596/setting-condition-for-mesh-refinement?show=600#c600" class="qa-c-item-what">commented</a>
																<span class="qa-c-item-when">
																	<span class="qa-c-item-when-data"><span class="published"><span class="value-title" title="2013-07-16T15:03:30+0000"></span>Jul 16, 2013</span></span>
																</span>
																<span class="qa-c-item-who">
																	<span class="qa-c-item-who-pad">by </span>
																	<span class="qa-c-item-who-data"><span class="vcard author"><a href="../../user/hnili" class="qa-user-link url nickname">hnili</a></span></span>
																	<span class="qa-c-item-who-title">FEniCS Novice</span>
																	<span class="qa-c-item-who-points">
																		<span class="qa-c-item-who-points-pad">(</span><span class="qa-c-item-who-points-data">590</span><span class="qa-c-item-who-points-pad"> points)</span>
																	</span>
																</span>
																<br>
																<span class="qa-c-item-what">edited</span>
																<span class="qa-c-item-when">
																	<span class="qa-c-item-when-data"><span class="updated"><span class="value-title" title="2013-07-16T15:17:32+0000"></span>Jul 16, 2013</span></span>
																</span>
																<span class="qa-c-item-who">
																	<span class="qa-c-item-who-pad">by </span><span class="qa-c-item-who-data"><a href="../../user/hnili" class="qa-user-link url nickname">hnili</a></span>
																</span>
															</span>
														</span>
														<div class="qa-c-item-buttons">
														</div>
													</div>
													<div class="qa-c-item-clear">
													</div>
												</div> <!-- END qa-c-item -->
												<div class="qa-c-list-item " id="q601">
													<a href="../../601/controlling-the-size-of-refined-mesh-elements" class="qa-c-item-link">controlling the size of refined mesh elements</a>
													<div class="qa-c-item-footer">
														<span class="qa-c-item-avatar-meta">
															<span class="qa-c-item-meta">
																<span class="qa-c-item-what">asked</span>
																<span class="qa-c-item-when">
																	<span class="qa-c-item-when-data">Jul 16, 2013</span>
																</span>
																<span class="qa-c-item-who">
																	<span class="qa-c-item-who-pad">by </span>
																	<span class="qa-c-item-who-data"><a href="../../user/hnili" class="qa-user-link url nickname">hnili</a></span>
																	<span class="qa-c-item-who-title">FEniCS Novice</span>
																	<span class="qa-c-item-who-points">
																		<span class="qa-c-item-who-points-pad">(</span><span class="qa-c-item-who-points-data">590</span><span class="qa-c-item-who-points-pad"> points)</span>
																	</span>
																</span>
															</span>
														</span>
													</div>
													<div class="qa-c-item-clear">
													</div>
												</div> <!-- END qa-c-item -->
												<div class="qa-c-list-item  hentry comment" id="c13905">
													<div class="qa-c-item-content">
														<a name="13905"></a><div class="entry-content"><p>I'm using the latest version of fenics from the latest Docker image. I am trying to do something similar to the original question. I tried using the eval method per this answer; but the arguments seem to be wrong. I get this error:</p>

<p>NotImplementedError: Wrong number or type of arguments for overloaded function 'Function_eval'.<br>
  Possible C/C++ prototypes are:<br>
    dolfin::Function::eval(dolfin::Array&lt; double &gt; &amp;,dolfin::Array&lt; double &gt; const &amp;) const<br>
    dolfin::Function::eval(dolfin::Array&lt; double &gt; &amp;,dolfin::Array&lt; double &gt; const &amp;,dolfin::Cell const &amp;,ufc::cell const &amp;) const</p>

<p>So my short question is: What was assumed to be the type of phi0 in the original question? What has changed in the past four years that change the answer?</p>

<p>Longer question: Should I be doing this differently if my solution Function is from a mixed space (made with FunctionSpace using a mixed element)?</p>

<p>I somewhat new to fenics and I have trouble navigating the documentation. I spent a bit of time trying to answer my question by reviewing the code, but I'm not getting anywhere. Thanks for the help.</p>

<p>Edit/Update: If I use eval_cell instead of eval, I instead run into the error here: <a rel="nofollow" href="https://answers.launchpad.net/fenics/+question/207055">https://answers.launchpad.net/fenics/+question/207055</a></p>

<p>Edit/Update 2: Now I'm making some progress. I was failing to use Jan's advice about eval. First off, in the suggested call, phi0.eval(value, x, cell), "x" must not be the same type as "p" from the question (a fenics.Point), but rather it should be x=[p.x(), p.y(), p.z()], which was mentioned as a "workaround" for a bug that was supposedly fixed in a 2013 development version. Furthermore, regarding the error message from my original comment, the "eval" method does not appear to have the correct arguments, but "eval_cell" seems to work. So now I have a running line of code which is "w.eval_cell(values, numpy.array([p.x(), p.y(), p.z()]), cell)".</p>
</div>
													</div>
													<div class="qa-c-item-footer">
														<span class="qa-c-item-avatar-meta">
															<span class="qa-c-item-meta">
																<a href="../../596/setting-condition-for-mesh-refinement?show=13905#c13905" class="qa-c-item-what">commented</a>
																<span class="qa-c-item-when">
																	<span class="qa-c-item-when-data"><span class="published"><span class="value-title" title="2017-06-11T10:35:09+0000"></span>Jun 11, 2017</span></span>
																</span>
																<span class="qa-c-item-who">
																	<span class="qa-c-item-who-pad">by </span>
																	<span class="qa-c-item-who-data"><span class="vcard author"><a href="../../user/zimmerman" class="qa-user-link url nickname">zimmerman</a></span></span>
																	<span class="qa-c-item-who-title">FEniCS Novice</span>
																	<span class="qa-c-item-who-points">
																		<span class="qa-c-item-who-points-pad">(</span><span class="qa-c-item-who-points-data">190</span><span class="qa-c-item-who-points-pad"> points)</span>
																	</span>
																</span>
																<br>
																<span class="qa-c-item-what">edited</span>
																<span class="qa-c-item-when">
																	<span class="qa-c-item-when-data"><span class="updated"><span class="value-title" title="2017-06-13T12:32:27+0000"></span>Jun 13, 2017</span></span>
																</span>
																<span class="qa-c-item-who">
																	<span class="qa-c-item-who-pad">by </span><span class="qa-c-item-who-data"><a href="../../user/zimmerman" class="qa-user-link url nickname">zimmerman</a></span>
																</span>
															</span>
														</span>
														<div class="qa-c-item-buttons">
														</div>
													</div>
													<div class="qa-c-item-clear">
													</div>
												</div> <!-- END qa-c-item -->
											</div> <!-- END qa-c-list -->
											
											<input type="hidden" name="code" value="0-1516468051-1223957e38805f7cd358c52c98122fdcb07d0829">
											<input type="hidden" name="qa_click" value="">
										</form>
										<div class="qa-c-form">
										</div> <!-- END qa-c-form -->
										
									</div> <!-- END qa-a-item-main -->
									<div class="qa-a-item-clear">
									</div>
								</div> <!-- END qa-a-list-item -->
								
							</div> <!-- END qa-a-list -->
							
						</div>
					</div> <!-- END qa-main -->
					
				</div> <!-- END main-wrapper -->
			</div> <!-- END main-shadow -->
		</div> <!-- END body-wrapper -->
		<!-- END footer-bottom-group -->
		
		<div style="position:absolute; left:-9999px; top:-9999px;">
			<span id="qa-waiting-template" class="qa-waiting">...</span>
		</div>
	
	

</body><!-- Powered by Question2Answer - http://www.question2answer.org/ --></html>