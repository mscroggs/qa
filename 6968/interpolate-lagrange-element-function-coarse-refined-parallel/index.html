<html><!-- Powered by Question2Answer - http://www.question2answer.org/ --><head>
		<meta http-equiv="content-type" content="text/html; charset=utf-8">
		<title>interpolate non-Lagrange finite element function from coarse mesh to refined mesh in parallel - FEniCS Q&amp;A</title>
		<meta name="description" content="If we have a finite element function in some FunctionSpace and then refine the mesh and  ... /dolfin/issue/373/interpolating-from-refined-mesh-onto">
		<meta name="keywords" content="interpolate,parallel">
		<link rel="stylesheet" type="text/css" href="../../qa-theme/Snow/qa-styles.css">
		<link rel="canonical" href="http://fenicsproject.org/qa/6968/interpolate-lagrange-element-function-coarse-refined-parallel">
		<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
    tex2jax: {inlineMath: [["$","$"],["\\(","\\)"]]},
    TeX: { extensions: ["AMSmath.js","AMSsymbols.js"]}
  });
</script>
<script type="text/javascript" src="../../mathjax/MathJax.js"></script>
		<script src="../../jquery-1.7.2.min.js" type="text/javascript"></script>
		<script src="../../highlight.min.js"></script>
<script type="text/javascript">
$(function(){
	$('.wmd-input').keypress(function(){
		window.clearTimeout(hljs.Timeout);
		hljs.Timeout = window.setTimeout(function() {
			hljs.initHighlighting.called = false;
			hljs.initHighlighting();
		}, 500);
	});
	window.setTimeout(function() {
		hljs.initHighlighting.called = false;
		hljs.initHighlighting();
	}, 500);
});
</script>


	</head>
	<body class="qa-template-question qa-body-js-off">
		<div class="qa-body-wrapper">
			
			<div class="qa-header">
				<div class="qa-logo">
					<a href="../../" class="qa-logo-link" title="FEniCS Q&amp;A"><img src="../../qa-theme/fenics_qa.png" border="0" alt="FEniCS Q&amp;A"></a>
				</div>
				<div class="qa-header-clear">
				</div>
			</div> <!-- END qa-header -->
			
			<div class="qa-main-shadow">
				
				<div class="qa-main-wrapper">
					
					<div class="qa-sidepanel">
						<div class="qa-sidebar">
							This is a read only copy of the old FEniCS QA forum. Please visit the <a href="https://www.allanswered.com/community/s/fenics-project/">new QA forum</a> to ask questions
						</div>
						
					</div>
					
					<div class="qa-main">
						<h1>
							<span class="entry-title">interpolate non-Lagrange finite element function from coarse mesh to refined mesh in parallel</span>
						</h1>
						<div class="qa-part-q-view">
							<div class="qa-q-view  hentry question" id="q6968">
								<form method="post" action="../../6968/interpolate-lagrange-element-function-coarse-refined-parallel">
									<div class="qa-q-view-stats">
										<div class="qa-voting qa-voting-net" id="voting_6968">
											<div class="qa-vote-count qa-vote-count-net">
												<span class="qa-netvote-count">
													<span class="qa-netvote-count-data">+1<span class="votes-up"><span class="value-title" title="1"></span></span><span class="votes-down"><span class="value-title" title="0"></span></span></span><span class="qa-netvote-count-pad"> vote</span>
												</span>
											</div>
											<div class="qa-vote-clear">
											</div>
										</div>
									</div>
									<input type="hidden" name="code" value="0-1516468096-36b35727a80f28877415ef09bf6b8fe2bb04966a">
								</form>
								<div class="qa-q-view-main">
									<form method="post" action="../../6968/interpolate-lagrange-element-function-coarse-refined-parallel">
										<div class="qa-q-view-content">
											<a name="6968"></a><div class="entry-content"><p>If we have a finite element function in some FunctionSpace and then refine the mesh and create a new FunctionSpace with the refined mesh, we can use the interpolate function to interpolate the function from the first space into the second or vice versa.  Unfortunately, this works in serial, but not in parallel.  (In parallel, if the "allow_extrapolation" parameter is not set, the code crashes, while if it is set, the code completes but gives the wrong answer.)  This is discussed, for example, <a rel="nofollow" href="https:////bitbucket.org/fenics-project/dolfin/issue/373/interpolating-from-refined-mesh-onto">here</a>.</p>

<p>If the FunctionSpaces use Lagrange elements, then instead of the usual interpolate function one can use LagrangeInterpolator().interpolate, and this gives correct results, also in parallel.</p>

<p>My question is: for non-Lagrange spaces, e.g., Nedelec spaces, is it possible to interpolate from a coarse mesh space to a refined mesh space in parallel or is this just not available in FEniCS?</p>
</div>
										</div>
										<div class="qa-q-view-tags">
											<ul class="qa-q-view-tag-list">
												<li class="qa-q-view-tag-item"><a href="../../tag/interpolate" rel="tag" class="qa-tag-link">interpolate</a></li>
												<li class="qa-q-view-tag-item"><a href="../../tag/parallel" rel="tag" class="qa-tag-link">parallel</a></li>
											</ul>
										</div>
										<span class="qa-q-view-avatar-meta">
											<span class="qa-q-view-avatar">
												<a href="../../user/dnarnold" class="qa-avatar-link"><img src="https://www.gravatar.com/avatar/95fa33c4f1fa2e34eb3498eaa8b0a091?s=50" width="50" height="50" class="qa-avatar-image" alt=""></a>
											</span>
											<span class="qa-q-view-meta">
												<a href="../../6968/interpolate-lagrange-element-function-coarse-refined-parallel" class="qa-q-view-what">asked</a>
												<span class="qa-q-view-when">
													<span class="qa-q-view-when-data"><span class="published"><span class="value-title" title="2015-04-18T00:08:36+0000"></span>Apr 18, 2015</span></span>
												</span>
												<span class="qa-q-view-who">
													<span class="qa-q-view-who-pad">by </span>
													<span class="qa-q-view-who-data"><span class="vcard author"><a href="../../user/dnarnold" class="qa-user-link url nickname">dnarnold</a></span></span>
													<span class="qa-q-view-who-title">FEniCS User</span>
													<span class="qa-q-view-who-points">
														<span class="qa-q-view-who-points-pad">(</span><span class="qa-q-view-who-points-data">2,360</span><span class="qa-q-view-who-points-pad"> points)</span>
													</span>
												</span>
											</span>
										</span>
										<div class="qa-q-view-buttons">
										</div>
										
										<div class="qa-q-view-c-list" style="display:none;" id="c6968_list">
										</div> <!-- END qa-c-list -->
										
										<input type="hidden" name="code" value="0-1516468096-301e75c35badf8792808f6b16851f0ebe9245bc1">
										<input type="hidden" name="qa_click" value="">
									</form>
									<div class="qa-c-form">
									</div> <!-- END qa-c-form -->
									
								</div> <!-- END qa-q-view-main -->
								<div class="qa-q-view-clear">
								</div>
							</div> <!-- END qa-q-view -->
							
						</div>
						<div class="qa-part-a-list">
							<h2 id="a_list_title">2 Answers</h2>
							<div class="qa-a-list" id="a_list">
								
								<div class="qa-a-list-item  hentry answer answer-selected qa-a-list-item-selected" id="a6970">
									<form method="post" action="../../6968/interpolate-lagrange-element-function-coarse-refined-parallel">
										<div class="qa-voting qa-voting-net" id="voting_6970">
											<div class="qa-vote-count qa-vote-count-net">
												<span class="qa-netvote-count">
													<span class="qa-netvote-count-data">+2<span class="votes-up"><span class="value-title" title="2"></span></span><span class="votes-down"><span class="value-title" title="0"></span></span></span><span class="qa-netvote-count-pad"> votes</span>
												</span>
											</div>
											<div class="qa-vote-clear">
											</div>
										</div>
										<input type="hidden" name="code" value="0-1516468096-36b35727a80f28877415ef09bf6b8fe2bb04966a">
									</form>
									<div class="qa-a-item-main">
										<form method="post" action="../../6968/interpolate-lagrange-element-function-coarse-refined-parallel">
											<div class="qa-a-item-selected">
												<div class="qa-a-selection">
													<div class="qa-a-selected">&#160;</div>
													<div class="qa-a-selected-text">Best answer</div>
												</div>
												<div class="qa-a-item-content">
													<a name="6970"></a><div class="entry-content"><p>I think you are right (that there is no way of doing it at present).</p>

<p>Since there is a defined parent &lt;-&gt; child relation between refined meshes, there should be a function like "interpolate_parent()" which works cell-wise and would work in parallel.</p>
</div>
												</div>
												<span class="qa-a-item-avatar-meta">
													<span class="qa-a-item-avatar">
														<a href="../../user/chris_richardson" class="qa-avatar-link"><img src="https://www.gravatar.com/avatar/d779daeb727bcec8f6b2c505810042db?s=40" width="40" height="40" class="qa-avatar-image" alt=""></a>
													</span>
													<span class="qa-a-item-meta">
														<a href="../../6968/interpolate-lagrange-element-function-coarse-refined-parallel?show=6970#a6970" class="qa-a-item-what">answered</a>
														<span class="qa-a-item-when">
															<span class="qa-a-item-when-data"><span class="published"><span class="value-title" title="2015-04-18T06:45:49+0000"></span>Apr 18, 2015</span></span>
														</span>
														<span class="qa-a-item-who">
															<span class="qa-a-item-who-pad">by </span>
															<span class="qa-a-item-who-data"><span class="vcard author"><a href="../../user/chris_richardson" class="qa-user-link url nickname">chris_richardson</a></span></span>
															<span class="qa-a-item-who-title">FEniCS Expert</span>
															<span class="qa-a-item-who-points">
																<span class="qa-a-item-who-points-pad">(</span><span class="qa-a-item-who-points-data">31,740</span><span class="qa-a-item-who-points-pad"> points)</span>
															</span>
														</span>
														<br>
														<span class="qa-a-item-what">selected</span>
														<span class="qa-a-item-when">
															<span class="qa-a-item-when-data"><span class="updated"><span class="value-title" title="2015-04-18T17:18:01+0000"></span>Apr 18, 2015</span></span>
														</span>
														<span class="qa-a-item-who">
															<span class="qa-a-item-who-pad">by </span><span class="qa-a-item-who-data"><a href="../../user/dnarnold" class="qa-user-link url nickname">dnarnold</a></span>
														</span>
													</span>
												</span>
											</div>
											<div class="qa-a-item-buttons">
												</div>
											
											<div class="qa-a-item-c-list" style="display:none;" id="c6970_list">
											</div> <!-- END qa-c-list -->
											
											<input type="hidden" name="code" value="0-1516468096-8f1f5da0632a054ef07d317f327440878b59893f">
											<input type="hidden" name="qa_click" value="">
										</form>
										<div class="qa-c-form">
										</div> <!-- END qa-c-form -->
										
									</div> <!-- END qa-a-item-main -->
									<div class="qa-a-item-clear">
									</div>
								</div> <!-- END qa-a-list-item -->
								
								<div class="qa-a-list-item  hentry answer" id="a6972">
									<form method="post" action="../../6968/interpolate-lagrange-element-function-coarse-refined-parallel">
										<div class="qa-voting qa-voting-net" id="voting_6972">
											<div class="qa-vote-count qa-vote-count-net">
												<span class="qa-netvote-count">
													<span class="qa-netvote-count-data">0<span class="votes-up"><span class="value-title" title="0"></span></span><span class="votes-down"><span class="value-title" title="0"></span></span></span><span class="qa-netvote-count-pad"> votes</span>
												</span>
											</div>
											<div class="qa-vote-clear">
											</div>
										</div>
										<input type="hidden" name="code" value="0-1516468096-36b35727a80f28877415ef09bf6b8fe2bb04966a">
									</form>
									<div class="qa-a-item-main">
										<form method="post" action="../../6968/interpolate-lagrange-element-function-coarse-refined-parallel">
											<div class="qa-a-selection">
											</div>
											<div class="qa-a-item-content">
												<a name="6972"></a><div class="entry-content"><p>Normally, yes, this is not possible for non-Lagrange space. However, there is a (perhaps ugly) hack that I can think of. Use LagrangeInterpolator to interpolate first from Nedelec on original mesh onto a Lagrange space on the new mesh. Then interpolate with regular interpolate function from the intermediate Lagrange space onto Nedelec on the new mesh.  A script may explain better:</p>

<pre><code>from dolfin import *

mesh1 = UnitSquareMesh(40, 40)   # Fine mesh
mesh2 = UnitSquareMesh(30, 30)   # Some other mesh
N1 = FunctionSpace(mesh1, "N1curl", 1)
N2 = FunctionSpace(mesh2, "N1curl", 1)
CG2 = VectorFunctionSpace(mesh2, "CG", 2)  # Intermediate space on mesh2

# Just create some simple solution on N1
e = Expression(("x[0]", "x[1]"))
u_n1 = interpolate(e, N1)

# Now we want u_n1 interpolated on N2. 
u_cg = Function(CG2)
u_n2 = Function(N2)

# Make first intermediate interpolation
lp = LagrangeInterpolator()
lp.interpolate(u_cg, u_n1)

# Move from u_cg to final N2
u_n2 = interpolate(u_cg, N2)
plot(u_n2)
interactive()
</code></pre>
</div>
											</div>
											<span class="qa-a-item-avatar-meta">
												<span class="qa-a-item-avatar">
													<a href="../../user/mikael-mortensen" class="qa-avatar-link"><img src="https://www.gravatar.com/avatar/d5614112a2818f1800a461e49ac229df?s=40" width="40" height="40" class="qa-avatar-image" alt=""></a>
												</span>
												<span class="qa-a-item-meta">
													<a href="../../6968/interpolate-lagrange-element-function-coarse-refined-parallel?show=6972#a6972" class="qa-a-item-what">answered</a>
													<span class="qa-a-item-when">
														<span class="qa-a-item-when-data"><span class="published"><span class="value-title" title="2015-04-19T20:31:02+0000"></span>Apr 19, 2015</span></span>
													</span>
													<span class="qa-a-item-who">
														<span class="qa-a-item-who-pad">by </span>
														<span class="qa-a-item-who-data"><span class="vcard author"><a href="../../user/mikael-mortensen" class="qa-user-link url nickname">mikael-mortensen</a></span></span>
														<span class="qa-a-item-who-title">FEniCS Expert</span>
														<span class="qa-a-item-who-points">
															<span class="qa-a-item-who-points-pad">(</span><span class="qa-a-item-who-points-data">29,340</span><span class="qa-a-item-who-points-pad"> points)</span>
														</span>
													</span>
												</span>
											</span>
											<div class="qa-a-item-buttons">
												</div>
											
											<div class="qa-a-item-c-list" id="c6972_list">
												<div class="qa-c-list-item  hentry comment" id="c6973">
													<div class="qa-c-item-content">
														<a name="6973"></a><div class="entry-content"><p>Actually this does not work.  The problem is that the N1curl space is not contained in the Lagrange CG2 space, because N1curl vector fields are, in general, not continuous.  Therefore if we interpolate an N1curl function to a CG2 space, and then interpolate that to an N1curl space on a different mesh, we will usually not get the same result as if we interpolated the first N1curl function directly onto the second N1curl space.</p>

<p>Here is a simple code that demonstrates that the problem.  We compute the interpolant from coarse mesh to fine mesh N1curl space first in the way you suggest (passing through CG2), and then directly.  The output shows that the two results are nowhere near equal.</p>

<pre><code>from dolfin import *
import numpy as np
mesh1 = UnitSquareMesh(1, 1)
mesh2 = UnitSquareMesh(2, 2)
N1 = FunctionSpace(mesh1, "N1curl", 1)
N2 = FunctionSpace(mesh2, "N1curl", 2)
CG2 = VectorFunctionSpace(mesh2, "CG", 2)
u_n1 = Function(N1)
u_n1.vector()[:] = np.array([0., 1., 2., 3., 4.])
u_cg = Function(CG2)
lp = LagrangeInterpolator()
lp.interpolate(u_cg, u_n1)
u_n2 = interpolate(u_cg, N2)
u_n2a = interpolate(u_n1, N2)
print np.linalg.norm(u_n2.vector().array() - u_n2a.vector().array())
</code></pre>

<p>Output is 0.768..., not near zero.</p>
</div>
													</div>
													<div class="qa-c-item-footer">
														<span class="qa-c-item-avatar-meta">
															<span class="qa-c-item-avatar">
																<a href="../../user/dnarnold" class="qa-avatar-link"><img src="https://www.gravatar.com/avatar/95fa33c4f1fa2e34eb3498eaa8b0a091?s=20" width="20" height="20" class="qa-avatar-image" alt=""></a>
															</span>
															<span class="qa-c-item-meta">
																<a href="../../6968/interpolate-lagrange-element-function-coarse-refined-parallel?show=6973#c6973" class="qa-c-item-what">commented</a>
																<span class="qa-c-item-when">
																	<span class="qa-c-item-when-data"><span class="published"><span class="value-title" title="2015-04-20T01:44:35+0000"></span>Apr 20, 2015</span></span>
																</span>
																<span class="qa-c-item-who">
																	<span class="qa-c-item-who-pad">by </span>
																	<span class="qa-c-item-who-data"><span class="vcard author"><a href="../../user/dnarnold" class="qa-user-link url nickname">dnarnold</a></span></span>
																	<span class="qa-c-item-who-title">FEniCS User</span>
																	<span class="qa-c-item-who-points">
																		<span class="qa-c-item-who-points-pad">(</span><span class="qa-c-item-who-points-data">2,360</span><span class="qa-c-item-who-points-pad"> points)</span>
																	</span>
																</span>
															</span>
														</span>
														<div class="qa-c-item-buttons">
														</div>
													</div>
													<div class="qa-c-item-clear">
													</div>
												</div> <!-- END qa-c-item -->
												<div class="qa-c-list-item  hentry comment" id="c6974">
													<div class="qa-c-item-content">
														<a name="6974"></a><div class="entry-content"><p>Ah, ok, an ugly hack that didn't work then:-( It seemed to work for my linear Expression and your testcase above at least gives me output 1e-14 if using N1curl of order one on mesh2 as well. Does it generally work for that particular case? </p>
</div>
													</div>
													<div class="qa-c-item-footer">
														<span class="qa-c-item-avatar-meta">
															<span class="qa-c-item-avatar">
																<a href="../../user/mikael-mortensen" class="qa-avatar-link"><img src="https://www.gravatar.com/avatar/d5614112a2818f1800a461e49ac229df?s=20" width="20" height="20" class="qa-avatar-image" alt=""></a>
															</span>
															<span class="qa-c-item-meta">
																<a href="../../6968/interpolate-lagrange-element-function-coarse-refined-parallel?show=6974#c6974" class="qa-c-item-what">commented</a>
																<span class="qa-c-item-when">
																	<span class="qa-c-item-when-data"><span class="published"><span class="value-title" title="2015-04-20T06:32:37+0000"></span>Apr 20, 2015</span></span>
																</span>
																<span class="qa-c-item-who">
																	<span class="qa-c-item-who-pad">by </span>
																	<span class="qa-c-item-who-data"><span class="vcard author"><a href="../../user/mikael-mortensen" class="qa-user-link url nickname">mikael-mortensen</a></span></span>
																	<span class="qa-c-item-who-title">FEniCS Expert</span>
																	<span class="qa-c-item-who-points">
																		<span class="qa-c-item-who-points-pad">(</span><span class="qa-c-item-who-points-data">29,340</span><span class="qa-c-item-who-points-pad"> points)</span>
																	</span>
																</span>
															</span>
														</span>
														<div class="qa-c-item-buttons">
														</div>
													</div>
													<div class="qa-c-item-clear">
													</div>
												</div> <!-- END qa-c-item -->
												<div class="qa-c-list-item  hentry comment" id="c6979">
													<div class="qa-c-item-content">
														<a name="6979"></a><div class="entry-content"><p>Yes, I overstated the case.  I believe that your approach does work for the case of interpolating<br>
N1curl on a mesh to N1curl on a refined mesh.  Thanks.</p>
</div>
													</div>
													<div class="qa-c-item-footer">
														<span class="qa-c-item-avatar-meta">
															<span class="qa-c-item-avatar">
																<a href="../../user/dnarnold" class="qa-avatar-link"><img src="https://www.gravatar.com/avatar/95fa33c4f1fa2e34eb3498eaa8b0a091?s=20" width="20" height="20" class="qa-avatar-image" alt=""></a>
															</span>
															<span class="qa-c-item-meta">
																<a href="../../6968/interpolate-lagrange-element-function-coarse-refined-parallel?show=6979#c6979" class="qa-c-item-what">commented</a>
																<span class="qa-c-item-when">
																	<span class="qa-c-item-when-data"><span class="published"><span class="value-title" title="2015-04-21T02:44:04+0000"></span>Apr 21, 2015</span></span>
																</span>
																<span class="qa-c-item-who">
																	<span class="qa-c-item-who-pad">by </span>
																	<span class="qa-c-item-who-data"><span class="vcard author"><a href="../../user/dnarnold" class="qa-user-link url nickname">dnarnold</a></span></span>
																	<span class="qa-c-item-who-title">FEniCS User</span>
																	<span class="qa-c-item-who-points">
																		<span class="qa-c-item-who-points-pad">(</span><span class="qa-c-item-who-points-data">2,360</span><span class="qa-c-item-who-points-pad"> points)</span>
																	</span>
																</span>
															</span>
														</span>
														<div class="qa-c-item-buttons">
														</div>
													</div>
													<div class="qa-c-item-clear">
													</div>
												</div> <!-- END qa-c-item -->
											</div> <!-- END qa-c-list -->
											
											<input type="hidden" name="code" value="0-1516468096-e7657e40767bebf9791c8c7a043976900494e392">
											<input type="hidden" name="qa_click" value="">
										</form>
										<div class="qa-c-form">
										</div> <!-- END qa-c-form -->
										
									</div> <!-- END qa-a-item-main -->
									<div class="qa-a-item-clear">
									</div>
								</div> <!-- END qa-a-list-item -->
								
							</div> <!-- END qa-a-list -->
							
						</div>
					</div> <!-- END qa-main -->
					
				</div> <!-- END main-wrapper -->
			</div> <!-- END main-shadow -->
		</div> <!-- END body-wrapper -->
		<!-- END footer-bottom-group -->
		
		<div style="position:absolute; left:-9999px; top:-9999px;">
			<span id="qa-waiting-template" class="qa-waiting">...</span>
		</div>
	
	

</body><!-- Powered by Question2Answer - http://www.question2answer.org/ --></html>