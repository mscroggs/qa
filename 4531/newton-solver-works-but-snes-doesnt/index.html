<html><!-- Powered by Question2Answer - http://www.question2answer.org/ --><head>
		<meta http-equiv="content-type" content="text/html; charset=utf-8">
		<title>Newton solver works but SNES doesnt - FEniCS Q&amp;A</title>
		<meta name="description" content="When using Newton solver with zero initial guess: Solving nonlinear variational problem. Newton iteration 0 ...  ? Any fixes for this ? Thanks.">
		<meta name="keywords" content="newton-solver,snes,convergence,line-search">
		<link rel="stylesheet" type="text/css" href="../../qa-theme/Snow/qa-styles.css">
		<link rel="canonical" href="http://fenicsproject.org/qa/4531/newton-solver-works-but-snes-doesnt">
		<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
    tex2jax: {inlineMath: [["$","$"],["\\(","\\)"]]},
    TeX: { extensions: ["AMSmath.js","AMSsymbols.js"]}
  });
</script>
<script type="text/javascript" src="../../mathjax/MathJax.js"></script>
		<script src="../../jquery-1.7.2.min.js" type="text/javascript"></script>
		<script src="../../highlight.min.js"></script>
<script type="text/javascript">
$(function(){
	$('.wmd-input').keypress(function(){
		window.clearTimeout(hljs.Timeout);
		hljs.Timeout = window.setTimeout(function() {
			hljs.initHighlighting.called = false;
			hljs.initHighlighting();
		}, 500);
	});
	window.setTimeout(function() {
		hljs.initHighlighting.called = false;
		hljs.initHighlighting();
	}, 500);
});
</script>


	</head>
	<body class="qa-template-question qa-body-js-off">
		<div class="qa-body-wrapper">
			
			<div class="qa-header">
				<div class="qa-logo">
					<a href="../../" class="qa-logo-link" title="FEniCS Q&amp;A"><img src="../../qa-theme/fenics_qa.png" border="0" alt="FEniCS Q&amp;A"></a>
				</div>
				<div class="qa-header-clear">
				</div>
			</div> <!-- END qa-header -->
			
			<div class="qa-main-shadow">
				
				<div class="qa-main-wrapper">
					
					<div class="qa-sidepanel">
						<div class="qa-sidebar">
							This is a read only copy of the old FEniCS QA forum. Please visit the <a href="https://www.allanswered.com/community/s/fenics-project/">new QA forum</a> to ask questions
						</div>
						
					</div>
					
					<div class="qa-main">
						<h1>
							<span class="entry-title">Newton solver works but SNES doesnt</span>
						</h1>
						<div class="qa-part-q-view">
							<div class="qa-q-view  hentry question" id="q4531">
								<form method="post" action="../../4531/newton-solver-works-but-snes-doesnt">
									<div class="qa-q-view-stats">
										<div class="qa-voting qa-voting-net" id="voting_4531">
											<div class="qa-vote-count qa-vote-count-net">
												<span class="qa-netvote-count">
													<span class="qa-netvote-count-data">+4<span class="votes-up"><span class="value-title" title="4"></span></span><span class="votes-down"><span class="value-title" title="0"></span></span></span><span class="qa-netvote-count-pad"> votes</span>
												</span>
											</div>
											<div class="qa-vote-clear">
											</div>
										</div>
									</div>
									<input type="hidden" name="code" value="0-1516468016-52992ec4a3d997efade64a274a507194b1e57daa">
								</form>
								<div class="qa-q-view-main">
									<form method="post" action="../../4531/newton-solver-works-but-snes-doesnt">
										<div class="qa-q-view-content">
											<a name="4531"></a><div class="entry-content"><p>When using Newton solver with zero initial guess:</p>

<pre><code>Solving nonlinear variational problem.
  Newton iteration 0: r (abs) = 2.333e+01 (tol = 1.000e-08) r (rel) = 1.000e+00 (tol = 1.000e-07)
  Newton iteration 1: r (abs) = 2.264e+03 (tol = 1.000e-08) r (rel) = 9.701e+01 (tol = 1.000e-07)
</code></pre>

<p>The residual drops after this and converges in 10 iterations.</p>

<p>But when I use snes_solver with  line search, it is unable to reduce the residual after obtaining the value above and  produces:</p>

<pre><code>Line search: Cubic step no good, shrinking lambda, current gnorm 3.205948897925e+03 lambda=1.0000000000000007e-13
      Line search: unable to find good step length! After 12 tries 
      Line search: fnorm=2.3334499970834795e+01, gnorm=3.2059488979247935e+03, ynorm=8.8411820675344393e+02, minlambda=9.9999999999999998e-13, lambda=1.0000000000000007e-13, initial slope=-5.4449888888888904e+02
  *** Warning: PETSc SNES solver diverged in 0 iterations with divergence reason DIVERGED_LINE_SEARCH.
</code></pre>

<p>Would someone know why is this happening ? Any fixes for this ?  Thanks.</p>
</div>
										</div>
										<div class="qa-q-view-tags">
											<ul class="qa-q-view-tag-list">
												<li class="qa-q-view-tag-item"><a href="../../tag/newton-solver" rel="tag" class="qa-tag-link">newton-solver</a></li>
												<li class="qa-q-view-tag-item"><a href="../../tag/snes" rel="tag" class="qa-tag-link">snes</a></li>
												<li class="qa-q-view-tag-item"><a href="../../tag/convergence" rel="tag" class="qa-tag-link">convergence</a></li>
												<li class="qa-q-view-tag-item"><a href="../../tag/line-search" rel="tag" class="qa-tag-link">line-search</a></li>
											</ul>
										</div>
										<span class="qa-q-view-avatar-meta">
											<span class="qa-q-view-meta">
												<a href="../../4531/newton-solver-works-but-snes-doesnt" class="qa-q-view-what">asked</a>
												<span class="qa-q-view-when">
													<span class="qa-q-view-when-data"><span class="published"><span class="value-title" title="2014-08-26T15:03:05+0000"></span>Aug 26, 2014</span></span>
												</span>
												<span class="qa-q-view-who">
													<span class="qa-q-view-who-pad">by </span>
													<span class="qa-q-view-who-data"><span class="vcard author"><a href="../../user/shriram" class="qa-user-link url nickname">shriram</a></span></span>
													<span class="qa-q-view-who-title">FEniCS User</span>
													<span class="qa-q-view-who-points">
														<span class="qa-q-view-who-points-pad">(</span><span class="qa-q-view-who-points-data">1,540</span><span class="qa-q-view-who-points-pad"> points)</span>
													</span>
												</span>
											</span>
										</span>
										<div class="qa-q-view-buttons">
										</div>
										
										<div class="qa-q-view-c-list" style="display:none;" id="c4531_list">
										</div> <!-- END qa-c-list -->
										
										<input type="hidden" name="code" value="0-1516468016-088199c784b40e235168b0f0fa82d19995829904">
										<input type="hidden" name="qa_click" value="">
									</form>
									<div class="qa-c-form">
									</div> <!-- END qa-c-form -->
									
								</div> <!-- END qa-q-view-main -->
								<div class="qa-q-view-clear">
								</div>
							</div> <!-- END qa-q-view -->
							
						</div>
						<div class="qa-part-a-list">
							<h2 id="a_list_title">1 Answer</h2>
							<div class="qa-a-list" id="a_list">
								
								<div class="qa-a-list-item  hentry answer answer-selected qa-a-list-item-selected" id="a4540">
									<form method="post" action="../../4531/newton-solver-works-but-snes-doesnt">
										<div class="qa-voting qa-voting-net" id="voting_4540">
											<div class="qa-vote-count qa-vote-count-net">
												<span class="qa-netvote-count">
													<span class="qa-netvote-count-data">+3<span class="votes-up"><span class="value-title" title="3"></span></span><span class="votes-down"><span class="value-title" title="0"></span></span></span><span class="qa-netvote-count-pad"> votes</span>
												</span>
											</div>
											<div class="qa-vote-clear">
											</div>
										</div>
										<input type="hidden" name="code" value="0-1516468016-52992ec4a3d997efade64a274a507194b1e57daa">
									</form>
									<div class="qa-a-item-main">
										<form method="post" action="../../4531/newton-solver-works-but-snes-doesnt">
											<div class="qa-a-item-selected">
												<div class="qa-a-selection">
													<div class="qa-a-selected">&#160;</div>
													<div class="qa-a-selected-text">Best answer</div>
												</div>
												<div class="qa-a-item-content">
													<a name="4540"></a><div class="entry-content"><p>Your example only shows 2 iterations for the newton solver but it is already clear what is going on. </p>

<p>Line search tests each new iteration to make sure the residual has decreased by a specified amount and, if the test fails, it searches along the 'direction' (line) of the newton step to find a point at which it does satisfy the test. If it still can't find a satisfactory answer, it crashes with the error you show. </p>

<p>Take a look at your first two iterations. The residual increases from 2.333e1 to 2.264e3. Line search rejects this and tries to find a suitable value, which apparently it cannot, so it crashes. The solution with snes is therefore to turn off line search (change it to 'basic'). If you post where you define your olver, we can help you. </p>

<p>BTW: The reason why your residual increases in another matter entirely. Maybe a zero initial guess is not a good one? </p>
</div>
												</div>
												<span class="qa-a-item-avatar-meta">
													<span class="qa-a-item-avatar">
														<a href="../../user/mwelland" class="qa-avatar-link"><img src="https://www.gravatar.com/avatar/af936799ea3fe5bd1cb6abb922ebbe83?s=40" width="40" height="40" class="qa-avatar-image" alt=""></a>
													</span>
													<span class="qa-a-item-meta">
														<a href="../../4531/newton-solver-works-but-snes-doesnt?show=4540#a4540" class="qa-a-item-what">answered</a>
														<span class="qa-a-item-when">
															<span class="qa-a-item-when-data"><span class="published"><span class="value-title" title="2014-08-26T21:04:10+0000"></span>Aug 26, 2014</span></span>
														</span>
														<span class="qa-a-item-who">
															<span class="qa-a-item-who-pad">by </span>
															<span class="qa-a-item-who-data"><span class="vcard author"><a href="../../user/mwelland" class="qa-user-link url nickname">mwelland</a></span></span>
															<span class="qa-a-item-who-title">FEniCS User</span>
															<span class="qa-a-item-who-points">
																<span class="qa-a-item-who-points-pad">(</span><span class="qa-a-item-who-points-data">8,410</span><span class="qa-a-item-who-points-pad"> points)</span>
															</span>
														</span>
														<br>
														<span class="qa-a-item-what">selected</span>
														<span class="qa-a-item-when">
															<span class="qa-a-item-when-data"><span class="updated"><span class="value-title" title="2014-08-26T21:22:12+0000"></span>Aug 26, 2014</span></span>
														</span>
														<span class="qa-a-item-who">
															<span class="qa-a-item-who-pad">by </span><span class="qa-a-item-who-data"><a href="../../user/shriram" class="qa-user-link url nickname">shriram</a></span>
														</span>
													</span>
												</span>
											</div>
											<div class="qa-a-item-buttons">
												</div>
											
											<div class="qa-a-item-c-list" id="c4540_list">
												<div class="qa-c-list-item  hentry comment" id="c4541">
													<div class="qa-c-item-content">
														<a name="4541"></a><div class="entry-content"><p>Thank you for your answer. <br>
I changed my solver to:</p>

<pre><code> prm = solver.parameters
    prm['nonlinear_solver'] = 'snes'
    prm['snes_solver']['line_search'] = 'basic'
    prm['snes_solver']['linear_solver']= 'lu'
</code></pre>

<p>Now I see it converged as before, and the option 'basic'  essentially does plain Newton Raphson.   Is there a way to see the specific parameters of prm['snes_solver']['linear_solver'] alone that can be tweaked ?  The command info(prm, True)  prints out everything.</p>
</div>
													</div>
													<div class="qa-c-item-footer">
														<span class="qa-c-item-avatar-meta">
															<span class="qa-c-item-meta">
																<a href="../../4531/newton-solver-works-but-snes-doesnt?show=4541#c4541" class="qa-c-item-what">commented</a>
																<span class="qa-c-item-when">
																	<span class="qa-c-item-when-data"><span class="published"><span class="value-title" title="2014-08-26T21:22:05+0000"></span>Aug 26, 2014</span></span>
																</span>
																<span class="qa-c-item-who">
																	<span class="qa-c-item-who-pad">by </span>
																	<span class="qa-c-item-who-data"><span class="vcard author"><a href="../../user/shriram" class="qa-user-link url nickname">shriram</a></span></span>
																	<span class="qa-c-item-who-title">FEniCS User</span>
																	<span class="qa-c-item-who-points">
																		<span class="qa-c-item-who-points-pad">(</span><span class="qa-c-item-who-points-data">1,540</span><span class="qa-c-item-who-points-pad"> points)</span>
																	</span>
																</span>
															</span>
														</span>
														<div class="qa-c-item-buttons">
														</div>
													</div>
													<div class="qa-c-item-clear">
													</div>
												</div> <!-- END qa-c-item -->
												<div class="qa-c-list-item  hentry comment" id="c5258">
													<div class="qa-c-item-content">
														<a name="5258"></a><div class="entry-content"><p>If you are using petsc, you can pass parameters to the linear (ksp) solver directly such as:</p>

<p>PETScOptions.set('ksp_gmres_restart', '30') <br>
PETScOptions.set('pc_type', 'lu')<br>
PETScOptions.set('ksp_type', 'preonly')<br>
PETScOptions.set('ksp_monitor_true_residual', 'True')<br>
PETScOptions.set('ksp_converged_reason', 'True')<br>
PETScOptions.set('ksp_atol', '1e-15')<br>
PETScOptions.set('ksp_rtol', '1e-6')<br>
PETScOptions.set('ksp_max_it', '1000')</p>

<p>Useful list here:<br>
<a rel="nofollow" href="http://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/KSP/KSPSetFromOptions.html">KSP settings</a></p>

<p>And for SNES<br>
<a rel="nofollow" href="http://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/SNES/SNESSetFromOptions.html">SNES settings</a></p>

<p>If you want to stay with FEniCS solvers, I believe there is a way to set up your linear solver by itself and then tell the newton solver to use the given linear solver. This may also answer your other question re using nullspaces with the adaptivelinearsolver. Take a look <a rel="nofollow" href="http://fenicsproject.org/qa/4273/pass-a-null-space-through-a-nonlinear-solver">here</a> (and feel free to post your code here if you are successful so others know how to do it too!)</p>
</div>
													</div>
													<div class="qa-c-item-footer">
														<span class="qa-c-item-avatar-meta">
															<span class="qa-c-item-avatar">
																<a href="../../user/mwelland" class="qa-avatar-link"><img src="https://www.gravatar.com/avatar/af936799ea3fe5bd1cb6abb922ebbe83?s=20" width="20" height="20" class="qa-avatar-image" alt=""></a>
															</span>
															<span class="qa-c-item-meta">
																<a href="../../4531/newton-solver-works-but-snes-doesnt?show=5258#c5258" class="qa-c-item-what">commented</a>
																<span class="qa-c-item-when">
																	<span class="qa-c-item-when-data"><span class="published"><span class="value-title" title="2014-09-02T18:42:15+0000"></span>Sep 2, 2014</span></span>
																</span>
																<span class="qa-c-item-who">
																	<span class="qa-c-item-who-pad">by </span>
																	<span class="qa-c-item-who-data"><span class="vcard author"><a href="../../user/mwelland" class="qa-user-link url nickname">mwelland</a></span></span>
																	<span class="qa-c-item-who-title">FEniCS User</span>
																	<span class="qa-c-item-who-points">
																		<span class="qa-c-item-who-points-pad">(</span><span class="qa-c-item-who-points-data">8,410</span><span class="qa-c-item-who-points-pad"> points)</span>
																	</span>
																</span>
															</span>
														</span>
														<div class="qa-c-item-buttons">
														</div>
													</div>
													<div class="qa-c-item-clear">
													</div>
												</div> <!-- END qa-c-item -->
												<div class="qa-c-list-item  hentry comment" id="c5259">
													<div class="qa-c-item-content">
														<a name="5259"></a><div class="entry-content"><p>Thanks for your reply.  I prefer to stay with python as much and as long as I can. The question on adaptive linear solver isnt mine though.</p>
</div>
													</div>
													<div class="qa-c-item-footer">
														<span class="qa-c-item-avatar-meta">
															<span class="qa-c-item-meta">
																<a href="../../4531/newton-solver-works-but-snes-doesnt?show=5259#c5259" class="qa-c-item-what">commented</a>
																<span class="qa-c-item-when">
																	<span class="qa-c-item-when-data"><span class="published"><span class="value-title" title="2014-09-02T22:29:49+0000"></span>Sep 3, 2014</span></span>
																</span>
																<span class="qa-c-item-who">
																	<span class="qa-c-item-who-pad">by </span>
																	<span class="qa-c-item-who-data"><span class="vcard author"><a href="../../user/shriram" class="qa-user-link url nickname">shriram</a></span></span>
																	<span class="qa-c-item-who-title">FEniCS User</span>
																	<span class="qa-c-item-who-points">
																		<span class="qa-c-item-who-points-pad">(</span><span class="qa-c-item-who-points-data">1,540</span><span class="qa-c-item-who-points-pad"> points)</span>
																	</span>
																</span>
															</span>
														</span>
														<div class="qa-c-item-buttons">
														</div>
													</div>
													<div class="qa-c-item-clear">
													</div>
												</div> <!-- END qa-c-item -->
											</div> <!-- END qa-c-list -->
											
											<input type="hidden" name="code" value="0-1516468016-4f7d09824e19415a4a33355fc0b4fea88b4e1b2f">
											<input type="hidden" name="qa_click" value="">
										</form>
										<div class="qa-c-form">
										</div> <!-- END qa-c-form -->
										
									</div> <!-- END qa-a-item-main -->
									<div class="qa-a-item-clear">
									</div>
								</div> <!-- END qa-a-list-item -->
								
							</div> <!-- END qa-a-list -->
							
						</div>
					</div> <!-- END qa-main -->
					
				</div> <!-- END main-wrapper -->
			</div> <!-- END main-shadow -->
		</div> <!-- END body-wrapper -->
		<!-- END footer-bottom-group -->
		
		<div style="position:absolute; left:-9999px; top:-9999px;">
			<span id="qa-waiting-template" class="qa-waiting">...</span>
		</div>
	
	

</body><!-- Powered by Question2Answer - http://www.question2answer.org/ --></html>