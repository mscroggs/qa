<html><!-- Powered by Question2Answer - http://www.question2answer.org/ --><head>
		<meta http-equiv="content-type" content="text/html; charset=utf-8">
		<title>Mapping degrees of freedom between related meshes - FEniCS Q&amp;A</title>
		<meta name="description" content="As the title suggests, I would like to map the degrees of freedom from a submesh to  ... -mapping-from-submesh-boundarymesh-back-actual-mesh?show=8110">
		<meta name="keywords" content="boundarymesh,submesh,dofmap">
		<link rel="stylesheet" type="text/css" href="../../qa-theme/Snow/qa-styles.css">
		<link rel="canonical" href="http://fenicsproject.org/qa/8522/mapping-degrees-of-freedom-between-related-meshes">
		<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
    tex2jax: {inlineMath: [["$","$"],["\\(","\\)"]]},
    TeX: { extensions: ["AMSmath.js","AMSsymbols.js"]}
  });
</script>
<script type="text/javascript" src="../../mathjax/MathJax.js"></script>
		<script src="../../jquery-1.7.2.min.js" type="text/javascript"></script>
		<script src="../../highlight.min.js"></script>
<script type="text/javascript">
$(function(){
	$('.wmd-input').keypress(function(){
		window.clearTimeout(hljs.Timeout);
		hljs.Timeout = window.setTimeout(function() {
			hljs.initHighlighting.called = false;
			hljs.initHighlighting();
		}, 500);
	});
	window.setTimeout(function() {
		hljs.initHighlighting.called = false;
		hljs.initHighlighting();
	}, 500);
});
</script>


	</head>
	<body class="qa-template-question qa-body-js-off">
		<div class="qa-body-wrapper">
			
			<div class="qa-header">
				<div class="qa-logo">
					<a href="../../" class="qa-logo-link" title="FEniCS Q&amp;A"><img src="../../qa-theme/fenics_qa.png" border="0" alt="FEniCS Q&amp;A"></a>
				</div>
				<div class="qa-header-clear">
				</div>
			</div> <!-- END qa-header -->
			
			<div class="qa-main-shadow">
				
				<div class="qa-main-wrapper">
					
					<div class="qa-sidepanel">
						<div class="qa-sidebar">
							This is a read only copy of the old FEniCS QA forum. Please visit the <a href="https://www.allanswered.com/community/s/fenics-project/">new QA forum</a> to ask questions
						</div>
						
					</div>
					
					<div class="qa-main">
						<h1>
							<span class="entry-title">Mapping degrees of freedom between related meshes</span>
						</h1>
						<div class="qa-part-q-view">
							<div class="qa-q-view  hentry question" id="q8522">
								<form method="post" action="../../8522/mapping-degrees-of-freedom-between-related-meshes">
									<div class="qa-q-view-stats">
										<div class="qa-voting qa-voting-net" id="voting_8522">
											<div class="qa-vote-count qa-vote-count-net">
												<span class="qa-netvote-count">
													<span class="qa-netvote-count-data">+1<span class="votes-up"><span class="value-title" title="1"></span></span><span class="votes-down"><span class="value-title" title="0"></span></span></span><span class="qa-netvote-count-pad"> vote</span>
												</span>
											</div>
											<div class="qa-vote-clear">
											</div>
										</div>
									</div>
									<input type="hidden" name="code" value="0-1516468178-eeaa4a925c17274b9acd7cab0e472e25968291c3">
								</form>
								<div class="qa-q-view-main">
									<form method="post" action="../../8522/mapping-degrees-of-freedom-between-related-meshes">
										<div class="qa-q-view-content">
											<a name="8522"></a><div class="entry-content"><p>As the title suggests, I would like to map the degrees of freedom from a submesh to the original mesh, and from a boundarymesh to its parent mesh.<br>
If the dof's correspond to vertices (CG1) I can do this by mapping and mapping back the corresponding vertices, using functions like (see second link):</p>

<pre><code>dof_to_vertex_map(Vs)
submesh.data().array('parent_vertex_indices', 0)
boundarymesh.entity_map(0)
vertex_to_dof_map(V)
</code></pre>

<p>Now my question is whether there exists a similar piece of information that I can use to relate the degrees of freedom between meshes, not just the vertices? Reason for asking is that my problem requires a CG2 functionspace. Any pointing in the right direction will be helpful.</p>

<p>See also:<br>
<a rel="nofollow" href="http://fenicsproject.org/qa/7923/interpolate-works-functionspaces-with-degree-polynomials?show=7923#q7923">interpolate-works-functionspaces-with-degree-polynomials</a><br>
<a rel="nofollow" href="http://fenicsproject.org/qa/6810/vertex-mapping-from-submesh-boundarymesh-back-actual-mesh?show=8110">vertex-mapping-from-submesh-boundarymesh-back-actual-mesh</a></p>
</div>
										</div>
										<div class="qa-q-view-tags">
											<ul class="qa-q-view-tag-list">
												<li class="qa-q-view-tag-item"><a href="../../tag/boundarymesh" rel="tag" class="qa-tag-link">boundarymesh</a></li>
												<li class="qa-q-view-tag-item"><a href="../../tag/submesh" rel="tag" class="qa-tag-link">submesh</a></li>
												<li class="qa-q-view-tag-item"><a href="../../tag/dofmap" rel="tag" class="qa-tag-link">dofmap</a></li>
											</ul>
										</div>
										<span class="qa-q-view-avatar-meta">
											<span class="qa-q-view-meta">
												<a href="../../8522/mapping-degrees-of-freedom-between-related-meshes" class="qa-q-view-what">asked</a>
												<span class="qa-q-view-when">
													<span class="qa-q-view-when-data"><span class="published"><span class="value-title" title="2015-11-10T14:39:44+0000"></span>Nov 10, 2015</span></span>
												</span>
												<span class="qa-q-view-who">
													<span class="qa-q-view-who-pad">by </span>
													<span class="qa-q-view-who-data"><span class="vcard author"><a href="../../user/maartent" class="qa-user-link url nickname">maartent</a></span></span>
													<span class="qa-q-view-who-title">FEniCS User</span>
													<span class="qa-q-view-who-points">
														<span class="qa-q-view-who-points-pad">(</span><span class="qa-q-view-who-points-data">3,910</span><span class="qa-q-view-who-points-pad"> points)</span>
													</span>
												</span>
											</span>
										</span>
										<div class="qa-q-view-buttons">
										</div>
										
										<div class="qa-q-view-c-list" style="display:none;" id="c8522_list">
										</div> <!-- END qa-c-list -->
										
										<input type="hidden" name="code" value="0-1516468178-9b3bde450773c1b9af2ea384ea2247b14106c6d4">
										<input type="hidden" name="qa_click" value="">
									</form>
									<div class="qa-c-form">
									</div> <!-- END qa-c-form -->
									
								</div> <!-- END qa-q-view-main -->
								<div class="qa-q-view-clear">
								</div>
							</div> <!-- END qa-q-view -->
							
						</div>
						<div class="qa-part-a-list">
							<h2 id="a_list_title">1 Answer</h2>
							<div class="qa-a-list" id="a_list">
								
								<div class="qa-a-list-item  hentry answer answer-selected qa-a-list-item-selected" id="a8530">
									<form method="post" action="../../8522/mapping-degrees-of-freedom-between-related-meshes">
										<div class="qa-voting qa-voting-net" id="voting_8530">
											<div class="qa-vote-count qa-vote-count-net">
												<span class="qa-netvote-count">
													<span class="qa-netvote-count-data">+1<span class="votes-up"><span class="value-title" title="1"></span></span><span class="votes-down"><span class="value-title" title="0"></span></span></span><span class="qa-netvote-count-pad"> vote</span>
												</span>
											</div>
											<div class="qa-vote-clear">
											</div>
										</div>
										<input type="hidden" name="code" value="0-1516468178-eeaa4a925c17274b9acd7cab0e472e25968291c3">
									</form>
									<div class="qa-a-item-main">
										<form method="post" action="../../8522/mapping-degrees-of-freedom-between-related-meshes">
											<div class="qa-a-item-selected">
												<div class="qa-a-selection">
													<div class="qa-a-selected">&#160;</div>
													<div class="qa-a-selected-text">Best answer</div>
												</div>
												<div class="qa-a-item-content">
													<a name="8530"></a><div class="entry-content"><p>If you have the corresponding cell objects in both meshes you can use the dofmap of the functions to get the degrees of freedom for each cell (call the dofmap.cell_dofs(cell.index()) method).</p>

<p>You will have to special case the mapping depending on the types of elements. The CG2 elements in 2D will i.e have the cell_dofs() method return six dof numbers, the first three degrees belong to the vertices and the next three correspond to facet centroids. </p>

<p>For CG2 in 2D, as far as I remember, the first facet centroid dof is on the facet facing (not connected to) the first vertex and so on. You can see in the FEniCS book for details on the dof numbering of various elements, or you can just ask dolfin for the coordinates of all dofs and infer the element ordering from that (<a rel="nofollow" href="http://fenicsproject.org/qa/3932/accessing-the-coordinates-of-a-degree-of-freedom)">http://fenicsproject.org/qa/3932/accessing-the-coordinates-of-a-degree-of-freedom)</a></p>
</div>
												</div>
												<span class="qa-a-item-avatar-meta">
													<span class="qa-a-item-meta">
														<a href="../../8522/mapping-degrees-of-freedom-between-related-meshes?show=8530#a8530" class="qa-a-item-what">answered</a>
														<span class="qa-a-item-when">
															<span class="qa-a-item-when-data"><span class="published"><span class="value-title" title="2015-11-11T10:04:14+0000"></span>Nov 11, 2015</span></span>
														</span>
														<span class="qa-a-item-who">
															<span class="qa-a-item-who-pad">by </span>
															<span class="qa-a-item-who-data"><span class="vcard author"><a href="../../user/Tormod+Landet" class="qa-user-link url nickname">Tormod Landet</a></span></span>
															<span class="qa-a-item-who-title">FEniCS User</span>
															<span class="qa-a-item-who-points">
																<span class="qa-a-item-who-points-pad">(</span><span class="qa-a-item-who-points-data">5,130</span><span class="qa-a-item-who-points-pad"> points)</span>
															</span>
														</span>
														<br>
														<span class="qa-a-item-what">selected</span>
														<span class="qa-a-item-when">
															<span class="qa-a-item-when-data"><span class="updated"><span class="value-title" title="2015-11-12T16:29:36+0000"></span>Nov 12, 2015</span></span>
														</span>
														<span class="qa-a-item-who">
															<span class="qa-a-item-who-pad">by </span><span class="qa-a-item-who-data"><a href="../../user/maartent" class="qa-user-link url nickname">maartent</a></span>
														</span>
													</span>
												</span>
											</div>
											<div class="qa-a-item-buttons">
												</div>
											
											<div class="qa-a-item-c-list" id="c8530_list">
												<div class="qa-c-list-item  hentry comment" id="c8539">
													<div class="qa-c-item-content">
														<a name="8539"></a><div class="entry-content"><p>Although it is probably possible to find matching cells and map the dof's, I found it eventually a lot easier to use the coordinates (thank you for mentioning them) of the dof's in both meshes, and map them that way. Not pretty, but simple and it works (for any order CG polynomial). I hope the soon-to-be-implemented MeshView will make life easier.</p>

<p>Perhaps the code is useful to someone else:</p>

<pre><code>from dolfin import *
import numpy as np

degree = 3
n = 20

mesh = UnitSquareMesh(n, n)
V = FunctionSpace(mesh, 'CG', degree)
class LeftBoundary(SubDomain):
    def inside(self, x, on_boundary):
        return near(x[0], 0.0)
leftboundary = LeftBoundary()
boundaries = FacetFunction('size_t', mesh)
boundaries.set_all(0)
leftboundary.mark(boundaries, 1)
ds = Measure('ds')[boundaries]

boundarymesh = BoundaryMesh(mesh, 'exterior')
left_mesh = SubMesh(boundarymesh, leftboundary)
L = FunctionSpace(left_mesh, 'CG', degree)
bf = Function(L)
# here goes some more code to find the correct bf
# but here a dummy function will do
bf.vector()[:] = np.linspace(0.0, 10.0, n * degree + 1)


# make a map of dofs from the boundarymesh to the original mesh
gdim = left_mesh.geometry().dim()
bmsh_dof_coordinates = L.dofmap().tabulate_all_coordinates(left_mesh).reshape(-1, gdim)
mesh_dof_coordinates = V.dofmap().tabulate_all_coordinates(mesh).reshape(-1, gdim)
bnd_to_glob_map = {}
for bnd_dof_nr, bnd_dof_coords in enumerate(bmsh_dof_coordinates):
    corresponding_dofs = [i for i, coords in enumerate(mesh_dof_coordinates) if np.array_equal(coords, bnd_dof_coords)]
    if len(corresponding_dofs) == 1:
        bnd_to_glob_map[bnd_dof_nr] = corresponding_dofs[0]
    else:
        raise NameError("Degrees of freedom not matching.")
print bnd_to_glob_map

# warp bf to V
bf_to_V = Function(V)
for bnd_dof, glob_dof in bnd_to_glob_map.iteritems():
    bf_to_V.vector()[glob_dof] = bf.vector().array()[bnd_dof]
plot(bf_to_V, interactive=True)
</code></pre>
</div>
													</div>
													<div class="qa-c-item-footer">
														<span class="qa-c-item-avatar-meta">
															<span class="qa-c-item-meta">
																<a href="../../8522/mapping-degrees-of-freedom-between-related-meshes?show=8539#c8539" class="qa-c-item-what">commented</a>
																<span class="qa-c-item-when">
																	<span class="qa-c-item-when-data"><span class="published"><span class="value-title" title="2015-11-12T16:29:32+0000"></span>Nov 12, 2015</span></span>
																</span>
																<span class="qa-c-item-who">
																	<span class="qa-c-item-who-pad">by </span>
																	<span class="qa-c-item-who-data"><span class="vcard author"><a href="../../user/maartent" class="qa-user-link url nickname">maartent</a></span></span>
																	<span class="qa-c-item-who-title">FEniCS User</span>
																	<span class="qa-c-item-who-points">
																		<span class="qa-c-item-who-points-pad">(</span><span class="qa-c-item-who-points-data">3,910</span><span class="qa-c-item-who-points-pad"> points)</span>
																	</span>
																</span>
															</span>
														</span>
														<div class="qa-c-item-buttons">
														</div>
													</div>
													<div class="qa-c-item-clear">
													</div>
												</div> <!-- END qa-c-item -->
											</div> <!-- END qa-c-list -->
											
											<input type="hidden" name="code" value="0-1516468178-6a5078ecfd6b1153b9ad294382bd39a9f39d6e94">
											<input type="hidden" name="qa_click" value="">
										</form>
										<div class="qa-c-form">
										</div> <!-- END qa-c-form -->
										
									</div> <!-- END qa-a-item-main -->
									<div class="qa-a-item-clear">
									</div>
								</div> <!-- END qa-a-list-item -->
								
							</div> <!-- END qa-a-list -->
							
						</div>
					</div> <!-- END qa-main -->
					
				</div> <!-- END main-wrapper -->
			</div> <!-- END main-shadow -->
		</div> <!-- END body-wrapper -->
		<!-- END footer-bottom-group -->
		
		<div style="position:absolute; left:-9999px; top:-9999px;">
			<span id="qa-waiting-template" class="qa-waiting">...</span>
		</div>
	
	

</body><!-- Powered by Question2Answer - http://www.question2answer.org/ --></html>