<html><!-- Powered by Question2Answer - http://www.question2answer.org/ --><head>
		<meta http-equiv="content-type" content="text/html; charset=utf-8">
		<title>Is it possible to perform a spectral decomposition on the strain tensor with current ufl operators? - FEniCS Q&amp;A</title>
		<meta name="description" content="I want to perform spectral decomposition on the strain tensor. Does FEniCS currently support such an operator? If not is it possible to write one?">
		<meta name="keywords" content="spectral-decomposition,eigenvalue-problem">
		<link rel="stylesheet" type="text/css" href="../../qa-theme/Snow/qa-styles.css">
		<link rel="canonical" href="http://fenicsproject.org/qa/13600/possible-perform-spectral-decomposition-current-operators">
		<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
    tex2jax: {inlineMath: [["$","$"],["\\(","\\)"]]},
    TeX: { extensions: ["AMSmath.js","AMSsymbols.js"]}
  });
</script>
<script type="text/javascript" src="../../mathjax/MathJax.js"></script>
		<script src="../../jquery-1.7.2.min.js" type="text/javascript"></script>
		<script src="../../highlight.min.js"></script>
<script type="text/javascript">
$(function(){
	$('.wmd-input').keypress(function(){
		window.clearTimeout(hljs.Timeout);
		hljs.Timeout = window.setTimeout(function() {
			hljs.initHighlighting.called = false;
			hljs.initHighlighting();
		}, 500);
	});
	window.setTimeout(function() {
		hljs.initHighlighting.called = false;
		hljs.initHighlighting();
	}, 500);
});
</script>


	</head>
	<body class="qa-template-question qa-body-js-off">
		<div class="qa-body-wrapper">
			
			<div class="qa-header">
				<div class="qa-logo">
					<a href="../../" class="qa-logo-link" title="FEniCS Q&amp;A"><img src="../../qa-theme/fenics_qa.png" border="0" alt="FEniCS Q&amp;A"></a>
				</div>
				<div class="qa-header-clear">
				</div>
			</div> <!-- END qa-header -->
			
			<div class="qa-main-shadow">
				
				<div class="qa-main-wrapper">
					
					<div class="qa-sidepanel">
						<div class="qa-sidebar">
							This is a read only copy of the old FEniCS QA forum. Please visit the <a href="https://www.allanswered.com/community/s/fenics-project/">new QA forum</a> to ask questions
						</div>
						
					</div>
					
					<div class="qa-main">
						<h1>
							<span class="entry-title">Is it possible to perform a spectral decomposition on the strain tensor with current ufl operators?</span>
						</h1>
						<div class="qa-part-q-view">
							<div class="qa-q-view  hentry question" id="q13600">
								<form method="post" action="../../13600/possible-perform-spectral-decomposition-current-operators">
									<div class="qa-q-view-stats">
										<div class="qa-voting qa-voting-net" id="voting_13600">
											<div class="qa-vote-count qa-vote-count-net">
												<span class="qa-netvote-count">
													<span class="qa-netvote-count-data">+2<span class="votes-up"><span class="value-title" title="2"></span></span><span class="votes-down"><span class="value-title" title="0"></span></span></span><span class="qa-netvote-count-pad"> votes</span>
												</span>
											</div>
											<div class="qa-vote-clear">
											</div>
										</div>
									</div>
									<input type="hidden" name="code" value="0-1516467872-fb81fd8406b2ecfdc018573cf8d87c7fe5a0a1b2">
								</form>
								<div class="qa-q-view-main">
									<form method="post" action="../../13600/possible-perform-spectral-decomposition-current-operators">
										<div class="qa-q-view-content">
											<a name="13600"></a><div class="entry-content"><p>I want to perform spectral decomposition on the strain tensor. Does FEniCS currently support such an operator? If not is it possible to write one?</p>
</div>
										</div>
										<div class="qa-q-view-tags">
											<ul class="qa-q-view-tag-list">
												<li class="qa-q-view-tag-item"><a href="../../tag/spectral-decomposition" rel="tag" class="qa-tag-link">spectral-decomposition</a></li>
												<li class="qa-q-view-tag-item"><a href="../../tag/eigenvalue-problem" rel="tag" class="qa-tag-link">eigenvalue-problem</a></li>
											</ul>
										</div>
										<span class="qa-q-view-avatar-meta">
											<span class="qa-q-view-meta">
												<a href="../../13600/possible-perform-spectral-decomposition-current-operators" class="qa-q-view-what">asked</a>
												<span class="qa-q-view-when">
													<span class="qa-q-view-when-data"><span class="published"><span class="value-title" title="2017-05-23T04:49:26+0000"></span>May 23, 2017</span></span>
												</span>
												<span class="qa-q-view-who">
													<span class="qa-q-view-who-pad">by </span>
													<span class="qa-q-view-who-data"><span class="vcard author"><a href="../../user/vivekkr1809" class="qa-user-link url nickname">vivekkr1809</a></span></span>
													<span class="qa-q-view-who-title">FEniCS Novice</span>
													<span class="qa-q-view-who-points">
														<span class="qa-q-view-who-points-pad">(</span><span class="qa-q-view-who-points-data">510</span><span class="qa-q-view-who-points-pad"> points)</span>
													</span>
												</span>
											</span>
										</span>
										<div class="qa-q-view-buttons">
										</div>
										
										<div class="qa-q-view-c-list" id="c13600_list">
											<div class="qa-c-list-item  hentry comment" id="c13602">
												<div class="qa-c-item-content">
													<a name="13602"></a><div class="entry-content"><p>Hi, do you intend to use this as part of defining a bilinear form? The following threads are relevant in any case, <a rel="nofollow" href="https://fenicsproject.org/qa/5649/error-calculating-eigenvalue-in-ufl?show=5649#q5649">bad news</a>, <a rel="nofollow" href="https://fenicsproject.org/qa/11681/define-ogden-strain-energy-density-function?show=11681#q11681">better news</a>.</p>
</div>
												</div>
												<div class="qa-c-item-footer">
													<span class="qa-c-item-avatar-meta">
														<span class="qa-c-item-avatar">
															<a href="../../user/MiroK" class="qa-avatar-link"><img src="https://www.gravatar.com/avatar/f566be3274ec73e3a6dda27bca11631c?s=20" width="20" height="20" class="qa-avatar-image" alt=""></a>
														</span>
														<span class="qa-c-item-meta">
															<a href="../../13600/possible-perform-spectral-decomposition-current-operators?show=13602#c13602" class="qa-c-item-what">commented</a>
															<span class="qa-c-item-when">
																<span class="qa-c-item-when-data"><span class="published"><span class="value-title" title="2017-05-23T09:36:17+0000"></span>May 23, 2017</span></span>
															</span>
															<span class="qa-c-item-who">
																<span class="qa-c-item-who-pad">by </span>
																<span class="qa-c-item-who-data"><span class="vcard author"><a href="../../user/MiroK" class="qa-user-link url nickname">MiroK</a></span></span>
																<span class="qa-c-item-who-title">FEniCS Expert</span>
																<span class="qa-c-item-who-points">
																	<span class="qa-c-item-who-points-pad">(</span><span class="qa-c-item-who-points-data">80,920</span><span class="qa-c-item-who-points-pad"> points)</span>
																</span>
															</span>
														</span>
													</span>
													<div class="qa-c-item-buttons">
													</div>
												</div>
												<div class="qa-c-item-clear">
												</div>
											</div> <!-- END qa-c-item -->
											<div class="qa-c-list-item  hentry comment" id="c13608">
												<div class="qa-c-item-content">
													<a name="13608"></a><div class="entry-content"><p>Hi MiroK,<br>
Yes. I would like to separate the positive and negative principal components of the strain tensor after the spectral decomposition. In my variational form I wanted to penalize only the positive part of the strain tensor.<br>
I had already looked at the <a rel="nofollow" href="https://fenicsproject.org/qa/11681/define-ogden-strain-energy-density-function?show=11681#q11681">better news</a> and also <a rel="nofollow" href="https://fenicsproject.org/qa/12281/eigenvalues-eigenvectors-stress-strain-tensor-element-level">this</a>. But these cannot be used if I want to do a decomposition of  a 2nd order strain tensor. I was hoping to write (even if it was challenging) a Python/C++ code to create an operator for the same. But from <a rel="nofollow" href="https://fenicsproject.org/qa/5649/error-calculating-eigenvalue-in-ufl?show=5649#q5649">bad news</a> it seems it is impossible. Please correct me if I am wrong.</p>

<p>Thanks<br>
Vivek</p>
</div>
												</div>
												<div class="qa-c-item-footer">
													<span class="qa-c-item-avatar-meta">
														<span class="qa-c-item-meta">
															<a href="../../13600/possible-perform-spectral-decomposition-current-operators?show=13608#c13608" class="qa-c-item-what">commented</a>
															<span class="qa-c-item-when">
																<span class="qa-c-item-when-data"><span class="published"><span class="value-title" title="2017-05-23T15:10:40+0000"></span>May 23, 2017</span></span>
															</span>
															<span class="qa-c-item-who">
																<span class="qa-c-item-who-pad">by </span>
																<span class="qa-c-item-who-data"><span class="vcard author"><a href="../../user/vivekkr1809" class="qa-user-link url nickname">vivekkr1809</a></span></span>
																<span class="qa-c-item-who-title">FEniCS Novice</span>
																<span class="qa-c-item-who-points">
																	<span class="qa-c-item-who-points-pad">(</span><span class="qa-c-item-who-points-data">510</span><span class="qa-c-item-who-points-pad"> points)</span>
																</span>
															</span>
														</span>
													</span>
													<div class="qa-c-item-buttons">
													</div>
												</div>
												<div class="qa-c-item-clear">
												</div>
											</div> <!-- END qa-c-item -->
											<div class="qa-c-list-item  hentry comment" id="c13610">
												<div class="qa-c-item-content">
													<a name="13610"></a><div class="entry-content"><p>Can you post relevant parts of the form?</p>
</div>
												</div>
												<div class="qa-c-item-footer">
													<span class="qa-c-item-avatar-meta">
														<span class="qa-c-item-avatar">
															<a href="../../user/MiroK" class="qa-avatar-link"><img src="https://www.gravatar.com/avatar/f566be3274ec73e3a6dda27bca11631c?s=20" width="20" height="20" class="qa-avatar-image" alt=""></a>
														</span>
														<span class="qa-c-item-meta">
															<a href="../../13600/possible-perform-spectral-decomposition-current-operators?show=13610#c13610" class="qa-c-item-what">commented</a>
															<span class="qa-c-item-when">
																<span class="qa-c-item-when-data"><span class="published"><span class="value-title" title="2017-05-23T15:19:53+0000"></span>May 23, 2017</span></span>
															</span>
															<span class="qa-c-item-who">
																<span class="qa-c-item-who-pad">by </span>
																<span class="qa-c-item-who-data"><span class="vcard author"><a href="../../user/MiroK" class="qa-user-link url nickname">MiroK</a></span></span>
																<span class="qa-c-item-who-title">FEniCS Expert</span>
																<span class="qa-c-item-who-points">
																	<span class="qa-c-item-who-points-pad">(</span><span class="qa-c-item-who-points-data">80,920</span><span class="qa-c-item-who-points-pad"> points)</span>
																</span>
															</span>
														</span>
													</span>
													<div class="qa-c-item-buttons">
													</div>
												</div>
												<div class="qa-c-item-clear">
												</div>
											</div> <!-- END qa-c-item -->
											<div class="qa-c-list-item  hentry comment" id="c13612">
												<div class="qa-c-item-content">
													<a name="13612"></a><div class="entry-content"><pre><code># Constitutive relation
def stress( gradu, g):
    k0 = lmda + 2.*mu
    eps = sym( gradu )
    tr_pos_eps = conditional( gt(tr(eps), 0.), tr(eps) ,0) # tr(eps) == tr(eps_volumetric) as tr(eps_deviatoric) = 0
    tr_neg_eps = tr(eps) - tr_pos_eps
    dev_eps = dev(eps)
    return  k0*tr_neg_eps*Identity(space_dim) + g*(k0*Identity(space_dim)*tr_pos_eps + mu*dev_eps )

     # Stored Energy
def stored_energy( gradu, g ):
    k0 = lmda + 2.*mu
    eps = sym( gradu )
    tr_pos_eps = conditional( gt(tr(eps), 0.), tr(eps) ,0) # Shouldn't we divide this by space_dim?
    tr_neg_eps = tr(eps) - tr_pos_eps
    dev_eps = dev(eps) 
    return k0*pow(tr_neg_eps,2)/2. + g*(k0*pow(tr_pos_eps,2)/2. +  mu*inner(dev_eps,dev_eps) )

     # The penalization function
def penalize( phase_field ):
    return ( pow(1. - phase_field,2)  + 1.e-9 )

    # Set up the residuals
    R_u =  inner(stress( grad(uh) , penalize( dh ) ), grad( delta_u) )*dx + inner(source_u, delta_u)*dx 
</code></pre>

<p>Code Snippet could be found above. So instead of separating the strains into volumetric and deviatoric parts, I would like to do an eigenvalue decomposition.</p>
</div>
												</div>
												<div class="qa-c-item-footer">
													<span class="qa-c-item-avatar-meta">
														<span class="qa-c-item-meta">
															<a href="../../13600/possible-perform-spectral-decomposition-current-operators?show=13612#c13612" class="qa-c-item-what">commented</a>
															<span class="qa-c-item-when">
																<span class="qa-c-item-when-data"><span class="published"><span class="value-title" title="2017-05-23T15:31:15+0000"></span>May 23, 2017</span></span>
															</span>
															<span class="qa-c-item-who">
																<span class="qa-c-item-who-pad">by </span>
																<span class="qa-c-item-who-data"><span class="vcard author"><a href="../../user/vivekkr1809" class="qa-user-link url nickname">vivekkr1809</a></span></span>
																<span class="qa-c-item-who-title">FEniCS Novice</span>
																<span class="qa-c-item-who-points">
																	<span class="qa-c-item-who-points-pad">(</span><span class="qa-c-item-who-points-data">510</span><span class="qa-c-item-who-points-pad"> points)</span>
																</span>
															</span>
														</span>
													</span>
													<div class="qa-c-item-buttons">
													</div>
												</div>
												<div class="qa-c-item-clear">
												</div>
											</div> <!-- END qa-c-item -->
										</div> <!-- END qa-c-list -->
										
										<input type="hidden" name="code" value="0-1516467872-ee7163823b40f501efc41b6f48c5cc8e1c98cedb">
										<input type="hidden" name="qa_click" value="">
									</form>
									<div class="qa-c-form">
									</div> <!-- END qa-c-form -->
									
								</div> <!-- END qa-q-view-main -->
								<div class="qa-q-view-clear">
								</div>
							</div> <!-- END qa-q-view -->
							
						</div>
						<div class="qa-part-a-list">
							<h2 id="a_list_title">2 Answers</h2>
							<div class="qa-a-list" id="a_list">
								
								<div class="qa-a-list-item  hentry answer answer-selected qa-a-list-item-selected" id="a13614">
									<form method="post" action="../../13600/possible-perform-spectral-decomposition-current-operators">
										<div class="qa-voting qa-voting-net" id="voting_13614">
											<div class="qa-vote-count qa-vote-count-net">
												<span class="qa-netvote-count">
													<span class="qa-netvote-count-data">+3<span class="votes-up"><span class="value-title" title="3"></span></span><span class="votes-down"><span class="value-title" title="0"></span></span></span><span class="qa-netvote-count-pad"> votes</span>
												</span>
											</div>
											<div class="qa-vote-clear">
											</div>
										</div>
										<input type="hidden" name="code" value="0-1516467872-fb81fd8406b2ecfdc018573cf8d87c7fe5a0a1b2">
									</form>
									<div class="qa-a-item-main">
										<form method="post" action="../../13600/possible-perform-spectral-decomposition-current-operators">
											<div class="qa-a-item-selected">
												<div class="qa-a-selection">
													<div class="qa-a-selected">&#160;</div>
													<div class="qa-a-selected-text">Best answer</div>
												</div>
												<div class="qa-a-item-content">
													<a name="13614"></a><div class="entry-content"><p>Hi, see if the following helps. The idea here is to let sympy do the heavy lifting of coming up with the expression for eigenvalues and eigenvectors and then turning that to UFL. At the moment the conversion is via string  and subsequent eval. You might want to build a better parser, especially because in 3d the expressions from sympy involve complex unit etc which do not have equivalent in UFL namespace.</p>

<pre><code>from dolfin import *
import sympy as sp

# Compute the symbolic expression for eigenvalues by sympy
T = sp.Matrix(2, 2, lambda i, j: sp.Symbol('T[%d, %d]' % (i, j), real=True))
eig_expr = T.eigenvects()   # ((v, multiplicity, [w])...)

eigv = [e[0] for e in eig_expr]
eigw = [e[-1][0] for e in eig_expr]

eigv_expr = map(str, eigv)
eigw_expr = [[str(e[0]), str(e[1])] for e in eigw]

# UFL operator for eigenvalues of 2x2 matrix, a pair of scalars
def eigv(T): return map(eval, eigv_expr)

# UFL operator for eigenvectors of 2x2 matrix, a pair of vectors
def eigw(T): return [as_vector(map(eval, vec)) for vec in eigw_expr]

n = 16
mesh = UnitSquareMesh(n, n)

V = TensorFunctionSpace(mesh, 'CG', 1)
x = SpatialCoordinate(mesh)

v = as_vector((x[0]*x[1]+x[0], -x[0]*x[1]+x[1]))

t = sym(grad(v))

t = project(t, V)

v0, v1 = eigv(t)
w0, w1 = eigw(t)

# Eigenvalues okay
print sqrt(assemble(inner(det(t)-v0*v1, det(t)-v0*v1)*dx))
print sqrt(assemble(inner(tr(t)-(v0+v1), tr(t)-(v0+v1))*dx))

# Orthogonality of eigenvectors 
print sqrt(assemble(inner(Constant(0) - dot(w0, w1), Constant(0) - dot(w0, w1))*dx))

# Decomposition
e = dot(t, w0)
e0 = v0*w0
print sqrt(assemble(inner(e-e0, e-e0)*dx))

e = dot(t, w1)
e0 = v1*w1
print sqrt(assemble(inner(e-e0, e-e0)*dx))
</code></pre>
</div>
												</div>
												<span class="qa-a-item-avatar-meta">
													<span class="qa-a-item-avatar">
														<a href="../../user/MiroK" class="qa-avatar-link"><img src="https://www.gravatar.com/avatar/f566be3274ec73e3a6dda27bca11631c?s=40" width="40" height="40" class="qa-avatar-image" alt=""></a>
													</span>
													<span class="qa-a-item-meta">
														<a href="../../13600/possible-perform-spectral-decomposition-current-operators?show=13614#a13614" class="qa-a-item-what">answered</a>
														<span class="qa-a-item-when">
															<span class="qa-a-item-when-data"><span class="published"><span class="value-title" title="2017-05-23T15:44:10+0000"></span>May 23, 2017</span></span>
														</span>
														<span class="qa-a-item-who">
															<span class="qa-a-item-who-pad">by </span>
															<span class="qa-a-item-who-data"><span class="vcard author"><a href="../../user/MiroK" class="qa-user-link url nickname">MiroK</a></span></span>
															<span class="qa-a-item-who-title">FEniCS Expert</span>
															<span class="qa-a-item-who-points">
																<span class="qa-a-item-who-points-pad">(</span><span class="qa-a-item-who-points-data">80,920</span><span class="qa-a-item-who-points-pad"> points)</span>
															</span>
														</span>
														<br>
														<span class="qa-a-item-what">selected</span>
														<span class="qa-a-item-when">
															<span class="qa-a-item-when-data"><span class="updated"><span class="value-title" title="2017-06-02T19:44:31+0000"></span>Jun 2, 2017</span></span>
														</span>
														<span class="qa-a-item-who">
															<span class="qa-a-item-who-pad">by </span><span class="qa-a-item-who-data"><a href="../../user/vivekkr1809" class="qa-user-link url nickname">vivekkr1809</a></span>
														</span>
													</span>
												</span>
											</div>
											<div class="qa-a-item-buttons">
												</div>
											
											<div class="qa-a-item-c-list" id="c13614_list">
												<div class="qa-c-list-item  hentry comment" id="c13616">
													<div class="qa-c-item-content">
														<a name="13616"></a><div class="entry-content"><p>Thanks a lot. I will try implementing the method.</p>
</div>
													</div>
													<div class="qa-c-item-footer">
														<span class="qa-c-item-avatar-meta">
															<span class="qa-c-item-meta">
																<a href="../../13600/possible-perform-spectral-decomposition-current-operators?show=13616#c13616" class="qa-c-item-what">commented</a>
																<span class="qa-c-item-when">
																	<span class="qa-c-item-when-data"><span class="published"><span class="value-title" title="2017-05-23T15:47:15+0000"></span>May 23, 2017</span></span>
																</span>
																<span class="qa-c-item-who">
																	<span class="qa-c-item-who-pad">by </span>
																	<span class="qa-c-item-who-data"><span class="vcard author"><a href="../../user/vivekkr1809" class="qa-user-link url nickname">vivekkr1809</a></span></span>
																	<span class="qa-c-item-who-title">FEniCS Novice</span>
																	<span class="qa-c-item-who-points">
																		<span class="qa-c-item-who-points-pad">(</span><span class="qa-c-item-who-points-data">510</span><span class="qa-c-item-who-points-pad"> points)</span>
																	</span>
																</span>
															</span>
														</span>
														<div class="qa-c-item-buttons">
														</div>
													</div>
													<div class="qa-c-item-clear">
													</div>
												</div> <!-- END qa-c-item -->
												<div class="qa-c-list-item  hentry comment" id="c13617">
													<div class="qa-c-item-content">
														<a name="13617"></a><div class="entry-content"><p>Sure, and if possible please share your solution.</p>
</div>
													</div>
													<div class="qa-c-item-footer">
														<span class="qa-c-item-avatar-meta">
															<span class="qa-c-item-avatar">
																<a href="../../user/MiroK" class="qa-avatar-link"><img src="https://www.gravatar.com/avatar/f566be3274ec73e3a6dda27bca11631c?s=20" width="20" height="20" class="qa-avatar-image" alt=""></a>
															</span>
															<span class="qa-c-item-meta">
																<a href="../../13600/possible-perform-spectral-decomposition-current-operators?show=13617#c13617" class="qa-c-item-what">commented</a>
																<span class="qa-c-item-when">
																	<span class="qa-c-item-when-data"><span class="published"><span class="value-title" title="2017-05-23T15:49:43+0000"></span>May 23, 2017</span></span>
																</span>
																<span class="qa-c-item-who">
																	<span class="qa-c-item-who-pad">by </span>
																	<span class="qa-c-item-who-data"><span class="vcard author"><a href="../../user/MiroK" class="qa-user-link url nickname">MiroK</a></span></span>
																	<span class="qa-c-item-who-title">FEniCS Expert</span>
																	<span class="qa-c-item-who-points">
																		<span class="qa-c-item-who-points-pad">(</span><span class="qa-c-item-who-points-data">80,920</span><span class="qa-c-item-who-points-pad"> points)</span>
																	</span>
																</span>
															</span>
														</span>
														<div class="qa-c-item-buttons">
														</div>
													</div>
													<div class="qa-c-item-clear">
													</div>
												</div> <!-- END qa-c-item -->
												<div class="qa-c-list-item  hentry comment" id="c13774">
													<div class="qa-c-item-content">
														<a name="13774"></a><div class="entry-content"><p>Hi Miroslav,</p>

<p>I tried implementing your suggestion of using sympy to obtain eigenvectors and eigenvalues, but I am running into troubles while reconstructing the strain tensor. I am getting an Arity error. In the following code I have attempted to simply reconstruct the strain using eigenvectors and eigenvalues but it throws an error. Code snippet:</p>

<pre><code>from dolfin import *
import sympy as sp
import numpy as np
import numpy.linalg as LA

#----------------------------------------------------------------------#
# set some dolfin specific parameters
parameters["form_compiler"]["optimize"]     = True
parameters["form_compiler"]["cpp_optimize"] = True
parameters["form_compiler"]["representation"] = 'uflacs'  
#----------------------------------------------------------------------#

#----------------------------------------------------------------------#
# Compute the symbolic expression for eigenvalues by sympy
T = sp.Matrix(2, 2, lambda i, j: sp.Symbol('T[%d, %d]' % (i, j), real=True))
eig_expr = T.eigenvects()   # ((v, multiplicity, [w])...)

eigv = [e[0] for e in eig_expr]
eigw = [e[-1][0] for e in eig_expr]

eigv_expr = map(str, eigv)
eigw_expr = [[str(e[0]), str(e[1])] for e in eigw]

#----------------------------------------------------------------------#


#----------------------------------------------------------------------#
# Create UFL operators for the eigenvalues and eigenvectors

# UFL operator for eigenvalues of 2x2 matrix, a pair of scalars
def eigv(T): return map(eval, eigv_expr)

# UFL operator for eigenvectors of 2x2 matrix, a pair of vectors
def eigw(T): return [as_vector(map(eval, vec)) for vec in eigw_expr]

#----------------------------------------------------------------------#

spd = 2 # Spatial dimension

n = 16 # Size of mesh
mesh = UnitSquareMesh(n, n)

V = VectorFunctionSpace(mesh, 'CG', 1) # V = TensorFunctionSpace(mesh, 'CG', 1) -&gt; Original
V_t = TensorFunctionSpace(mesh, 'CG', 1)

x = SpatialCoordinate(mesh)

# Define variational problem
u = TrialFunction(V)
v = TestFunction(V)
f = Constant((0., -1.0))
T = Constant((0., 0.))

# Define boundary condition
tol = 1E-14

def clamped_boundary(x, on_boundary):
    return on_boundary and x[0] &lt; tol

bc = DirichletBC(V, Constant((0, 0)), clamped_boundary)

def eps(u):
    return  sym(grad(u))

lmbda = 10.0
mu = 1.0

def sigma(k):
    #return lmbda*(tr(eps(u)))*Identity(spd) +2*mu*eps(u)
    # To compare the answers
    t_e = eps(k)

    v0 , v1 = eigv(t_e)
    w0 , w1 = eigw(t_e)
    # v0, v1 are 'Sum objects
    # w0, w1 are 'ListTensor' objects

    # Creating tensor objects for eigenvalues
    vp = ([v0,0.0],[0.0,v1])

    vp = as_tensor(vp)

    #vp = project(vp,V_t) -&gt; Gives Arity error

    # Creating tensor objects for eigenvectors
    wp = ([w0[0],w1[0]],[w0[1],w1[1]])
    wp = as_tensor(wp)
    # Taking the transpose of the eigenvector matrix
    wp_T = wp.T
    # Reconstructing the strain tensor
    strn = wp*vp*wp.T
    strn =sym(strn)

    # Using strn gives the following error:
    # ArityMismatch("Applying nonlinear operator {0} to expression depending on form argument {1}.".format(o._ufl_class_.__name__, t))
    # ArityMismatch: Applying nonlinear operator Sqrt to expression depending on form argument v_1.

    return lmbda*(tr(strn))*Identity(spd) +2.0*mu*strn

a = inner(sigma(u),eps(v))*dx
L = dot(f, v)*dx + dot(T, v)*ds


# Compute solution
u = Function(V)
solve(a == L, u, bc)


V = FunctionSpace(mesh, 'CG', 1)

# Compute magnitude of displacement
u_magnitude = sqrt(dot(u, u))
u_magnitude = project(u_magnitude, V)
print('min/max u:',
      u_magnitude.vector().array().min(),
      u_magnitude.vector().array().max())
</code></pre>

<p>I have already looked at your suggestion <a rel="nofollow" href="https://fenicsproject.org/qa/9117/arity-mismatch-exception">here</a> but could not utilize it here. Any suggestions?</p>
</div>
													</div>
													<div class="qa-c-item-footer">
														<span class="qa-c-item-avatar-meta">
															<span class="qa-c-item-meta">
																<a href="../../13600/possible-perform-spectral-decomposition-current-operators?show=13774#c13774" class="qa-c-item-what">commented</a>
																<span class="qa-c-item-when">
																	<span class="qa-c-item-when-data"><span class="published"><span class="value-title" title="2017-06-01T20:16:53+0000"></span>Jun 1, 2017</span></span>
																</span>
																<span class="qa-c-item-who">
																	<span class="qa-c-item-who-pad">by </span>
																	<span class="qa-c-item-who-data"><span class="vcard author"><a href="../../user/vivekkr1809" class="qa-user-link url nickname">vivekkr1809</a></span></span>
																	<span class="qa-c-item-who-title">FEniCS Novice</span>
																	<span class="qa-c-item-who-points">
																		<span class="qa-c-item-who-points-pad">(</span><span class="qa-c-item-who-points-data">510</span><span class="qa-c-item-who-points-pad"> points)</span>
																	</span>
																</span>
																<br>
																<span class="qa-c-item-what">edited</span>
																<span class="qa-c-item-when">
																	<span class="qa-c-item-when-data"><span class="updated"><span class="value-title" title="2017-06-01T20:54:01+0000"></span>Jun 1, 2017</span></span>
																</span>
																<span class="qa-c-item-who">
																	<span class="qa-c-item-who-pad">by </span><span class="qa-c-item-who-data"><a href="../../user/vivekkr1809" class="qa-user-link url nickname">vivekkr1809</a></span>
																</span>
															</span>
														</span>
														<div class="qa-c-item-buttons">
														</div>
													</div>
													<div class="qa-c-item-clear">
													</div>
												</div> <!-- END qa-c-item -->
												<div class="qa-c-list-item  hentry comment" id="c13780">
													<div class="qa-c-item-content">
														<a name="13780"></a><div class="entry-content"><p>Hi Miroslav,</p>

<p>I attempted the following changes to test the reconstruction of the strain tensor and it seems to work in this code:</p>

<pre><code>"""
The code performs an eignevalue decomposition of the strain tensor and
then reconstructs the strain tensor to compare the solutions.
"""

from dolfin import *
import sympy as sp
import numpy as np
import numpy.linalg as LA

#----------------------------------------------------------------------#
# set some dolfin specific parameters
parameters["form_compiler"]["optimize"]     = True
parameters["form_compiler"]["cpp_optimize"] = True
parameters["form_compiler"]["representation"] = 'uflacs'  
#----------------------------------------------------------------------#


# Compute the symbolic expression for eigenvalues by sympy
T = sp.Matrix(2, 2, lambda i, j: sp.Symbol('T[%d, %d]' % (i, j), real=True))
eig_expr = T.eigenvects()   # ((v, multiplicity, [w])...)

eigv = [e[0] for e in eig_expr]
eigw = [e[-1][0] for e in eig_expr]

eigv = sp.Matrix(eigv) # Column vector
eigw = sp.Matrix(eigw) # Row has the elements
eigw = sp.Matrix([[eigw[0],eigw[2]],[eigw[1],eigw[3]]])
eigv = sp.Matrix([[eigv[0], 0.0],[0.0, eigv[1]]])

eig_dec = eigw*eigv*eigw.inv()

#print(T)
#print("--------------")
#print("eigw")
#print(eigw)
#print("--------------")
#print("eigv")
#print(eigv)
#print("--------------")
#print("eigw.inv()")
#print(eigw.inv())
#print("--------------")
#print("--------------")
#print("eig_dec")
#print(sp.simplify(eig_dec))


eigv_expr = map(str, eigv)
eigw_expr = map(str, eigw)


# UFL operator for eigenvalues of 2x2 matrix, a pair of scalars
def eigv(T): return map(eval, eigv_expr)

# UFL operator for eigenvectors of 2x2 matrix, a pair of vectors
def eigw(T): return map(eval, eigw_expr)


n = 16
mesh = UnitSquareMesh(n, n)

V = TensorFunctionSpace(mesh, 'CG', 1)
x = SpatialCoordinate(mesh)

v = as_vector((x[0]*x[1]+x[0], -x[0]*x[1]+x[1]))

t = sym(grad(v))

t = project(t, V)

v00, v01, v10, v11 = eigv(t)

w00, w01, w10, w11 = eigw(t)

w = ([w00,w01],[w10,w11])
w = as_tensor(w)

v = ([v00,v01],[v10,v11])
v = as_tensor(v)

strn = w*v*inv(w)

# Comparing the strain obtained using eigenvalue decomposition with the original strain.
print sqrt(assemble(inner(t-strn, t-strn)*dx))

print sqrt(assemble(inner(det(t)-v[0,0]*v[1,1], det(t)-v[0,0]*v[1,1])*dx))

print sqrt(assemble(inner(tr(t)-tr(strn), tr(t)-tr(strn))*dx))

#Looks ok
</code></pre>

<p>I then tried the same implementation with a 2-D elasticity problem and again ran into the Arity issue.</p>

<pre><code>from dolfin import *
import sympy as sp
import numpy as np
import numpy.linalg as LA

#----------------------------------------------------------------------#
# set some dolfin specific parameters
parameters["form_compiler"]["optimize"]     = True
parameters["form_compiler"]["cpp_optimize"] = True
parameters["form_compiler"]["representation"] = 'uflacs'  
#----------------------------------------------------------------------#

#----------------------------------------------------------------------#
# Compute the symbolic expression for eigenvalues by sympy
T = sp.Matrix(2, 2, lambda i, j: sp.Symbol('T[%d, %d]' % (i, j), symmetric = True, real=True))
eig_expr = T.eigenvects()   # ((v, multiplicity, [w])...)

eigv = [e[0] for e in eig_expr]
eigw = [e[-1][0] for e in eig_expr]

eigv = sp.Matrix(eigv) # Column vector
eigw = sp.Matrix(eigw) # Row has the elements
eigw = sp.Matrix([[eigw[0],eigw[2]],[eigw[1],eigw[3]]])
eigv = sp.Matrix([[eigv[0], 0.0],[0.0, eigv[1]]])

eigv_expr = map(str, eigv)
eigw_expr = map(str, eigw)

#----------------------------------------------------------------------#


#----------------------------------------------------------------------#
# Create UFL operators for the eigenvalues and eigenvectors

# UFL operator for eigenvalues of 2x2 matrix, a pair of scalars
def eigv(T): return map(eval, eigv_expr)

# UFL operator for eigenvectors of 2x2 matrix, a pair of vectors
def eigw(T): return map(eval, eigw_expr)

#----------------------------------------------------------------------#

spd = 2 # Spatial dimension

n = 16 # Size of mesh
mesh = UnitSquareMesh(n, n)

V = VectorFunctionSpace(mesh, 'CG', 1) # V = TensorFunctionSpace(mesh, 'CG', 1) -&gt; Original
V_t = TensorFunctionSpace(mesh, 'CG', 1)

x = SpatialCoordinate(mesh)

# Define variational problem
u = TrialFunction(V)
v = TestFunction(V)
f = Constant((0., -1.0))
T = Constant((0., 0.))

# Define boundary condition
tol = 1E-14

def clamped_boundary(x, on_boundary):
    return on_boundary and x[0] &lt; tol

bc = DirichletBC(V, Constant((0, 0)), clamped_boundary)

def eps(u):
    return  sym(grad(u))


def strn(u):
    t_e = eps(u)

    v00, v01, v10, v11 = eigv(t_e)

    w00, w01, w10, w11 = eigw(t_e)

    wp = ([w00,w01],[w10,w11])
    wp = as_tensor(wp)

    vp = ([v00,v01],[v10,v11])
    vp = as_tensor(vp)

    return wp*vp*inv(wp)



lmbda = 10.0
mu = 1.0

def sigma(u):
    #return lmbda*(tr(eps(u)))*Identity(spd) +2*mu*eps(u)
    # To compare the answers

    # Using strn instead of eps(u) gives the following error:
    # ArityMismatch("Applying nonlinear operator {0} to expression depending on form argument {1}.".format(o._ufl_class_.__name__, t))
    # ArityMismatch: Applying nonlinear operator Sqrt to expression depending on form argument v_1.
    # Here : https://fenicsproject.org/qa/6882/problem-with-mixed-space-formulation
    # It is mentioned that the object to be projected must not be defined in terms of trial/test functions
    # Seems irrelevant but the only one that is close enough

    return lmbda*(tr(strn(u)))*Identity(spd) +2.0*mu*strn(u)

a = inner(sigma(u),eps(v))*dx
L = dot(f, v)*dx + dot(T, v)*ds


# Compute solution
u = Function(V)
solve(a == L, u, bc)

# Not adding the following line gives an error
# Why do we need to add this here?
V = FunctionSpace(mesh, 'CG', 1)

# Compute magnitude of displacement
u_magnitude = sqrt(dot(u, u))
u_magnitude = project(u_magnitude, V)
#plot(u_magnitude, 'Displacement magnitude')
# Any suggestions?
print('min/max u:',
      u_magnitude.vector().array().min(),
      u_magnitude.vector().array().max())
</code></pre>

<p>Error message</p>

<blockquote>
  <p>in nonlinear_operator<br>
      raise ArityMismatch("Applying nonlinear operator {0} to expression depending on form argument {1}.".format(o._ufl_class_.<strong>name</strong>, t))<br>
  ArityMismatch: Applying nonlinear operator Sqrt to expression depending on form argument v_1.</p>
</blockquote>

<p>Any suggestions?</p>
</div>
													</div>
													<div class="qa-c-item-footer">
														<span class="qa-c-item-avatar-meta">
															<span class="qa-c-item-meta">
																<a href="../../13600/possible-perform-spectral-decomposition-current-operators?show=13780#c13780" class="qa-c-item-what">commented</a>
																<span class="qa-c-item-when">
																	<span class="qa-c-item-when-data"><span class="published"><span class="value-title" title="2017-06-02T09:08:33+0000"></span>Jun 2, 2017</span></span>
																</span>
																<span class="qa-c-item-who">
																	<span class="qa-c-item-who-pad">by </span>
																	<span class="qa-c-item-who-data"><span class="vcard author"><a href="../../user/vivekkr1809" class="qa-user-link url nickname">vivekkr1809</a></span></span>
																	<span class="qa-c-item-who-title">FEniCS Novice</span>
																	<span class="qa-c-item-who-points">
																		<span class="qa-c-item-who-points-pad">(</span><span class="qa-c-item-who-points-data">510</span><span class="qa-c-item-who-points-pad"> points)</span>
																	</span>
																</span>
															</span>
														</span>
														<div class="qa-c-item-buttons">
														</div>
													</div>
													<div class="qa-c-item-clear">
													</div>
												</div> <!-- END qa-c-item -->
												<div class="qa-c-list-item  hentry comment" id="c13783">
													<div class="qa-c-item-content">
														<a name="13783"></a><div class="entry-content"><p>Basically function <code>sigma</code> above is nonlinear as a consequence of eigenpair computations. You need to set up the problem as nonlinear with u as a <code>Function</code>.</p>
</div>
													</div>
													<div class="qa-c-item-footer">
														<span class="qa-c-item-avatar-meta">
															<span class="qa-c-item-avatar">
																<a href="../../user/MiroK" class="qa-avatar-link"><img src="https://www.gravatar.com/avatar/f566be3274ec73e3a6dda27bca11631c?s=20" width="20" height="20" class="qa-avatar-image" alt=""></a>
															</span>
															<span class="qa-c-item-meta">
																<a href="../../13600/possible-perform-spectral-decomposition-current-operators?show=13783#c13783" class="qa-c-item-what">commented</a>
																<span class="qa-c-item-when">
																	<span class="qa-c-item-when-data"><span class="published"><span class="value-title" title="2017-06-02T09:45:56+0000"></span>Jun 2, 2017</span></span>
																</span>
																<span class="qa-c-item-who">
																	<span class="qa-c-item-who-pad">by </span>
																	<span class="qa-c-item-who-data"><span class="vcard author"><a href="../../user/MiroK" class="qa-user-link url nickname">MiroK</a></span></span>
																	<span class="qa-c-item-who-title">FEniCS Expert</span>
																	<span class="qa-c-item-who-points">
																		<span class="qa-c-item-who-points-pad">(</span><span class="qa-c-item-who-points-data">80,920</span><span class="qa-c-item-who-points-pad"> points)</span>
																	</span>
																</span>
															</span>
														</span>
														<div class="qa-c-item-buttons">
														</div>
													</div>
													<div class="qa-c-item-clear">
													</div>
												</div> <!-- END qa-c-item -->
												<div class="qa-c-list-item  hentry comment" id="c13784">
													<div class="qa-c-item-content">
														<a name="13784"></a><div class="entry-content"><p>Thanks! It works.</p>
</div>
													</div>
													<div class="qa-c-item-footer">
														<span class="qa-c-item-avatar-meta">
															<span class="qa-c-item-meta">
																<a href="../../13600/possible-perform-spectral-decomposition-current-operators?show=13784#c13784" class="qa-c-item-what">commented</a>
																<span class="qa-c-item-when">
																	<span class="qa-c-item-when-data"><span class="published"><span class="value-title" title="2017-06-02T09:57:40+0000"></span>Jun 2, 2017</span></span>
																</span>
																<span class="qa-c-item-who">
																	<span class="qa-c-item-who-pad">by </span>
																	<span class="qa-c-item-who-data"><span class="vcard author"><a href="../../user/vivekkr1809" class="qa-user-link url nickname">vivekkr1809</a></span></span>
																	<span class="qa-c-item-who-title">FEniCS Novice</span>
																	<span class="qa-c-item-who-points">
																		<span class="qa-c-item-who-points-pad">(</span><span class="qa-c-item-who-points-data">510</span><span class="qa-c-item-who-points-pad"> points)</span>
																	</span>
																</span>
															</span>
														</span>
														<div class="qa-c-item-buttons">
														</div>
													</div>
													<div class="qa-c-item-clear">
													</div>
												</div> <!-- END qa-c-item -->
												<div class="qa-c-list-item  hentry comment" id="c13785">
													<div class="qa-c-item-content">
														<a name="13785"></a><div class="entry-content"><p>Update:<br>
Even though it worked, i.e. no Arity errors. My Newton solver is no longer able to solve the problem.  The errors shown are  : r(abs)=-nan; r(rel)=-nan. I am looking into the possible sources of errors.</p>
</div>
													</div>
													<div class="qa-c-item-footer">
														<span class="qa-c-item-avatar-meta">
															<span class="qa-c-item-meta">
																<a href="../../13600/possible-perform-spectral-decomposition-current-operators?show=13785#c13785" class="qa-c-item-what">commented</a>
																<span class="qa-c-item-when">
																	<span class="qa-c-item-when-data"><span class="published"><span class="value-title" title="2017-06-02T10:25:13+0000"></span>Jun 2, 2017</span></span>
																</span>
																<span class="qa-c-item-who">
																	<span class="qa-c-item-who-pad">by </span>
																	<span class="qa-c-item-who-data"><span class="vcard author"><a href="../../user/vivekkr1809" class="qa-user-link url nickname">vivekkr1809</a></span></span>
																	<span class="qa-c-item-who-title">FEniCS Novice</span>
																	<span class="qa-c-item-who-points">
																		<span class="qa-c-item-who-points-pad">(</span><span class="qa-c-item-who-points-data">510</span><span class="qa-c-item-who-points-pad"> points)</span>
																	</span>
																</span>
															</span>
														</span>
														<div class="qa-c-item-buttons">
														</div>
													</div>
													<div class="qa-c-item-clear">
													</div>
												</div> <!-- END qa-c-item -->
												<div class="qa-c-list-item  hentry comment" id="c13788">
													<div class="qa-c-item-content">
														<a name="13788"></a><div class="entry-content"><p>I figured out the error. It was the incorrect initialization of the solution function.</p>

<p>Thanks a lot for the help MiroK</p>
</div>
													</div>
													<div class="qa-c-item-footer">
														<span class="qa-c-item-avatar-meta">
															<span class="qa-c-item-meta">
																<a href="../../13600/possible-perform-spectral-decomposition-current-operators?show=13788#c13788" class="qa-c-item-what">commented</a>
																<span class="qa-c-item-when">
																	<span class="qa-c-item-when-data"><span class="published"><span class="value-title" title="2017-06-02T18:49:13+0000"></span>Jun 2, 2017</span></span>
																</span>
																<span class="qa-c-item-who">
																	<span class="qa-c-item-who-pad">by </span>
																	<span class="qa-c-item-who-data"><span class="vcard author"><a href="../../user/vivekkr1809" class="qa-user-link url nickname">vivekkr1809</a></span></span>
																	<span class="qa-c-item-who-title">FEniCS Novice</span>
																	<span class="qa-c-item-who-points">
																		<span class="qa-c-item-who-points-pad">(</span><span class="qa-c-item-who-points-data">510</span><span class="qa-c-item-who-points-pad"> points)</span>
																	</span>
																</span>
															</span>
														</span>
														<div class="qa-c-item-buttons">
														</div>
													</div>
													<div class="qa-c-item-clear">
													</div>
												</div> <!-- END qa-c-item -->
												<div class="qa-c-list-item  hentry comment" id="c13790">
													<div class="qa-c-item-content">
														<a name="13790"></a><div class="entry-content"><p>Perfect, could you update the code you posted in the comment such that it works? Thanks.</p>
</div>
													</div>
													<div class="qa-c-item-footer">
														<span class="qa-c-item-avatar-meta">
															<span class="qa-c-item-avatar">
																<a href="../../user/MiroK" class="qa-avatar-link"><img src="https://www.gravatar.com/avatar/f566be3274ec73e3a6dda27bca11631c?s=20" width="20" height="20" class="qa-avatar-image" alt=""></a>
															</span>
															<span class="qa-c-item-meta">
																<a href="../../13600/possible-perform-spectral-decomposition-current-operators?show=13790#c13790" class="qa-c-item-what">commented</a>
																<span class="qa-c-item-when">
																	<span class="qa-c-item-when-data"><span class="published"><span class="value-title" title="2017-06-02T19:19:30+0000"></span>Jun 2, 2017</span></span>
																</span>
																<span class="qa-c-item-who">
																	<span class="qa-c-item-who-pad">by </span>
																	<span class="qa-c-item-who-data"><span class="vcard author"><a href="../../user/MiroK" class="qa-user-link url nickname">MiroK</a></span></span>
																	<span class="qa-c-item-who-title">FEniCS Expert</span>
																	<span class="qa-c-item-who-points">
																		<span class="qa-c-item-who-points-pad">(</span><span class="qa-c-item-who-points-data">80,920</span><span class="qa-c-item-who-points-pad"> points)</span>
																	</span>
																</span>
															</span>
														</span>
														<div class="qa-c-item-buttons">
														</div>
													</div>
													<div class="qa-c-item-clear">
													</div>
												</div> <!-- END qa-c-item -->
												<div class="qa-c-list-item  hentry comment" id="c13793">
													<div class="qa-c-item-content">
														<a name="13793"></a><div class="entry-content"><p>Added it as an answer. Thanks!</p>
</div>
													</div>
													<div class="qa-c-item-footer">
														<span class="qa-c-item-avatar-meta">
															<span class="qa-c-item-meta">
																<a href="../../13600/possible-perform-spectral-decomposition-current-operators?show=13793#c13793" class="qa-c-item-what">commented</a>
																<span class="qa-c-item-when">
																	<span class="qa-c-item-when-data"><span class="published"><span class="value-title" title="2017-06-02T19:34:16+0000"></span>Jun 2, 2017</span></span>
																</span>
																<span class="qa-c-item-who">
																	<span class="qa-c-item-who-pad">by </span>
																	<span class="qa-c-item-who-data"><span class="vcard author"><a href="../../user/vivekkr1809" class="qa-user-link url nickname">vivekkr1809</a></span></span>
																	<span class="qa-c-item-who-title">FEniCS Novice</span>
																	<span class="qa-c-item-who-points">
																		<span class="qa-c-item-who-points-pad">(</span><span class="qa-c-item-who-points-data">510</span><span class="qa-c-item-who-points-pad"> points)</span>
																	</span>
																</span>
															</span>
														</span>
														<div class="qa-c-item-buttons">
														</div>
													</div>
													<div class="qa-c-item-clear">
													</div>
												</div> <!-- END qa-c-item -->
											</div> <!-- END qa-c-list -->
											
											<input type="hidden" name="code" value="0-1516467872-5ce3a9c55465cccb43a144a3b72075941ff4825e">
											<input type="hidden" name="qa_click" value="">
										</form>
										<div class="qa-c-form">
										</div> <!-- END qa-c-form -->
										
									</div> <!-- END qa-a-item-main -->
									<div class="qa-a-item-clear">
									</div>
								</div> <!-- END qa-a-list-item -->
								
								<div class="qa-a-list-item  hentry answer" id="a13792">
									<form method="post" action="../../13600/possible-perform-spectral-decomposition-current-operators">
										<div class="qa-voting qa-voting-net" id="voting_13792">
											<div class="qa-vote-count qa-vote-count-net">
												<span class="qa-netvote-count">
													<span class="qa-netvote-count-data">+2<span class="votes-up"><span class="value-title" title="2"></span></span><span class="votes-down"><span class="value-title" title="0"></span></span></span><span class="qa-netvote-count-pad"> votes</span>
												</span>
											</div>
											<div class="qa-vote-clear">
											</div>
										</div>
										<input type="hidden" name="code" value="0-1516467872-fb81fd8406b2ecfdc018573cf8d87c7fe5a0a1b2">
									</form>
									<div class="qa-a-item-main">
										<form method="post" action="../../13600/possible-perform-spectral-decomposition-current-operators">
											<div class="qa-a-selection">
											</div>
											<div class="qa-a-item-content">
												<a name="13792"></a><div class="entry-content"><p>I am answering my own question so that a working code is available:</p>

<p>Code for eigenvalue decomposition:</p>

<pre><code>from dolfin import *
import sympy as sp
import numpy as np
import numpy.linalg as LA

#----------------------------------------------------------------------#
# set some dolfin specific parameters
parameters["form_compiler"]["optimize"]     = True
parameters["form_compiler"]["cpp_optimize"] = True
parameters["form_compiler"]["representation"] = 'uflacs'  
#----------------------------------------------------------------------#

#----------------------------------------------------------------------#
# Compute the symbolic expression for eigenvalues by sympy
T = sp.Matrix(2, 2, lambda i, j: sp.Symbol('T[%d, %d]' % (i, j), symmetric =True, real=True))
eig_expr = T.eigenvects()   # ((v, multiplicity, [w])...)
#eig_expr = T.LDLdecomposition()

eigv = [e[0] for e in eig_expr]
eigw = [e[-1][0] for e in eig_expr]

eigv = sp.Matrix(eigv) # Column vector
eigw = sp.Matrix(eigw) # Row has the elements
eigw = sp.Matrix([[eigw[0],eigw[2]],[eigw[1],eigw[3]]])
eigv = sp.Matrix([[eigv[0], 0.0],[0.0, eigv[1]]])

eigv_expr = map(str, eigv)
eigw_expr = map(str, eigw)

#----------------------------------------------------------------------#


#----------------------------------------------------------------------#
# Create UFL operators for the eigenvalues and eigenvectors

# UFL operator for eigenvalues of 2x2 matrix, a pair of scalars
def eigv(T): return map(eval, eigv_expr)

# UFL operator for eigenvectors of 2x2 matrix, a pair of vectors
def eigw(T): return map(eval, eigw_expr)

#----------------------------------------------------------------------#

spd = 2 # Spatial dimension

n = 16 # Size of mesh
mesh = UnitSquareMesh(n, n)

V = VectorFunctionSpace(mesh, 'CG', 1) # V = TensorFunctionSpace(mesh, 'CG', 1) -&gt; Original

x = SpatialCoordinate(mesh)

# Define variational problem
du = TrialFunction(V)
delta_u = TestFunction(V)

# set up solution functions
uh = Function(V,name='displacement')
# The way the eigenvalues are computed we cannot allow a constant value of u at start

uh_array = uh.vector().array()
uh_array = np.random.rand(len(uh_array))
uh.vector()[:] = uh_array


force = Constant((0., -1.0))
T = Constant((0., 0.))

# Define boundary condition
tol = 1E-14

def clamped_boundary(x, on_boundary):
    return on_boundary and x[0] &lt; tol

bc = DirichletBC(V, Constant((0, 0)), clamped_boundary)

def eps(u):
    return  sym(grad(u))


def strn(u):
    t = sym(grad(u))

    v00, v01, v10, v11 = eigv(t)

    w00, w01, w10, w11 = eigw(t)

    w = ([w00,w01],[w10,w11])
    w = as_tensor(w)

    v = ([v00,v01],[v10,v11])

    v = as_tensor(v)


    return w*v*inv(w)
# Positive strain
def strn_p(u):
    t = sym(grad(u))
    v00, v01, v10, v11 = eigv(t)

    v00 = conditional(gt(v00,0.0),v00,0.0)
    v11 = conditional(gt(v11,0.0),v11,0.0)

    w00, w01, w10, w11 = eigw(t)
    wp = ([w00,w01],[w10,w11])
    wp = as_tensor(wp)
    vp = ([v00,v01],[v10,v11])
    vp = as_tensor(vp)  
    return wp*vp*inv(wp)
# Negative strain
def strn_n(u):
    t = sym(grad(u))
    v00, v01, v10, v11 = eigv(t)
    v00 = conditional(lt(v00,0.0),v00,0.0)
    v11 = conditional(lt(v11,0.0),v11,0.0)
    w00, w01, w10, w11 = eigw(t)
    wn = ([w00,w01],[w10,w11])
    wn = as_tensor(wn)
    vn = ([v00,v01],[v10,v11])
    vn = as_tensor(vn)  
    return wn*vn*inv(wn)

lmbda = 10.0
mu = 1.0

def sigma(u):

    #return lmbda*(tr(eps(u)))*Identity(spd) +2*mu*eps(u)

    # To compare the answers

    return lmbda*(tr(strn_p(u)+strn_n(u)))*Identity(spd) +2.0*mu*(strn_p(u)+strn_n(u))




F_u = inner(sigma(uh),grad(delta_u))*dx + dot(force, delta_u)*dx

J_u = derivative(F_u, uh, du )

# Compute solution
problem = NonlinearVariationalProblem(F_u, uh, bc, J_u)
solver  = NonlinearVariationalSolver(problem)

solver.solve()

V = FunctionSpace(mesh, 'CG', 1)

# Compute magnitude of displacement
u_magnitude = sqrt(dot(uh, uh))
u_magnitude = project(u_magnitude, V)
#plot(u_magnitude, 'Displacement magnitude')
# Any suggestions?
print('min/max u:',
      u_magnitude.vector().array().min(),
      u_magnitude.vector().array().max())

#----------------------------------------------------------------------#
# A simple 2-D elasticity problem ends here.
# The solution obtained was:
# ('min/max u:', -5.0591841289798924e-05, 0.9251112919755422)
#
# Reconstructing the strain gives:
#('min/max u:', -5.0591841289772903e-05, 0.92511129197543296)
# Obtaining the values manually and solving gives me the same answer.
#----------------------------------------------------------------------#
</code></pre>
</div>
											</div>
											<span class="qa-a-item-avatar-meta">
												<span class="qa-a-item-meta">
													<a href="../../13600/possible-perform-spectral-decomposition-current-operators?show=13792#a13792" class="qa-a-item-what">answered</a>
													<span class="qa-a-item-when">
														<span class="qa-a-item-when-data"><span class="published"><span class="value-title" title="2017-06-02T19:33:42+0000"></span>Jun 2, 2017</span></span>
													</span>
													<span class="qa-a-item-who">
														<span class="qa-a-item-who-pad">by </span>
														<span class="qa-a-item-who-data"><span class="vcard author"><a href="../../user/vivekkr1809" class="qa-user-link url nickname">vivekkr1809</a></span></span>
														<span class="qa-a-item-who-title">FEniCS Novice</span>
														<span class="qa-a-item-who-points">
															<span class="qa-a-item-who-points-pad">(</span><span class="qa-a-item-who-points-data">510</span><span class="qa-a-item-who-points-pad"> points)</span>
														</span>
													</span>
												</span>
											</span>
											<div class="qa-a-item-buttons">
												</div>
											
											<div class="qa-a-item-c-list" id="c13792_list">
												<div class="qa-c-list-item  hentry comment" id="c13794">
													<div class="qa-c-item-content">
														<a name="13794"></a><div class="entry-content"><p>Cool, is there a need for <code>inv</code> in <code>str_n</code> and <code>str_p</code>? The eigenvectors should be orthonormal and therefore the inverse could be computed by transpose and in your case the expression for it defined directly. In any case, nicely done.</p>
</div>
													</div>
													<div class="qa-c-item-footer">
														<span class="qa-c-item-avatar-meta">
															<span class="qa-c-item-avatar">
																<a href="../../user/MiroK" class="qa-avatar-link"><img src="https://www.gravatar.com/avatar/f566be3274ec73e3a6dda27bca11631c?s=20" width="20" height="20" class="qa-avatar-image" alt=""></a>
															</span>
															<span class="qa-c-item-meta">
																<a href="../../13600/possible-perform-spectral-decomposition-current-operators?show=13794#c13794" class="qa-c-item-what">commented</a>
																<span class="qa-c-item-when">
																	<span class="qa-c-item-when-data"><span class="published"><span class="value-title" title="2017-06-02T19:46:23+0000"></span>Jun 2, 2017</span></span>
																</span>
																<span class="qa-c-item-who">
																	<span class="qa-c-item-who-pad">by </span>
																	<span class="qa-c-item-who-data"><span class="vcard author"><a href="../../user/MiroK" class="qa-user-link url nickname">MiroK</a></span></span>
																	<span class="qa-c-item-who-title">FEniCS Expert</span>
																	<span class="qa-c-item-who-points">
																		<span class="qa-c-item-who-points-pad">(</span><span class="qa-c-item-who-points-data">80,920</span><span class="qa-c-item-who-points-pad"> points)</span>
																	</span>
																</span>
															</span>
														</span>
														<div class="qa-c-item-buttons">
														</div>
													</div>
													<div class="qa-c-item-clear">
													</div>
												</div> <!-- END qa-c-item -->
												<div class="qa-c-list-item  hentry comment" id="c13795">
													<div class="qa-c-item-content">
														<a name="13795"></a><div class="entry-content"><p>Hi Miroslav,</p>

<p>Using the transpose instead of inverse was giving erroneous results. I am not exactly sure why. One possibility could be that the eigenvalue decomposition does not lead to orthogonal vectors. If  could find the reason and the solution, I would update the code. I am looking into it so that the computations could be faster. </p>

<p>Thanks</p>
</div>
													</div>
													<div class="qa-c-item-footer">
														<span class="qa-c-item-avatar-meta">
															<span class="qa-c-item-meta">
																<a href="../../13600/possible-perform-spectral-decomposition-current-operators?show=13795#c13795" class="qa-c-item-what">commented</a>
																<span class="qa-c-item-when">
																	<span class="qa-c-item-when-data"><span class="published"><span class="value-title" title="2017-06-02T22:35:34+0000"></span>Jun 3, 2017</span></span>
																</span>
																<span class="qa-c-item-who">
																	<span class="qa-c-item-who-pad">by </span>
																	<span class="qa-c-item-who-data"><span class="vcard author"><a href="../../user/vivekkr1809" class="qa-user-link url nickname">vivekkr1809</a></span></span>
																	<span class="qa-c-item-who-title">FEniCS Novice</span>
																	<span class="qa-c-item-who-points">
																		<span class="qa-c-item-who-points-pad">(</span><span class="qa-c-item-who-points-data">510</span><span class="qa-c-item-who-points-pad"> points)</span>
																	</span>
																</span>
															</span>
														</span>
														<div class="qa-c-item-buttons">
														</div>
													</div>
													<div class="qa-c-item-clear">
													</div>
												</div> <!-- END qa-c-item -->
											</div> <!-- END qa-c-list -->
											
											<input type="hidden" name="code" value="0-1516467872-d07dbf7bebebf484fd09abadf61ebd972a696680">
											<input type="hidden" name="qa_click" value="">
										</form>
										<div class="qa-c-form">
										</div> <!-- END qa-c-form -->
										
									</div> <!-- END qa-a-item-main -->
									<div class="qa-a-item-clear">
									</div>
								</div> <!-- END qa-a-list-item -->
								
							</div> <!-- END qa-a-list -->
							
						</div>
					</div> <!-- END qa-main -->
					
				</div> <!-- END main-wrapper -->
			</div> <!-- END main-shadow -->
		</div> <!-- END body-wrapper -->
		<!-- END footer-bottom-group -->
		
		<div style="position:absolute; left:-9999px; top:-9999px;">
			<span id="qa-waiting-template" class="qa-waiting">...</span>
		</div>
	
	

</body><!-- Powered by Question2Answer - http://www.question2answer.org/ --></html>