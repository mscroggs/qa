<html><!-- Powered by Question2Answer - http://www.question2answer.org/ --><head>
		<meta http-equiv="content-type" content="text/html; charset=utf-8">
		<title>Scalar Mixed Function Space Problem - FEniCS Q&amp;A</title>
		<meta name="description" content="Hello I am trying to solve two coupled equations (Nernst-Planck and Poisson) for a simple domain. First ...  C_previous*v_1*dx u = Function(W) while t">
		<meta name="keywords" content="mixed-formulation,mixed-function-space,split">
		<link rel="stylesheet" type="text/css" href="../../qa-theme/Snow/qa-styles.css">
		<link rel="canonical" href="http://fenicsproject.org/qa/13269/scalar-mixed-function-space-problem">
		<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
    tex2jax: {inlineMath: [["$","$"],["\\(","\\)"]]},
    TeX: { extensions: ["AMSmath.js","AMSsymbols.js"]}
  });
</script>
<script type="text/javascript" src="../../mathjax/MathJax.js"></script>
		<script src="../../jquery-1.7.2.min.js" type="text/javascript"></script>
		<script src="../../highlight.min.js"></script>
<script type="text/javascript">
$(function(){
	$('.wmd-input').keypress(function(){
		window.clearTimeout(hljs.Timeout);
		hljs.Timeout = window.setTimeout(function() {
			hljs.initHighlighting.called = false;
			hljs.initHighlighting();
		}, 500);
	});
	window.setTimeout(function() {
		hljs.initHighlighting.called = false;
		hljs.initHighlighting();
	}, 500);
});
</script>


	</head>
	<body class="qa-template-question qa-body-js-off">
		<div class="qa-body-wrapper">
			
			<div class="qa-header">
				<div class="qa-logo">
					<a href="../../" class="qa-logo-link" title="FEniCS Q&amp;A"><img src="../../qa-theme/fenics_qa.png" border="0" alt="FEniCS Q&amp;A"></a>
				</div>
				<div class="qa-header-clear">
				</div>
			</div> <!-- END qa-header -->
			
			<div class="qa-main-shadow">
				
				<div class="qa-main-wrapper">
					
					<div class="qa-sidepanel">
						<div class="qa-sidebar">
							This is a read only copy of the old FEniCS QA forum. Please visit the <a href="https://www.allanswered.com/community/s/fenics-project/">new QA forum</a> to ask questions
						</div>
						
					</div>
					
					<div class="qa-main">
						<h1>
							<span class="entry-title">Scalar Mixed Function Space Problem</span>
						</h1>
						<div class="qa-part-q-view">
							<div class="qa-q-view  hentry question" id="q13269">
								<form method="post" action="../../13269/scalar-mixed-function-space-problem">
									<div class="qa-q-view-stats">
										<div class="qa-voting qa-voting-net" id="voting_13269">
											<div class="qa-vote-count qa-vote-count-net">
												<span class="qa-netvote-count">
													<span class="qa-netvote-count-data">+2<span class="votes-up"><span class="value-title" title="2"></span></span><span class="votes-down"><span class="value-title" title="0"></span></span></span><span class="qa-netvote-count-pad"> votes</span>
												</span>
											</div>
											<div class="qa-vote-clear">
											</div>
										</div>
									</div>
									<input type="hidden" name="code" value="0-1516467859-953e1e1a93927bdc99da3d5a9705377defddaefa">
								</form>
								<div class="qa-q-view-main">
									<form method="post" action="../../13269/scalar-mixed-function-space-problem">
										<div class="qa-q-view-content">
											<a name="13269"></a><div class="entry-content"><p>Hello<br>
I am trying to solve two coupled equations (Nernst-Planck and Poisson) for a simple domain. First of all I would like to explain my equations and boundary conditions. The equations are:<br>
<img src="http://i.imgur.com/wxZiztO.jpg" alt="enter image description here"><br>
For the above equations <strong>c</strong> and <strong>phi</strong> are the unknowns corresponding to the concentration and electrical potential respectively. In addition, <strong>epsilon</strong> is constant = 0.0082<br>
The domain is a square as shown below:<br>
<img src="http://i.imgur.com/HSSX3Tz.jpg" alt="enter image description here"><br>
The Dirichlet boundary condition should be applied on the top and the bottom boundaries:<br>
<img src="http://i.imgur.com/j2zSM3l.jpg" alt="enter image description here"><br>
For both unknowns, zero Neumann boundary condition should be applied on all of the boundaries.<br>
In order to derive the weak form of the Eq.1 we can multiply the Eq.1 by a test function <strong>(v_1)</strong> :<br>
<img src="http://i.imgur.com/GNNzlq1.jpg" alt="enter image description here"><br>
After integration by parts and applying zero Neumann boundary conditions:</p>

<p><img src="http://i.imgur.com/l4Q6SC7.jpg" alt="enter image description here"><br>
After discretizing the first term in the Eq.4:<br>
<img src="http://i.imgur.com/FPpKgxK.jpg" alt="enter image description here"><br>
The c_0 in the above equation corresponds to the solution in the previous time step.Finally the weak form of the Eq.1 can be derived as:<br>
<img src="http://i.imgur.com/sMrWECO.jpg" alt="enter image description here"><br>
We can derive the weak form of the Eq.2 easily by multiplying it by another test function <strong>(v_2)</strong>:<br>
<img src="http://i.imgur.com/RoI0AgO.jpg" alt="enter image description here"><br>
After integration by parts (and considering zero Neumann B.C) the weak form of the Eq.2 can be derived as:<br>
<img src="http://i.imgur.com/lelWkik.jpg" alt="enter image description here"><br>
<strong>The weak form of the whole system</strong> is obtained by summing up the Eq.6 and Eq.8:<br>
<img src="http://i.imgur.com/MI25TFn.jpg" alt="enter image description here"><br>
As far as I know, I should use a mixed function space for the two unknowns in this problem (c &amp; phi). I have implemented it in a code but I am getting an error. This is my complete code:</p>

<pre><code>from dolfin import *
import mshr

# Define boundaries
class Left(SubDomain):
    def inside(self, x, on_boundary):
        return near(x[0], 0.0)

class Right(SubDomain):
    def inside(self, x, on_boundary):
        return near(x[0], 1.0)

class Bottom(SubDomain):
    def inside(self, x, on_boundary):
        return near(x[1], 0.0)

class Top(SubDomain):
    def inside(self, x, on_boundary):
        return near(x[1], 1.0)

# Initialize sub-domain instances
left = Left()
top = Top()
right = Right()
bottom = Bottom()

# Domain
domain = mshr.Rectangle(Point(0,0), Point(1,1))

# Mesh
mesh = mshr.generate_mesh(domain, 20)

# Marking boundary domains
boundaries = FacetFunction("size_t", mesh)
boundaries.set_all(0)
left.mark(boundaries, 2)
top.mark(boundaries, 1)
right.mark(boundaries, 4)
bottom.mark(boundaries, 3)

#Defining the function spaces for the concentration
V_c = FunctionSpace(mesh, 'CG', 1)

#Defining the function spaces for the voltage
V_phi = FunctionSpace(mesh, 'CG', 1)

#Defining the mixed function space
W = MixedFunctionSpace((V_c, V_phi))

#Defining the Trial  functions
(c, phi) = TrialFunctions(W)

#Defining the test  functions
(v_1, v_2) = TestFunctions(W)

# Time variables
dt = 0.05; t = 0; T = 1.1

# Previous solution
W_const = Constant((1200))
C_previous= interpolate(W_const, V_c)

# Define Dirichlet boundary conditions at top boundary (V=4.0 volt)
Voltage = Constant((4.0))
bc_top = DirichletBC(W.sub(1), Voltage, 1)

# Define Dirichlet boundary conditions at bottom boundary (V=0.0 volt)
bc_bottom = DirichletBC(W.sub(1), 0.0, 3)

#Collecting the boundary conditions
bcs = [bc_top, bc_bottom]

#Define eps in the weak form
eps=0.0082

# Define variational form
a = dot(grad(phi),grad(v_2))*dx - (1./(2*(pow(eps,2))))*c*v_2*dx\
    + (1./(2*(pow(eps,2))))*v_2*dx+c*v_1*dx\
     +dt *eps*dot(grad(c),grad(v_1))*dx\
     +dt*eps*c*dot(grad(phi),grad(v_1))*dx

L = C_previous*v_1*dx

u = Function(W)

while t &lt;= T:
    A, b = assemble_system(a, L, bcs)

    solve(A, u.vector(), b)
    (c, phi) = u.split()

    C_previous.assign(c)

    t += dt
    plot(c, interactive=False)
</code></pre>

<p>This is the error I get: </p>

<pre><code>#line 87, in &lt;module&gt;
    A, b = assemble_system(a, L, bcs)
</code></pre>

<p>I think there is something wrong in the defining the variational form that should be exactly the Eq.9. In addition to that I am not sure about this line:</p>

<pre><code>    solve(A, u.vector(), b)
</code></pre>

<p>As you can see in the code, finally I want to split the mixed space and for example plot the concentration (c) over the time. <br>
Could you please help get this code to work? Thanks in advance for your time.</p>
</div>
										</div>
										<div class="qa-q-view-tags">
											<ul class="qa-q-view-tag-list">
												<li class="qa-q-view-tag-item"><a href="../../tag/mixed-formulation" rel="tag" class="qa-tag-link">mixed-formulation</a></li>
												<li class="qa-q-view-tag-item"><a href="../../tag/mixed-function-space" rel="tag" class="qa-tag-link">mixed-function-space</a></li>
												<li class="qa-q-view-tag-item"><a href="../../tag/split" rel="tag" class="qa-tag-link">split</a></li>
											</ul>
										</div>
										<span class="qa-q-view-avatar-meta">
											<span class="qa-q-view-meta">
												<a href="../../13269/scalar-mixed-function-space-problem" class="qa-q-view-what">asked</a>
												<span class="qa-q-view-when">
													<span class="qa-q-view-when-data"><span class="published"><span class="value-title" title="2017-05-01T06:27:51+0000"></span>May 1, 2017</span></span>
												</span>
												<span class="qa-q-view-who">
													<span class="qa-q-view-who-pad">by </span>
													<span class="qa-q-view-who-data"><span class="vcard author"><a href="../../user/Leo" class="qa-user-link url nickname">Leo</a></span></span>
													<span class="qa-q-view-who-title">FEniCS Novice</span>
													<span class="qa-q-view-who-points">
														<span class="qa-q-view-who-points-pad">(</span><span class="qa-q-view-who-points-data">840</span><span class="qa-q-view-who-points-pad"> points)</span>
													</span>
												</span>
											</span>
										</span>
										<div class="qa-q-view-buttons">
										</div>
										
										<div class="qa-q-view-c-list" id="c13269_list">
											<div class="qa-c-list-item  hentry comment" id="c13273">
												<div class="qa-c-item-content">
													<a name="13273"></a><div class="entry-content"><p>Your system of equations is nonlinear if solve simultaneously. C.f. dot(c*grad(phi), grad(v1)).</p>
</div>
												</div>
												<div class="qa-c-item-footer">
													<span class="qa-c-item-avatar-meta">
														<span class="qa-c-item-avatar">
															<a href="../../user/nate" class="qa-avatar-link"><img src="../../?qa=image&amp;qa_blobid=969593914916706065&amp;qa_size=20" width="20" height="20" class="qa-avatar-image" alt=""></a>
														</span>
														<span class="qa-c-item-meta">
															<a href="../../13269/scalar-mixed-function-space-problem?show=13273#c13273" class="qa-c-item-what">commented</a>
															<span class="qa-c-item-when">
																<span class="qa-c-item-when-data"><span class="published"><span class="value-title" title="2017-05-01T09:08:04+0000"></span>May 1, 2017</span></span>
															</span>
															<span class="qa-c-item-who">
																<span class="qa-c-item-who-pad">by </span>
																<span class="qa-c-item-who-data"><span class="vcard author"><a href="../../user/nate" class="qa-user-link url nickname">nate</a></span></span>
																<span class="qa-c-item-who-title">FEniCS Expert</span>
																<span class="qa-c-item-who-points">
																	<span class="qa-c-item-who-points-pad">(</span><span class="qa-c-item-who-points-data">17,050</span><span class="qa-c-item-who-points-pad"> points)</span>
																</span>
															</span>
														</span>
													</span>
													<div class="qa-c-item-buttons">
													</div>
												</div>
												<div class="qa-c-item-clear">
												</div>
											</div> <!-- END qa-c-item -->
											<div class="qa-c-list-item  hentry comment" id="c13278">
												<div class="qa-c-item-content">
													<a name="13278"></a><div class="entry-content"><p>I did what you said but still the error exists! </p>
</div>
												</div>
												<div class="qa-c-item-footer">
													<span class="qa-c-item-avatar-meta">
														<span class="qa-c-item-meta">
															<a href="../../13269/scalar-mixed-function-space-problem?show=13278#c13278" class="qa-c-item-what">commented</a>
															<span class="qa-c-item-when">
																<span class="qa-c-item-when-data"><span class="published"><span class="value-title" title="2017-05-01T19:08:00+0000"></span>May 1, 2017</span></span>
															</span>
															<span class="qa-c-item-who">
																<span class="qa-c-item-who-pad">by </span>
																<span class="qa-c-item-who-data"><span class="vcard author"><a href="../../user/Leo" class="qa-user-link url nickname">Leo</a></span></span>
																<span class="qa-c-item-who-title">FEniCS Novice</span>
																<span class="qa-c-item-who-points">
																	<span class="qa-c-item-who-points-pad">(</span><span class="qa-c-item-who-points-data">840</span><span class="qa-c-item-who-points-pad"> points)</span>
																</span>
															</span>
														</span>
													</span>
													<div class="qa-c-item-buttons">
													</div>
												</div>
												<div class="qa-c-item-clear">
												</div>
											</div> <!-- END qa-c-item -->
										</div> <!-- END qa-c-list -->
										
										<input type="hidden" name="code" value="0-1516467859-8b878394e34ff3d386d778c8f6a9c0faa75e29bc">
										<input type="hidden" name="qa_click" value="">
									</form>
									<div class="qa-c-form">
									</div> <!-- END qa-c-form -->
									
								</div> <!-- END qa-q-view-main -->
								<div class="qa-q-view-clear">
								</div>
							</div> <!-- END qa-q-view -->
							
						</div>
						<div class="qa-part-a-list">
							<h2 id="a_list_title">2 Answers</h2>
							<div class="qa-a-list" id="a_list">
								
								<div class="qa-a-list-item  hentry answer answer-selected qa-a-list-item-selected" id="a13293">
									<form method="post" action="../../13269/scalar-mixed-function-space-problem">
										<div class="qa-voting qa-voting-net" id="voting_13293">
											<div class="qa-vote-count qa-vote-count-net">
												<span class="qa-netvote-count">
													<span class="qa-netvote-count-data">+1<span class="votes-up"><span class="value-title" title="1"></span></span><span class="votes-down"><span class="value-title" title="0"></span></span></span><span class="qa-netvote-count-pad"> vote</span>
												</span>
											</div>
											<div class="qa-vote-clear">
											</div>
										</div>
										<input type="hidden" name="code" value="0-1516467859-953e1e1a93927bdc99da3d5a9705377defddaefa">
									</form>
									<div class="qa-a-item-main">
										<form method="post" action="../../13269/scalar-mixed-function-space-problem">
											<div class="qa-a-item-selected">
												<div class="qa-a-selection">
													<div class="qa-a-selected">&#160;</div>
													<div class="qa-a-selected-text">Best answer</div>
												</div>
												<div class="qa-a-item-content">
													<a name="13293"></a><div class="entry-content"><p>Hi,</p>

<p>you have several issues there. As nate pointed, the problem in nonlinear. Also correct BC application is needed. <br>
Moreover, your splitting into bilinear and (uni)linear functional is wrong. If it was a linear problem then the term  <code>+ (1./(2 * (pow(eps,2)))) * v_2 * dx</code>  has to be in functional <code>L</code>.</p>

<p>Anyway, I have edited your code for the nonlinear solver. The problem with assign is solved<br>
setting <code>deepcopy=True</code> in u.split(True).</p>

<pre><code>from dolfin import *
import mshr


# Define boundaries
class Left(SubDomain):
    def inside(self, x, on_boundary):
        return near(x[0], 0.0)


class Right(SubDomain):
    def inside(self, x, on_boundary):
        return near(x[0], 1.0)


class Bottom(SubDomain):
    def inside(self, x, on_boundary):
        return near(x[1], 0.0)


class Top(SubDomain):
    def inside(self, x, on_boundary):
        return near(x[1], 1.0)


# Initialize sub-domain instances
left = Left()
top = Top()
right = Right()
bottom = Bottom()

# Domain
domain = mshr.Rectangle(Point(0,0), Point(1,1))

# Mesh
mesh = mshr.generate_mesh(domain, 20)

# Marking boundary domains
boundaries = FacetFunction("size_t", mesh)
boundaries.set_all(0)
left.mark(boundaries, 2)
top.mark(boundaries, 1)
right.mark(boundaries, 4)
bottom.mark(boundaries, 3)

CG1_elem = FiniteElement("CG", mesh.ufl_cell(), 1)

#Defining the function spaces for the concentration
V_c = FunctionSpace(mesh, CG1_elem)

#Defining the function spaces for the voltage
V_phi = FunctionSpace(mesh, CG1_elem)

#Defining the mixed function space
W_elem = MixedElement([CG1_elem, CG1_elem])
W = FunctionSpace(mesh, W_elem)

#Defining the "Trial" functions
u = Function(W)
c, phi = split(u)

#Defining the test  functions
(v_1, v_2) = TestFunctions(W)

# Time variables
dt = 0.05; t = 0; T = 10

# Previous solution
W_const = Constant(1.0)
C_previous= interpolate(W_const, V_c)

# Define Dirichlet boundary conditions at top boundary (V=4.0 volt)
Voltage = Constant(4.0)
bc_top = DirichletBC(W.sub(1), Voltage, boundaries, 1)

# Define Dirichlet boundary conditions at bottom boundary (V=0.0 volt)
bc_bottom = DirichletBC(W.sub(1), 0.0, boundaries, 3)

#Collecting the boundary conditions
bcs = [bc_top, bc_bottom]

#Define eps in the weak form
eps=0.0082

# Define variational form
a = dot(grad(phi), grad(v_2)) * dx \
    + c*v_1 * dx \
    - (1./(2 * (pow(eps,2)))) * c * v_2 * dx \
    + dt * eps * dot(grad(c),grad(v_1)) * dx \
    + dt * eps * c * dot(grad(phi),grad(v_1)) * dx

L = C_previous * v_1 * dx - (1./(2 * (pow(eps,2)))) * v_2 * dx

# For nonlinear solver
F = a - L

while t &lt;= T:
    solve(F == 0, u, bcs)

    (c, phi) = u.split(True)
    C_previous.assign(c)

    t += dt
    plot(c, key="c", interactive=False)
</code></pre>
</div>
												</div>
												<span class="qa-a-item-avatar-meta">
													<span class="qa-a-item-avatar">
														<a href="../../user/mhabera" class="qa-avatar-link"><img src="../../?qa=image&amp;qa_blobid=16889760115928551178&amp;qa_size=40" width="29" height="40" class="qa-avatar-image" alt=""></a>
													</span>
													<span class="qa-a-item-meta">
														<a href="../../13269/scalar-mixed-function-space-problem?show=13293#a13293" class="qa-a-item-what">answered</a>
														<span class="qa-a-item-when">
															<span class="qa-a-item-when-data"><span class="published"><span class="value-title" title="2017-05-02T21:52:54+0000"></span>May 2, 2017</span></span>
														</span>
														<span class="qa-a-item-who">
															<span class="qa-a-item-who-pad">by </span>
															<span class="qa-a-item-who-data"><span class="vcard author"><a href="../../user/mhabera" class="qa-user-link url nickname">mhabera</a></span></span>
															<span class="qa-a-item-who-title">FEniCS User</span>
															<span class="qa-a-item-who-points">
																<span class="qa-a-item-who-points-pad">(</span><span class="qa-a-item-who-points-data">1,890</span><span class="qa-a-item-who-points-pad"> points)</span>
															</span>
														</span>
														<br>
														<span class="qa-a-item-what">selected</span>
														<span class="qa-a-item-when">
															<span class="qa-a-item-when-data"><span class="updated"><span class="value-title" title="2017-05-03T06:22:58+0000"></span>May 3, 2017</span></span>
														</span>
														<span class="qa-a-item-who">
															<span class="qa-a-item-who-pad">by </span><span class="qa-a-item-who-data"><a href="../../user/Leo" class="qa-user-link url nickname">Leo</a></span>
														</span>
													</span>
												</span>
											</div>
											<div class="qa-a-item-buttons">
												</div>
											
											<div class="qa-a-item-c-list" id="c13293_list">
												<div class="qa-c-list-item  hentry comment" id="c13294">
													<div class="qa-c-item-content">
														<a name="13294"></a><div class="entry-content"><p>Thank you for the time you spent on this code. When I run your code I get this error:</p>

<pre><code> V_c = FunctionSpace(mesh, CG1_elem)
TypeError: __init__() takes at least 4 arguments (3 given)
</code></pre>

<p>Anyway I changed the V_c and V_phi this way:</p>

<pre><code>V_c = FunctionSpace(mesh, CG1_elem,1)
V_phi = FunctionSpace(mesh, CG1_elem,1)
</code></pre>

<p>I run the code again and Unfortunately this time I got another error:</p>

<pre><code>*** Error:   Unable to create function space.
*** Reason:  Illegal argument for finite element family, not a    string: &lt;CG1 on a &lt;Domain built from &lt;triangle cell in 2D&gt; with label None&gt;&gt;.
*** Where:   This error was encountered inside functionspace.py.
</code></pre>

<p>Do you have any idea to fix these errors? <br>
Thanks!</p>
</div>
													</div>
													<div class="qa-c-item-footer">
														<span class="qa-c-item-avatar-meta">
															<span class="qa-c-item-meta">
																<a href="../../13269/scalar-mixed-function-space-problem?show=13294#c13294" class="qa-c-item-what">commented</a>
																<span class="qa-c-item-when">
																	<span class="qa-c-item-when-data"><span class="published"><span class="value-title" title="2017-05-02T22:38:44+0000"></span>May 3, 2017</span></span>
																</span>
																<span class="qa-c-item-who">
																	<span class="qa-c-item-who-pad">by </span>
																	<span class="qa-c-item-who-data"><span class="vcard author"><a href="../../user/Leo" class="qa-user-link url nickname">Leo</a></span></span>
																	<span class="qa-c-item-who-title">FEniCS Novice</span>
																	<span class="qa-c-item-who-points">
																		<span class="qa-c-item-who-points-pad">(</span><span class="qa-c-item-who-points-data">840</span><span class="qa-c-item-who-points-pad"> points)</span>
																	</span>
																</span>
															</span>
														</span>
														<div class="qa-c-item-buttons">
														</div>
													</div>
													<div class="qa-c-item-clear">
													</div>
												</div> <!-- END qa-c-item -->
												<div class="qa-c-list-item  hentry comment" id="c13295">
													<div class="qa-c-item-content">
														<a name="13295"></a><div class="entry-content"><p>What version of FEniCS do you use? Just run command <code>dolfin-version</code> in terminal to see. </p>

<p>You should probably use the old way of spaces definition - as you had in the original code.</p>

<pre><code>from dolfin import *
import mshr


# Define boundaries
class Left(SubDomain):
    def inside(self, x, on_boundary):
        return near(x[0], 0.0)


class Right(SubDomain):
    def inside(self, x, on_boundary):
        return near(x[0], 1.0)


class Bottom(SubDomain):
    def inside(self, x, on_boundary):
        return near(x[1], 0.0)


class Top(SubDomain):
    def inside(self, x, on_boundary):
        return near(x[1], 1.0)


# Initialize sub-domain instances
left = Left()
top = Top()
right = Right()
bottom = Bottom()

# Domain
domain = mshr.Rectangle(Point(0,0), Point(1,1))

# Mesh
mesh = mshr.generate_mesh(domain, 20)

# Marking boundary domains
boundaries = FacetFunction("size_t", mesh)
boundaries.set_all(0)
left.mark(boundaries, 2)
top.mark(boundaries, 1)
right.mark(boundaries, 4)
bottom.mark(boundaries, 3)

#Defining the function spaces for the concentration
V_c = FunctionSpace(mesh, 'CG', 1)

#Defining the function spaces for the voltage
V_phi = FunctionSpace(mesh, 'CG', 1)

#Defining the mixed function space
W = MixedFunctionSpace((V_c, V_phi))

#Defining the "Trial" functions
u = Function(W)
c, phi = split(u)

#Defining the test  functions
(v_1, v_2) = TestFunctions(W)

# Time variables
dt = 0.05; t = 0; T = 10

# Previous solution
W_const = Constant(1.0)
C_previous= interpolate(W_const, V_c)

# Define Dirichlet boundary conditions at top boundary (V=4.0 volt)
Voltage = Constant(4.0)
bc_top = DirichletBC(W.sub(1), Voltage, boundaries, 1)

# Define Dirichlet boundary conditions at bottom boundary (V=0.0 volt)
bc_bottom = DirichletBC(W.sub(1), 0.0, boundaries, 3)

#Collecting the boundary conditions
bcs = [bc_top, bc_bottom]

#Define eps in the weak form
eps=0.0082

# Define variational form
a = dot(grad(phi), grad(v_2)) * dx \
    + c*v_1 * dx \
    - (1./(2 * (pow(eps,2)))) * c * v_2 * dx \
    + dt * eps * dot(grad(c),grad(v_1)) * dx \
    + dt * eps * c * dot(grad(phi),grad(v_1)) * dx

L = C_previous * v_1 * dx - (1./(2 * (pow(eps,2)))) * v_2 * dx

# For nonlinear solver
F = a - L

while t &lt;= T:
    solve(F == 0, u, bcs)

    (c, phi) = u.split(True)
    C_previous.assign(c)

    t += dt
    plot(c, key="c", interactive=False)
</code></pre>
</div>
													</div>
													<div class="qa-c-item-footer">
														<span class="qa-c-item-avatar-meta">
															<span class="qa-c-item-avatar">
																<a href="../../user/mhabera" class="qa-avatar-link"><img src="../../?qa=image&amp;qa_blobid=16889760115928551178&amp;qa_size=20" width="14" height="20" class="qa-avatar-image" alt=""></a>
															</span>
															<span class="qa-c-item-meta">
																<a href="../../13269/scalar-mixed-function-space-problem?show=13295#c13295" class="qa-c-item-what">commented</a>
																<span class="qa-c-item-when">
																	<span class="qa-c-item-when-data"><span class="published"><span class="value-title" title="2017-05-02T23:09:11+0000"></span>May 3, 2017</span></span>
																</span>
																<span class="qa-c-item-who">
																	<span class="qa-c-item-who-pad">by </span>
																	<span class="qa-c-item-who-data"><span class="vcard author"><a href="../../user/mhabera" class="qa-user-link url nickname">mhabera</a></span></span>
																	<span class="qa-c-item-who-title">FEniCS User</span>
																	<span class="qa-c-item-who-points">
																		<span class="qa-c-item-who-points-pad">(</span><span class="qa-c-item-who-points-data">1,890</span><span class="qa-c-item-who-points-pad"> points)</span>
																	</span>
																</span>
															</span>
														</span>
														<div class="qa-c-item-buttons">
														</div>
													</div>
													<div class="qa-c-item-clear">
													</div>
												</div> <!-- END qa-c-item -->
												<div class="qa-c-list-item  hentry comment" id="c13296">
													<div class="qa-c-item-content">
														<a name="13296"></a><div class="entry-content"><p>Thank you so much. It fixed the errors. <br>
I am using the version 1.6.0. You are absolutely right. I had to bring  the term (1./(2 * (pow(eps,2)))) * v_2 * dx  in functional L (not a).<br>
As the last question: How can I extract the results in an arbitrary point of the domain? Lets say I want to know the value of the "c" (or "phi") at the time = 5 in the center of the square domain [point:(0.5,0.5)]. How can I do that? </p>
</div>
													</div>
													<div class="qa-c-item-footer">
														<span class="qa-c-item-avatar-meta">
															<span class="qa-c-item-meta">
																<a href="../../13269/scalar-mixed-function-space-problem?show=13296#c13296" class="qa-c-item-what">commented</a>
																<span class="qa-c-item-when">
																	<span class="qa-c-item-when-data"><span class="published"><span class="value-title" title="2017-05-03T06:22:50+0000"></span>May 3, 2017</span></span>
																</span>
																<span class="qa-c-item-who">
																	<span class="qa-c-item-who-pad">by </span>
																	<span class="qa-c-item-who-data"><span class="vcard author"><a href="../../user/Leo" class="qa-user-link url nickname">Leo</a></span></span>
																	<span class="qa-c-item-who-title">FEniCS Novice</span>
																	<span class="qa-c-item-who-points">
																		<span class="qa-c-item-who-points-pad">(</span><span class="qa-c-item-who-points-data">840</span><span class="qa-c-item-who-points-pad"> points)</span>
																	</span>
																</span>
															</span>
														</span>
														<div class="qa-c-item-buttons">
														</div>
													</div>
													<div class="qa-c-item-clear">
													</div>
												</div> <!-- END qa-c-item -->
												<div class="qa-c-list-item  hentry comment" id="c13297">
													<div class="qa-c-item-content">
														<a name="13297"></a><div class="entry-content"><p>Please read the section 5.4.3 in <a rel="nofollow" href="https://fenicsproject.org/pub/tutorial/pdf/fenics-tutorial-vol1.pdf">https://fenicsproject.org/pub/tutorial/pdf/fenics-tutorial-vol1.pdf</a></p>

<p>In short, you can use </p>

<pre><code>c(0.5, 0.5)
</code></pre>

<p>but this is very expensive and I would not use it for any other finite element space than <code>CG1</code>.</p>
</div>
													</div>
													<div class="qa-c-item-footer">
														<span class="qa-c-item-avatar-meta">
															<span class="qa-c-item-avatar">
																<a href="../../user/mhabera" class="qa-avatar-link"><img src="../../?qa=image&amp;qa_blobid=16889760115928551178&amp;qa_size=20" width="14" height="20" class="qa-avatar-image" alt=""></a>
															</span>
															<span class="qa-c-item-meta">
																<a href="../../13269/scalar-mixed-function-space-problem?show=13297#c13297" class="qa-c-item-what">commented</a>
																<span class="qa-c-item-when">
																	<span class="qa-c-item-when-data"><span class="published"><span class="value-title" title="2017-05-03T07:38:50+0000"></span>May 3, 2017</span></span>
																</span>
																<span class="qa-c-item-who">
																	<span class="qa-c-item-who-pad">by </span>
																	<span class="qa-c-item-who-data"><span class="vcard author"><a href="../../user/mhabera" class="qa-user-link url nickname">mhabera</a></span></span>
																	<span class="qa-c-item-who-title">FEniCS User</span>
																	<span class="qa-c-item-who-points">
																		<span class="qa-c-item-who-points-pad">(</span><span class="qa-c-item-who-points-data">1,890</span><span class="qa-c-item-who-points-pad"> points)</span>
																	</span>
																</span>
															</span>
														</span>
														<div class="qa-c-item-buttons">
														</div>
													</div>
													<div class="qa-c-item-clear">
													</div>
												</div> <!-- END qa-c-item -->
												<div class="qa-c-list-item  hentry comment" id="c13315">
													<div class="qa-c-item-content">
														<a name="13315"></a><div class="entry-content"><p>That was really helpful. Thanks again.</p>
</div>
													</div>
													<div class="qa-c-item-footer">
														<span class="qa-c-item-avatar-meta">
															<span class="qa-c-item-meta">
																<a href="../../13269/scalar-mixed-function-space-problem?show=13315#c13315" class="qa-c-item-what">commented</a>
																<span class="qa-c-item-when">
																	<span class="qa-c-item-when-data"><span class="published"><span class="value-title" title="2017-05-03T22:06:55+0000"></span>May 4, 2017</span></span>
																</span>
																<span class="qa-c-item-who">
																	<span class="qa-c-item-who-pad">by </span>
																	<span class="qa-c-item-who-data"><span class="vcard author"><a href="../../user/Leo" class="qa-user-link url nickname">Leo</a></span></span>
																	<span class="qa-c-item-who-title">FEniCS Novice</span>
																	<span class="qa-c-item-who-points">
																		<span class="qa-c-item-who-points-pad">(</span><span class="qa-c-item-who-points-data">840</span><span class="qa-c-item-who-points-pad"> points)</span>
																	</span>
																</span>
															</span>
														</span>
														<div class="qa-c-item-buttons">
														</div>
													</div>
													<div class="qa-c-item-clear">
													</div>
												</div> <!-- END qa-c-item -->
											</div> <!-- END qa-c-list -->
											
											<input type="hidden" name="code" value="0-1516467859-db4fb464ba64123e83f0a04f8ac9150a919411b8">
											<input type="hidden" name="qa_click" value="">
										</form>
										<div class="qa-c-form">
										</div> <!-- END qa-c-form -->
										
									</div> <!-- END qa-a-item-main -->
									<div class="qa-a-item-clear">
									</div>
								</div> <!-- END qa-a-list-item -->
								
								<div class="qa-a-list-item  hentry answer" id="a13274">
									<form method="post" action="../../13269/scalar-mixed-function-space-problem">
										<div class="qa-voting qa-voting-net" id="voting_13274">
											<div class="qa-vote-count qa-vote-count-net">
												<span class="qa-netvote-count">
													<span class="qa-netvote-count-data">+1<span class="votes-up"><span class="value-title" title="1"></span></span><span class="votes-down"><span class="value-title" title="0"></span></span></span><span class="qa-netvote-count-pad"> vote</span>
												</span>
											</div>
											<div class="qa-vote-clear">
											</div>
										</div>
										<input type="hidden" name="code" value="0-1516467859-953e1e1a93927bdc99da3d5a9705377defddaefa">
									</form>
									<div class="qa-a-item-main">
										<form method="post" action="../../13269/scalar-mixed-function-space-problem">
											<div class="qa-a-selection">
											</div>
											<div class="qa-a-item-content">
												<a name="13274"></a><div class="entry-content"><p>It is non-linear (as pointed out by nate), but you also need to apply the BC correctly:</p>

<pre><code> bc_top = DirichletBC(W.sub(1), Voltage, boundaries, 1)
bc_bottom = DirichletBC(W.sub(1), 0.0, boundaries, 3)
</code></pre>
</div>
											</div>
											<span class="qa-a-item-avatar-meta">
												<span class="qa-a-item-avatar">
													<a href="../../user/KristianE" class="qa-avatar-link"><img src="https://www.gravatar.com/avatar/8e8c30d82e263e44bd8fe50055a60421?s=40" width="40" height="40" class="qa-avatar-image" alt=""></a>
												</span>
												<span class="qa-a-item-meta">
													<a href="../../13269/scalar-mixed-function-space-problem?show=13274#a13274" class="qa-a-item-what">answered</a>
													<span class="qa-a-item-when">
														<span class="qa-a-item-when-data"><span class="published"><span class="value-title" title="2017-05-01T14:15:26+0000"></span>May 1, 2017</span></span>
													</span>
													<span class="qa-a-item-who">
														<span class="qa-a-item-who-pad">by </span>
														<span class="qa-a-item-who-data"><span class="vcard author"><a href="../../user/KristianE" class="qa-user-link url nickname">KristianE</a></span></span>
														<span class="qa-a-item-who-title">FEniCS Expert</span>
														<span class="qa-a-item-who-points">
															<span class="qa-a-item-who-points-pad">(</span><span class="qa-a-item-who-points-data">12,900</span><span class="qa-a-item-who-points-pad"> points)</span>
														</span>
													</span>
												</span>
											</span>
											<div class="qa-a-item-buttons">
												</div>
											
											<div class="qa-a-item-c-list" id="c13274_list">
												<div class="qa-c-list-item  hentry comment" id="c13279">
													<div class="qa-c-item-content">
														<a name="13279"></a><div class="entry-content"><p>I modified the boundary condition based on what you suggested.  The problem here is related to the writing of the variational form. There are two problems here:</p>

<p><strong>1- Variational form :</strong> <br>
I know this problem is non-linear. I derived the weak form equations (Eq.6 and Eq.8) that correspond to the Eq.1 and Eq.2 respectively and added them to find the final weak form (Eq.9):</p>

<pre><code>a = dot(grad(phi),grad(v_2))*dx \
    - (1./(2*(pow(eps,2))))*c*v_2*dx\
    + (1./(2*(pow(eps,2))))*v_2*dx\
    +c*v_1*dx\
     +dt *eps*dot(grad(c),grad(v_1))*dx\
     +dt*eps*c*dot(grad(phi),grad(v_1))*dx 
</code></pre>

<p>I removed the terms in the above form one  by one and I realized if I only keep the first and the 4th term, I do not get that error again, like:</p>

<pre><code>a = dot(grad(phi),grad(v_2))*dx \
    +c*v_1*dx
</code></pre>

<p><strong>2- Defining the initial condition</strong><br>
I define the c_0 (C_previous in the code) as:</p>

<pre><code># Previous solution
W_const = Constant((1200))
C_previous= interpolate(W_const, V_c)
</code></pre>

<p>And when I assign it to the unknown c in the time loop:</p>

<pre><code>C_previous.assign(c)
</code></pre>

<p>I get this error:</p>

<pre><code>Error:   Unable to initialize vector of degrees of freedom for function.
Reason:  Cannot re-initialize a non-empty vector. Consider creating a new function.
</code></pre>

<p>I would like to mention again that I want to solve these two equarions over the time simultaneously and plot the concentration (unknown c) in time. <br>
Could you please help me fix the two problems I mentioned above to get it to work? Once thanks again for your time.</p>
</div>
													</div>
													<div class="qa-c-item-footer">
														<span class="qa-c-item-avatar-meta">
															<span class="qa-c-item-meta">
																<a href="../../13269/scalar-mixed-function-space-problem?show=13279#c13279" class="qa-c-item-what">commented</a>
																<span class="qa-c-item-when">
																	<span class="qa-c-item-when-data"><span class="published"><span class="value-title" title="2017-05-01T20:38:28+0000"></span>May 1, 2017</span></span>
																</span>
																<span class="qa-c-item-who">
																	<span class="qa-c-item-who-pad">by </span>
																	<span class="qa-c-item-who-data"><span class="vcard author"><a href="../../user/Leo" class="qa-user-link url nickname">Leo</a></span></span>
																	<span class="qa-c-item-who-title">FEniCS Novice</span>
																	<span class="qa-c-item-who-points">
																		<span class="qa-c-item-who-points-pad">(</span><span class="qa-c-item-who-points-data">840</span><span class="qa-c-item-who-points-pad"> points)</span>
																	</span>
																</span>
																<br>
																<span class="qa-c-item-what">edited</span>
																<span class="qa-c-item-when">
																	<span class="qa-c-item-when-data"><span class="updated"><span class="value-title" title="2017-05-01T20:49:22+0000"></span>May 1, 2017</span></span>
																</span>
																<span class="qa-c-item-who">
																	<span class="qa-c-item-who-pad">by </span><span class="qa-c-item-who-data"><a href="../../user/Leo" class="qa-user-link url nickname">Leo</a></span>
																</span>
															</span>
														</span>
														<div class="qa-c-item-buttons">
														</div>
													</div>
													<div class="qa-c-item-clear">
													</div>
												</div> <!-- END qa-c-item -->
												<div class="qa-c-list-item  hentry comment" id="c13284">
													<div class="qa-c-item-content">
														<a name="13284"></a><div class="entry-content"><p>You can probably solve the assignment problem by doing a projection.</p>

<p>Furthermore, a has to be bilinear (a product of test and trial functions) and to me it looks like you forgot to multiply with dt on some of the terms.</p>
</div>
													</div>
													<div class="qa-c-item-footer">
														<span class="qa-c-item-avatar-meta">
															<span class="qa-c-item-avatar">
																<a href="../../user/KristianE" class="qa-avatar-link"><img src="https://www.gravatar.com/avatar/8e8c30d82e263e44bd8fe50055a60421?s=20" width="20" height="20" class="qa-avatar-image" alt=""></a>
															</span>
															<span class="qa-c-item-meta">
																<a href="../../13269/scalar-mixed-function-space-problem?show=13284#c13284" class="qa-c-item-what">commented</a>
																<span class="qa-c-item-when">
																	<span class="qa-c-item-when-data"><span class="published"><span class="value-title" title="2017-05-02T13:18:15+0000"></span>May 2, 2017</span></span>
																</span>
																<span class="qa-c-item-who">
																	<span class="qa-c-item-who-pad">by </span>
																	<span class="qa-c-item-who-data"><span class="vcard author"><a href="../../user/KristianE" class="qa-user-link url nickname">KristianE</a></span></span>
																	<span class="qa-c-item-who-title">FEniCS Expert</span>
																	<span class="qa-c-item-who-points">
																		<span class="qa-c-item-who-points-pad">(</span><span class="qa-c-item-who-points-data">12,900</span><span class="qa-c-item-who-points-pad"> points)</span>
																	</span>
																</span>
															</span>
														</span>
														<div class="qa-c-item-buttons">
														</div>
													</div>
													<div class="qa-c-item-clear">
													</div>
												</div> <!-- END qa-c-item -->
												<div class="qa-c-list-item  hentry comment" id="c13289">
													<div class="qa-c-item-content">
														<a name="13289"></a><div class="entry-content"><p>I have multiplied the Eq.5 by "dt" and it was reduced to Eq.6 which is a weak form of the Eq.1.<br>
In addition there is no time derivative in the Eq.7. So "dt" does not apprear in the weak form of the Eq.2. After all, I think the weak form is correct. <br>
In addition the projection did not solve the assignment problem. I still get the same error!</p>
</div>
													</div>
													<div class="qa-c-item-footer">
														<span class="qa-c-item-avatar-meta">
															<span class="qa-c-item-meta">
																<a href="../../13269/scalar-mixed-function-space-problem?show=13289#c13289" class="qa-c-item-what">commented</a>
																<span class="qa-c-item-when">
																	<span class="qa-c-item-when-data"><span class="published"><span class="value-title" title="2017-05-02T19:07:57+0000"></span>May 2, 2017</span></span>
																</span>
																<span class="qa-c-item-who">
																	<span class="qa-c-item-who-pad">by </span>
																	<span class="qa-c-item-who-data"><span class="vcard author"><a href="../../user/Leo" class="qa-user-link url nickname">Leo</a></span></span>
																	<span class="qa-c-item-who-title">FEniCS Novice</span>
																	<span class="qa-c-item-who-points">
																		<span class="qa-c-item-who-points-pad">(</span><span class="qa-c-item-who-points-data">840</span><span class="qa-c-item-who-points-pad"> points)</span>
																	</span>
																</span>
															</span>
														</span>
														<div class="qa-c-item-buttons">
														</div>
													</div>
													<div class="qa-c-item-clear">
													</div>
												</div> <!-- END qa-c-item -->
											</div> <!-- END qa-c-list -->
											
											<input type="hidden" name="code" value="0-1516467859-882202eacbcae8b86eb4a7b241bee65b9d190ced">
											<input type="hidden" name="qa_click" value="">
										</form>
										<div class="qa-c-form">
										</div> <!-- END qa-c-form -->
										
									</div> <!-- END qa-a-item-main -->
									<div class="qa-a-item-clear">
									</div>
								</div> <!-- END qa-a-list-item -->
								
							</div> <!-- END qa-a-list -->
							
						</div>
					</div> <!-- END qa-main -->
					
				</div> <!-- END main-wrapper -->
			</div> <!-- END main-shadow -->
		</div> <!-- END body-wrapper -->
		<!-- END footer-bottom-group -->
		
		<div style="position:absolute; left:-9999px; top:-9999px;">
			<span id="qa-waiting-template" class="qa-waiting">...</span>
		</div>
	
	

</body><!-- Powered by Question2Answer - http://www.question2answer.org/ --></html>