<html><!-- Powered by Question2Answer - http://www.question2answer.org/ --><head>
		<meta http-equiv="content-type" content="text/html; charset=utf-8">
		<title>unexpectedly large memory usage - FEniCS Q&amp;A</title>
		<meta name="description" content="I'm trying to solve an elasticity equation on a 3D domain, but even with 94GB of RAM I run out of memory when trying to ... x[0]-0.5)**2+(x[1]-0.5)**2">
		<meta name="keywords" content="out_of_memory,3d">
		<link rel="stylesheet" type="text/css" href="../../qa-theme/Snow/qa-styles.css">
		<link rel="canonical" href="http://fenicsproject.org/qa/6781/unexpectedly-large-memory-usage">
		<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
    tex2jax: {inlineMath: [["$","$"],["\\(","\\)"]]},
    TeX: { extensions: ["AMSmath.js","AMSsymbols.js"]}
  });
</script>
<script type="text/javascript" src="../../mathjax/MathJax.js"></script>
		<script src="../../jquery-1.7.2.min.js" type="text/javascript"></script>
		<script src="../../highlight.min.js"></script>
<script type="text/javascript">
$(function(){
	$('.wmd-input').keypress(function(){
		window.clearTimeout(hljs.Timeout);
		hljs.Timeout = window.setTimeout(function() {
			hljs.initHighlighting.called = false;
			hljs.initHighlighting();
		}, 500);
	});
	window.setTimeout(function() {
		hljs.initHighlighting.called = false;
		hljs.initHighlighting();
	}, 500);
});
</script>


	</head>
	<body class="qa-template-question qa-body-js-off">
		<div class="qa-body-wrapper">
			
			<div class="qa-header">
				<div class="qa-logo">
					<a href="../../" class="qa-logo-link" title="FEniCS Q&amp;A"><img src="../../qa-theme/fenics_qa.png" border="0" alt="FEniCS Q&amp;A"></a>
				</div>
				<div class="qa-header-clear">
				</div>
			</div> <!-- END qa-header -->
			
			<div class="qa-main-shadow">
				
				<div class="qa-main-wrapper">
					
					<div class="qa-sidepanel">
						<div class="qa-sidebar">
							This is a read only copy of the old FEniCS QA forum. Please visit the <a href="https://www.allanswered.com/community/s/fenics-project/">new QA forum</a> to ask questions
						</div>
						
					</div>
					
					<div class="qa-main">
						<h1>
							<span class="entry-title">unexpectedly large memory usage</span>
						</h1>
						<div class="qa-part-q-view">
							<div class="qa-q-view  hentry question" id="q6781">
								<form method="post" action="../../6781/unexpectedly-large-memory-usage">
									<div class="qa-q-view-stats">
										<div class="qa-voting qa-voting-net" id="voting_6781">
											<div class="qa-vote-count qa-vote-count-net">
												<span class="qa-netvote-count">
													<span class="qa-netvote-count-data">+1<span class="votes-up"><span class="value-title" title="1"></span></span><span class="votes-down"><span class="value-title" title="0"></span></span></span><span class="qa-netvote-count-pad"> vote</span>
												</span>
											</div>
											<div class="qa-vote-clear">
											</div>
										</div>
									</div>
									<input type="hidden" name="code" value="0-1516468087-7272e2e42974a4dd6cecea3cf121546d0629b67d">
								</form>
								<div class="qa-q-view-main">
									<form method="post" action="../../6781/unexpectedly-large-memory-usage">
										<div class="qa-q-view-content">
											<a name="6781"></a><div class="entry-content"><p>I'm trying to solve an elasticity equation on a 3D domain, but even with 94GB of RAM I run out of memory when trying to use a mesh that is 140x140x140.  This seems completely unreasonable.  Below is my code.  I'm running it using mpirun with 8 processors.  If anyone has any ideas of where all of the memory is going and how I can make things more efficent, please let me know.</p>

<pre><code>from dolfin import *
import numpy, copy, time

parameters['form_compiler']['optimize'] = True
parameters['form_compiler']['cpp_optimize'] = True

# define periodic boundary
class PeriodicBoundary(SubDomain):
    def inside(self, x, on_boundary):
        # return True if on left or bottom boundary AND NOT on one of the two slave edges
        return bool((near(x[0], 0.) or near(x[1], 0.) or near(x[2], 0.)) and
                (not ((near(x[1], 1.) and near(x[2], 0.)) or
                      (near(x[1], 0.) and near(x[2], 1.)) or
                      (near(x[0], 0.) and near(x[2], 1.)) or
                      (near(x[0], 1.) and near(x[2], 0.)) or
                      (near(x[0], 0.) and near(x[1], 1.)) or
                      (near(x[0], 1.) and near(x[1], 0.)))) and on_boundary)
    def map(self, x, y):
        if near(x[0], 1.) and near(x[1], 1.) and near(x[2], 1.):
            y[0] = x[0] - 1.
            y[1] = x[1] - 1.
            y[2] = x[2] - 1.
        elif near(x[1], 1.) and near(x[2], 1.):
            y[0] = x[0]
            y[1] = x[1] - 1.
            y[2] = x[2] - 1.
        elif near(x[0], 1.) and near(x[1], 1.):
            y[0] = x[0] - 1.
            y[1] = x[1] - 1.
            y[2] = x[2]
        elif near(x[0], 1.) and near(x[2], 1.):
            y[0] = x[0] - 1.
            y[1] = x[1]
            y[2] = x[2] - 1.
        elif near(x[0], 1.):
            y[0] = x[0] - 1.
            y[1] = x[1]
            y[2] = x[2]
        elif near(x[1], 1.):
            y[0] = x[0]
            y[1] = x[1] - 1.
            y[2] = x[2]
        elif near(x[2], 1):
            y[0] = x[0]
            y[1] = x[1]
            y[2] = x[2] - 1.
        else:
            y[0] = -1000.
            y[1] = -1000.
            y[2] = -1000.

# Create mesh
nn = 140
mesh = UnitCubeMesh(nn, nn, nn)
V = VectorFunctionSpace(mesh, "CG", 1, constrained_domain=PeriodicBoundary())

class Fiber(SubDomain):
    def inside(self, x, on_boundary):
        return True if ((x[0]-0.5)**2+(x[1]-0.5)**2 &lt;= 0.25**2) else False
fib = Fiber()

domains = CellFunction("size_t", mesh)
domains.set_all(0)
fib.mark(domains, 1)
dy = Measure("dx")[domains]

# define tensors
bbEm = numpy.zeros(81)
bbEm = bbEm.reshape(3,3,3,3)
bbEf = numpy.zeros(81)
bbEf = bbEf.reshape(3,3,3,3)
delta = [[1,0,0],[0,1,0],[0,0,1]]

# Elastic parameters
Em, Ef, nu = 10.5, 150000.0, 0.3
mum, lmbdam = Em/(2*(1 + nu)), Em*nu/((1 + nu)*(1 - 2*nu))
muf, lmbdaf = Ef/(2*(1 + nu)), Ef*nu/((1 + nu)*(1 - 2*nu))
# define bbEm
for ii in range(3):
    for jj in range(3):
        for kk in range(3):
            for ll in range(3):
                bbEm[ii,jj,kk,ll] = mum*(delta[ii][kk]*delta[jj][ll]+delta[ii][ll]*delta[kk][jj])+lmbdam*delta[ii][jj]*delta[kk][ll]
# define bbEf
for ii in range(3):
    for jj in range(3):
        for kk in range(3):
            for ll in range(3):
                bbEf[ii,jj,kk,ll] = muf*(delta[ii][kk]*delta[jj][ll]+delta[ii][ll]*delta[kk][jj])+lmbdaf*delta[ii][jj]*delta[kk][ll]
bbEmC = Constant(bbEm)
bbEfC = Constant(bbEf)

# define basis for V
e0 = Constant([1,0,0])
e1 = Constant([0,1,0])
e2 = Constant([0,0,1])
e = [e0, e1, e2]

# Define functions
u = TrialFunction(V)
v = TestFunction(V)

# Set up linear problem
a = bbEmC[i,j,k,l]*grad(u[k])[l]*grad(v[i])[j]*dy(0) \
    + bbEfC[i,j,k,l]*grad(u[k])[l]*grad(v[i])[j]*dy(1)

A = assemble(a)
z = Function(V)
b = None

# solve the problem
ii, jj = 0, 0
L = - bbEmC[i,j,k,l]*outer(e[ii],e[jj])[k,l]*grad(v[i])[j]*dy(0) \
    - bbEfC[i,j,k,l]*outer(e[ii],e[jj])[k,l]*grad(v[i])[j]*dy(1)
b = assemble(L, tensor=b)

# Create Krylov solver
solver = KrylovSolver(A, "gmres", "amg")

# Create vector that spans the null space
null_vec = Vector(z.vector())
V.dofmap().set(null_vec, 1.0)
null_vec *= 1.0/null_vec.norm("l2")

# Create null space basis object and attach to Krylov solver
null_space = VectorSpaceBasis([null_vec])
solver.set_nullspace(null_space)

# Orthogonalize b with respect to the null space (this gurantees that
# a solution exists)
null_space.orthogonalize(b);

solver.solve(z.vector(), b)
</code></pre>
</div>
										</div>
										<div class="qa-q-view-tags">
											<ul class="qa-q-view-tag-list">
												<li class="qa-q-view-tag-item"><a href="../../tag/out_of_memory" rel="tag" class="qa-tag-link">out_of_memory</a></li>
												<li class="qa-q-view-tag-item"><a href="../../tag/3d" rel="tag" class="qa-tag-link">3d</a></li>
											</ul>
										</div>
										<span class="qa-q-view-avatar-meta">
											<span class="qa-q-view-meta">
												<a href="../../6781/unexpectedly-large-memory-usage" class="qa-q-view-what">asked</a>
												<span class="qa-q-view-when">
													<span class="qa-q-view-when-data"><span class="published"><span class="value-title" title="2015-03-17T15:20:56+0000"></span>Mar 17, 2015</span></span>
												</span>
												<span class="qa-q-view-who">
													<span class="qa-q-view-who-pad">by </span>
													<span class="qa-q-view-who-data"><span class="vcard author"><a href="../../user/bseguin" class="qa-user-link url nickname">bseguin</a></span></span>
													<span class="qa-q-view-who-title">FEniCS Novice</span>
													<span class="qa-q-view-who-points">
														<span class="qa-q-view-who-points-pad">(</span><span class="qa-q-view-who-points-data">650</span><span class="qa-q-view-who-points-pad"> points)</span>
													</span>
												</span>
											</span>
										</span>
										<div class="qa-q-view-buttons">
										</div>
										
										<div class="qa-q-view-c-list" id="c6781_list">
											<div class="qa-c-list-item  hentry comment" id="c6785">
												<div class="qa-c-item-content">
													<a name="6785"></a><div class="entry-content"><p>Try to check where the memory and time is spent. Complex forms like this is know to be hard for the standard form compiler. You can check if it is the form compiler by check the following line before assemble.</p>

<pre><code>a = Form(a)
</code></pre>

<p>If it is this line that takes time you should try using uflacs as backend for the formcompiler. </p>

<pre><code>parameters["form_compiler"]["representation"] = "uflacs"
</code></pre>

<p>Dependent on what FEniCS installation you have you might need to install it from <a rel="nofollow" href="https://bitbucket.org/fenics-project/uflacs">source</a></p>
</div>
												</div>
												<div class="qa-c-item-footer">
													<span class="qa-c-item-avatar-meta">
														<span class="qa-c-item-avatar">
															<a href="../../user/johanhake" class="qa-avatar-link"><img src="https://www.gravatar.com/avatar/73612279d6702974866af2e1a9653a5b?s=20" width="20" height="20" class="qa-avatar-image" alt=""></a>
														</span>
														<span class="qa-c-item-meta">
															<a href="../../6781/unexpectedly-large-memory-usage?show=6785#c6785" class="qa-c-item-what">commented</a>
															<span class="qa-c-item-when">
																<span class="qa-c-item-when-data"><span class="published"><span class="value-title" title="2015-03-18T07:30:10+0000"></span>Mar 18, 2015</span></span>
															</span>
															<span class="qa-c-item-who">
																<span class="qa-c-item-who-pad">by </span>
																<span class="qa-c-item-who-data"><span class="vcard author"><a href="../../user/johanhake" class="qa-user-link url nickname">johanhake</a></span></span>
																<span class="qa-c-item-who-title">FEniCS Expert</span>
																<span class="qa-c-item-who-points">
																	<span class="qa-c-item-who-points-pad">(</span><span class="qa-c-item-who-points-data">22,480</span><span class="qa-c-item-who-points-pad"> points)</span>
																</span>
															</span>
														</span>
													</span>
													<div class="qa-c-item-buttons">
													</div>
												</div>
												<div class="qa-c-item-clear">
												</div>
											</div> <!-- END qa-c-item -->
											<div class="qa-c-list-item  hentry comment" id="c6787">
												<div class="qa-c-item-content">
													<a name="6787"></a><div class="entry-content"><p>After a little poking at your code, I found that the number of nonzeros in your matrix is going like <code>135*nn^3</code>. (ie. approximately 135 nonzeros per row). Does this sound correct for the PDE and elements you are using?</p>

<p>Assuming a CSR implementation of the matrix, we need roughly 3 arrays of this length (row_ptr, cols, vals). This is roughly:</p>

<p><code>135 * 140 * 140 * 140 * (4 Bytes + 4 Bytes + 8 Bytes) =  6 GB</code></p>

<p>Can you see if your memory footprint matches this after <em>only</em> matrix assembly?</p>
</div>
												</div>
												<div class="qa-c-item-footer">
													<span class="qa-c-item-avatar-meta">
														<span class="qa-c-item-meta">
															<a href="../../6781/unexpectedly-large-memory-usage?show=6787#c6787" class="qa-c-item-what">commented</a>
															<span class="qa-c-item-when">
																<span class="qa-c-item-when-data"><span class="published"><span class="value-title" title="2015-03-18T07:45:58+0000"></span>Mar 18, 2015</span></span>
															</span>
															<span class="qa-c-item-who">
																<span class="qa-c-item-who-pad">by </span>
																<span class="qa-c-item-who-data"><span class="vcard author"><a href="../../user/leibs" class="qa-user-link url nickname">leibs</a></span></span>
																<span class="qa-c-item-who-title">FEniCS Novice</span>
																<span class="qa-c-item-who-points">
																	<span class="qa-c-item-who-points-pad">(</span><span class="qa-c-item-who-points-data">360</span><span class="qa-c-item-who-points-pad"> points)</span>
																</span>
															</span>
														</span>
													</span>
													<div class="qa-c-item-buttons">
													</div>
												</div>
												<div class="qa-c-item-clear">
												</div>
											</div> <!-- END qa-c-item -->
											<div class="qa-c-list-item  hentry comment" id="c6796">
												<div class="qa-c-item-content">
													<a name="6796"></a><div class="entry-content"><p>When I switch to the preconditioner petsc_amg I was able to save some RAM, but it still seems like I'm using a lot.  Using this new preconditioner with a grid size of 140x140x140, I found that after assembling the matrix A from the form a the computer uses 12GB of RAM.  At the maximum, it uses 22GB.  I also tried using the hypre_amg preconditioner but this uses much more memory, which is consistent with what  &#216;yvind Evju said.  However, even with the petsc_amg preconditioner I can't solve the problem on a 250x250x250 grid.</p>
</div>
												</div>
												<div class="qa-c-item-footer">
													<span class="qa-c-item-avatar-meta">
														<span class="qa-c-item-meta">
															<a href="../../6781/unexpectedly-large-memory-usage?show=6796#c6796" class="qa-c-item-what">commented</a>
															<span class="qa-c-item-when">
																<span class="qa-c-item-when-data"><span class="published"><span class="value-title" title="2015-03-18T13:27:48+0000"></span>Mar 18, 2015</span></span>
															</span>
															<span class="qa-c-item-who">
																<span class="qa-c-item-who-pad">by </span>
																<span class="qa-c-item-who-data"><span class="vcard author"><a href="../../user/bseguin" class="qa-user-link url nickname">bseguin</a></span></span>
																<span class="qa-c-item-who-title">FEniCS Novice</span>
																<span class="qa-c-item-who-points">
																	<span class="qa-c-item-who-points-pad">(</span><span class="qa-c-item-who-points-data">650</span><span class="qa-c-item-who-points-pad"> points)</span>
																</span>
															</span>
														</span>
													</span>
													<div class="qa-c-item-buttons">
													</div>
												</div>
												<div class="qa-c-item-clear">
												</div>
											</div> <!-- END qa-c-item -->
											<div class="qa-c-list-item  hentry comment" id="c6805">
												<div class="qa-c-item-content">
													<a name="6805"></a><div class="entry-content"><p>12GB for the matrix seems a little high but not unreasonable. Was this from a parallel run? I would fully expect 250x250x250 to exceed your 94GB limit. </p>

<p>Here is my reasoning: Based on &#216;yvind Evju's run it seems as if there is rouglhly a 3x memory overhead for invoking GAMG or ML (not sure which was called). At 250x250x250 the matrix size will be 30GB. The 3x overhead brings us to 90GB. Assuming your OS takes a bit of the memory and some additional overheads for MPI, this puts you right at the limit.</p>
</div>
												</div>
												<div class="qa-c-item-footer">
													<span class="qa-c-item-avatar-meta">
														<span class="qa-c-item-meta">
															<a href="../../6781/unexpectedly-large-memory-usage?show=6805#c6805" class="qa-c-item-what">commented</a>
															<span class="qa-c-item-when">
																<span class="qa-c-item-when-data"><span class="published"><span class="value-title" title="2015-03-18T16:15:29+0000"></span>Mar 18, 2015</span></span>
															</span>
															<span class="qa-c-item-who">
																<span class="qa-c-item-who-pad">by </span>
																<span class="qa-c-item-who-data"><span class="vcard author"><a href="../../user/leibs" class="qa-user-link url nickname">leibs</a></span></span>
																<span class="qa-c-item-who-title">FEniCS Novice</span>
																<span class="qa-c-item-who-points">
																	<span class="qa-c-item-who-points-pad">(</span><span class="qa-c-item-who-points-data">360</span><span class="qa-c-item-who-points-pad"> points)</span>
																</span>
															</span>
														</span>
													</span>
													<div class="qa-c-item-buttons">
													</div>
												</div>
												<div class="qa-c-item-clear">
												</div>
											</div> <!-- END qa-c-item -->
											<div class="qa-c-list-item  hentry comment" id="c6807">
												<div class="qa-c-item-content">
													<a name="6807"></a><div class="entry-content"><p>From what you wrote, it seems that not invoking a preconditioner will save a lot of memory.  Maybe I'll try this.</p>
</div>
												</div>
												<div class="qa-c-item-footer">
													<span class="qa-c-item-avatar-meta">
														<span class="qa-c-item-meta">
															<a href="../../6781/unexpectedly-large-memory-usage?show=6807#c6807" class="qa-c-item-what">commented</a>
															<span class="qa-c-item-when">
																<span class="qa-c-item-when-data"><span class="published"><span class="value-title" title="2015-03-18T17:42:19+0000"></span>Mar 18, 2015</span></span>
															</span>
															<span class="qa-c-item-who">
																<span class="qa-c-item-who-pad">by </span>
																<span class="qa-c-item-who-data"><span class="vcard author"><a href="../../user/bseguin" class="qa-user-link url nickname">bseguin</a></span></span>
																<span class="qa-c-item-who-title">FEniCS Novice</span>
																<span class="qa-c-item-who-points">
																	<span class="qa-c-item-who-points-pad">(</span><span class="qa-c-item-who-points-data">650</span><span class="qa-c-item-who-points-pad"> points)</span>
																</span>
															</span>
														</span>
													</span>
													<div class="qa-c-item-buttons">
													</div>
												</div>
												<div class="qa-c-item-clear">
												</div>
											</div> <!-- END qa-c-item -->
										</div> <!-- END qa-c-list -->
										
										<input type="hidden" name="code" value="0-1516468087-9f66a2dcffc9382d9e2a60c3df43d05ae852801c">
										<input type="hidden" name="qa_click" value="">
									</form>
									<div class="qa-c-form">
									</div> <!-- END qa-c-form -->
									
								</div> <!-- END qa-q-view-main -->
								<div class="qa-q-view-clear">
								</div>
							</div> <!-- END qa-q-view -->
							
						</div>
						<div class="qa-part-a-list">
							<h2 id="a_list_title">2 Answers</h2>
							<div class="qa-a-list" id="a_list">
								
								<div class="qa-a-list-item  hentry answer" id="a6786">
									<form method="post" action="../../6781/unexpectedly-large-memory-usage">
										<div class="qa-voting qa-voting-net" id="voting_6786">
											<div class="qa-vote-count qa-vote-count-net">
												<span class="qa-netvote-count">
													<span class="qa-netvote-count-data">0<span class="votes-up"><span class="value-title" title="0"></span></span><span class="votes-down"><span class="value-title" title="0"></span></span></span><span class="qa-netvote-count-pad"> votes</span>
												</span>
											</div>
											<div class="qa-vote-clear">
											</div>
										</div>
										<input type="hidden" name="code" value="0-1516468087-7272e2e42974a4dd6cecea3cf121546d0629b67d">
									</form>
									<div class="qa-a-item-main">
										<form method="post" action="../../6781/unexpectedly-large-memory-usage">
											<div class="qa-a-selection">
											</div>
											<div class="qa-a-item-content">
												<a name="6786"></a><div class="entry-content"><p>I tried to run it and maxed out at ~18GB. I would suggest looking into the preconditioner. There are several options of AMG-preconditioners in dolfin, depending on linear algebra backend and how they were built. </p>

<p>My fallback default were PETSc with ML-amg preconditioner. If your fallback is Hypre, I think this is the reason for your memory issues.</p>
</div>
											</div>
											<span class="qa-a-item-avatar-meta">
												<span class="qa-a-item-meta">
													<a href="../../6781/unexpectedly-large-memory-usage?show=6786#a6786" class="qa-a-item-what">answered</a>
													<span class="qa-a-item-when">
														<span class="qa-a-item-when-data"><span class="published"><span class="value-title" title="2015-03-18T07:38:59+0000"></span>Mar 18, 2015</span></span>
													</span>
													<span class="qa-a-item-who">
														<span class="qa-a-item-who-pad">by </span>
														<span class="qa-a-item-who-data"><span class="vcard author"><a href="../../user/%C3%98yvind+Evju" class="qa-user-link url nickname">&#216;yvind Evju</a></span></span>
														<span class="qa-a-item-who-title">FEniCS Expert</span>
														<span class="qa-a-item-who-points">
															<span class="qa-a-item-who-points-pad">(</span><span class="qa-a-item-who-points-data">17,700</span><span class="qa-a-item-who-points-pad"> points)</span>
														</span>
													</span>
												</span>
											</span>
											<div class="qa-a-item-buttons">
												</div>
											
											<div class="qa-a-item-c-list" id="c6786_list">
												<div class="qa-c-list-item  hentry comment" id="c6788">
													<div class="qa-c-item-content">
														<a name="6788"></a><div class="entry-content"><p>Your measured 18 GB matches closely with my 6GB estimate. That is, in an AMG setting the finest level would need to store additional interpolation and restriction operators. If you have Hypre available I would be really interested in seeing the output with the setting:</p>

<pre><code>PETScOptions.set("pc_hypre_boomeramg_print_statistics", 1)
</code></pre>
</div>
													</div>
													<div class="qa-c-item-footer">
														<span class="qa-c-item-avatar-meta">
															<span class="qa-c-item-meta">
																<a href="../../6781/unexpectedly-large-memory-usage?show=6788#c6788" class="qa-c-item-what">commented</a>
																<span class="qa-c-item-when">
																	<span class="qa-c-item-when-data"><span class="published"><span class="value-title" title="2015-03-18T07:58:46+0000"></span>Mar 18, 2015</span></span>
																</span>
																<span class="qa-c-item-who">
																	<span class="qa-c-item-who-pad">by </span>
																	<span class="qa-c-item-who-data"><span class="vcard author"><a href="../../user/leibs" class="qa-user-link url nickname">leibs</a></span></span>
																	<span class="qa-c-item-who-title">FEniCS Novice</span>
																	<span class="qa-c-item-who-points">
																		<span class="qa-c-item-who-points-pad">(</span><span class="qa-c-item-who-points-data">360</span><span class="qa-c-item-who-points-pad"> points)</span>
																	</span>
																</span>
															</span>
														</span>
														<div class="qa-c-item-buttons">
														</div>
													</div>
													<div class="qa-c-item-clear">
													</div>
												</div> <!-- END qa-c-item -->
												<div class="qa-c-list-item  hentry comment" id="c6789">
													<div class="qa-c-item-content">
														<a name="6789"></a><div class="entry-content"><p>This is the output using nn=100. Using the hypre amg, it topped out at 13,4GB. With ML amg it topped out at 6,8GB (very briefly, consistent ~5,5GB). The memory usage before solve is 4,5GB.</p>

<pre><code>BoomerAMG SETUP PARAMETERS:

 Max levels = 25
 Num levels = 12

 Strength Threshold = 0.250000
 Interpolation Truncation Factor = 0.000000
 Maximum Row Sum Threshold for Dependency Weakening = 0.900000

 Coarsening Type = Falgout-CLJP 
 measures are determined locally

 Interpolation = modified classical interpolation

Operator Matrix Information:

            nonzero         entries per row        row sums
lev   rows  entries  sparse  min  max   avg       min         max
===================================================================
 0 3000000 135000000  0.000    45   45  45.0  -4.889e-12   5.031e-12
 1 1500000 263038000  0.000   117  178  175.4  -7.352e-12   8.259e-12
 2  528750 187709966  0.001   152  435  355.0  -1.907e-11   1.955e-11
 3  144966 71835558  0.003   180  933  495.5  -3.041e-11   5.314e-11
 4   59453 71072043  0.020   278 2086  1195.4  -4.559e-11   1.270e-10
 5   26566 64054820  0.091   400 4736  2411.2  -4.909e-11   2.383e-10
 6   11679 46124427  0.338   781 6816  3949.3  -1.024e-10   3.432e-10
 7    4959 20537869  0.835  1258 4908  4141.5  -9.807e-11   8.016e-10
 8    1845  3394971  0.997  1130 1845  1840.1  -3.070e-10   2.289e-09
 9     471   221841  1.000   471  471  471.0  -3.106e-10   8.567e-09
10      68     4624  1.000    68   68  68.0   2.270e-13   5.905e-08
11       4       16  1.000     4    4   4.0   1.789e-08   1.529e-07


Interpolation Matrix Information:
                 entries/row    min     max         row sums
lev  rows cols    min max     weight   weight     min       max 
=================================================================
 0 3000000 x 1500000   1   6   9.091e-02 1.000e+00 1.000e+00 1.000e+00
 1 1500000 x 528750   1  10   3.700e-02 1.000e+00 1.000e+00 1.000e+00
 2 528750 x 144966   1  17   2.484e-02 1.000e+00 1.000e+00 1.000e+00
 3 144966 x 59453   1  32   1.173e-02 1.000e+00 1.000e+00 1.000e+00
 4 59453 x 26566   1  35   1.214e-02 1.000e+00 1.000e+00 1.000e+00
 5 26566 x 11679   1  41   1.168e-02 1.000e+00 1.000e+00 1.000e+00
 6 11679 x 4959    1  54   9.038e-03 1.000e+00 1.000e+00 1.000e+00
 7  4959 x 1845    1  52   8.576e-03 1.000e+00 1.000e+00 1.000e+00
 8  1845 x 471     1  43   1.180e-02 1.000e+00 1.000e+00 1.000e+00
 9   471 x 68      1  19   1.330e-02 1.000e+00 1.000e+00 1.000e+00
10    68 x 4       1   2   2.052e-01 1.000e+00 1.000e+00 1.000e+00


     Complexity:    grid = 1.759587
                operator = 6.392549




BoomerAMG SOLVER PARAMETERS:

  Maximum number of cycles:         1 
  Stopping Tolerance:               0.000000e+00 
  Cycle type (1 = V, 2 = W, etc.):  1

  Relaxation Parameters:
   Visiting Grid:                     down   up  coarse
            Number of sweeps:            1    1     1 
   Type 0=Jac, 3=hGS, 6=hSGS, 9=GE:      6    6     9 
   Point types, partial sweeps (1=C, -1=F):
                  Pre-CG relaxation (down):   1  -1
                   Post-CG relaxation (up):  -1   1
                             Coarsest grid:   0
</code></pre>
</div>
													</div>
													<div class="qa-c-item-footer">
														<span class="qa-c-item-avatar-meta">
															<span class="qa-c-item-meta">
																<a href="../../6781/unexpectedly-large-memory-usage?show=6789#c6789" class="qa-c-item-what">commented</a>
																<span class="qa-c-item-when">
																	<span class="qa-c-item-when-data"><span class="published"><span class="value-title" title="2015-03-18T08:25:10+0000"></span>Mar 18, 2015</span></span>
																</span>
																<span class="qa-c-item-who">
																	<span class="qa-c-item-who-pad">by </span>
																	<span class="qa-c-item-who-data"><span class="vcard author"><a href="../../user/%C3%98yvind+Evju" class="qa-user-link url nickname">&#216;yvind Evju</a></span></span>
																	<span class="qa-c-item-who-title">FEniCS Expert</span>
																	<span class="qa-c-item-who-points">
																		<span class="qa-c-item-who-points-pad">(</span><span class="qa-c-item-who-points-data">17,700</span><span class="qa-c-item-who-points-pad"> points)</span>
																	</span>
																</span>
															</span>
														</span>
														<div class="qa-c-item-buttons">
														</div>
													</div>
													<div class="qa-c-item-clear">
													</div>
												</div> <!-- END qa-c-item -->
												<div class="qa-c-list-item  hentry comment" id="c6797">
													<div class="qa-c-item-content">
														<a name="6797"></a><div class="entry-content"><p>It looks like I don't have the ml_amg precondtioner avaliable, even though I have all of the other preconditioners available.  Do you know how I can go about installing it?</p>
</div>
													</div>
													<div class="qa-c-item-footer">
														<span class="qa-c-item-avatar-meta">
															<span class="qa-c-item-meta">
																<a href="../../6781/unexpectedly-large-memory-usage?show=6797#c6797" class="qa-c-item-what">commented</a>
																<span class="qa-c-item-when">
																	<span class="qa-c-item-when-data"><span class="published"><span class="value-title" title="2015-03-18T13:33:37+0000"></span>Mar 18, 2015</span></span>
																</span>
																<span class="qa-c-item-who">
																	<span class="qa-c-item-who-pad">by </span>
																	<span class="qa-c-item-who-data"><span class="vcard author"><a href="../../user/bseguin" class="qa-user-link url nickname">bseguin</a></span></span>
																	<span class="qa-c-item-who-title">FEniCS Novice</span>
																	<span class="qa-c-item-who-points">
																		<span class="qa-c-item-who-points-pad">(</span><span class="qa-c-item-who-points-data">650</span><span class="qa-c-item-who-points-pad"> points)</span>
																	</span>
																</span>
															</span>
														</span>
														<div class="qa-c-item-buttons">
														</div>
													</div>
													<div class="qa-c-item-clear">
													</div>
												</div> <!-- END qa-c-item -->
												<div class="qa-c-list-item  hentry comment" id="c6798">
													<div class="qa-c-item-content">
														<a name="6798"></a><div class="entry-content"><p>You need to build PETSc with ML. I think this is default if you're installing the HashDist way (<a rel="nofollow" href="http://fenicsproject.org/download/"></a><a rel="nofollow" href="http://fenicsproject.org/download/">http://fenicsproject.org/download/</a>). Otherwise, I suggest you take a look at the <a rel="nofollow" href="https://bitbucket.org/fenics-project/fenics-developer-tools">FEniCS Developer Tools</a> and customize the .yaml-profile as needed.</p>
</div>
													</div>
													<div class="qa-c-item-footer">
														<span class="qa-c-item-avatar-meta">
															<span class="qa-c-item-meta">
																<a href="../../6781/unexpectedly-large-memory-usage?show=6798#c6798" class="qa-c-item-what">commented</a>
																<span class="qa-c-item-when">
																	<span class="qa-c-item-when-data"><span class="published"><span class="value-title" title="2015-03-18T13:40:51+0000"></span>Mar 18, 2015</span></span>
																</span>
																<span class="qa-c-item-who">
																	<span class="qa-c-item-who-pad">by </span>
																	<span class="qa-c-item-who-data"><span class="vcard author"><a href="../../user/%C3%98yvind+Evju" class="qa-user-link url nickname">&#216;yvind Evju</a></span></span>
																	<span class="qa-c-item-who-title">FEniCS Expert</span>
																	<span class="qa-c-item-who-points">
																		<span class="qa-c-item-who-points-pad">(</span><span class="qa-c-item-who-points-data">17,700</span><span class="qa-c-item-who-points-pad"> points)</span>
																	</span>
																</span>
															</span>
														</span>
														<div class="qa-c-item-buttons">
														</div>
													</div>
													<div class="qa-c-item-clear">
													</div>
												</div> <!-- END qa-c-item -->
												<div class="qa-c-list-item  hentry comment" id="c6802">
													<div class="qa-c-item-content">
														<a name="6802"></a><div class="entry-content"><p>While I don't have ml_amg on my machine with 98G of RAM, I do have it installed on my laptop.  A quick test showed me that using ml_amg instead of petsc_amg doesn't result in any difference in memory usage.  By the way, when I ran the code I mentioned above I was doing it with mpirun -np 8.  Could running it on 8 cores affect the amount of RAM needed by a large amount?</p>
</div>
													</div>
													<div class="qa-c-item-footer">
														<span class="qa-c-item-avatar-meta">
															<span class="qa-c-item-meta">
																<a href="../../6781/unexpectedly-large-memory-usage?show=6802#c6802" class="qa-c-item-what">commented</a>
																<span class="qa-c-item-when">
																	<span class="qa-c-item-when-data"><span class="published"><span class="value-title" title="2015-03-18T14:47:17+0000"></span>Mar 18, 2015</span></span>
																</span>
																<span class="qa-c-item-who">
																	<span class="qa-c-item-who-pad">by </span>
																	<span class="qa-c-item-who-data"><span class="vcard author"><a href="../../user/bseguin" class="qa-user-link url nickname">bseguin</a></span></span>
																	<span class="qa-c-item-who-title">FEniCS Novice</span>
																	<span class="qa-c-item-who-points">
																		<span class="qa-c-item-who-points-pad">(</span><span class="qa-c-item-who-points-data">650</span><span class="qa-c-item-who-points-pad"> points)</span>
																	</span>
																</span>
															</span>
														</span>
														<div class="qa-c-item-buttons">
														</div>
													</div>
													<div class="qa-c-item-clear">
													</div>
												</div> <!-- END qa-c-item -->
												<div class="qa-c-list-item  hentry comment" id="c6806">
													<div class="qa-c-item-content">
														<a name="6806"></a><div class="entry-content"><p>One more quick comment, after looking at the output from your Hypre run. Adding up the NNZ from each of the levels and assuming a CSR format results in ~13GB.</p>

<p>Have a look at the NNZ from level 1. Yikes! The NNZ increased. We can look into tuning Hypre parameters if needed.</p>
</div>
													</div>
													<div class="qa-c-item-footer">
														<span class="qa-c-item-avatar-meta">
															<span class="qa-c-item-meta">
																<a href="../../6781/unexpectedly-large-memory-usage?show=6806#c6806" class="qa-c-item-what">commented</a>
																<span class="qa-c-item-when">
																	<span class="qa-c-item-when-data"><span class="published"><span class="value-title" title="2015-03-18T16:28:19+0000"></span>Mar 18, 2015</span></span>
																</span>
																<span class="qa-c-item-who">
																	<span class="qa-c-item-who-pad">by </span>
																	<span class="qa-c-item-who-data"><span class="vcard author"><a href="../../user/leibs" class="qa-user-link url nickname">leibs</a></span></span>
																	<span class="qa-c-item-who-title">FEniCS Novice</span>
																	<span class="qa-c-item-who-points">
																		<span class="qa-c-item-who-points-pad">(</span><span class="qa-c-item-who-points-data">360</span><span class="qa-c-item-who-points-pad"> points)</span>
																	</span>
																</span>
															</span>
														</span>
														<div class="qa-c-item-buttons">
														</div>
													</div>
													<div class="qa-c-item-clear">
													</div>
												</div> <!-- END qa-c-item -->
											</div> <!-- END qa-c-list -->
											
											<input type="hidden" name="code" value="0-1516468087-f145b5b8bcd4089fe32156d917de3dc06ed9890c">
											<input type="hidden" name="qa_click" value="">
										</form>
										<div class="qa-c-form">
										</div> <!-- END qa-c-form -->
										
									</div> <!-- END qa-a-item-main -->
									<div class="qa-a-item-clear">
									</div>
								</div> <!-- END qa-a-list-item -->
								
								<div class="qa-a-list-item  hentry answer" id="a6811">
									<form method="post" action="../../6781/unexpectedly-large-memory-usage">
										<div class="qa-voting qa-voting-net" id="voting_6811">
											<div class="qa-vote-count qa-vote-count-net">
												<span class="qa-netvote-count">
													<span class="qa-netvote-count-data">+2<span class="votes-up"><span class="value-title" title="2"></span></span><span class="votes-down"><span class="value-title" title="0"></span></span></span><span class="qa-netvote-count-pad"> votes</span>
												</span>
											</div>
											<div class="qa-vote-clear">
											</div>
										</div>
										<input type="hidden" name="code" value="0-1516468087-7272e2e42974a4dd6cecea3cf121546d0629b67d">
									</form>
									<div class="qa-a-item-main">
										<form method="post" action="../../6781/unexpectedly-large-memory-usage">
											<div class="qa-a-selection">
											</div>
											<div class="qa-a-item-content">
												<a name="6811"></a><div class="entry-content"><p>As a continuation of our discussion above, in the form of an answer. The default Hypre parameters are very conservative, and are designed to construct a rather robust AMG. We can sacrifice a little on its memory storage by tighting up a few parameters, with the expectancy of taken a few additional iterations.</p>

<p>You mentioned that you may just turn off the prconditioner to save spae. You will find that with the elliptic-like problem you are solving that not using a preconditioner will result very poor Krylov solver convergence, and direct solver in 3D will be nearly impossible. My suggestion is to use Hypre, and tune the following two parameters (below are the defaults):</p>

<pre><code>PETScOptions.set("pc_hypre_boomeramg_strong_threshold", .25)
PETScOptions.set("pc_hypre_boomeramg_truncfactor", 0.0)
</code></pre>

<p>Start by tuning the threshold. In the case of a 3D problem you should try 0.5. This should result in better (lower) operator complexity, but may take a few more iterations to achieve convergence. There is a balance to be found.</p>

<p>The Hypre manual (<a rel="nofollow" href="http://computation.llnl.gov/project/linear_solvers/software.php)">http://computation.llnl.gov/project/linear_solvers/software.php)</a> lists many additional options that are exposed to the user for tuning.</p>
</div>
											</div>
											<span class="qa-a-item-avatar-meta">
												<span class="qa-a-item-meta">
													<a href="../../6781/unexpectedly-large-memory-usage?show=6811#a6811" class="qa-a-item-what">answered</a>
													<span class="qa-a-item-when">
														<span class="qa-a-item-when-data"><span class="published"><span class="value-title" title="2015-03-18T20:57:07+0000"></span>Mar 18, 2015</span></span>
													</span>
													<span class="qa-a-item-who">
														<span class="qa-a-item-who-pad">by </span>
														<span class="qa-a-item-who-data"><span class="vcard author"><a href="../../user/leibs" class="qa-user-link url nickname">leibs</a></span></span>
														<span class="qa-a-item-who-title">FEniCS Novice</span>
														<span class="qa-a-item-who-points">
															<span class="qa-a-item-who-points-pad">(</span><span class="qa-a-item-who-points-data">360</span><span class="qa-a-item-who-points-pad"> points)</span>
														</span>
													</span>
												</span>
											</span>
											<div class="qa-a-item-buttons">
												</div>
											
											<div class="qa-a-item-c-list" style="display:none;" id="c6811_list">
											</div> <!-- END qa-c-list -->
											
											<input type="hidden" name="code" value="0-1516468087-69ed546ae62a79dda9708924d9ab108c9e10f5d6">
											<input type="hidden" name="qa_click" value="">
										</form>
										<div class="qa-c-form">
										</div> <!-- END qa-c-form -->
										
									</div> <!-- END qa-a-item-main -->
									<div class="qa-a-item-clear">
									</div>
								</div> <!-- END qa-a-list-item -->
								
							</div> <!-- END qa-a-list -->
							
						</div>
					</div> <!-- END qa-main -->
					
				</div> <!-- END main-wrapper -->
			</div> <!-- END main-shadow -->
		</div> <!-- END body-wrapper -->
		<!-- END footer-bottom-group -->
		
		<div style="position:absolute; left:-9999px; top:-9999px;">
			<span id="qa-waiting-template" class="qa-waiting">...</span>
		</div>
	
	

</body><!-- Powered by Question2Answer - http://www.question2answer.org/ --></html>